<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>청전광장 - 실시간 공유형 사회복지 시스템</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- SheetJS (Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; }
        .input-field {
            width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; outline: none;
            transition: border-color 0.2s, box-shadow 0.2s; background-color: white; font-size: 0.875rem;
        }
        .input-field:focus { border-color: #10b981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1); }
        .input-field:read-only { background-color: #f8fafc; color: #64748b; cursor: default; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        
        /* Table Sticky Headers */
        .sticky-col { position: sticky; left: 0; background-color: white; z-index: 10; }
        .sticky-header { position: sticky; top: 0; z-index: 20; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden">

    <!-- Mobile Header -->
    <div class="md:hidden fixed top-0 left-0 right-0 bg-slate-800 text-white p-4 flex justify-between items-center z-50 h-16">
        <h1 class="font-bold flex items-center gap-2 text-lg"><i data-lucide="book-open" class="text-emerald-400"></i> 청전광장 (공유형)</h1>
        <button id="mobile-menu-btn"><i data-lucide="menu"></i></button>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-slate-800 text-white transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 flex flex-col pt-16 md:pt-0">
        <div class="p-6 hidden md:flex items-center justify-between">
            <h1 class="text-xl font-bold flex items-center gap-2"><i data-lucide="book-open" class="text-emerald-400"></i> 청전광장</h1>
        </div>
        <nav class="flex-1 px-4 space-y-2 mt-4 md:mt-0">
            <button onclick="app.setTab('dashboard')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-slate-300 hover:bg-slate-700" data-tab="dashboard"><i data-lucide="layout-dashboard"></i> 홈</button>
            <button onclick="app.setTab('clients')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-slate-300 hover:bg-slate-700" data-tab="clients"><i data-lucide="users"></i> 대상자 관리</button>
            <button onclick="app.setTab('logs')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-slate-300 hover:bg-slate-700" data-tab="logs"><i data-lucide="file-text"></i> 서비스 일지</button>
            <button onclick="app.setTab('statistics')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-slate-300 hover:bg-slate-700" data-tab="statistics"><i data-lucide="bar-chart-2"></i> 통계</button>
            <button onclick="app.setTab('services')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-slate-300 hover:bg-slate-700" data-tab="services"><i data-lucide="settings"></i> 서비스 설정</button>
        </nav>
        <div class="p-4 bg-slate-900 text-xs text-slate-400">
            <div class="flex items-center gap-2 mb-1 text-emerald-400"><i data-lucide="cloud"></i> <span>Firebase 연결됨</span></div>
            <p>데이터가 실시간 공유됩니다.</p>
        </div>
    </aside>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>

    <main class="flex-1 p-4 md:p-8 pt-20 md:pt-8 overflow-y-auto w-full relative" id="main-content">
        <div class="flex items-center justify-center h-full text-slate-400"><div class="animate-spin mr-2"><i data-lucide="loader-2"></i></div>데이터 불러오는 중...</div>
    </main>

    <div id="modal-container" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-overlay p-4 overflow-y-auto"></div>

    <!-- Firebase SDK & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAx1EJ_7kawHTzsNS97ts5FjCaTJRqJTdM",
            authDomain: "cj-base.firebaseapp.com",
            projectId: "cj-base",
            storageBucket: "cj-base.firebasestorage.app",
            messagingSenderId: "518471894886",
            appId: "1:518471894886:web:9befd2e6d922b22edd6aa7"
        };

        // --- 2. Initialize Firebase ---
        let db, auth;
        try {
            const fbApp = initializeApp(firebaseConfig);
            db = getFirestore(fbApp);
            auth = getAuth(fbApp);
            signInAnonymously(auth).catch((error) => {
                console.error("익명 로그인 실패:", error);
                alert("로그인 실패: 인터넷 연결을 확인해주세요.");
            });
        } catch (e) {
            console.error("Firebase 초기화 실패:", e);
        }

        // --- 3. Constants & State ---
        const CONSTANTS = {
            DONG_LIST: ['대연동', '감만동', '우암동', '문현동', '용호동', '용당동'],
            STATUS_LIST: ['이용', '장기부재', '종결'],
            CARE_LEVEL_LIST: ['일반', '중점'],
            ECONOMIC_LIST: ['일반(저소득)', '기초수급', '조건부 기초수급', '차상위'],
            HOUSEHOLD_LIST: ['독거세대', '부부세대', '동거', '자녀동거세대', '조손동거세대'],
            PROVIDE_METHOD_LIST: ['전화', '방문', '내방', '기타']
        };

        const state = {
            activeTab: 'dashboard',
            clients: [],
            services: [],
            logs: [],
            editingServiceId: null,
            // [수정됨] UI 상태 관리를 위한 객체 추가
            ui: {
                regionDropdownOpen: false
            },
            filters: {
                client: { 
                    status: '이용', 
                    level: '', 
                    // [수정됨] 다중 선택을 위해 배열로 초기화
                    region: [], 
                    gender: '', 
                    search: '', 
                    searchPhone: '', 
                    targetYear: '', 
                    targetMonth: '' 
                },
                log: { start: '', end: '', search: '', category: '', service: '' },
                stats: { start: new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0], end: new Date().toISOString().split('T')[0], type: 'detail', region: '', name: '' }
            }
        };

        // --- 4. Helper Functions ---
        function calculateAge(birthDate) {
            if (!birthDate) return 0;
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
            return age;
        }

        // --- 5. Data Sync (Real-time) ---
        function initDataSync() {
            if (!db) return;
            const handleErr = (e) => { if(e.code === 'permission-denied') console.warn("권한 부족: 규칙을 확인하세요."); };

            onSnapshot(query(collection(db, "clients"), orderBy("createdAt", "desc")), (snap) => {
                state.clients = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            }, handleErr);
            
            onSnapshot(collection(db, "services"), (snap) => {
                let loaded = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                const sortOrder = ['위기관리체계구축', '욕구기반 위기관리', '위기상황관리 및 긴급지원', '기타'];
                loaded.sort((a, b) => {
                    const catA = (a.majorCategory || '').replace(/\s+/g, '');
                    const catB = (b.majorCategory || '').replace(/\s+/g, '');
                    const indexA = sortOrder.findIndex(k => k.replace(/\s+/g, '') === catA);
                    const indexB = sortOrder.findIndex(k => k.replace(/\s+/g, '') === catB);
                    if (indexA !== -1 && indexB !== -1) {
                        if (indexA !== indexB) return indexA - indexB;
                        return (a.category || '').localeCompare(b.category || '');
                    }
                    if (indexA !== -1) return -1;
                    if (indexB !== -1) return 1;
                    return (a.majorCategory || '').localeCompare(b.majorCategory || '');
                });
                state.services = loaded;
                render();
            }, handleErr);
            
            onSnapshot(query(collection(db, "logs"), orderBy("date", "desc")), (snap) => {
                state.logs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            }, handleErr);
        }

        // --- 6. Render Logic ---
        function renderDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const todayLogs = state.logs.filter(l => l.date === today).length;
            const highFocus = state.clients.filter(c => c.careLevel === '중점').length;
            const general = state.clients.filter(c => c.careLevel === '일반').length;

            return `
                <div class="space-y-6 animate-fade-in">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl md:text-2xl font-bold text-slate-800">홈</h2>
                        <div class="text-xs md:text-sm text-emerald-600 flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>공유 중</div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 md:gap-6">
                        <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                            <div class="p-3 bg-blue-100 text-blue-600 rounded-lg"><i data-lucide="users"></i></div>
                            <div>
                                <p class="text-sm text-slate-500">총 대상자</p>
                                <p class="text-2xl font-bold text-slate-800">${state.clients.length}<span class="text-sm font-normal text-slate-500">명</span></p>
                                <p class="text-xs text-slate-400 mt-1">(중점: <span class="text-pink-600 font-bold">${highFocus}</span> / 일반: <span class="text-blue-600 font-bold">${general}</span>)</p>
                            </div>
                        </div>
                        <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                            <div class="p-3 bg-emerald-100 text-emerald-600 rounded-lg"><i data-lucide="file-text"></i></div>
                            <div><p class="text-sm text-slate-500">오늘 일지</p><p class="text-2xl font-bold text-slate-800">${todayLogs}<span class="text-sm font-normal text-slate-500">건</span></p></div>
                        </div>
                        <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                            <div class="p-3 bg-purple-100 text-purple-600 rounded-lg"><i data-lucide="settings"></i></div>
                            <div><p class="text-sm text-slate-500">제공 서비스</p><p class="text-2xl font-bold text-slate-800">${state.services.length}<span class="text-sm font-normal text-slate-500">개</span></p></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 md:p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">최근 활동</h3>
                        <div class="space-y-3">
                        ${state.logs.length === 0 ? '<p class="text-center text-slate-400 py-4">데이터 없음</p>' : state.logs.slice(0,5).map(log => `
                            <div class="flex flex-col sm:flex-row sm:items-start gap-2 sm:gap-4 pb-3 border-b last:border-0 p-2 hover:bg-slate-50 rounded">
                                <div class="hidden sm:block mt-1 text-slate-500"><i data-lucide="check-circle" size="16"></i></div>
                                <div class="flex-1">
                                    <p class="font-medium text-slate-800 text-sm md:text-base">
                                        <span class="text-emerald-600 font-bold">${log.clientName}</span>님 
                                        <span class="text-xs text-slate-400 mx-1">|</span>
                                        ${log.serviceName}
                                    </p>
                                    <p class="text-xs md:text-sm text-slate-500 mt-1 line-clamp-2">${log.date} | ${log.content}</p>
                                </div>
                            </div>`).join('')}
                        </div>
                    </div>
                </div>`;
        }

        function renderClientManager() {
            const { search, searchPhone, status, level, region, gender, targetYear, targetMonth } = state.filters.client;
            
            // 필터링 기준 날짜 계산
            let filterStart = '0000-01-01';
            let filterEnd = '9999-12-31';

            if (targetYear) {
                if (targetMonth) {
                    const m = String(targetMonth).padStart(2, '0');
                    filterStart = `${targetYear}-${m}-01`;
                    const lastDay = new Date(targetYear, targetMonth, 0).getDate();
                    filterEnd = `${targetYear}-${m}-${lastDay}`;
                } else {
                    filterStart = `${targetYear}-01-01`;
                    filterEnd = `${targetYear}-12-31`;
                }
            }
            
            const filtered = state.clients.filter(c => {
                const matchBasic = (!search || c.name.includes(search)) &&
                                   (!searchPhone || (c.phone && c.phone.includes(searchPhone))) && 
                                   (!status || c.status === status) &&
                                   (!level || c.careLevel === level) &&
                                   // [수정됨] 행정동 다중 선택 필터 로직 (배열이 비어있거나 포함되어 있으면 통과)
                                   (region.length === 0 || region.includes(c.region)) &&
                                   (!gender || c.gender === gender);
                
                if (!matchBasic) return false;

                const sDate = c.serviceStartDate || '0000-01-01'; 
                const eDate = c.endDate || '9999-12-31'; 

                if (sDate > filterEnd) return false;

                if (status && status !== '종결') {
                    if (eDate < filterStart) return false;
                }
                
                return true;
            }).sort((a, b) => (a.serviceStartDate || '').localeCompare(b.serviceStartDate || ''));

            // 상단 통계용 집계 로직 (오늘 날짜 기준)
            const today = new Date().toISOString().split('T')[0];
            
            let activeStats = {
                total: 0,
                highFocus: 0, general: 0,
                male: 0, female: 0
            };

            state.clients.forEach(c => {
                const isTerminatedToday = c.status === '종결' || (c.endDate && c.endDate < today);
                const isNotStartedYet = c.serviceStartDate && c.serviceStartDate > today;

                if (c.status === '이용' && !isTerminatedToday && !isNotStartedYet) {
                    activeStats.total++;
                    if (c.careLevel === '중점') activeStats.highFocus++;
                    else if (c.careLevel === '일반') activeStats.general++;
                    if (c.gender === '남성') activeStats.male++;
                    else if (c.gender === '여성') activeStats.female++;
                }
            });

            const yearOptions = [`<option value="" ${!targetYear ? 'selected' : ''}>전체 기간</option>`];
            for (let y = 2010; y <= 2100; y++) {
                yearOptions.push(`<option value="${y}" ${parseInt(targetYear) === y ? 'selected' : ''}>${y}년</option>`);
            }

            const monthOptions = [`<option value="" ${!targetMonth ? 'selected' : ''}>전체 월</option>`];
            for (let m = 1; m <= 12; m++) {
                monthOptions.push(`<option value="${m}" ${parseInt(targetMonth) === m ? 'selected' : ''}>${m}월</option>`);
            }
            
            return `
                <div class="space-y-6 animate-fade-in">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                        <h2 class="text-xl md:text-2xl font-bold text-slate-800">대상자 관리</h2>
                        <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                            <button onclick="app.downloadClientListExcel()" class="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-xs md:text-sm flex items-center gap-1 flex-1 sm:flex-none justify-center"><i data-lucide="download" size="14"></i> 명부 저장</button>
                            <button onclick="app.downloadTemplate()" class="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-xs md:text-sm flex items-center gap-1 flex-1 sm:flex-none justify-center"><i data-lucide="file-text" size="14"></i> 양식</button>
                            <label class="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-xs md:text-sm flex items-center gap-1 cursor-pointer flex-1 sm:flex-none justify-center"><i data-lucide="upload" size="14"></i> 엑셀등록<input type="file" class="hidden" onchange="app.uploadExcel(this)"></label>
                            <button onclick="app.openClientModal()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-xs md:text-sm flex items-center gap-1 flex-1 sm:flex-none justify-center"><i data-lucide="plus" size="16"></i> 등록</button>
                        </div>
                    </div>

                    <!-- [수정됨] 상단 통계 영역 (Grid가 여기서 닫히도록 수정!) -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                       <!-- 첫 번째 칸 -->
                       <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between">
                          <div>
                              <p class="text-xs text-slate-500">현재 이용 대상자 (오늘 기준)</p>
                              <p class="text-2xl font-bold text-slate-800 mt-1">${activeStats.total}<span class="text-sm text-slate-400 font-normal ml-1">명</span></p>
                          </div>
                          <div class="p-3 bg-emerald-50 rounded-full text-emerald-500"><i data-lucide="user-check" size="24"></i></div>
                       </div>
                       
                       <!-- 두 번째 칸 -->
                       <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-center">
                          <div class="flex justify-between items-center mb-2">
                              <span class="text-xs text-slate-500 font-medium">등급별</span>
                              <div class="text-sm font-bold">
                                  <span class="text-pink-600">중점 ${activeStats.highFocus}</span>
                                  <span class="text-slate-300 mx-1">|</span>
                                  <span class="text-blue-600">일반 ${activeStats.general}</span>
                              </div>
                          </div>
                          <div class="w-full h-px bg-slate-100 my-1"></div>
                          <div class="flex justify-between items-center mt-1">
                              <span class="text-xs text-slate-500 font-medium">성별</span>
                              <div class="text-sm font-bold">
                                  <span class="text-blue-500">남 ${activeStats.male}</span>
                                  <span class="text-slate-300 mx-1">|</span>
                                  <span class="text-red-500">여 ${activeStats.female}</span>
                              </div>
                          </div>
                       </div>
                       
                       <!-- 세 번째 칸 -->
                       <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center justify-center text-slate-300 border-dashed">
                          <span class="text-sm flex items-center gap-2"><i data-lucide="plus-circle" size="16"></i> 빈 슬롯</span>
                       </div>
                    </div> <!-- 닫는 태그 복구 완료! -->

                    <!-- 필터 영역 (레이아웃 정리됨) -->
                    <div class="bg-white p-3 rounded-xl shadow-sm flex flex-col gap-2">
                        <!-- 첫 번째 줄: 드롭다운 필터들 -->
                        <div class="flex flex-wrap items-center gap-1 sm:gap-2 text-sm">
                            <div class="flex items-center gap-1 text-slate-600 font-bold mr-1 flex-shrink-0"><i data-lucide="filter" size="14"></i></div>
                            
                            <select class="input-field py-1.5 px-2 text-sm flex-1 min-w-[90px]" onchange="app.setFilter('client','targetYear',this.value)" title="연도">
                                ${yearOptions.join('')}
                            </select>
                            <select class="input-field py-1.5 px-2 text-sm flex-1 min-w-[70px]" onchange="app.setFilter('client','targetMonth',this.value)" title="월">
                                ${monthOptions.join('')}
                            </select>

                            <div class="h-4 w-px bg-slate-300 mx-1 hidden sm:block"></div>

                            <select class="input-field py-1.5 px-2 text-sm flex-1 min-w-[70px]" onchange="app.setFilter('client','status',this.value)">
                                <option value="">전체</option>
                                ${CONSTANTS.STATUS_LIST.map(s=>`<option value="${s}" ${status===s?'selected':''}>${s}</option>`).join('')}
                            </select>

                            <select class="input-field py-1.5 px-2 text-sm flex-1 min-w-[70px]" onchange="app.setFilter('client','level',this.value)">
                                <option value="">등급</option>${CONSTANTS.CARE_LEVEL_LIST.map(c=>`<option value="${c}" ${level===c?'selected':''}>${c}</option>`).join('')}
                            </select>
                            
                            <!-- [수정됨] 행정동 다중 선택 체크박스 드롭다운 -->
                            <div class="relative z-30">
                                <button onclick="app.toggleRegionDropdown()" class="input-field py-1.5 px-2 text-sm flex items-center justify-between min-w-[100px] bg-white cursor-pointer text-left h-[34px]">
                                    <span class="truncate max-w-[90px] text-slate-700">${region.length > 0 ? (region.length === CONSTANTS.DONG_LIST.length ? '전체 동' : region.join(',')) : '전체 동'}</span>
                                    <i data-lucide="chevron-down" size="14" class="text-slate-400"></i>
                                </button>
                                
                                ${state.ui.regionDropdownOpen ? `
                                    <div class="fixed inset-0 z-40" onclick="app.toggleRegionDropdown()"></div>
                                    <div class="absolute top-full left-0 mt-1 w-48 bg-white border border-slate-200 rounded-lg shadow-xl z-50 p-2 max-h-60 overflow-y-auto animate-fade-in">
                                        ${CONSTANTS.DONG_LIST.map(d => `
                                            <label class="flex items-center gap-2 text-sm p-2 hover:bg-slate-50 rounded cursor-pointer select-none">
                                                <input type="checkbox" class="rounded text-emerald-600 focus:ring-emerald-500 w-4 h-4 border-slate-300"
                                                    ${region.includes(d) ? 'checked' : ''}
                                                    onchange="app.toggleRegionFilter('${d}')">
                                                <span class="text-slate-700">${d}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>

                            <select class="input-field py-1.5 px-2 text-sm flex-1 min-w-[70px]" onchange="app.setFilter('client','gender',this.value)">
                                <option value="">성별</option>
                                <option value="남성" ${gender==='남성'?'selected':''}>남성</option>
                                <option value="여성" ${gender==='여성'?'selected':''}>여성</option>
                            </select>
                        </div>

                        <!-- 두 번째 줄: 텍스트 검색 (라벨 추가 및 아이콘 제거) -->
                        <div class="flex flex-wrap items-center gap-3 w-full mt-1">
                            <!-- 대상자명 검색 -->
                            <div class="flex items-center gap-2 flex-1 min-w-[180px]">
                                <span class="text-sm font-bold text-slate-600 whitespace-nowrap">대상자명</span>
                                <!-- [수정됨] 글자를 모두 지우면(빈값) 즉시 필터 초기화 추가 -->
                                <input class="input-field py-1.5 px-2 text-sm w-full" placeholder="이름 입력 (Enter)" value="${search}" 
                                    onkeydown="if(event.key === 'Enter') app.setFilter('client','search',this.value)"
                                    oninput="if(this.value === '') app.setFilter('client','search','')">
                            </div>
                            
                            <!-- 연락처 검색 -->
                            <div class="flex items-center gap-2 flex-1 min-w-[180px]">
                                <span class="text-sm font-bold text-slate-600 whitespace-nowrap">연락처</span>
                                <!-- [수정됨] 글자를 모두 지우면(빈값) 즉시 필터 초기화 추가 -->
                                <input class="input-field py-1.5 px-2 text-sm w-full" placeholder="번호 입력 (Enter)" value="${searchPhone}" 
                                    onkeydown="if(event.key === 'Enter') app.setFilter('client','searchPhone',this.value)"
                                    oninput="if(this.value === '') app.setFilter('client','searchPhone','')">
                            </div>
                            
                            <button onclick="app.resetFilters('client')" class="bg-slate-100 text-slate-500 hover:text-slate-700 text-xs flex items-center gap-1 whitespace-nowrap px-3 py-2 rounded-lg font-medium transition-colors ml-auto sm:ml-0"><i data-lucide="refresh-cw" size="14"></i> 초기화</button>
                        </div>
                    </div>

                    <div class="space-y-2">
                        ${filtered.length === 0 ? `<div class="text-center py-12 bg-white rounded-xl border border-dashed border-slate-200 text-slate-400">검색 결과가 없습니다.</div>` :
                        filtered.map(c => {
                            const isLogicallyTerminated = c.status === '종결' || (c.endDate && c.endDate <= filterEnd);
                            const displayStatus = isLogicallyTerminated ? '종결' : c.status;
                            const statusColor = displayStatus === '종결' ? 'bg-slate-100 text-slate-500' : 
                                              (displayStatus === '이용' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500');

                            return `
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col sm:flex-row sm:items-center justify-between gap-3 group hover:bg-slate-50 transition-colors">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-bold text-2xl text-slate-800 cursor-pointer hover:text-blue-600 hover:underline transition-all" onclick="app.openClientModal('${c.id}')" title="상세 정보 보기/수정">${c.name}</span>
                                        <span class="text-base font-bold ${c.gender==='남성'?'text-blue-500':'text-red-500'}">(${calculateAge(c.birthDate)}세/${c.gender})</span>
                                        
                                        <div class="flex items-center gap-1 ml-1">
                                            <span class="text-xs px-2 py-0.5 rounded bg-slate-100 text-slate-600 font-medium">${c.region}</span>
                                            <span class="text-xs px-2 py-0.5 rounded ${c.careLevel==='중점'?'bg-pink-100 text-pink-700':'bg-blue-100 text-blue-700'} font-medium">${c.careLevel}</span>
                                            
                                            <!-- 상태 배지 -->
                                            <span class="text-xs px-2 py-0.5 rounded ${statusColor} font-medium">${displayStatus}</span>
                                            
                                            ${targetYear && !isLogicallyTerminated ? `<span class="text-xs text-emerald-600 bg-emerald-50 px-1.5 rounded border border-emerald-100">이용중</span>` : ''}
                                        </div>
                                    </div>
                                    <div class="flex flex-wrap gap-4 text-base text-slate-600 items-center">
                                        <!-- [수정됨] 연락처2가 있으면 함께 표시 -->
                                        <span class="flex items-center gap-1"><i data-lucide="phone" size="10" class="text-slate-400"></i> ${c.phone||'-'}${c.phone2 ? ' / ' + c.phone2 : ''}</span>
                                        <span class="text-slate-300 text-sm">|</span>
                                        <span class="flex items-center gap-1"><i data-lucide="home" size="10" class="text-slate-400"></i> ${c.address||'-'}</span>
                                    </div>
                                </div>
                                
                                <div class="flex items-center gap-2 justify-end w-full sm:w-auto">
                                    ${displayStatus !== '종결' ? `
                                    <button onclick="app.getAiRecommendation('${c.id}')" class="text-purple-600 hover:bg-purple-50 p-1.5 rounded" title="AI 제안">
                                        <i data-lucide="sparkles" size="18"></i>
                                    </button>` : ''}
                                    <button onclick="app.openClientModal('${c.id}')" class="text-slate-400 hover:text-blue-500 p-1.5 rounded" title="수정">
                                        <i data-lucide="edit" size="18"></i>
                                    </button>
                                    <button onclick="app.deleteData('clients','${c.id}')" class="text-slate-400 hover:text-red-500 p-1.5 rounded" title="삭제">
                                        <i data-lucide="trash-2" size="18"></i>
                                    </button>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
        }

        function renderLogManager() {
            const { start, end, search, category, service } = state.filters.log;
            const filtered = state.logs.filter(l => 
                (!start || l.date >= start) && (!end || l.date <= end) && (!search || l.clientName.includes(search)) && 
                (!category || (l.serviceItems && l.serviceItems.some(i => i.category === category))) &&
                (!service || (l.serviceItems && l.serviceItems.some(i => i.serviceName === service)))
            );
            const categories = [...new Set(state.services.map(s => s.category))];
            const filteredServices = category ? state.services.filter(s => s.category === category) : state.services;

            return `
                <div class="space-y-6 animate-fade-in">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl md:text-2xl font-bold text-slate-800">서비스 일지</h2>
                        <div class="flex gap-2">
                            <button onclick="app.printLogs()" class="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-1 hover:bg-slate-200 transition-colors"><i data-lucide="printer" size="16"></i> 인쇄</button>
                            <button onclick="app.downloadLogsExcel()" class="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-1 hover:bg-slate-200 transition-colors"><i data-lucide="download" size="16"></i> 엑셀 저장</button>
                            <button onclick="app.openLogModal()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium hover:bg-emerald-700 transition-colors"><i data-lucide="plus" size="16"></i> 작성</button>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm flex items-center gap-2 overflow-x-auto whitespace-nowrap">
                        <div class="flex items-center gap-1 text-slate-600 font-bold text-sm mr-2 flex-shrink-0">
                            <i data-lucide="filter" size="14"></i> 필터
                        </div>

                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <!-- [수정됨] max 속성 추가하여 연도 4자리(9999년) 제한 -->
                            <input type="date" class="input-field py-1.5 w-full sm:w-32 text-sm" value="${start}" onchange="app.setFilter('log','start',this.value)" max="9999-12-31">
                            <span class="text-slate-400">~</span>
                            <!-- [수정됨] max 속성 추가하여 연도 4자리(9999년) 제한 -->
                            <input type="date" class="input-field py-1.5 w-full sm:w-32 text-sm" value="${end}" onchange="app.setFilter('log','end',this.value)" max="9999-12-31">
                        </div>
                        
                        <!-- [수정됨] 서비스 일지 이름 검색: Enter키 검색 & 빈값 자동 초기화 적용 -->
                        <input class="input-field py-1.5 w-full sm:w-32 text-sm" placeholder="이름 (Enter)" value="${search}" 
                            onkeydown="if(event.key === 'Enter') app.setFilter('log','search',this.value)"
                            oninput="if(this.value === '') app.setFilter('log','search','')">

                        <div class="flex gap-2 w-full sm:w-auto flex-1">
                            <select class="input-field py-1.5 w-full sm:w-32 text-sm" onchange="app.setFilter('log','category',this.value); app.setFilter('log','service','');">
                                <option value="">서비스(전체)</option>${categories.map(c=>`<option value="${c}" ${category===c?'selected':''}>${c}</option>`).join('')}
                            </select>
                            <select class="input-field py-1.5 w-full sm:w-32 text-sm" onchange="app.setFilter('log','service',this.value)">
                                <option value="">상세내용(전체)</option>${filteredServices.map(s=>`<option value="${s.name}" ${service===s.name?'selected':''}>${s.name}</option>`).join('')}
                            </select>
                        </div>
                        <button onclick="app.resetFilters('log')" class="ml-auto text-slate-400 hover:text-slate-600 text-xs flex items-center gap-1 flex-shrink-0"><i data-lucide="refresh-cw" size="14"></i> 초기화</button>
                    </div>
                    <div class="space-y-4">
                        ${filtered.length === 0 ? '<div class="text-center py-12 text-slate-400">검색 결과가 없습니다.</div>' : filtered.map(l => {
                            const c = state.clients.find(cl => cl.id === l.clientId);
                            return `
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 flex flex-col md:flex-row items-start gap-6 hover:shadow-md transition-shadow relative">
                                <!-- Left Column: 33% -->
                                <div class="md:w-1/3 border-b md:border-b-0 md:border-r border-slate-100 pb-4 md:pb-0 md:pr-6 flex-shrink-0 w-full">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm text-slate-500 font-medium flex items-center gap-1"><i data-lucide="calendar" size="10"></i> ${l.date}</span>
                                        <span class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded-full font-medium">${l.provideMethod || '방문'}</span>
                                    </div>
                                    <div class="mb-4">
                                        <div class="flex items-baseline gap-2">
                                            <span class="text-lg font-bold text-slate-800">${l.clientName}</span>
                                            <span class="text-xs text-slate-500">${c ? `(${calculateAge(c.birthDate)}세/${c.gender})` : ''}</span>
                                        </div>
                                        ${c ? `<div class="text-xs text-slate-400 mt-0.5">${c.region} | ${c.careLevel}</div>` : ''}
                                    </div>
                                    
                                    <div class="space-y-2">
                                        ${l.serviceItems ? l.serviceItems.map(i => `
                                            <div class="bg-emerald-50/50 border border-emerald-100 rounded-lg px-2.5 py-1.5 flex flex-col items-start gap-1 text-xs">
                                                <div class="flex items-center gap-1 w-full">
                                                    <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 flex-shrink-0"></div>
                                                    <span class="font-bold text-emerald-800 whitespace-nowrap">${i.category} > ${i.serviceName}</span>
                                                </div>
                                                ${i.detailNote ? `
                                                    <div class="text-slate-600 whitespace-normal break-all pl-2.5 border-l-2 border-emerald-200 leading-snug w-full">
                                                        ${i.detailNote}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `).join('') : ''}
                                    </div>
                                </div>

                                <!-- Right Column: Content Area -->
                                <div class="flex-1 relative min-w-0 flex flex-col justify-start h-full">
                                    <!-- Header: Content Label & Actions/Author -->
                                    <div class="flex justify-between items-start mb-1">
                                        <div class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1 pt-1">
                                            <i data-lucide="file-text" size="10"></i> 진행 내용
                                        </div>
                                        
                                        <!-- Right Side: Buttons & Author - Absolute Position for PC -->
                                        <div class="flex flex-col items-end gap-1 md:absolute md:top-0 md:right-0">
                                            <div class="flex gap-1">
                                                <button onclick="app.duplicateLog('${l.id}')" class="p-1.5 text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 rounded transition-colors" title="복사"><i data-lucide="copy" size="10"></i></button>
                                                <button onclick="app.openLogModal('${l.id}')" class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors" title="수정"><i data-lucide="edit" size="10"></i></button>
                                                <button onclick="app.deleteData('logs','${l.id}')" class="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" title="삭제"><i data-lucide="trash-2" size="10"></i></button>
                                            </div>
                                            <span class="text-xs text-slate-500 bg-slate-50 px-2 py-0.5 rounded flex items-center gap-1">
                                                <i data-lucide="user" size="10"></i> ${l.provider || '미지정'}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <!-- Content Body: 클릭 시 수정 모달 열기 -->
                                    <div class="flex-1 mt-0">
                                        <p class="text-slate-700 text-sm leading-relaxed whitespace-pre-wrap cursor-pointer p-2 -ml-2 rounded hover:bg-slate-50 hover:text-blue-800 transition-colors mt-0" title="클릭하여 수정하기" onclick="app.openLogModal('${l.id}')">${l.content}</p>
                                    </div>
                                </div>
                            </div>`
                        }).join('')}
                    </div>
                </div>`;
        }

        function renderStatistics() {
            const { start, end, type, region, name } = state.filters.stats;
            const targetClients = state.clients.filter(c => 
                (!region || c.region === region) && 
                (!name || c.name.includes(name))
            );

            // [수정됨] 정렬 로직 변경: 이름순(.sort()) 제거 -> state.services의 순서(대분류 기준) 유지
            let serviceHeaders = [];
            let headerGroups = {};
            let orderedCategories = [];

            if (type === 'category') {
                // Set을 사용하여 중복 제거하되, state.services의 원본 순서(대분류 우선)를 유지
                serviceHeaders = [...new Set(state.services.map(s => s.category))].filter(Boolean);
            } else {
                // 상세 보기: 카테고리 순서를 먼저 추출
                orderedCategories = [...new Set(state.services.map(s => s.category || '기타'))];

                state.services.forEach(s => {
                    const cat = s.category || '기타';
                    if (!headerGroups[cat]) headerGroups[cat] = [];
                    if (!headerGroups[cat].includes(s.name)) headerGroups[cat].push(s.name);
                });
                
                // 정렬된 카테고리 순서대로 헤더 생성
                serviceHeaders = orderedCategories.flatMap(cat => headerGroups[cat]);
            }

            const dataMap = {}; 
            
            targetClients.forEach(c => {
                dataMap[c.id] = { name: c.name, total: 0, counts: {} };
                serviceHeaders.forEach(k => dataMap[c.id].counts[k] = 0);
            });

            state.logs.forEach(l => {
                if (l.date < start || l.date > end) return;
                let cid = l.clientId;
                if (!dataMap[cid] && l.clientName) {
                    const found = targetClients.find(c => c.name === l.clientName);
                    if(found) cid = found.id;
                }

                if (dataMap[cid]) {
                    const items = l.serviceItems || [{ serviceName: l.serviceName, category: l.serviceCategory }];
                    items.forEach(item => {
                        let key = type === 'category' ? item.category : item.serviceName;
                        if (!key && item.serviceName && type === 'category') {
                            const s = state.services.find(svc => svc.name === item.serviceName);
                            if(s) key = s.category;
                        }
                        
                        if (key && dataMap[cid].counts[key] !== undefined) {
                            dataMap[cid].counts[key]++;
                            dataMap[cid].total++;
                        }
                    });
                }
            });

            const rows = Object.values(dataMap).filter(r => r.total >= 0).sort((a,b) => b.total - a.total);
            const colTotals = {};
            serviceHeaders.forEach(k => colTotals[k] = rows.reduce((sum, r) => sum + (r.counts[k]||0), 0));
            const grandTotal = rows.reduce((sum, r) => sum + r.total, 0);

            // [수정됨] 테이블 헤더 가운데 정렬(text-center) 추가
            let theadHTML = '';
            if (type === 'category') {
                theadHTML = `<tr>
                    <th class="p-3 sticky-col border-b border-r min-w-[80px] bg-slate-50 text-xs sm:text-sm text-center">대상자</th>
                    <th class="p-3 bg-emerald-50 text-emerald-700 border-b border-r min-w-[50px] text-xs sm:text-sm text-center">합계</th>
                    ${serviceHeaders.map(k => `<th class="p-3 border-b border-r min-w-[80px] text-xs sm:text-sm text-center">${k}</th>`).join('')}
                </tr>`;
            } else {
                // 상세 보기 헤더 생성 시 orderedCategories 사용
                theadHTML = `<tr>
                    <th rowspan="2" class="p-3 sticky-col border-b border-r min-w-[80px] bg-slate-50 z-30 text-xs sm:text-sm text-center">대상자</th>
                    <th rowspan="2" class="p-3 bg-emerald-50 text-emerald-700 border-b border-r min-w-[50px] z-30 text-xs sm:text-sm text-center">합계</th>
                    ${orderedCategories.map(cat => `<th colspan="${headerGroups[cat].length}" class="p-2 border-b border-r bg-slate-100 text-center text-xs text-center">${cat}</th>`).join('')}
                </tr><tr>
                    ${orderedCategories.map(cat => headerGroups[cat].map(svc => `<th class="p-2 border-b border-r font-normal text-xs min-w-[80px] text-center">${svc}</th>`).join('')).join('')}
                </tr>`;
            }

            return `
                <div class="space-y-6 animate-fade-in">
                    <h2 class="text-2xl font-bold text-slate-800">서비스 제공 통계</h2>
                    <div class="flex flex-col sm:flex-row flex-wrap gap-2 items-center bg-white p-4 rounded-xl shadow-sm">
                        <div class="flex bg-slate-100 p-1 rounded w-full sm:w-auto justify-center">
                            <button onclick="app.setFilter('stats','type','category')" class="px-3 py-1 rounded text-sm flex-1 sm:flex-none ${type==='category'?'bg-white shadow':''}">분류별</button>
                            <button onclick="app.setFilter('stats','type','detail')" class="px-3 py-1 rounded text-sm flex-1 sm:flex-none ${type==='detail'?'bg-white shadow':''}">상세별</button>
                        </div>
                        <div class="flex w-full sm:w-auto gap-2">
                            <input type="date" class="input-field w-full sm:w-32 py-1 text-sm" value="${start}" onchange="app.setFilter('stats','start',this.value)" max="9999-12-31">
                            <input type="date" class="input-field w-full sm:w-32 py-1 text-sm" value="${end}" onchange="app.setFilter('stats','end',this.value)" max="9999-12-31">
                        </div>
                        <div class="flex w-full sm:w-auto gap-2 flex-1">
                            <input class="input-field w-full sm:w-24 py-1 text-sm" placeholder="이름" value="${name}" oninput="app.setFilter('stats','name',this.value)">
                            <select class="input-field w-full sm:w-24 py-1 text-sm" onchange="app.setFilter('stats','region',this.value)"><option value="">전체 동</option>${CONSTANTS.DONG_LIST.map(d=>`<option value="${d}" ${region===d?'selected':''}>${d}</option>`).join('')}</select>
                        </div>
                        <button onclick="app.downloadStatsExcel()" class="w-full sm:w-auto bg-emerald-600 text-white p-2 rounded flex justify-center"><i data-lucide="download" size="16"></i></button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-auto max-h-[600px]">
                        <table class="w-full text-sm text-left border-collapse whitespace-nowrap">
                            <thead class="sticky-header bg-slate-50 text-slate-600 font-semibold z-20">${theadHTML}</thead>
                            <tbody class="divide-y divide-slate-100">
                                <tr class="bg-slate-50 font-bold sticky top-0 z-10">
                                    <td class="p-3 sticky-col border-r bg-slate-50 text-center">총계</td>
                                    <td class="p-3 text-center border-r bg-emerald-50 text-emerald-700">${grandTotal}</td>
                                    ${serviceHeaders.map(k => `<td class="p-3 text-center border-r">${colTotals[k]}</td>`).join('')}
                                </tr>
                                ${rows.map(r => `
                                    <tr class="hover:bg-slate-50">
                                        <td class="p-3 sticky-col bg-white border-r group-hover:bg-slate-50 text-center">${r.name}</td>
                                        <td class="p-3 text-center font-bold bg-emerald-50 border-r text-emerald-600">${r.total}</td>
                                        ${serviceHeaders.map(k => `<td class="p-3 text-center border-r ${r.counts[k]>0?'bg-blue-50 font-medium text-blue-600 text-slate-800':'text-slate-300'}">${r.counts[k]||'-'}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // --- ServiceManager (Updated) ---
        function renderServiceManager() {
            const isEditing = !!state.editingServiceId;
            const editData = isEditing ? state.services.find(s => s.id === state.editingServiceId) : {};

            return `
                <div class="space-y-6 animate-fade-in">
                    <h2 class="text-2xl font-bold text-slate-800">서비스 목록 설정</h2>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <form onsubmit="app.addService(event)" class="flex flex-col sm:flex-row flex-wrap gap-4 items-end">
                            <div class="w-full sm:flex-1 min-w-[140px]">
                                <label class="block text-sm font-medium text-slate-700 mb-1">서비스 대분류</label>
                                <input name="majorCategory" class="input-field" placeholder="예: 위기관리" value="${editData.majorCategory || ''}" list="list-major" autocomplete="off">
                                <datalist id="list-major">${[...new Set(state.services.map(s=>s.majorCategory).filter(Boolean))].sort().map(v=>`<option value="${v}">`).join('')}</datalist>
                            </div>
                            <div class="w-full sm:flex-1 min-w-[140px]">
                                <label class="block text-sm font-medium text-slate-700 mb-1">서비스</label>
                                <input name="category" class="input-field" placeholder="예: 사례관리" required value="${editData.category || ''}" list="list-cat" autocomplete="off">
                                <datalist id="list-cat">${[...new Set(state.services.map(s=>s.category).filter(Boolean))].sort().map(v=>`<option value="${v}">`).join('')}</datalist>
                            </div>
                            <div class="w-full sm:flex-1 min-w-[140px]">
                                <label class="block text-sm font-medium text-slate-700 mb-1">서비스 상세내용</label>
                                <input name="name" class="input-field" placeholder="예: 초기상담" required value="${editData.name || ''}" list="list-name" autocomplete="off">
                                <datalist id="list-name">${[...new Set(state.services.map(s=>s.name).filter(Boolean))].sort().map(v=>`<option value="${v}">`).join('')}</datalist>
                            </div>
                            <div class="w-full sm:flex-1 min-w-[140px]">
                                <label class="block text-sm font-medium text-slate-700 mb-1">예시</label>
                                <input name="example" class="input-field" placeholder="예: 가정방문" value="${editData.example || ''}">
                            </div>
                            <div class="w-full sm:w-auto flex gap-2">
                                ${isEditing ? `<button type="button" onclick="app.cancelEditService()" class="flex-1 sm:flex-none bg-slate-200 text-slate-600 px-4 py-2 rounded-lg hover:bg-slate-300 h-[42px] whitespace-nowrap">취소</button>` : ''}
                                <button type="submit" class="flex-1 sm:flex-none bg-slate-800 text-white px-6 py-2 rounded-lg hover:bg-slate-700 h-[42px] whitespace-nowrap">${isEditing ? '수정' : '추가'}</button>
                            </div>
                        </form>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden overflow-x-auto">
                        <table class="w-full text-left min-w-[800px]">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="p-4 font-semibold text-slate-600 whitespace-nowrap w-[20%]">서비스 대분류</th>
                                    <th class="p-4 font-semibold text-slate-600 whitespace-nowrap w-[20%]">서비스</th>
                                    <th class="p-4 font-semibold text-slate-600 whitespace-nowrap w-[25%]">서비스 상세내용</th>
                                    <th class="p-4 font-semibold text-slate-600 whitespace-nowrap w-[25%]">예시</th>
                                    <th class="p-4 font-semibold text-slate-600 text-right whitespace-nowrap w-[10%]">관리</th>
                                </tr>
                            </thead>
                            <tbody>${state.services.map(s => `
                                <tr class="border-t border-slate-100 hover:bg-slate-50 ${state.editingServiceId === s.id ? 'bg-slate-100' : ''}">
                                    <td class="p-4 text-slate-800">${s.majorCategory || '-'}</td>
                                    <td class="p-4 text-slate-500"><span class="bg-slate-100 px-2 py-1 rounded text-xs">${s.category}</span></td>
                                    <td class="p-4 text-slate-800 font-medium">${s.name}</td>
                                    <td class="p-4 text-slate-600 text-sm">${s.example || '-'}</td>
                                    <td class="p-4 text-right flex justify-end gap-1">
                                        <button onclick="app.editService('${s.id}')" class="text-slate-400 hover:text-blue-500 p-1"><i data-lucide="edit" size="18"></i></button>
                                        <button onclick="app.deleteData('services','${s.id}')" class="text-slate-400 hover:text-red-600 p-1"><i data-lucide="trash-2" size="18"></i></button>
                                    </td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // --- 7. Modal & Form Logic ---
        window.app = {
            setTab: (t) => { state.activeTab = t; render(); document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('sidebar-overlay').classList.add('hidden'); },
            setFilter: (s, k, v) => { state.filters[s][k] = v; render(); },
            
            // [추가됨] 행정동 드롭다운 토글 및 필터 로직
            toggleRegionDropdown: () => {
                state.ui.regionDropdownOpen = !state.ui.regionDropdownOpen;
                render();
            },
            toggleRegionFilter: (val) => {
                const currentRegions = state.filters.client.region;
                const idx = currentRegions.indexOf(val);
                
                if (idx > -1) {
                    currentRegions.splice(idx, 1);
                } else {
                    currentRegions.push(val);
                }
                
                // UX 개선: 모든 동을 선택하면 필터를 비워서 '전체'로 처리 (선택적으로 적용)
                if (currentRegions.length === CONSTANTS.DONG_LIST.length) {
                    // 선택 유지 or 초기화? 여기서는 선택 유지하되 표시는 전체로 함
                }
                
                render();
            },

            // --- Reset Filters Logic (수정됨: 초기화 시에도 '이용' 상태로 복귀) ---
            resetFilters: (scope) => {
                const defaults = {
                    client: { 
                        status: '이용', // 기본값 '이용'
                        level: '', 
                        region: [], // [수정됨] 배열 초기화
                        gender: '', 
                        search: '', searchPhone: '', 
                        targetYear: '', 
                        targetMonth: '' 
                    },
                    log: { start: '', end: '', search: '', category: '', service: '' }
                };
                state.filters[scope] = defaults[scope];
                if(scope === 'client') state.ui.regionDropdownOpen = false;
                render();
            },

            // --- Download Client List (수정됨: 월 필터 및 시작일 누락 로직 반영) ---
            downloadClientListExcel: () => {
                const { search, searchPhone, status, level, region, gender, targetYear, targetMonth } = state.filters.client;
                
                // 날짜 범위 계산
                let filterStart = '0000-01-01';
                let filterEnd = '9999-12-31';

                if (targetYear) {
                    if (targetMonth) {
                        const m = String(targetMonth).padStart(2, '0');
                        filterStart = `${targetYear}-${m}-01`;
                        const lastDay = new Date(targetYear, targetMonth, 0).getDate();
                        filterEnd = `${targetYear}-${m}-${lastDay}`;
                    } else {
                        filterStart = `${targetYear}-01-01`;
                        filterEnd = `${targetYear}-12-31`;
                    }
                }

                // Filter Logic
                const filtered = state.clients.filter(c => {
                    const matchBasic = (!search || c.name.includes(search)) &&
                                       (!searchPhone || (c.phone && c.phone.includes(searchPhone))) && 
                                       (!status || c.status === status) &&
                                       (!level || c.careLevel === level) &&
                                       // [수정됨] 엑셀 다운로드에도 다중 지역 필터 적용
                                       (region.length === 0 || region.includes(c.region)) &&
                                       (!gender || c.gender === gender);
                    
                    if (!matchBasic) return false;

                    // 화면 로직과 동일하게 변경 (전체/종결 선택 시 과거 데이터 포함)
                    const sDate = c.serviceStartDate || '0000-01-01'; 
                    const eDate = c.endDate || '9999-12-31'; 

                    // 미래 시작 숨김
                    if (sDate > filterEnd) return false;

                    // 특정 활성 상태('이용' 등)일 때만 과거 종료자 숨김
                    if (status && status !== '종결') {
                        if (eDate < filterStart) return false;
                    }
                    
                    return true;
                }).sort((a, b) => (a.serviceStartDate || '').localeCompare(b.serviceStartDate || ''));

                if (filtered.length === 0) {
                    alert("다운로드할 대상자가 없습니다.");
                    return;
                }

                const excelData = filtered.map(c => ({
                    '이름': c.name,
                    '성별': c.gender,
                    '생년월일': c.birthDate,
                    '행정동': c.region,
                    '상세주소': c.address,
                    '연락처': c.phone,
                    '보호자관계': c.guardianRelation,
                    '보호자연락처': c.guardianPhone,
                    '상태': c.status,
                    '관리등급': c.careLevel,
                    '경제상황': c.economicStatus,
                    '세대유형': c.householdType,
                    '서비스시작일': c.serviceStartDate,
                    '장기부재기간': c.absencePeriod,
                    '종결일자': c.endDate,
                    '비고': c.note
                }));

                const ws = XLSX.utils.json_to_sheet(excelData);
                ws['!cols'] = [{ wch: 10 }, { wch: 6 }, { wch: 12 }, { wch: 8 }, { wch: 30 }, { wch: 13 }, { wch: 10 }, { wch: 13 }, { wch: 8 }, { wch: 8 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 20 }, { wch: 12 }, { wch: 30 }];
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "대상자명부");
                XLSX.writeFile(wb, `대상자명부_${new Date().toISOString().slice(0,10)}.xlsx`);
            },

            // --- Client Modal ---
            openClientModal: (id) => {
                const c = id ? state.clients.find(x => x.id === id) : {};
                
                // [수정됨] 기존 장기부재기간 텍스트 파싱
                let absStart = '', absEnd = '';
                if (c.absencePeriod && c.absencePeriod.includes('~')) {
                    const parts = c.absencePeriod.split('~');
                    if(parts.length === 2) {
                        absStart = parts[0].trim();
                        absEnd = parts[1].trim();
                    }
                }

                const html = `
                <div class="bg-white w-full max-w-4xl p-4 sm:p-6 rounded-xl shadow-xl max-h-[90vh] overflow-y-auto mx-2">
                    <h3 class="font-bold text-lg mb-4">${c.id ? '수정' : '등록'}</h3>
                    <form onsubmit="app.saveClient(event, '${c.id || ''}')" class="space-y-4">
                        <!-- 첫 번째 줄: 이름, 성별, 주민번호, 생년월일 (유지) -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3">
                            <div><label class="text-sm block mb-1">이름</label><input name="name" class="input-field" value="${c.name||''}" required></div>
                            <div>
                                <label class="text-sm block mb-1">성별</label>
                                <select name="gender" class="input-field" id="gender-select">
                                    <option value="남성">남성</option>
                                    <option value="여성" ${c.gender==='여성'?'selected':''}>여성</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm block mb-1">주민등록번호</label>
                                <input name="residentNum" class="input-field" placeholder="YYMMDD-1..." value="${c.residentNum||''}" maxlength="14" oninput="app.calcBirthFromRR(this)">
                            </div>
                            <div>
                                <label class="text-sm block mb-1">생년월일</label>
                                <input type="date" name="birthDate" id="birth-date-input" class="input-field" value="${c.birthDate||''}" max="9999-12-31">
                            </div>
                        </div>

                        <!-- [수정됨] 두 번째 줄: 연락처1, 연락처2, 보호자 연락처 (3칸 배치) -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-sm block mb-1">연락처 1</label>
                                <input name="phone" class="input-field" placeholder="본인 연락처" value="${c.phone||''}">
                            </div>
                            <div>
                                <label class="text-sm block mb-1">연락처 2</label>
                                <input name="phone2" class="input-field" placeholder="비상/추가 연락처" value="${c.phone2||''}">
                            </div>
                            <div>
                                <label class="text-sm block mb-1">보호자 연락처</label>
                                <div class="flex gap-2">
                                    <input name="guardianRelation" class="input-field w-20" placeholder="관계" value="${c.guardianRelation||''}">
                                    <input name="guardianPhone" class="input-field flex-1" placeholder="번호" value="${c.guardianPhone||''}">
                                </div>
                            </div>
                        </div>

                        <!-- [수정됨] 세 번째 줄: 행정동(좁게), 주소(넓게) -->
                        <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
                            <div class="sm:col-span-1">
                                <label class="text-sm block mb-1">행정동</label>
                                <select name="region" class="input-field">
                                    ${CONSTANTS.DONG_LIST.map(d=>`<option value="${d}" ${c.region===d?'selected':''}>${d}</option>`).join('')}
                                </select>
                            </div>
                            <div class="sm:col-span-3">
                                <label class="text-sm block mb-1">주소</label>
                                <input name="address" class="input-field" value="${c.address||''}" placeholder="상세 주소 입력">
                            </div>
                        </div>

                        <!-- 네 번째 줄: 등급, 경제상황, 세대유형 (유지) -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            <div><label class="text-sm block mb-1">등급</label><select name="careLevel" class="input-field">${CONSTANTS.CARE_LEVEL_LIST.map(v=>`<option value="${v}" ${c.careLevel===v?'selected':''}>${v}</option>`).join('')}</select></div>
                            <div><label class="text-sm block mb-1">경제상황</label><select name="economicStatus" class="input-field">${CONSTANTS.ECONOMIC_LIST.map(v=>`<option value="${v}" ${c.economicStatus===v?'selected':''}>${v}</option>`).join('')}</select></div>
                            <div><label class="text-sm block mb-1">세대유형</label><select name="householdType" class="input-field">${CONSTANTS.HOUSEHOLD_LIST.map(v=>`<option value="${v}" ${c.householdType===v?'selected':''}>${v}</option>`).join('')}</select></div>
                        </div>

                        <!-- 다섯 번째 줄: 서비스 관리 (상태, 시작일, 장기부재, 종결일 - 유지) -->
                        <div class="grid grid-cols-1 sm:grid-cols-12 gap-3">
                            <div class="sm:col-span-2">
                                <label class="text-sm block mb-1">상태</label>
                                <select name="status" class="input-field">
                                    ${CONSTANTS.STATUS_LIST.map(s=>`<option value="${s}" ${c.status===s?'selected':''}>${s}</option>`).join('')}
                                </select>
                            </div>
                            <div class="sm:col-span-3"><label class="text-sm block mb-1">시작일</label><input type="date" name="serviceStartDate" class="input-field" value="${c.serviceStartDate||''}" max="9999-12-31"></div>
                            <div class="sm:col-span-4">
                                <label class="text-sm block mb-1">장기부재기간</label>
                                <div class="flex items-center gap-1">
                                    <input type="date" name="absStart" class="input-field px-1 text-sm text-center" value="${absStart}" max="9999-12-31" style="font-size: 0.8rem;">
                                    <span class="text-slate-400">~</span>
                                    <input type="date" name="absEnd" class="input-field px-1 text-sm text-center" value="${absEnd}" max="9999-12-31" style="font-size: 0.8rem;">
                                </div>
                            </div>
                            <div class="sm:col-span-3"><label class="text-sm block mb-1">종결일</label><input type="date" name="endDate" class="input-field" value="${c.endDate||''}" max="9999-12-31"></div>
                        </div>

                        <div><label class="text-sm block mb-1">비고</label><textarea name="note" class="input-field" rows="2">${c.note||''}</textarea></div>
                        <div class="flex justify-end gap-2 pt-2"><button type="button" onclick="app.closeModal()" class="px-4 py-2 text-slate-600 border border-slate-200 rounded-lg">취소</button><button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded-lg">저장</button></div>
                    </form>
                </div>`;
                showModal(html);
            },
            
            // [수정됨] 주민번호 하이픈 자동 입력 및 생년월일 계산
            calcBirthFromRR: (input) => {
                // 1. 숫자만 추출
                let val = input.value.replace(/[^0-9]/g, '');
                
                // 2. 하이픈 자동 포맷팅 (6자리 넘어가면 중간에 - 삽입)
                if (val.length > 6) {
                    val = val.slice(0, 6) + '-' + val.slice(6);
                    input.value = val;
                }
                
                // 3. 계산 로직을 위해 다시 숫자만 추출 (위에서 input.value에 하이픈을 넣었으므로)
                const cleanVal = val.replace(/-/g, '');

                // 7자리 이상(YYMMDD + 성별코드)일 때 계산 시작
                if (cleanVal.length >= 7) {
                    const yy = cleanVal.substr(0, 2);
                    const mm = cleanVal.substr(2, 2);
                    const dd = cleanVal.substr(4, 2);
                    const g = cleanVal.substr(6, 1);

                    let yearPrefix = '';
                    
                    // 1,2,5,6 -> 1900년대 / 3,4,7,8 -> 2000년대
                    if (['1', '2', '5', '6'].includes(g)) yearPrefix = '19';
                    else if (['3', '4', '7', '8'].includes(g)) yearPrefix = '20';

                    if (yearPrefix) {
                        const fullDate = `${yearPrefix}${yy}-${mm}-${dd}`;
                        const birthInput = document.getElementById('birth-date-input');
                        if (birthInput) birthInput.value = fullDate;
                        
                        // (선택사항) 성별도 자동 선택
                        const genderSelect = document.getElementById('gender-select');
                        if (genderSelect) {
                            if (['1', '3', '5', '7'].includes(g)) genderSelect.value = '남성';
                            else if (['2', '4', '6', '8'].includes(g)) genderSelect.value = '여성';
                        }
                    }
                }
            },

            saveClient: async (e, id) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);
                
                // [수정됨] 시작일과 종료일을 합쳐서 하나의 문자열로 저장
                const start = data.absStart;
                const end = data.absEnd;
                
                if (start || end) {
                    // 둘 중 하나라도 입력되면 포맷팅 (없는 쪽은 빈칸)
                    data.absencePeriod = `${start || ''} ~ ${end || ''}`;
                } else {
                    data.absencePeriod = '';
                }
                
                // DB에 불필요한 필드 저장 방지
                delete data.absStart;
                delete data.absEnd;

                // 생성일이 없으면 추가 (수정 시에는 유지하거나 덮어쓰지 않음)
                if (!id) data.createdAt = new Date().toISOString();

                try {
                    if (id) await updateDoc(doc(db, "clients", id), data);
                    else await addDoc(collection(db, "clients"), data);
                    closeModal();
                } catch(err) { alert("저장 실패: " + err.message); }
            },

            // --- Log Modal ---
            openLogModal: (id) => {
                const l = id ? state.logs.find(x => x.id === id) : { date: new Date().toISOString().split('T')[0], provideMethod: '방문', provider: '', serviceItems: [{id: Date.now(), category:'', serviceName:'', detailNote:''}] };
                const c = id ? (state.clients.find(x => x.name === l.clientName) || {}) : {};
                
                // Reset temporary selected clients
                window.tempSelectedClients = id ? [l.clientName] : [];
                window.tempServiceItems = l.serviceItems || [{id: Date.now(), category:'', serviceName:'', detailNote:''}];

                const html = `
                <div class="bg-white w-full max-w-4xl p-4 sm:p-6 rounded-xl shadow-xl max-h-[90vh] overflow-y-auto mx-2">
                    <h3 class="font-bold text-lg mb-4">${l.id ? '수정' : '작성'}</h3>
                    <form onsubmit="app.saveLog(event, '${l.id || ''}')" class="space-y-4">
                        <!-- Row 1: Date, Method, Provider -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 bg-slate-50 p-4 rounded">
                            <div>
                                <label class="block text-sm font-medium mb-1">날짜</label>
                                <input type="date" name="date" class="input-field" value="${l.date}" required max="9999-12-31">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">제공방법</label>
                                <select name="provideMethod" class="input-field">
                                    ${CONSTANTS.PROVIDE_METHOD_LIST.map(m => `<option value="${m}" ${l.provideMethod===m?'selected':''}>${m}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">제공자</label>
                                <input name="provider" class="input-field" value="${l.provider || ''}" placeholder="담당자">
                            </div>
                        </div>

                        <!-- Row 2: Client Search & Auto Info (Updated for Multi-Select + Enter Key) -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 bg-slate-50 p-4 rounded mt-2">
                            <div class="md:col-span-1">
                                <label class="block text-sm font-medium mb-1">대상자 검색</label>
                                <div class="flex gap-2 mb-2">
                                    <input list="cl-list" id="client-input" class="input-field" placeholder="이름 검색" onchange="app.fillClientInfo(this)" onkeydown="if(event.key === 'Enter') { event.preventDefault(); app.addClientToSelection(); }" autocomplete="off" ${id ? 'disabled title="수정 시 대상자 변경 불가"' : ''}>
                                    <datalist id="cl-list">${state.clients.map(c=>`<option value="${c.name}">`).join('')}</datalist>
                                    ${!id ? `<button type="button" onclick="app.addClientToSelection()" class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded text-sm font-medium whitespace-nowrap hover:bg-emerald-200">+추가</button>` : ''}
                                </div>
                                <!-- Selected Clients Container -->
                                <div id="selected-clients-area" class="flex flex-wrap gap-2"></div>
                            </div>
                            <div class="md:col-span-3 flex flex-col sm:flex-row gap-2">
                                <div class="flex-1">
                                    <label class="block text-sm font-medium mb-1 text-slate-500">생년월일</label>
                                    <input id="d-birth" class="input-field bg-slate-100" readonly value="${c.birthDate||''}">
                                </div>
                                <div class="flex-1">
                                    <label class="block text-sm font-medium mb-1 text-slate-500">행정동</label>
                                    <input id="d-region" class="input-field bg-slate-100" readonly value="${c.region||''}">
                                </div>
                                <div class="flex-1">
                                    <label class="block text-sm font-medium mb-1 text-slate-500">관리등급</label>
                                    <input id="d-level" class="input-field bg-slate-100" readonly value="${c.careLevel||''}">
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between mb-2"><label class="font-bold text-sm">서비스 (최대 6개)</label><button type="button" onclick="app.addSvcRow()" class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded">추가</button></div>
                            <div id="svc-container" class="space-y-2"></div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1"><label class="text-sm">내용</label><button type="button" onclick="app.aiDraft()" class="text-xs bg-purple-100 text-purple-700 px-2 rounded">AI 다듬기</button></div>
                            <textarea id="log-content" name="content" class="input-field h-32" required>${l.content||''}</textarea>
                        </div>
                        <div class="flex justify-end gap-2"><button type="button" onclick="app.closeModal()" class="px-4 py-2 text-slate-600 border border-slate-200 rounded-lg">취소</button><button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded-lg">저장</button></div>
                    </form>
                </div>`;
                showModal(html);
                window.tempServiceItems.forEach(item => renderSvcRow(item));
                app.renderSelectedClients(id); 
            },

            // --- Multi-Client Logic ---
            fillClientInfo: (input) => {
                const c = state.clients.find(x => x.name === input.value);
                if(c) {
                    document.getElementById('d-birth').value = c.birthDate || '';
                    document.getElementById('d-region').value = c.region || '';
                    document.getElementById('d-level').value = c.careLevel || '';
                } else {
                    document.getElementById('d-birth').value = '';
                    document.getElementById('d-region').value = '';
                    document.getElementById('d-level').value = '';
                }
            },
            addClientToSelection: () => {
                const input = document.getElementById('client-input');
                const name = input.value.trim();
                if(!name) return;
                
                const isValid = state.clients.some(c => c.name === name);
                if(!isValid) { alert("등록된 대상자가 아닙니다."); return; }

                if(!window.tempSelectedClients.includes(name)) {
                    window.tempSelectedClients.push(name);
                    app.renderSelectedClients();
                }
                input.value = ''; // Clear
                // Reset Info Fields
                document.getElementById('d-birth').value = '';
                document.getElementById('d-region').value = '';
                document.getElementById('d-level').value = '';
            },
            removeClientFromSelection: (index) => {
                window.tempSelectedClients.splice(index, 1);
                app.renderSelectedClients();
            },
            renderSelectedClients: (isEditMode = false) => {
                const container = document.getElementById('selected-clients-area');
                if(!container) return;
                container.innerHTML = window.tempSelectedClients.map((name, idx) => `
                    <span class="bg-emerald-50 text-emerald-700 px-2 py-1 rounded text-sm flex items-center gap-1 border border-emerald-200">
                        ${name}
                        ${!isEditMode ? `<button type="button" onclick="app.removeClientFromSelection(${idx})" class="text-emerald-400 hover:text-red-500"><i data-lucide="x" size="14"></i></button>` : ''}
                    </span>
                `).join('');
                lucide.createIcons();
            },

            addSvcRow: () => {
                if(document.querySelectorAll('.svc-row').length >= 6) return alert('최대 6개까지입니다.');
                renderSvcRow({id: Date.now(), category:'', serviceName:'', detailNote:''});
            },
            removeSvcRow: (id) => document.getElementById(`row-${id}`).remove(),
            
            saveLog: async (e, id) => {
                e.preventDefault();
                if(window.tempSelectedClients.length === 0) return alert("대상자를 1명 이상 추가해주세요.");

                const fd = new FormData(e.target);
                
                // Collect Service Items
                const items = Array.from(document.querySelectorAll('.svc-row')).map(row => ({
                    category: row.querySelector('.cat-sel').value,
                    serviceName: row.querySelector('.svc-sel').value,
                    detailNote: row.querySelector('.det-inp').value
                })).filter(i => i.serviceName);

                if(items.length === 0) return alert('서비스를 하나 이상 선택하세요.');

                // Base Data
                const baseData = {
                    date: fd.get('date'),
                    provideMethod: fd.get('provideMethod'),
                    provider: fd.get('provider'),
                    content: fd.get('content'),
                    serviceItems: items,
                    serviceName: items.map(i=>i.serviceName).join(', ') 
                };

                try {
                    // Loop through selected clients and create/update logs
                    const promises = window.tempSelectedClients.map(async (cName, idx) => {
                        const client = state.clients.find(x => x.name === cName);
                        const logData = {
                            ...baseData,
                            clientName: cName,
                            clientId: client ? client.id : 'unknown'
                        };

                        if (id && idx === 0) {
                            // In edit mode, update the existing log (first one)
                            // Multi-client edit isn't supported in standard flow, usually editing applies to the original log only.
                            // But if user managed to add more people in edit mode (disabled in UI), this logic handles it.
                            return updateDoc(doc(db, "logs", id), logData);
                        } else {
                            // Create new logs
                            return addDoc(collection(db, "logs"), logData);
                        }
                    });

                    await Promise.all(promises);
                    closeModal();
                } catch(err) { alert("저장 실패: " + err.message); }
            },
            duplicateLog: async (id) => {
                const l = state.logs.find(x => x.id === id);
                if(l) {
                    const { id, ...data } = l; 
                    data.date = new Date().toISOString().split('T')[0];
                    await addDoc(collection(db, "logs"), data);
                }
            },
            aiDraft: () => {
                const t = document.getElementById('log-content');
                if(!t.value) return alert('내용을 입력하세요');
                t.value = "AI 분석 중...";
                setTimeout(() => { t.value = "[AI] 대상자 안부 확인 및 물품 전달 완료. 건강 상태 양호함."; }, 1000);
            },
            
            // --- Common ---
            deleteData: (col, id) => {
                // Custom Confirm Modal
                const html = `
                <div class="bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl transform transition-all scale-100">
                    <div class="text-center">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                            <i data-lucide="alert-triangle" class="text-red-600" size="24"></i>
                        </div>
                        <h3 class="text-lg font-bold text-slate-900 mb-2">삭제 확인</h3>
                        <p class="text-sm text-slate-500 mb-6">정말로 삭제하시겠습니까?<br>이 작업은 되돌릴 수 없습니다.</p>
                        <div class="flex gap-3 justify-center">
                            <button onclick="app.executeDelete('${col}', '${id}')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium shadow-sm">
                                예, 삭제
                            </button>
                            <button onclick="app.closeModal()" class="flex-1 px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 font-medium">
                                아니오
                            </button>
                        </div>
                    </div>
                </div>`;
                showModal(html);
                lucide.createIcons();
            },
            executeDelete: async (col, id) => {
                try {
                    await deleteDoc(doc(db, col, id));
                    closeModal();
                } catch (err) {
                    alert("삭제 실패: " + err.message);
                }
            },
            closeModal: () => closeModal(),
            
            // --- Service Settings & Excel ---
            editService: (id) => {
                state.editingServiceId = id;
                render();
            },
            cancelEditService: () => {
                state.editingServiceId = null;
                render();
            },
            addService: async (e) => {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(e.target));
                try {
                    if (state.editingServiceId) { await updateDoc(doc(db, "services", state.editingServiceId), data); state.editingServiceId = null; alert("서비스가 수정되었습니다."); } 
                    else { await addDoc(collection(db, "services"), data); alert("서비스가 추가되었습니다."); }
                    e.target.reset(); render();
                } catch (err) { alert("오류 발생: " + err.message); }
            },
            downloadTemplate: () => {
                const ws = XLSX.utils.aoa_to_sheet([['이름','성별','생년월일','행정동','연락처','상태']]);
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "양식");
                XLSX.writeFile(wb, "대상자등록양식.xlsx");
            },
            uploadExcel: (input) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const wb = XLSX.read(e.target.result, {type:'binary'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1}).slice(1);
                    json.forEach(async row => {
                        if(row[0]) await addDoc(collection(db,"clients"), {
                            name:String(row[0]), gender:String(row[1]||'남성'), birthDate:String(row[2]||''), region:String(row[3]||'대연동'), 
                            phone:String(row[4]||''), status:String(row[5]||'이용'), careLevel:'일반', createdAt: new Date().toISOString()
                        });
                    });
                    alert("등록이 시작되었습니다. 잠시 후 새로고침 됩니다.");
                };
                reader.readAsBinaryString(input.files[0]);
            },
            downloadStatsExcel: () => {
                const ws = XLSX.utils.json_to_sheet(state.logs.map(l => ({
                    날짜: l.date, 대상자: l.clientName, 서비스: l.serviceName, 내용: l.content
                })));
                const wb = XLSX.utils.book_new(); 
                XLSX.utils.book_append_sheet(wb, ws, "통계");
                XLSX.writeFile(wb, "통계데이터.xlsx");
            },
            downloadLogsExcel: () => {
                const { start, end, search, category, service } = state.filters.log;
                
                // 1. Filter data
                const filtered = state.logs.filter(l => 
                    (!start || l.date >= start) && (!end || l.date <= end) && 
                    (!search || l.clientName.includes(search)) && 
                    (!category || (l.serviceItems && l.serviceItems.some(i => i.category === category))) &&
                    (!service || (l.serviceItems && l.serviceItems.some(i => i.serviceName === service)))
                ).sort((a, b) => new Date(a.date) - new Date(b.date));

                if (filtered.length === 0) {
                    alert("다운로드할 데이터가 없습니다.");
                    return;
                }

                // 2. Flatten data (Log 1 : N Services -> N Rows)
                const excelData = [];

                filtered.forEach(l => {
                    const client = state.clients.find(c => c.id === l.clientId);
                    const baseData = {
                        '날짜': l.date,
                        '대상자명': l.clientName,
                        '생년월일': client ? client.birthDate : '',
                        '관리등급': client ? client.careLevel : '',
                        '제공방법': l.provideMethod || '방문',
                        '제공자': l.provider || '',
                        '진행 내용': l.content
                    };

                    if (l.serviceItems && l.serviceItems.length > 0) {
                        l.serviceItems.forEach(item => {
                            excelData.push({
                                ...baseData,
                                '서비스': item.category,
                                '서비스 상세내용': item.serviceName,
                                '메모': item.detailNote || ''
                            });
                        });
                    } else {
                        excelData.push({
                            ...baseData,
                            '서비스': '',
                            '서비스 상세내용': '',
                            '메모': ''
                        });
                    }
                });

                // 3. Export
                const ws = XLSX.utils.json_to_sheet(excelData);
                ws['!cols'] = [{ wch: 12 }, { wch: 10 }, { wch: 12 }, { wch: 8 }, { wch: 8 }, { wch: 10 }, { wch: 50 }, { wch: 15 }, { wch: 20 }, { wch: 20 }];
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "서비스일지");
                XLSX.writeFile(wb, `서비스일지_${new Date().toISOString().slice(0,10)}.xlsx`);
            },
            
            // --- 인쇄 기능 (Reverted to Stable Table Layout) ---
            printLogs: () => {
                const { start, end, search, category, service } = state.filters.log;
                
                const filtered = state.logs.filter(l => 
                    (!start || l.date >= start) && (!end || l.date <= end) && 
                    (!search || l.clientName.includes(search)) && 
                    (!category || (l.serviceItems && l.serviceItems.some(i => i.category === category))) &&
                    (!service || (l.serviceItems && l.serviceItems.some(i => i.serviceName === service)))
                ).sort((a, b) => new Date(a.date) - new Date(b.date));

                if (filtered.length === 0) {
                    alert("인쇄할 일지가 없습니다.");
                    return;
                }

                const printWindow = window.open('', '', 'width=1100,height=800');
                
                let rowsHTML = '';
                filtered.forEach(l => {
                    const client = state.clients.find(c => c.id === l.clientId);
                    const servicesHTML = l.serviceItems && l.serviceItems.length > 0 
                        ? l.serviceItems.map(i => 
                            `<div>
                                <b>[${i.category}] ${i.serviceName}</b>
                                ${i.detailNote ? `<span style="font-size:0.9em; color:#555;"> - ${i.detailNote}</span>` : ''}
                            </div>`
                        ).join('')
                        : '-';

                    rowsHTML += `
                        <tr>
                            <td style="text-align:center;">${l.date}</td>
                            <td style="text-align:center;">
                                <b>${l.clientName}</b><br>
                                <span style="font-size:0.85em; color:#666;">${client ? calculateAge(client.birthDate)+'세' : ''}</span>
                            </td>
                            <td style="text-align:center;">${l.provideMethod || '방문'}</td>
                            <td style="text-align:center;">${l.provider || ''}</td>
                            <td style="padding:5px;">${servicesHTML}</td>
                            <td style="white-space:pre-wrap; padding:5px;">${l.content}</td>
                        </tr>
                    `;
                });

                const printDocument = `
                    <html>
                    <head>
                        <title>서비스제공 · 과정상담기록지</title>
                        <style>
                            @media print { 
                                body { -webkit-print-color-adjust: exact; font-size: 12px; } 
                                table { page-break-inside: auto; }
                                tr { page-break-inside: avoid; page-break-after: auto; }
                            }
                            body { font-family: "Malgun Gothic", sans-serif; padding: 20px; }
                            h1 { text-align: center; font-size: 20px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #333; }
                            table { width: 100%; border-collapse: collapse; font-size: 12px; }
                            th, td { border: 1px solid #999; padding: 6px; vertical-align: top; }
                            th { background-color: #f0f0f0; text-align: center; font-weight: bold; height: 30px; }
                        </style>
                    </head>
                    <body>
                        <h1>서비스제공 · 과정상담기록지</h1>
                        <table>
                            <thead>
                                <tr>
                                    <th width="90">일자</th>
                                    <th width="80">대상자</th>
                                    <th width="60">방법</th>
                                    <th width="70">제공자</th>
                                    <th width="250">서비스 내용</th>
                                    <th>진행 내용</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rowsHTML}
                            </tbody>
                        </table>
                        <script>
                            window.onload = function() { 
                                setTimeout(function() { window.print(); window.close(); }, 500);
                            }
                        <\/script>
                    </body>
                    </html>
                `;

                printWindow.document.write(printDocument);
                printWindow.document.close();
            }
        };

        // UI Helpers
        function showModal(html) {
            const m = document.getElementById('modal-container');
            m.innerHTML = html; m.classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modal-container').classList.add('hidden'); }
        
        // Dynamic Service Row Renderer
        function renderSvcRow(item) {
            const cats = [...new Set(state.services.map(s => s.category))];
            const div = document.createElement('div');
            div.className = "svc-row flex flex-col sm:flex-row gap-2 mb-2 p-2 border rounded bg-white sm:bg-transparent sm:border-0";
            div.id = `row-${item.id || Date.now()}`;
            div.innerHTML = `
                <select class="cat-sel input-field w-full sm:w-1/4" onchange="app.updateOpts(this)">
                    <option value="">분류</option>${cats.map(c=>`<option value="${c}" ${item.category===c?'selected':''}>${c}</option>`).join('')}
                </select>
                <select class="svc-sel input-field w-full sm:w-1/3"><option value="${item.serviceName}">${item.serviceName||'선택'}</option></select>
                <div class="flex w-full sm:flex-1 gap-2">
                    <input class="det-inp input-field flex-1" placeholder="메모" value="${item.detailNote||''}">
                    <button type="button" onclick="app.removeSvcRow('${div.id.split('-')[1]}')" class="text-red-400 p-1"><i data-lucide="minus-circle"></i></button>
                </div>
            `;
            document.getElementById('svc-container').appendChild(div);
            if(item.category) {
                const sel = div.querySelector('.svc-sel');
                const svcs = state.services.filter(s => s.category === item.category);
                sel.innerHTML = svcs.map(s => `<option value="${s.name}" ${s.name===item.serviceName?'selected':''}>${s.name}</option>`).join('');
            }
            lucide.createIcons();
        }
        app.updateOpts = (el) => {
            const svcs = state.services.filter(s => s.category === el.value);
            el.nextElementSibling.innerHTML = svcs.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        };

        function render() {
            const main = document.getElementById('main-content');
            document.querySelectorAll('.nav-item').forEach(b => {
                if(b.dataset.tab === state.activeTab) { b.classList.add('bg-emerald-600', 'text-white'); b.classList.remove('text-slate-300'); }
                else { b.classList.remove('bg-emerald-600', 'text-white'); b.classList.add('text-slate-300'); }
            });

            if (state.activeTab === 'dashboard') main.innerHTML = renderDashboard();
            else if (state.activeTab === 'clients') main.innerHTML = renderClientManager();
            else if (state.activeTab === 'logs') main.innerHTML = renderLogManager();
            else if (state.activeTab === 'statistics') main.innerHTML = renderStatistics();
            else if (state.activeTab === 'services') main.innerHTML = renderServiceManager();
            lucide.createIcons();
        }

        document.getElementById('mobile-menu-btn').addEventListener('click', () => {
            const s = document.getElementById('sidebar');
            if(s.classList.contains('-translate-x-full')) { s.classList.remove('-translate-x-full'); document.getElementById('sidebar-overlay').classList.remove('hidden'); }
            else { s.classList.add('-translate-x-full'); document.getElementById('sidebar-overlay').classList.add('hidden'); }
        });
        document.getElementById('sidebar-overlay').addEventListener('click', () => { document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('sidebar-overlay').classList.add('hidden'); });

        initDataSync();
    </script>
</body>
</html>
