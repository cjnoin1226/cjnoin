<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>청전광장 - 실시간 공유형 사회복지 시스템</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- SheetJS (Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; }
        .input-field {
            width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; outline: none;
            transition: border-color 0.2s, box-shadow 0.2s; background-color: white; font-size: 0.875rem;
        }
        .input-field:focus { border-color: #10b981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1); }
        .input-field:read-only { background-color: #f8fafc; color: #64748b; cursor: default; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden">

    <!-- Mobile Header -->
    <div class="md:hidden fixed top-0 left-0 right-0 bg-slate-800 text-white p-4 flex justify-between items-center z-50 h-16">
        <h1 class="font-bold flex items-center gap-2 text-lg"><i data-lucide="book-open" class="text-emerald-400"></i> 청전광장 (공유형)</h1>
        <button id="mobile-menu-btn"><i data-lucide="menu"></i></button>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-slate-800 text-white transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 flex flex-col pt-16 md:pt-0">
        <div class="p-6 hidden md:flex items-center justify-between">
            <h1 class="text-xl font-bold flex items-center gap-2"><i data-lucide="book-open" class="text-emerald-400"></i> 청전광장</h1>
        </div>
        <nav class="flex-1 px-4 space-y-2 mt-4 md:mt-0">
            <button onclick="app.setTab('dashboard')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-slate-300 hover:bg-slate-700" data-tab="dashboard"><i data-lucide="layout-dashboard"></i> 홈</button>
            <button onclick="app.setTab('clients')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-slate-300 hover:bg-slate-700" data-tab="clients"><i data-lucide="users"></i> 대상자 관리</button>
            <button onclick="app.setTab('logs')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-slate-300 hover:bg-slate-700" data-tab="logs"><i data-lucide="file-text"></i> 서비스 일지</button>
            <button onclick="app.setTab('statistics')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-slate-300 hover:bg-slate-700" data-tab="statistics"><i data-lucide="bar-chart-2"></i> 통계</button>
            <button onclick="app.setTab('services')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-slate-300 hover:bg-slate-700" data-tab="services"><i data-lucide="settings"></i> 서비스 설정</button>
        </nav>
        <div class="p-4 bg-slate-900 text-xs text-slate-400">
            <div class="flex items-center gap-2 mb-1 text-emerald-400"><i data-lucide="cloud"></i> <span>Firebase 연결됨</span></div>
            <p>데이터가 실시간 공유됩니다.</p>
        </div>
    </aside>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>

    <main class="flex-1 p-4 md:p-8 pt-20 md:pt-8 overflow-y-auto w-full relative" id="main-content">
        <div class="flex items-center justify-center h-full text-slate-400"><div class="animate-spin mr-2"><i data-lucide="loader-2"></i></div>데이터 불러오는 중...</div>
    </main>

    <div id="modal-container" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-overlay p-4"></div>

    <!-- Firebase SDK & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. Firebase Configuration (★중요: 본인의 Firebase 설정으로 채우세요★) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAx1EJ_7kawHTzsNS97ts5FjCaTJRqJTdM",
            authDomain: "cj-base.firebaseapp.com",
            projectId: "cj-base",
            storageBucket: "cj-base.firebasestorage.app",
            messagingSenderId: "518471894886",
            appId: "1:518471894886:web:9befd2e6d922b22edd6aa7"
        };

        // --- 2. Initialize Firebase ---
        let db, auth;
        try {
            const fbApp = initializeApp(firebaseConfig);
            db = getFirestore(fbApp);
            auth = getAuth(fbApp);
            // 자동 익명 로그인
            signInAnonymously(auth).catch(console.error);
        } catch (e) {
            console.error("Firebase 초기화 실패: 설정값을 확인하세요.", e);
            alert("Firebase 설정이 필요합니다. 코드를 열어 firebaseConfig 부분을 수정해주세요.");
        }

        // --- 3. Constants & State ---
        const CONSTANTS = {
            DONG_LIST: ['대연동', '감만동', '우암동', '문현동', '용호동', '용당동'],
            STATUS_LIST: ['이용', '장기부재', '종결'],
            CARE_LEVEL_LIST: ['일반', '중점'],
            ECONOMIC_LIST: ['일반(저소득)', '기초수급', '조건부 기초수급', '차상위'],
            HOUSEHOLD_LIST: ['독거세대', '부부세대', '동거', '자녀동거세대', '조손동거세대']
        };

        const state = {
            activeTab: 'dashboard',
            clients: [],
            services: [],
            logs: [],
            filters: {
                client: { status: '', level: '', region: '', search: '' },
                log: { start: '', end: '', search: '', category: '' },
                stats: { start: new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0], end: new Date().toISOString().split('T')[0], type: 'detail' }
            }
        };

        // --- 4. Helper Functions ---
        function calculateAge(birthDate) {
            if (!birthDate) return 0;
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
            return age;
        }

        // --- 5. Data Sync (Real-time) ---
        function initDataSync() {
            if (!db) return;
            // Clients Sync
            onSnapshot(query(collection(db, "clients"), orderBy("createdAt", "desc")), (snap) => {
                state.clients = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (state.activeTab === 'clients' || state.activeTab === 'dashboard') render();
            });
            // Services Sync
            onSnapshot(collection(db, "services"), (snap) => {
                state.services = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (state.activeTab === 'services' || state.activeTab === 'dashboard') render();
            });
            // Logs Sync
            onSnapshot(query(collection(db, "logs"), orderBy("date", "desc")), (snap) => {
                state.logs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                render(); // Logs affect almost all tabs
            });
        }

        // --- 6. Render Logic ---
        function renderDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const todayLogs = state.logs.filter(l => l.date === today).length;
            const highFocus = state.clients.filter(c => c.careLevel === '중점').length;
            return `
                <div class="space-y-6 animate-fade-in">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-slate-800">홈</h2>
                        <div class="text-sm text-emerald-600 flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>실시간 공유 중</div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                            <div class="p-3 bg-blue-100 text-blue-600 rounded-lg"><i data-lucide="users"></i></div>
                            <div><p class="text-sm text-slate-500">총 대상자</p><p class="text-2xl font-bold text-slate-800">${state.clients.length}명</p></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                            <div class="p-3 bg-emerald-100 text-emerald-600 rounded-lg"><i data-lucide="file-text"></i></div>
                            <div><p class="text-sm text-slate-500">오늘 일지</p><p class="text-2xl font-bold text-slate-800">${todayLogs}건</p></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                            <div class="p-3 bg-purple-100 text-purple-600 rounded-lg"><i data-lucide="settings"></i></div>
                            <div><p class="text-sm text-slate-500">제공 서비스</p><p class="text-2xl font-bold text-slate-800">${state.services.length}개</p></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">최근 활동</h3>
                        <div class="space-y-4">
                        ${state.logs.length === 0 ? '<p class="text-center text-slate-400 py-4">데이터 없음</p>' : state.logs.slice(0,5).map(log => `
                            <div class="flex items-start gap-4 pb-4 border-b last:border-0 p-2 hover:bg-slate-50 rounded">
                                <div class="mt-1 text-slate-500"><i data-lucide="check-circle" size="16"></i></div>
                                <div>
                                    <p class="font-medium text-slate-800"><span class="text-emerald-600 font-bold">${log.clientName}</span>님 - ${log.serviceName}</p>
                                    <p class="text-sm text-slate-500 mt-1">${log.date} | ${log.content.substring(0,40)}...</p>
                                </div>
                            </div>`).join('')}
                        </div>
                    </div>
                </div>`;
        }

        function renderClientManager() {
            const { search, status, level, region } = state.filters.client;
            const filtered = state.clients.filter(c => 
                (!search || c.name.includes(search)) &&
                (!status || c.status === status) &&
                (!level || c.careLevel === level) &&
                (!region || c.region === region)
            );

            return `
                <div class="space-y-6 animate-fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-2">
                        <h2 class="text-2xl font-bold text-slate-800">대상자 관리</h2>
                        <div class="flex gap-2">
                            <button onclick="app.downloadTemplate()" class="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-sm flex items-center gap-1"><i data-lucide="download" size="14"></i> 양식</button>
                            <label class="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-sm flex items-center gap-1 cursor-pointer"><i data-lucide="upload" size="14"></i> 엑셀등록<input type="file" class="hidden" onchange="app.uploadExcel(this)"></label>
                            <button onclick="app.openClientModal()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg flex items-center gap-1"><i data-lucide="plus" size="16"></i> 등록</button>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm flex flex-wrap gap-2 items-center">
                        <div class="flex items-center gap-1 text-slate-600 font-bold text-sm mr-2"><i data-lucide="filter" size="14"></i> 필터</div>
                        <input class="input-field py-1.5 text-sm w-32" placeholder="이름" value="${search}" oninput="app.setFilter('client','search',this.value)">
                        <select class="input-field py-1.5 text-sm w-32" onchange="app.setFilter('client','status',this.value)"><option value="">상태(전체)</option>${CONSTANTS.STATUS_LIST.map(s=>`<option value="${s}" ${status===s?'selected':''}>${s}</option>`).join('')}</select>
                        <select class="input-field py-1.5 text-sm w-32" onchange="app.setFilter('client','region',this.value)"><option value="">동(전체)</option>${CONSTANTS.DONG_LIST.map(d=>`<option value="${d}" ${region===d?'selected':''}>${d}</option>`).join('')}</select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${filtered.map(c => `
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 relative group hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-2">
                                <div class="font-bold text-lg">${c.name} <span class="text-sm font-normal text-slate-500">(${calculateAge(c.birthDate)}세/${c.gender})</span></div>
                                <div class="flex gap-1">
                                    <button onclick="app.openClientModal('${c.id}')" class="text-slate-300 hover:text-blue-500"><i data-lucide="edit" size="16"></i></button>
                                    <button onclick="app.deleteData('clients','${c.id}')" class="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" size="16"></i></button>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-1 mb-3">
                                <span class="bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded">${c.region}</span>
                                <span class="${c.careLevel==='중점'?'bg-pink-100 text-pink-700':'bg-blue-100 text-blue-700'} text-xs px-2 py-1 rounded">${c.careLevel}</span>
                                <span class="${c.status==='이용'?'bg-green-100 text-green-700':'bg-slate-100 text-slate-500'} text-xs px-2 py-1 rounded">${c.status}</span>
                            </div>
                            <div class="text-sm text-slate-600 space-y-1">
                                <p class="flex items-center gap-2"><i data-lucide="phone" size="14"></i> ${c.phone||'-'}</p>
                                <p class="flex items-center gap-2"><i data-lucide="home" size="14"></i> ${c.address||'-'}</p>
                            </div>
                        </div>`).join('')}
                    </div>
                </div>`;
        }

        function renderLogManager() {
            const { start, end, search, category } = state.filters.log;
            const filtered = state.logs.filter(l => 
                (!start || l.date >= start) && (!end || l.date <= end) && (!search || l.clientName.includes(search)) && 
                (!category || (l.serviceItems && l.serviceItems.some(i => i.category === category)))
            );
            const categories = [...new Set(state.services.map(s => s.category))];

            return `
                <div class="space-y-6 animate-fade-in">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-slate-800">서비스 일지</h2>
                        <button onclick="app.openLogModal()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg flex items-center gap-2"><i data-lucide="plus" size="16"></i> 작성</button>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm flex flex-wrap gap-2 items-center">
                        <input type="date" class="input-field py-1.5 w-32" value="${start}" onchange="app.setFilter('log','start',this.value)">
                        <span class="text-slate-400">~</span>
                        <input type="date" class="input-field py-1.5 w-32" value="${end}" onchange="app.setFilter('log','end',this.value)">
                        <input class="input-field py-1.5 w-32" placeholder="이름" value="${search}" oninput="app.setFilter('log','search',this.value)">
                        <select class="input-field py-1.5 w-32" onchange="app.setFilter('log','category',this.value)"><option value="">서비스(전체)</option>${categories.map(c=>`<option value="${c}" ${category===c?'selected':''}>${c}</option>`).join('')}</select>
                    </div>
                    <div class="space-y-4">
                        ${filtered.map(l => {
                            const c = state.clients.find(cl => cl.id === l.clientId);
                            return `
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col md:flex-row gap-4">
                                <div class="md:w-48 border-r border-slate-100 pr-4">
                                    <div class="text-sm text-slate-500">${l.date}</div>
                                    <div class="font-bold text-lg">${l.clientName}</div>
                                    <div class="text-xs text-slate-500">${c ? `${calculateAge(c.birthDate)}세 | ${c.careLevel}` : ''}</div>
                                    <div class="mt-2 flex flex-wrap gap-1">
                                        ${l.serviceItems ? l.serviceItems.map(i => `<span class="bg-emerald-50 text-emerald-700 text-xs px-2 py-1 rounded">${i.serviceName}</span>`).join('') : ''}
                                    </div>
                                </div>
                                <div class="flex-1 relative">
                                    <div class="absolute top-0 right-0 flex gap-1">
                                        <button onclick="app.duplicateLog('${l.id}')" class="p-1 text-slate-300 hover:text-emerald-500"><i data-lucide="copy" size="16"></i></button>
                                        <button onclick="app.openLogModal('${l.id}')" class="p-1 text-slate-300 hover:text-blue-500"><i data-lucide="edit" size="16"></i></button>
                                        <button onclick="app.deleteData('logs','${l.id}')" class="p-1 text-slate-300 hover:text-red-500"><i data-lucide="trash-2" size="16"></i></button>
                                    </div>
                                    <p class="text-slate-600 whitespace-pre-wrap mt-6 md:mt-0">${l.content}</p>
                                </div>
                            </div>`
                        }).join('')}
                    </div>
                </div>`;
        }

        // --- 7. Modal & Form Logic ---
        window.app = {
            setTab: (t) => { state.activeTab = t; render(); document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('sidebar-overlay').classList.add('hidden'); },
            setFilter: (s, k, v) => { state.filters[s][k] = v; render(); },
            
            // --- Client Modal ---
            openClientModal: (id) => {
                const c = id ? state.clients.find(x => x.id === id) : {};
                const html = `
                <div class="bg-white w-full max-w-4xl p-6 rounded-xl shadow-xl max-h-[90vh] overflow-y-auto">
                    <h3 class="font-bold text-lg mb-4">${c.id ? '수정' : '등록'}</h3>
                    <form onsubmit="app.saveClient(event, '${c.id || ''}')" class="space-y-4">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div><label class="text-sm">이름</label><input name="name" class="input-field" value="${c.name||''}" required></div>
                            <div><label class="text-sm">성별</label><select name="gender" class="input-field"><option value="남성">남성</option><option value="여성" ${c.gender==='여성'?'selected':''}>여성</option></select></div>
                            <div><label class="text-sm">생년월일</label><input type="date" name="birthDate" class="input-field" value="${c.birthDate||''}"></div>
                            <div><label class="text-sm">상태</label><select name="status" class="input-field">${CONSTANTS.STATUS_LIST.map(s=>`<option value="${s}" ${c.status===s?'selected':''}>${s}</option>`).join('')}</select></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-sm">연락처</label><input name="phone" class="input-field" value="${c.phone||''}"></div>
                            <div><label class="text-sm">보호자 연락처</label><div class="flex gap-2"><input name="guardianRelation" class="input-field w-20" placeholder="관계" value="${c.guardianRelation||''}"><input name="guardianPhone" class="input-field flex-1" placeholder="번호" value="${c.guardianPhone||''}"></div></div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div><label class="text-sm">행정동</label><select name="region" class="input-field">${CONSTANTS.DONG_LIST.map(d=>`<option value="${d}" ${c.region===d?'selected':''}>${d}</option>`).join('')}</select></div>
                            <div class="col-span-3"><label class="text-sm">주소</label><input name="address" class="input-field" value="${c.address||''}"></div>
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <div><label class="text-sm">등급</label><select name="careLevel" class="input-field">${CONSTANTS.CARE_LEVEL_LIST.map(v=>`<option value="${v}" ${c.careLevel===v?'selected':''}>${v}</option>`).join('')}</select></div>
                            <div><label class="text-sm">경제상황</label><select name="economicStatus" class="input-field">${CONSTANTS.ECONOMIC_LIST.map(v=>`<option value="${v}" ${c.economicStatus===v?'selected':''}>${v}</option>`).join('')}</select></div>
                            <div><label class="text-sm">세대유형</label><select name="householdType" class="input-field">${CONSTANTS.HOUSEHOLD_LIST.map(v=>`<option value="${v}" ${c.householdType===v?'selected':''}>${v}</option>`).join('')}</select></div>
                        </div>
                         <div class="grid grid-cols-3 gap-4">
                            <div><label class="text-sm">시작일</label><input type="date" name="serviceStartDate" class="input-field" value="${c.serviceStartDate||''}"></div>
                            <div><label class="text-sm">부재기간</label><input name="absencePeriod" class="input-field" value="${c.absencePeriod||''}"></div>
                            <div><label class="text-sm">종결일</label><input type="date" name="endDate" class="input-field" value="${c.endDate||''}"></div>
                        </div>
                        <div><label class="text-sm">비고</label><textarea name="note" class="input-field" rows="2">${c.note||''}</textarea></div>
                        <div class="flex justify-end gap-2 pt-2"><button type="button" onclick="app.closeModal()" class="px-4 py-2 text-slate-600">취소</button><button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded-lg">저장</button></div>
                    </form>
                </div>`;
                showModal(html);
            },
            
            saveClient: async (e, id) => {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(e.target));
                data.createdAt = new Date().toISOString();
                try {
                    if (id) await updateDoc(doc(db, "clients", id), data);
                    else await addDoc(collection(db, "clients"), data);
                    closeModal();
                } catch(err) { alert("저장 실패: " + err.message); }
            },

            // --- Log Modal ---
            openLogModal: (id) => {
                const l = id ? state.logs.find(x => x.id === id) : { date: new Date().toISOString().split('T')[0], serviceItems: [{id: Date.now(), category:'', serviceName:'', detailNote:''}] };
                const c = state.clients.find(x => x.name === l.clientName) || {};
                
                // 전역 임시 저장 (서비스 항목)
                window.tempServiceItems = l.serviceItems || [{id: Date.now(), category:'', serviceName:'', detailNote:''}];

                const html = `
                <div class="bg-white w-full max-w-4xl p-6 rounded-xl shadow-xl max-h-[90vh] overflow-y-auto">
                    <h3 class="font-bold text-lg mb-4">${l.id ? '수정' : '작성'}</h3>
                    <form onsubmit="app.saveLog(event, '${l.id || ''}')" class="space-y-4">
                        <div class="grid grid-cols-4 gap-4 bg-slate-50 p-4 rounded">
                            <div><label class="text-sm">날짜</label><input type="date" name="date" class="input-field" value="${l.date}" required></div>
                            <div><label class="text-sm">대상자</label><input list="cl-list" name="clientName" class="input-field" value="${l.clientName||''}" required onchange="app.fillClientInfo(this)"><datalist id="cl-list">${state.clients.map(c=>`<option value="${c.name}">`).join('')}</datalist></div>
                            <div class="col-span-2 flex gap-2">
                                <input id="d-birth" class="input-field" readonly value="${c.birthDate||''}" placeholder="생년월일">
                                <input id="d-region" class="input-field" readonly value="${c.region||''}" placeholder="행정동">
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-2"><label class="font-bold text-sm">서비스 (최대 6개)</label><button type="button" onclick="app.addSvcRow()" class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded">추가</button></div>
                            <div id="svc-container" class="space-y-2"></div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1"><label class="text-sm">내용</label><button type="button" onclick="app.aiDraft()" class="text-xs bg-purple-100 text-purple-700 px-2 rounded">AI 다듬기</button></div>
                            <textarea id="log-content" name="content" class="input-field h-32" required>${l.content||''}</textarea>
                        </div>
                        <div class="flex justify-end gap-2"><button type="button" onclick="app.closeModal()" class="px-4 py-2 text-slate-600">취소</button><button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded-lg">저장</button></div>
                    </form>
                </div>`;
                showModal(html);
                window.tempServiceItems.forEach(item => renderSvcRow(item));
            },

            fillClientInfo: (input) => {
                const c = state.clients.find(x => x.name === input.value);
                if(c) {
                    document.getElementById('d-birth').value = c.birthDate;
                    document.getElementById('d-region').value = c.region;
                }
            },
            addSvcRow: () => {
                if(document.querySelectorAll('.svc-row').length >= 6) return alert('최대 6개까지입니다.');
                renderSvcRow({id: Date.now(), category:'', serviceName:'', detailNote:''});
            },
            removeSvcRow: (id) => document.getElementById(`row-${id}`).remove(),
            
            saveLog: async (e, id) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const cName = fd.get('clientName');
                const client = state.clients.find(x => x.name === cName);
                
                // DOM에서 서비스 항목 수집
                const items = Array.from(document.querySelectorAll('.svc-row')).map(row => ({
                    category: row.querySelector('.cat-sel').value,
                    serviceName: row.querySelector('.svc-sel').value,
                    detailNote: row.querySelector('.det-inp').value
                })).filter(i => i.serviceName);

                if(items.length === 0) return alert('서비스를 하나 이상 선택하세요.');

                const data = {
                    date: fd.get('date'),
                    clientName: cName,
                    clientId: client ? client.id : 'unknown',
                    content: fd.get('content'),
                    serviceItems: items,
                    serviceName: items.map(i=>i.serviceName).join(', ') // 대표 표시용
                };

                try {
                    if (id) await updateDoc(doc(db, "logs", id), data);
                    else await addDoc(collection(db, "logs"), data);
                    closeModal();
                } catch(err) { alert("저장 실패: " + err.message); }
            },
            duplicateLog: async (id) => {
                const l = state.logs.find(x => x.id === id);
                if(l) {
                    const { id, ...data } = l; // ID 제외 복사
                    data.date = new Date().toISOString().split('T')[0];
                    await addDoc(collection(db, "logs"), data);
                }
            },
            aiDraft: () => {
                const t = document.getElementById('log-content');
                if(!t.value) return alert('내용을 입력하세요');
                t.value = "AI 분석 중...";
                setTimeout(() => { t.value = "[AI] 대상자 안부 확인 및 물품 전달 완료. 건강 상태 양호함."; }, 1000);
            },
            
            // --- Common ---
            deleteData: async (col, id) => {
                if(confirm('삭제하시겠습니까? (복구 불가)')) await deleteDoc(doc(db, col, id));
            },
            closeModal: () => closeModal(),
            
            // --- Service Settings & Excel ---
            addService: async (e) => {
                e.preventDefault();
                await addDoc(collection(db, "services"), Object.fromEntries(new FormData(e.target)));
                e.target.reset();
            },
            downloadTemplate: () => {
                const ws = XLSX.utils.aoa_to_sheet([['이름','성별','생년월일','행정동','연락처','상태']]);
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "양식");
                XLSX.writeFile(wb, "대상자등록양식.xlsx");
            },
            uploadExcel: (input) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const wb = XLSX.read(e.target.result, {type:'binary'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1}).slice(1);
                    json.forEach(async row => {
                        if(row[0]) await addDoc(collection(db,"clients"), {
                            name:String(row[0]), gender:String(row[1]||'남성'), birthDate:String(row[2]||''), region:String(row[3]||'대연동'), 
                            phone:String(row[4]||''), status:String(row[5]||'이용'), careLevel:'일반', createdAt: new Date().toISOString()
                        });
                    });
                    alert("등록이 시작되었습니다. 잠시 후 새로고침 됩니다.");
                };
                reader.readAsBinaryString(input.files[0]);
            }
        };

        // UI Helpers
        function showModal(html) {
            const m = document.getElementById('modal-container');
            m.innerHTML = html; m.classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modal-container').classList.add('hidden'); }
        
        // Dynamic Service Row Renderer
        function renderSvcRow(item) {
            const cats = [...new Set(state.services.map(s => s.category))];
            const div = document.createElement('div');
            div.className = "svc-row flex gap-2 mb-2";
            div.id = `row-${item.id || Date.now()}`;
            div.innerHTML = `
                <select class="cat-sel input-field w-1/3" onchange="app.updateOpts(this)">
                    <option value="">분류</option>${cats.map(c=>`<option value="${c}" ${item.category===c?'selected':''}>${c}</option>`).join('')}
                </select>
                <select class="svc-sel input-field w-1/3"><option value="${item.serviceName}">${item.serviceName||'선택'}</option></select>
                <input class="det-inp input-field flex-1" placeholder="메모" value="${item.detailNote||''}">
                <button type="button" onclick="app.removeSvcRow('${div.id.split('-')[1]}')" class="text-red-400"><i data-lucide="minus-circle"></i></button>
            `;
            document.getElementById('svc-container').appendChild(div);
            // Trigger option update if category exists
            if(item.category) {
                const sel = div.querySelector('.svc-sel');
                const svcs = state.services.filter(s => s.category === item.category);
                sel.innerHTML = svcs.map(s => `<option value="${s.name}" ${s.name===item.serviceName?'selected':''}>${s.name}</option>`).join('');
            }
            lucide.createIcons();
        }
        app.updateOpts = (el) => {
            const svcs = state.services.filter(s => s.category === el.value);
            el.nextElementSibling.innerHTML = svcs.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        };

        // Render Functions
        function render() {
            const main = document.getElementById('main-content');
            document.querySelectorAll('.nav-item').forEach(b => {
                if(b.dataset.tab === state.activeTab) { b.classList.add('bg-emerald-600', 'text-white'); b.classList.remove('text-slate-300'); }
                else { b.classList.remove('bg-emerald-600', 'text-white'); b.classList.add('text-slate-300'); }
            });

            if (state.activeTab === 'dashboard') main.innerHTML = renderDashboard();
            else if (state.activeTab === 'clients') main.innerHTML = renderClientManager();
            else if (state.activeTab === 'logs') main.innerHTML = renderLogManager();
            else if (state.activeTab === 'services') {
                main.innerHTML = `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold">서비스 설정</h2>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <form onsubmit="app.addService(event)" class="flex gap-4 items-end">
                            <div><label class="text-sm">대분류</label><input name="majorCategory" class="input-field" placeholder="위기관리"></div>
                            <div><label class="text-sm">분류</label><input name="category" class="input-field" placeholder="사례관리" required></div>
                            <div><label class="text-sm">서비스명</label><input name="name" class="input-field" placeholder="상담" required></div>
                            <div class="flex-1"><label class="text-sm">예시</label><input name="example" class="input-field" placeholder="방문"></div>
                            <button class="bg-slate-800 text-white px-4 py-2 rounded">추가</button>
                        </form>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50"><tr><th class="p-2">분류</th><th class="p-2">서비스명</th><th class="p-2">예시</th><th class="p-2">삭제</th></tr></thead>
                            <tbody>${state.services.map(s=>`<tr class="border-t"><td class="p-2">${s.category}</td><td class="p-2 font-bold">${s.name}</td><td class="p-2 text-sm">${s.example||''}</td><td class="p-2"><button onclick="app.deleteData('services','${s.id}')" class="text-red-400"><i data-lucide="trash-2" size="16"></i></button></td></tr>`).join('')}</tbody>
                        </table>
                    </div>
                </div>`;
            } else if (state.activeTab === 'statistics') {
                // Simple Stats View
                main.innerHTML = `<div class="p-12 text-center text-slate-500">통계 기능 준비 중... (엑셀 다운로드는 가능)</div>`;
            }
            lucide.createIcons();
        }

        // --- Init ---
        // 모바일 메뉴
        document.getElementById('mobile-menu-btn').addEventListener('click', () => {
            const s = document.getElementById('sidebar');
            if(s.classList.contains('-translate-x-full')) { s.classList.remove('-translate-x-full'); document.getElementById('sidebar-overlay').classList.remove('hidden'); }
            else { s.classList.add('-translate-x-full'); document.getElementById('sidebar-overlay').classList.add('hidden'); }
        });
        document.getElementById('sidebar-overlay').addEventListener('click', () => { document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('sidebar-overlay').classList.add('hidden'); });

        // Start
        initDataSync();
    </script>
</body>
</html>
