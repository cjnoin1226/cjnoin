<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>청전광장 - 사회복지 통합 관리 시스템</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .input-field {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .input-field:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1);
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out forwards;
        }
        /* Sticky table header and column fix */
        .sticky-left {
            position: sticky;
            left: 0;
            z-index: 5;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col md:flex-row font-sans overflow-hidden">
    <!-- Main Application Mount Point -->
    <div id="app" class="flex-1 flex flex-col md:flex-row">
        <div id="sidebar-container"></div>
        <main class="flex-1 p-4 md:p-8 overflow-y-auto overflow-x-auto">
            <div id="content-container" class="max-w-5xl mx-auto">
                <div class="min-h-screen flex flex-col items-center justify-center text-slate-400">
                    <svg class="animate-spin mb-4 text-emerald-600" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 1-9 9 9 9 0 0 1-9-9 9 9 0 0 1 9-9c1.956 0 3.829.746 5.244 2.158"></path></svg>
                    <p>데이터 및 시스템을 초기화하는 중입니다...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals Container -->
    <div id="modal-container"></div>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Firebase SDKs (ES Module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Constants & Global Setup ---
        const DONG_LIST = ['대연동', '감만동', '우암동', '문현동', '용호동', '용당동'];
        const GENDER_LIST = ['남성', '여성'];
        const STATUS_LIST = ['이용', '장기부재', '종결'];
        const CARE_LEVEL_LIST = ['일반', '중점'];
        const ECONOMIC_LIST = ['일반(저소득)', '기초수급', '조건부 기초수급', '차상위'];
        const HOUSEHOLD_LIST = ['독거세대', '부부세대', '동거', '자녀동거세대', '조손동거세대'];
        const PROVIDE_METHOD_LIST = ['전화', '방문', '내방'];

        const SAMPLE_SERVICES = [
            { name: '민관협의체구성', category: '사례관리', majorCategory: '위기관리 체계구축', example: '지역사회보장협의체 회의 참석' },
            { name: '초기상담', category: '사례관리', majorCategory: '욕구기반 위기관리', example: '가정방문 및 욕구조사' },
            { name: '긴급 생계비 지원', category: '경제적 위기관리', majorCategory: '욕구기반 위기관리', example: '긴급복지 생계비 연계' },
            { name: '급식지원', category: '긴급지원', majorCategory: '위기상황 관리 및 긴급지원', example: '도시락 배달, 경로식당 이용' },
            { name: '법률 상담 및 동행', category: '권리옹호', majorCategory: '위기관리 체계구축', example: '무료법률구조공단 동행' },
        ];
        
        // --- Global State ---
        let state = {
            user: null,
            userId: null,
            activeTab: 'dashboard',
            sidebarOpen: false,
            targetLogId: null,
            
            // Data States
            clients: [],
            services: [],
            logs: [],
            isLoading: true,
            
            // Log Manager Form State (Complex, moved to logManagerContext)
            logManagerContext: {
                showForm: false,
                editingLogId: null,
                isDrafting: false,
                newLog: {
                    clientId: '', clientName: '', date: new Date().toISOString().split('T')[0],
                    provider: '', provideMethod: '', content: '',
                    serviceItems: [{ id: Date.now(), category: '', serviceId: '', serviceName: '', detailNote: '' }]
                },
                isClientDropdownOpen: false,
                filterStartDate: '', filterEndDate: '', searchTerm: '', filterCategory: '', filterService: '',
                sortedClients: [],
                allCategories: [],
                servicesInFilteredCategory: [],
            },

            // Client Manager Form/Modal State
            clientManagerContext: {
                showForm: false,
                editingClientId: null,
                newClient: {},
                selectedClient: null,
                aiRecommendation: '',
                isAiLoading: false,
                filterStatus: '', filterCareLevel: '', filterRegion: '', filterGender: '', clientSearchTerm: '',
            },

            // Statistics Manager State
            statsManagerContext: {
                startDate: new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0],
                endDate: new Date().toISOString().split('T')[0],
                viewType: 'detail', // 'detail' or 'category'
                filterName: '',
                filterRegion: '',
                // Memoized data will be calculated dynamically
            }
        };

        // --- Firebase Setup ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const basePath = ['artifacts', appId, 'public', 'data'];
        
        // --- Utility Functions ---
        const callGemini = async (prompt) => {
            const apiKey = ""; 
            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                    }
                );

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "응답을 생성할 수 없습니다.";
            } catch (error) {
                console.error("Gemini API Error:", error);
                return "AI 서비스 연결 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.";
            }
        };

        const calculateAge = (birthDate) => {
            if (!birthDate) return 0;
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        };

        const getStatusColor = (status) => {
            if (STATUS_LIST.includes(status)) {
                switch(status) {
                    case '이용': return 'bg-green-100 text-green-700';
                    case '장기부재': return 'bg-orange-100 text-orange-700';
                    case '종결': return 'bg-slate-100 text-slate-500';
                    default: return 'bg-slate-100 text-slate-600';
                }
            }
            return 'bg-purple-100 text-purple-700'; 
        };

        const getCareLevelStyle = (level) => {
            if (level === '중점') return 'bg-pink-100 text-pink-700';
            if (level === '일반') return 'bg-blue-100 text-blue-700';
            return 'bg-indigo-50 text-indigo-700';
        };

        // DOM Helper: Create Icon
        const createIcon = (name, size = 20, className = '') => {
            const icon = lucide.createIcons()[name];
            if (!icon) return '';
            return `<svg class="${className}" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${icon}</svg>`;
        };

        // DOM Helper: Render Select with Other Input
        const renderSelectWithOtherHTML = (idPrefix, value, options, placeholder = "직접 입력") => {
            const isCustom = value && value !== '기타' && !options.includes(value);
            const selectValue = (value === '기타' || isCustom) ? '기타' : value;

            return `
                <div class="flex gap-1 w-full">
                    <select
                        id="${idPrefix}-select"
                        data-target="${idPrefix}-input"
                        class="input-field transition-all ${selectValue === '기타' ? '!w-24 flex-none' : 'w-full'}"
                        onchange="handleSelectWithOtherChange(this, '${idPrefix}')"
                    >
                        <option value="" disabled>선택</option>
                        ${options.map(opt => `<option value="${opt}" ${selectValue === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                        <option value="기타" ${selectValue === '기타' ? 'selected' : ''}>기타</option>
                    </select>
                    <input
                        type="text"
                        id="${idPrefix}-input"
                        class="input-field flex-1 ${selectValue === '기타' ? '' : 'hidden'}"
                        value="${selectValue === '기타' ? (isCustom ? value : '') : ''}"
                        oninput="handleOtherInputChange(this, '${idPrefix}')"
                        placeholder="${placeholder}"
                    />
                </div>
            `;
        };

        // Global function for SelectWithOther logic
        window.handleSelectWithOtherChange = (selectElement, idPrefix) => {
            const customInput = document.getElementById(`${idPrefix}-input`);
            const target = customInput ? customInput.getAttribute('data-target') : null;
            const event = new Event('input', { bubbles: true });

            if (selectElement.value === '기타') {
                if (customInput) {
                    customInput.classList.remove('hidden');
                    customInput.value = '';
                    customInput.focus();
                }
                // Trigger input change for '기타' to be set initially
                document.getElementById(idPrefix).value = '기타';
                document.getElementById(idPrefix).dispatchEvent(event);
            } else {
                if (customInput) {
                    customInput.classList.add('hidden');
                }
                document.getElementById(idPrefix).value = selectElement.value;
                document.getElementById(idPrefix).dispatchEvent(event);
            }
        };

        window.handleOtherInputChange = (inputElement, idPrefix) => {
            const hiddenInput = document.getElementById(idPrefix);
            hiddenInput.value = inputElement.value;
            hiddenInput.dispatchEvent(new Event('input', { bubbles: true }));
        };

        // --- State Update Function (replaces React's useState) ---
        const updateState = (newState) => {
            Object.assign(state, newState);
            renderApp(); // Re-render the application after state change
        };

        // --- CRUD Operations ---
        const addClient = async (client) => {
            await addDoc(collection(db, ...basePath, 'clients'), { ...client, createdAt: new Date().toISOString() });
        };
        const updateClient = async (id, updatedData) => {
            await updateDoc(doc(db, ...basePath, 'clients', id), updatedData);
        };
        const deleteClient = async (id) => {
            await deleteDoc(doc(db, ...basePath, 'clients', id));
        };
        const addService = async (service) => {
            await addDoc(collection(db, ...basePath, 'services'), service);
        };
        const deleteService = async (id) => {
            await deleteDoc(doc(db, ...basePath, 'services', id));
        };
        const addLog = async (log) => {
            await addDoc(collection(db, ...basePath, 'logs'), { ...log, timestamp: new Date().toISOString() });
        };
        const updateLog = async (id, updatedLog) => {
            await updateDoc(doc(db, ...basePath, 'logs', id), { ...updatedLog, timestamp: new Date().toISOString() });
        };
        const deleteLog = async (id) => {
            await deleteDoc(doc(db, ...basePath, 'logs', id));
        };
        const loadSampleData = async () => {
            if (state.services.length > 0) return; 
            SAMPLE_SERVICES.forEach(s => addService(s));
        };

        // --- Component Render Functions ---

        // 1. Sidebar
        const renderSidebar = () => {
            const items = [
                { id: 'dashboard', label: '홈', icon: 'LayoutDashboard' },
                { id: 'clients', label: '대상자 관리', icon: 'Users' },
                { id: 'logs', label: '서비스 일지', icon: 'FileText' },
                { id: 'statistics', label: '통계', icon: 'BarChart2' },
                { id: 'services', label: '서비스 목록 설정', icon: 'Settings' },
            ];
            
            const content = `
                <div class="fixed inset-y-0 left-0 z-50 w-64 bg-slate-800 text-white transform transition-transform duration-300 ease-in-out ${state.sidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 flex flex-col flex-shrink-0">
                    <div class="p-6 flex items-center justify-between">
                        <h1 class="text-xl font-bold flex items-center gap-2">
                            ${createIcon('BookOpen', 24, 'text-emerald-400')}
                            청전광장
                        </h1>
                        <button onclick="updateState({ sidebarOpen: false })" class="md:hidden text-slate-400 hover:text-white">
                            ${createIcon('X', 24)}
                        </button>
                    </div>
                    
                    <nav class="flex-1 px-4 space-y-2">
                        ${items.map(item => `
                            <button
                                onclick="updateState({ activeTab: '${item.id}', sidebarOpen: false })"
                                class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${state.activeTab === item.id ? 'bg-emerald-600 text-white' : 'text-slate-300 hover:bg-slate-700'}"
                            >
                                ${createIcon(item.icon, 20)}
                                ${item.label}
                            </button>
                        `).join('')}
                    </nav>
                    
                    <div class="p-4 bg-slate-900 text-xs text-slate-400">
                        <div class="flex items-center gap-2 mb-1 text-emerald-400">
                            ${createIcon('Cloud', 12)}
                            <span>실시간 데이터 동기화 중</span>
                        </div>
                        <p>사회복지 통합관리 시스템 v2.1</p>
                    </div>
                </div>
            `;
            document.getElementById('sidebar-container').innerHTML = content;
        };
        
        // 2. Dashboard
        const renderDashboard = () => {
            const todayLogs = state.logs.filter(l => l.date === new Date().toISOString().split('T')[0]).length;
            const highFocusCount = state.clients.filter(c => c.careLevel === '중점').length;
            const generalCount = state.clients.filter(c => c.careLevel === '일반').length;

            const content = `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-slate-800">홈</h2>
                        <div class="text-sm text-slate-500 flex items-center gap-1">
                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                            실시간 연결됨
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                            <div class="p-3 bg-blue-100 text-blue-600 rounded-lg">${createIcon('Users', 24)}</div>
                            <div>
                                <p class="text-sm text-slate-500">총 대상자</p>
                                <div class="flex items-baseline gap-2">
                                    <p class="text-2xl font-bold text-slate-800">${state.clients.length}명</p>
                                </div>
                                <p class="text-xs text-slate-400 mt-1">
                                    (중점: <span class="font-medium text-pink-600">${highFocusCount}</span>명 / 
                                    일반: <span class="font-medium text-blue-600">${generalCount}</span>명)
                                </p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                            <div class="p-3 bg-emerald-100 text-emerald-600 rounded-lg">${createIcon('FileText', 24)}</div>
                            <div>
                                <p class="text-sm text-slate-500">오늘 작성된 일지</p>
                                <p class="text-2xl font-bold text-slate-800">${todayLogs}건</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                            <div class="p-3 bg-purple-100 text-purple-600 rounded-lg">${createIcon('Settings', 24)}</div>
                            <div>
                                <p class="text-sm text-slate-500">제공 가능 서비스</p>
                                <p class="text-2xl font-bold text-slate-800">${state.services.length}개</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">최근 활동 기록</h3>
                        ${state.logs.length === 0 ? `
                            <p class="text-slate-400 text-center py-4">아직 기록된 활동이 없습니다.</p>
                        ` : `
                            <div class="space-y-4">
                                ${state.logs.slice(0, 5).map(log => `
                                    <div 
                                        onclick="updateState({ targetLogId: '${log.id}', activeTab: 'logs' })"
                                        class="flex items-start gap-4 pb-4 border-b last:border-0 last:pb-0 border-slate-100 cursor-pointer hover:bg-slate-50 rounded p-2 transition-colors"
                                    >
                                        <div class="mt-1 p-2 bg-slate-100 rounded-full text-slate-500">${createIcon('CheckCircle', 16)}</div>
                                        <div>
                                            <p class="font-medium text-slate-800">
                                                <span class="text-emerald-600 font-bold">${log.clientName || ''}</span>님에게 
                                                <span class="bg-slate-100 px-2 py-0.5 rounded mx-2 text-sm">${log.serviceName || ''}</span>
                                                서비스를 제공했습니다.
                                            </p>
                                            <p class="text-sm text-slate-500 mt-1">${log.date || ''} | ${String(log.content || '').substring(0, 50)}...</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
            document.getElementById('content-container').innerHTML = content;
        };
        
        // 3. Client Manager
        const renderClientManager = () => {
            const context = state.clientManagerContext;
            
            // --- Logic Functions (inside render to access state) ---

            const handleNewClientChange = (key, value) => {
                const newClient = { ...context.newClient, [key]: value };
                updateState({ clientManagerContext: { ...context, newClient } });
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                const client = context.newClient;
                if (!client.name) return;

                const dialogContainer = document.getElementById('modal-container');
                dialogContainer.innerHTML = ''; // Close existing modal if any

                if (context.editingClientId) {
                    await updateClient(context.editingClientId, client);
                    alert("대상자 정보가 수정되었습니다.");
                } else {
                    await addClient(client);
                    alert("새 대상자가 등록되었습니다.");
                }

                updateState({ clientManagerContext: { 
                    ...context,
                    editingClientId: null,
                    showForm: false,
                    newClient: {
                        name: '', birthDate: '', gender: '남성', region: '대연동',
                        careLevel: '일반', economicStatus: '일반(저소득)', householdType: '독거세대', status: '이용', address: '', phone: '',
                        guardianRelation: '', guardianPhone: '', serviceStartDate: '', absencePeriod: '', endDate: '', note: ''
                    }
                }});
            };
            
            window.startEditClient = (clientId) => {
                const client = state.clients.find(c => c.id === clientId);
                if (!client) return;
                updateState({ clientManagerContext: {
                    ...context,
                    editingClientId: clientId,
                    newClient: {
                        name: client.name || '', birthDate: client.birthDate || '', gender: client.gender || '남성', region: client.region || '대연동',
                        careLevel: client.careLevel || '일반', economicStatus: client.economicStatus || '일반(저소득)', householdType: client.householdType || '독거세대',
                        status: client.status || '이용', address: client.address || '', phone: client.phone || '',
                        guardianRelation: client.guardianRelation || '', guardianPhone: client.guardianPhone || '',
                        serviceStartDate: client.serviceStartDate || '', absencePeriod: client.absencePeriod || '', endDate: client.endDate || '', note: client.note || ''
                    },
                    showForm: true,
                }});
            };

            window.handleDownloadTemplate = () => {
                if (typeof XLSX === 'undefined') { alert('엑셀 라이브러리가 로드되지 않았습니다.'); return; }
                const header = [
                    '이름', '성별', '생년월일(YYYY-MM-DD)', '행정동', '연락처', '서비스상태', 
                    '주소', '관리등급', '경제상황', '세대유형', '보호자관계', '보호자연락처', 
                    '서비스시작일', '장기부재기간', '종결일자', '비고'
                ];
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([header]);
                XLSX.utils.book_append_sheet(wb, ws, "대상자등록양식");
                XLSX.writeFile(wb, "대상자등록양식.xlsx");
            };

            window.handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (typeof XLSX === 'undefined') { alert('엑셀 라이브러리가 로드되지 않았습니다.'); return; }

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const bstr = evt.target.result;
                    const wb = XLSX.read(bstr, { type: 'binary' });
                    const wsname = wb.SheetNames[0];
                    const ws = wb.Sheets[wsname];
                    const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    
                    const rows = data.slice(1);
                    let successCount = 0;

                    rows.forEach((row) => {
                        if (row[0]) {
                            const clientData = {
                                name: String(row[0] || ''),
                                gender: String(row[1] || '남성'),
                                birthDate: String(row[2] || ''),
                                region: String(row[3] || '대연동'),
                                phone: String(row[4] || ''),
                                status: String(row[5] || '이용'),
                                address: String(row[6] || ''),
                                careLevel: String(row[7] || '일반'),
                                economicStatus: String(row[8] || '일반(저소득)'),
                                householdType: String(row[9] || '독거세대'),
                                guardianRelation: String(row[10] || ''),
                                guardianPhone: String(row[11] || ''),
                                serviceStartDate: String(row[12] || ''),
                                absencePeriod: String(row[13] || ''),
                                endDate: String(row[14] || ''),
                                note: String(row[15] || ''),
                                createdAt: new Date().toISOString()
                            };
                            addClient(clientData);
                            successCount++;
                        }
                    });
                    alert(`${successCount}명의 대상자가 등록되었습니다.`);
                    e.target.value = ''; 
                };
                reader.readAsBinaryString(file);
            };

            window.getAiRecommendation = async (clientId) => {
                const client = state.clients.find(c => c.id === clientId);
                if (!client) return;

                // Open modal and start loading
                updateState({ 
                    clientManagerContext: { 
                        ...context, 
                        selectedClient: client, 
                        isAiLoading: true, 
                        aiRecommendation: '' 
                    } 
                });

                const age = client.birthDate ? calculateAge(client.birthDate) : 0;
                const info = client.careLevel ? `${client.careLevel}, ${client.economicStatus}` : '';
                const extraInfo = client.status ? `(${client.status})` : '';

                const prompt = `
                    당신은 전문 사회복지사입니다. 다음 대상자 정보를 바탕으로 필요한 복지 서비스나 주의해야 할 케어 포인트를 3가지 추천해주세요. 한국어로 부드럽고 전문적인 어조로 작성해주세요.
                    
                    대상자 정보:
                    - 이름: ${client.name} (${client.gender || '성별미상'})
                    - 나이: ${age}세 (${client.birthDate || '생년월일 미상'})
                    - 등급 및 구분: ${info} ${extraInfo}
                    - 거주지: ${client.address} (${client.region || '행정동 미상'})
                `;

                const result = await callGemini(prompt);
                updateState({ 
                    clientManagerContext: { 
                        ...state.clientManagerContext, 
                        isAiLoading: false, 
                        aiRecommendation: result 
                    } 
                });
            };

            // Filters and Search Logic
            const filteredClients = state.clients.filter(client => {
                const matchStatus = context.filterStatus === '' || client.status === context.filterStatus;
                const matchCareLevel = context.filterCareLevel === '' || client.careLevel === context.filterCareLevel;
                const matchRegion = context.filterRegion === '' || client.region === context.filterRegion;
                const matchGender = context.filterGender === '' || client.gender === context.filterGender;
                const matchName = context.clientSearchTerm === '' || (client.name && client.name.includes(context.clientSearchTerm));
                return matchStatus && matchCareLevel && matchRegion && matchGender && matchName;
            }).sort((a, b) => {
                const dateA = String(a.serviceStartDate || '');
                const dateB = String(b.serviceStartDate || '');
                return dateB.localeCompare(dateA);
            });

            const totalCount = state.clients.length;
            const highFocusCount = state.clients.filter(c => c.careLevel === '중점').length;
            const generalCount = state.clients.filter(c => c.careLevel === '일반').length;
            const maleCount = state.clients.filter(c => c.gender === '남성').length;
            const femaleCount = state.clients.filter(c => c.gender === '여성').length;

            const content = `
                <div class="space-y-6">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-2">
                        <h2 class="text-2xl font-bold text-slate-800">대상자 관리</h2>
                        <div class="flex gap-2">
                            <button onclick="handleDownloadTemplate()" class="flex items-center gap-1 bg-slate-100 text-slate-600 px-3 py-2 rounded-lg hover:bg-slate-200 transition-colors text-sm">
                                ${createIcon('Download', 16)} 양식 다운로드
                            </button>
                            <label class="flex items-center gap-1 bg-slate-100 text-slate-600 px-3 py-2 rounded-lg hover:bg-slate-200 transition-colors text-sm cursor-pointer">
                                ${createIcon('Upload', 16)} 엑셀 일괄 등록
                                <input type="file" accept=".xlsx, .xls" class="hidden" onchange="handleFileUpload(event)" />
                            </label>
                            <button 
                                onclick="updateState({ clientManagerContext: { ...state.clientManagerContext, editingClientId: null, showForm: !state.clientManagerContext.showForm } })"
                                class="flex items-center gap-2 bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-colors"
                            >
                                ${createIcon('Plus', 20)} 대상자 등록
                            </button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between">
                            <div><p class="text-sm text-slate-500">총 대상자</p><p class="text-2xl font-bold text-slate-800">${totalCount}명</p></div>
                            <div class="p-2 bg-slate-50 rounded-full text-slate-400">${createIcon('Users', 20)}</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                            <p class="text-sm text-slate-500">관리 등급별</p>
                            <div class="flex gap-4 mt-2 items-center">
                                <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-pink-500"></div><span class="text-sm font-bold text-slate-700">중점 ${highFocusCount}</span></div>
                                <div class="h-4 w-px bg-slate-200"></div>
                                <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-blue-500"></div><span class="text-sm font-bold text-slate-700">일반 ${generalCount}</span></div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                            <p class="text-sm text-slate-500">성별</p>
                            <div class="flex gap-4 mt-2 items-center">
                                <div class="flex items-center gap-1"><span class="text-blue-500 font-bold text-sm">남 ${maleCount}</span></div>
                                <div class="h-4 w-px bg-slate-200"></div>
                                <div class="flex items-center gap-1"><span class="text-red-500 font-bold text-sm">여 ${femaleCount}</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Search & Filters -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col md:flex-row flex-wrap items-center gap-2">
                        <div class="flex items-center gap-1 text-slate-600 mr-2 whitespace-nowrap self-start md:self-center">
                            ${createIcon('Filter', 16)}
                            <span class="font-bold text-sm">검색 필터</span>
                        </div>
                        
                        <div class="relative flex-1 min-w-[120px] max-w-[200px]">
                            ${createIcon('Search', 14, 'absolute left-2 top-1/2 transform -translate-y-1/2 text-slate-400')}
                            <input 
                                type="text"
                                placeholder="이름 검색"
                                class="input-field text-sm py-2 pl-8 w-full"
                                value="${context.clientSearchTerm}"
                                oninput="updateState({ clientManagerContext: { ...state.clientManagerContext, clientSearchTerm: this.value } })"
                            />
                        </div>

                        <select class="input-field text-sm py-2 flex-1 min-w-[80px] max-w-[160px]" 
                                onchange="updateState({ clientManagerContext: { ...state.clientManagerContext, filterStatus: this.value } })"
                        >
                            <option value="">상태 (전체)</option>
                            ${STATUS_LIST.map(s => `<option value="${s}" ${context.filterStatus === s ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                        <select class="input-field text-sm py-2 flex-1 min-w-[80px] max-w-[160px]" 
                                onchange="updateState({ clientManagerContext: { ...state.clientManagerContext, filterCareLevel: this.value } })"
                        >
                            <option value="">등급 (전체)</option>
                            ${CARE_LEVEL_LIST.map(c => `<option value="${c}" ${context.filterCareLevel === c ? 'selected' : ''}>${c}</option>`).join('')}
                        </select>
                        <select class="input-field text-sm py-2 flex-1 min-w-[80px] max-w-[160px]" 
                                onchange="updateState({ clientManagerContext: { ...state.clientManagerContext, filterRegion: this.value } })"
                        >
                            <option value="">행정동 (전체)</option>
                            ${DONG_LIST.map(d => `<option value="${d}" ${context.filterRegion === d ? 'selected' : ''}>${d}</option>`).join('')}
                        </select>
                        <select class="input-field text-sm py-2 flex-1 min-w-[80px] max-w-[160px]" 
                                onchange="updateState({ clientManagerContext: { ...state.clientManagerContext, filterGender: this.value } })"
                        >
                            <option value="">성별 (전체)</option>
                            <option value="남성" ${context.filterGender === '남성' ? 'selected' : ''}>남성</option>
                            <option value="여성" ${context.filterGender === '여성' ? 'selected' : ''}>여성</option>
                        </select>

                        <button 
                            onclick="updateState({ clientManagerContext: { ...state.clientManagerContext, filterStatus: '', filterCareLevel: '', filterRegion: '', filterGender: '', clientSearchTerm: '' } })" 
                            class="ml-auto text-xs flex items-center gap-1 text-slate-400 hover:text-slate-600 transition-colors whitespace-nowrap"
                        >
                            ${createIcon('RefreshCw', 14)} <span class="hidden sm:inline">초기화</span>
                        </button>
                    </div>

                    ${context.showForm ? `
                        <form id="client-form" onsubmit="event.preventDefault(); document.getElementById('client-manager-form-submit').click();" class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 animate-fade-in">
                            <h3 class="font-bold mb-4 text-lg">${context.editingClientId ? '대상자 정보 수정' : '새 대상자 등록'}</h3>
                            
                            <input type="hidden" id="newClient-gender" value="${context.newClient.gender}" />
                            <input type="hidden" id="newClient-region" value="${context.newClient.region}" />
                            <input type="hidden" id="newClient-status" value="${context.newClient.status}" />
                            <input type="hidden" id="newClient-careLevel" value="${context.newClient.careLevel}" />
                            <input type="hidden" id="newClient-economicStatus" value="${context.newClient.economicStatus}" />
                            <input type="hidden" id="newClient-householdType" value="${context.newClient.householdType}" />
                            
                            <!-- Row 1 -->
                            <div class="flex flex-col md:flex-row gap-4 mb-4">
                                <div class="flex-[1.5]">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">이름</label>
                                    <input placeholder="대상자 성함" class="input-field" value="${context.newClient.name || ''}" 
                                        oninput="handleNewClientChange('name', this.value)" required />
                                </div>
                                <div class="w-20">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">성별</label>
                                    ${renderSelectWithOtherHTML('newClient-gender', context.newClient.gender, GENDER_LIST)}
                                </div>
                                <div class="flex-1 min-w-[120px]">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">생년월일</label>
                                    <input type="date" class="input-field" value="${context.newClient.birthDate || ''}" 
                                        oninput="handleNewClientChange('birthDate', this.value)" required max="9999-12-31" />
                                </div>
                                <div class="flex-[1.5] min-w-[100px]">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">서비스 상태</label>
                                    ${renderSelectWithOtherHTML('newClient-status', context.newClient.status, STATUS_LIST)}
                                </div>
                            </div>

                            <!-- Row 2 -->
                            <div class="flex flex-col md:flex-row gap-4 mb-4">
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">연락처</label>
                                    <input placeholder="010-0000-0000" class="input-field" value="${context.newClient.phone || ''}" 
                                        oninput="handleNewClientChange('phone', this.value)" />
                                </div>
                                <div class="flex-[1.2]">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">보호자 연락처</label>
                                    <div class="flex gap-2">
                                        <input placeholder="관계" class="input-field !w-20 text-center p-2" value="${context.newClient.guardianRelation || ''}" 
                                            oninput="handleNewClientChange('guardianRelation', this.value)" />
                                        <input placeholder="010-0000-0000" class="input-field flex-1" value="${context.newClient.guardianPhone || ''}" 
                                            oninput="handleNewClientChange('guardianPhone', this.value)" />
                                    </div>
                                </div>
                            </div>

                            <!-- Row 3 -->
                            <div class="flex flex-col md:flex-row gap-4 mb-4">
                                <div class="w-full md:w-1/4 min-w-[120px]">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">행정동</label>
                                    ${renderSelectWithOtherHTML('newClient-region', context.newClient.region, DONG_LIST)}
                                </div>
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">상세 주소</label>
                                    <input placeholder="상세 주소를 입력하세요" class="input-field" value="${context.newClient.address || ''}" 
                                        oninput="handleNewClientChange('address', this.value)" />
                                </div>
                            </div>

                            <!-- Row 4 -->
                            <div class="flex flex-col md:flex-row gap-4 mb-4">
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">관리 등급</label>
                                    ${renderSelectWithOtherHTML('newClient-careLevel', context.newClient.careLevel, CARE_LEVEL_LIST)}
                                </div>
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">경제 상황 구분</label>
                                    ${renderSelectWithOtherHTML('newClient-economicStatus', context.newClient.economicStatus, ECONOMIC_LIST)}
                                </div>
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">세대 유형</label>
                                    ${renderSelectWithOtherHTML('newClient-householdType', context.newClient.householdType, HOUSEHOLD_LIST)}
                                </div>
                            </div>

                            <!-- Row 5 -->
                            <div class="flex flex-col md:flex-row gap-4 mb-4">
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">서비스 시작일</label>
                                    <input type="date" class="input-field" value="${context.newClient.serviceStartDate || ''}" 
                                        oninput="handleNewClientChange('serviceStartDate', this.value)" max="9999-12-31" />
                                </div>
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">장기부재 기간</label>
                                    <input placeholder="예: 2023.10.01~2023.10.31" class="input-field" value="${context.newClient.absencePeriod || ''}" 
                                        oninput="handleNewClientChange('absencePeriod', this.value)" />
                                </div>
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">종결 일자</label>
                                    <input type="date" class="input-field" value="${context.newClient.endDate || ''}" 
                                        oninput="handleNewClientChange('endDate', this.value)" max="9999-12-31" />
                                </div>
                            </div>

                            <!-- Row 6 -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-slate-700 mb-1">비고</label>
                                <textarea 
                                    rows="5"
                                    placeholder="특이사항 등 메모" 
                                    class="input-field resize-none" 
                                    oninput="handleNewClientChange('note', this.value)" 
                                >${context.newClient.note || ''}</textarea>
                            </div>

                            <div class="flex justify-end gap-2">
                                <button type="button" onclick="updateState({ clientManagerContext: { ...state.clientManagerContext, showForm: false } })" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">취소</button>
                                <button type="button" id="client-manager-form-submit" onclick="(${handleSubmit}).call(this, event)" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium">
                                    ${context.editingClientId ? '수정 완료' : '저장하기'}
                                </button>
                            </div>
                        </form>
                    ` : ''}
                    
                    <!-- Client List -->
                    ${filteredClients.length === 0 ? `
                        <div class="text-center py-12 bg-white rounded-xl border border-slate-100 border-dashed">
                            ${createIcon('Users', 48, 'mx-auto mb-2 opacity-50')}
                            <p>조건에 맞는 대상자가 없습니다.</p>
                        </div>
                    ` : `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${filteredClients.map(client => {
                                const age = client.birthDate ? calculateAge(client.birthDate) : 0;
                                const statusColor = getStatusColor(client.status);
                                const genderText = client.gender === '남성' ? '남' : client.gender === '여성' ? '여' : client.gender;
                                const genderColor = client.gender === '남성' ? 'text-blue-500' : client.gender === '여성' ? 'text-red-500' : 'text-gray-500';
                                const careLevelStyle = getCareLevelStyle(client.careLevel);

                                return `
                                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow relative overflow-hidden group ${client.status === '종결' ? 'opacity-75' : ''}">
                                        <div class="flex justify-between items-start mb-2">
                                            <div class="flex items-center gap-2">
                                                <h3 class="font-bold text-lg text-slate-800">${client.name || ''}</h3>
                                                <span class="text-sm font-bold ${genderColor}">(${age}세/${genderText || ''})</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                ${client.status ? `<span class="text-xs px-2 py-1 rounded font-medium ${statusColor}">${client.status || ''}</span>` : ''}
                                                <button onclick="startEditClient('${client.id}')" class="text-slate-300 hover:text-blue-500 transition-colors">${createIcon('Edit', 18)}</button>
                                                <button onclick="if(confirm('정말로 ${client.name} 대상자를 삭제하시겠습니까?')) { deleteClient('${client.id}'); }" class="text-slate-300 hover:text-red-500">${createIcon('Trash2', 18)}</button>
                                            </div>
                                        </div>
                                        
                                        <div class="flex flex-wrap gap-1 mb-3">
                                            ${client.region ? `<span class="inline-block bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded">${client.region || ''}</span>` : ''}
                                            ${client.careLevel ? `<span class="inline-block text-xs px-2 py-1 rounded ${careLevelStyle}">${client.careLevel || ''}</span>` : ''}
                                            ${client.economicStatus ? `<span class="inline-block bg-amber-50 text-amber-700 text-xs px-2 py-1 rounded">${client.economicStatus || ''}</span>` : ''}
                                        </div>

                                        <div class="space-y-1 text-sm text-slate-600 mb-4">
                                            <p class="flex items-center gap-2"><span class="w-4">${createIcon('Users', 14)}</span> ${client.phone || '-'}</p>
                                            <p class="flex items-center gap-2"><span class="w-4">🏠</span> ${client.address || '-'}</p>
                                        </div>
                                        
                                        ${client.status !== '종결' ? `
                                            <button 
                                                onclick="getAiRecommendation('${client.id}')"
                                                class="w-full flex items-center justify-center gap-2 py-2 bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100 transition-colors text-sm font-medium"
                                            >
                                                ${createIcon('Sparkles', 16)}
                                                AI 케어 제안받기
                                            </button>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `;
            document.getElementById('content-container').innerHTML = content;
            renderClientModal();
        };

        const renderClientModal = () => {
            const context = state.clientManagerContext;
            const client = context.selectedClient;
            
            if (!client) {
                document.getElementById('modal-container').innerHTML = '';
                return;
            }

            const age = client.birthDate ? calculateAge(client.birthDate) : 0;
            
            const modalHTML = `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl max-w-lg w-full p-6 shadow-xl relative">
                        <button 
                            onclick="updateState({ clientManagerContext: { ...state.clientManagerContext, selectedClient: null } })"
                            class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"
                        >
                            ${createIcon('X', 24)}
                        </button>
                        
                        <div class="flex items-center gap-2 mb-4 text-purple-600">
                            ${createIcon('Sparkles', 24)}
                            <h3 class="text-lg font-bold">AI 맞춤 케어 제안</h3>
                        </div>
                        
                        <div class="mb-4 p-3 bg-slate-50 rounded-lg border border-slate-100">
                            <p class="font-medium text-slate-800">
                                ${client.name} 
                                <span class="text-slate-500 text-sm ml-1">
                                    (${age}세, ${client.gender || '성별미상'})
                                </span>
                            </p>
                        </div>

                        <div class="min-h-[150px]">
                            ${context.isAiLoading ? `
                                <div class="flex flex-col items-center justify-center h-full py-8 text-slate-400">
                                    ${createIcon('Loader2', 32, 'animate-spin mb-2')}
                                    <p>AI가 대상자를 분석 중입니다...</p>
                                </div>
                            ` : `
                                <div class="prose prose-sm max-w-none whitespace-pre-wrap text-slate-700 leading-relaxed">
                                    ${context.aiRecommendation.replace(/\n/g, '<br>')}
                                </div>
                            `}
                        </div>
                        
                        <div class="mt-6 flex justify-end">
                            <button 
                                onclick="updateState({ clientManagerContext: { ...state.clientManagerContext, selectedClient: null } })"
                                class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700"
                            >
                                닫기
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').innerHTML = modalHTML;
        };
        
        // 4. Log Manager
        const renderLogManager = () => {
            // Complex LogManager logic requires local context updates
            const context = state.logManagerContext;
            const clientContext = state.clientManagerContext;

            // Derived State Calculations
            context.sortedClients = [...state.clients].sort((a, b) => String(a.name).localeCompare(String(b.name), 'ko'));
            context.allCategories = [...new Set(state.services.map(s => s.category))];
            context.servicesInFilteredCategory = context.filterCategory ? state.services.filter(s => s.category === context.filterCategory) : state.services;
            
            const matchedClient = state.clients.find(c => c.name === context.newLog.clientName);

            const filteredLogs = state.logs.filter(log => {
                const matchName = (log.clientName || '').toLowerCase().includes(context.searchTerm.toLowerCase());
                let matchDate = true;
                if (context.filterStartDate) matchDate = matchDate && log.date >= context.filterStartDate;
                if (context.filterEndDate) matchDate = matchDate && log.date <= context.filterEndDate;
                let matchCategory = true;
                if (context.filterCategory) {
                    const items = log.serviceItems && log.serviceItems.length > 0 ? log.serviceItems : [{ category: log.serviceCategory }];
                    matchCategory = items.some(item => item.category === context.filterCategory);
                }
                let matchService = true;
                if (context.filterService) {
                    const items = log.serviceItems && log.serviceItems.length > 0 ? log.serviceItems : [{ serviceName: log.serviceName }];
                    matchService = items.some(item => item.serviceName === context.filterService);
                }
                return matchName && matchDate && matchCategory && matchService;
            });
            
            // --- Logic Handlers ---

            window.handleLogFormChange = (key, value) => {
                const newLog = { ...context.newLog, [key]: value };
                if (key === 'clientName') {
                    const client = state.clients.find(c => c.name === value);
                    newLog.clientId = client ? client.id : '';
                }
                updateState({ logManagerContext: { ...context, newLog } });
            };

            window.handleServiceItemChange = (itemId, field, value) => {
                const updatedItems = context.newLog.serviceItems.map(item => {
                    if (item.id === itemId) {
                        const updated = { ...item, [field]: value };
                        if (field === 'category') { updated.serviceId = ''; updated.serviceName = ''; }
                        if (field === 'serviceId') {
                            const s = state.services.find(svc => svc.id === value);
                            updated.serviceName = s ? s.name : '';
                        }
                        return updated;
                    }
                    return item;
                });
                updateState({ logManagerContext: { ...context, newLog: { ...context.newLog, serviceItems: updatedItems } } });
            };

            window.addServiceItem = () => {
                if (context.newLog.serviceItems.length >= 6) return;
                const newItems = [...context.newLog.serviceItems, { id: Date.now(), category: '', serviceId: '', serviceName: '', detailNote: '' }];
                updateState({ logManagerContext: { ...context, newLog: { ...context.newLog, serviceItems: newItems } } });
            };
            
            window.removeServiceItem = (itemId) => {
                const newItems = context.newLog.serviceItems.filter(item => item.id !== itemId);
                updateState({ logManagerContext: { ...context, newLog: { ...context.newLog, serviceItems: newItems } } });
            };

            const closeLogForm = () => {
                updateState({ 
                    logManagerContext: { 
                        ...context, 
                        showForm: false, 
                        editingLogId: null, 
                        newLog: { clientId: '', clientName: '', date: new Date().toISOString().split('T')[0], provider: '', provideMethod: '', content: '', serviceItems: [{ id: Date.now(), category: '', serviceId: '', serviceName: '', detailNote: '' }] }
                    }
                });
            };

            window.startEditLog = (logId) => {
                const log = state.logs.find(l => l.id === logId);
                if (!log) return;
                
                let initialServiceItems = [];
                if (log.serviceItems && log.serviceItems.length > 0) { initialServiceItems = log.serviceItems; } 
                else { initialServiceItems = [{ id: Date.now(), category: log.serviceCategory || '', serviceId: log.serviceId || '', serviceName: log.serviceName || '', detailNote: '' }]; }
                
                updateState({ logManagerContext: { 
                    ...context,
                    editingLogId: logId,
                    showForm: true,
                    newLog: { 
                        clientId: log.clientId || '', clientName: log.clientName, date: log.date, 
                        provider: log.provider || '', provideMethod: log.provideMethod || '', content: log.content, 
                        serviceItems: initialServiceItems
                    }
                }});
            };
            
            window.duplicateLog = (logId) => {
                const log = state.logs.find(l => l.id === logId);
                if (!log) return;
                
                let initialServiceItems = [];
                if (log.serviceItems && log.serviceItems.length > 0) { initialServiceItems = log.serviceItems.map((item, index) => ({ ...item, id: Date.now() + index })); } 
                else { initialServiceItems = [{ id: Date.now(), category: log.serviceCategory || '', serviceId: log.serviceId || '', serviceName: log.serviceName || '', detailNote: '' }]; }
                
                updateState({ logManagerContext: { 
                    ...context,
                    editingLogId: null, // New log
                    showForm: true,
                    newLog: { 
                        clientId: log.clientId || '', clientName: log.clientName, date: new Date().toISOString().split('T')[0], 
                        provider: log.provider || '', provideMethod: log.provideMethod || '', content: log.content, 
                        serviceItems: initialServiceItems
                    }
                }});
            };

            window.handleLogSubmit = async (e) => {
                e.preventDefault();
                const log = context.newLog;
                if (!log.clientName) { alert('대상자를 선택해주세요.'); return; }
                const validServices = log.serviceItems.filter(item => item.serviceName);
                if (validServices.length === 0) { alert('최소 하나의 서비스를 선택해주세요.'); return; }
                
                const serviceNameStr = validServices.map(s => s.serviceName).join(', ');
                const serviceCategoryStr = validServices[0].category;
                
                const logData = { 
                    clientId: log.clientId, clientName: log.clientName, date: log.date, 
                    provider: log.provider, provideMethod: log.provideMethod, content: log.content, 
                    serviceName: serviceNameStr, serviceCategory: serviceCategoryStr, serviceItems: validServices 
                };
                
                if (context.editingLogId) { 
                    await updateLog(context.editingLogId, logData); 
                    alert("일지가 수정되었습니다.");
                } else { 
                    await addLog(logData); 
                }
                closeLogForm();
            };

            window.handleAiDraft = async () => {
                if (!context.newLog.content.trim()) { alert("내용을 입력해주세요."); return; }
                
                updateState({ logManagerContext: { ...context, isDrafting: true } });
                
                const client = state.clients.find(c => c.name === context.newLog.clientName);
                const clientInfo = client ? `대상자: ${client.name} (${calculateAge(client.birthDate)}세, ${client.careLevel}), ` : '';
                
                const prompt = `
                    당신은 전문 사회복지사입니다. 다음 일지 내용을 전문적이고 깔끔한 문장으로 다듬어주세요. 보고서 형식으로 작성하며, 핵심적인 정보가 빠지지 않도록 유의해주세요. 내용은 한국어로 작성합니다.
                    
                    ${clientInfo}
                    제공 서비스: ${context.newLog.serviceItems.map(i => i.serviceName).filter(Boolean).join(', ')}
                    작성 내용: ${context.newLog.content}
                `; 
                const polishedContent = await callGemini(prompt);
                
                updateState({ logManagerContext: { ...state.logManagerContext, isDrafting: false, newLog: { ...state.logManagerContext.newLog, content: polishedContent } } });
            };

            window.handleDropdownToggle = (open) => {
                updateState({ logManagerContext: { ...context, isClientDropdownOpen: open } });
            };

            // Process targetLogId on load/tab switch
            if (state.targetLogId && state.logs.length > 0) {
                const targetLog = state.logs.find(l => l.id === state.targetLogId);
                if (targetLog) {
                    window.startEditLog(state.targetLogId);
                    updateState({ targetLogId: null });
                }
            }


            const content = `
                <div class="space-y-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <h2 class="text-2xl font-bold text-slate-800">서비스 일지</h2>
                        <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto items-center">
                            <button onclick="updateState({ logManagerContext: { ...state.logManagerContext, showForm: !state.logManagerContext.showForm } })" 
                                class="flex items-center justify-center gap-2 bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-colors whitespace-nowrap">
                                ${createIcon('Plus', 20)} 일지 작성
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filters Bar -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col md:flex-row flex-wrap items-center gap-2">
                        <div class="flex items-center gap-1 text-slate-600 mr-2 whitespace-nowrap self-start md:self-center">${createIcon('Filter', 16)}<span class="font-bold text-sm">검색 필터</span></div>
                        <div class="flex items-center gap-2 w-full md:w-auto">
                            <div class="relative flex-1 md:w-44">
                                ${createIcon('Calendar', 14, 'absolute left-2 top-1/2 transform -translate-y-1/2 text-slate-400')}
                                <input type="date" class="input-field text-sm py-2 pl-8" value="${context.filterStartDate}" 
                                    onchange="updateState({ logManagerContext: { ...state.logManagerContext, filterStartDate: this.value } })" max="9999-12-31"/>
                            </div>
                            <span class="text-slate-400">~</span>
                            <div class="relative flex-1 md:w-44">
                                <input type="date" class="input-field text-sm py-2" value="${context.filterEndDate}" 
                                    onchange="updateState({ logManagerContext: { ...state.logManagerContext, filterEndDate: this.value } })" max="9999-12-31"/>
                            </div>
                        </div>
                        <div class="relative w-full md:w-32 min-w-[100px]">
                            ${createIcon('Search', 14, 'absolute left-2 top-1/2 transform -translate-y-1/2 text-slate-400')}
                            <input type="text" placeholder="이름" class="input-field text-sm py-2 pl-8 w-full" value="${context.searchTerm}" 
                                oninput="updateState({ logManagerContext: { ...state.logManagerContext, searchTerm: this.value } })" />
                        </div>
                        <select class="input-field text-sm py-2 flex-1 w-full md:w-auto min-w-[130px]" 
                                onchange="updateState({ logManagerContext: { ...state.logManagerContext, filterCategory: this.value, filterService: '' } })">
                            <option value="">서비스 종류(전체)</option>
                            ${context.allCategories.map(cat => `<option value="${cat}" ${context.filterCategory === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                        </select>
                        <select class="input-field text-sm py-2 flex-1 w-full md:w-auto min-w-[130px]"
                                onchange="updateState({ logManagerContext: { ...state.logManagerContext, filterService: this.value } })">
                            <option value="">세부 서비스(전체)</option>
                            ${context.servicesInFilteredCategory.map(s => `<option value="${s.name}" ${context.filterService === s.name ? 'selected' : ''}>${s.name}</option>`).join('')}
                        </select>
                        <button onclick="updateState({ logManagerContext: { ...state.logManagerContext, filterStartDate: '', filterEndDate: '', searchTerm: '', filterCategory: '', filterService: '' } })" 
                                class="ml-auto text-xs flex items-center gap-1 text-slate-400 hover:text-slate-600 transition-colors whitespace-nowrap">
                            ${createIcon('RefreshCw', 14)} 초기화
                        </button>
                    </div>

                    ${context.showForm ? `
                        <form onsubmit="handleLogSubmit(event)" class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 animate-fade-in">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-lg">${context.editingLogId ? '일지 수정하기' : '일지 작성하기'}</h3>
                            </div>
                            
                            <input type="hidden" id="newLog-provideMethod" value="${context.newLog.provideMethod}" />
                            
                            <!-- Row 1 (Date, Method, Provider) -->
                            <div class="flex flex-row gap-4">
                                <div class="flex-1 min-w-[120px]">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">날짜</label>
                                    <input type="date" class="input-field" value="${context.newLog.date}" onchange="handleLogFormChange('date', this.value)" required />
                                </div>
                                <div class="relative flex-[1.5] min-w-[150px]">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">제공방법</label>
                                    ${renderSelectWithOtherHTML('newLog-provideMethod', context.newLog.provideMethod, PROVIDE_METHOD_LIST, "직접 입력 (예: 문자)")}
                                </div>
                                <div class="flex-1 min-w-[100px]">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">제공자</label>
                                    <input type="text" class="input-field" placeholder="담당자 성명" value="${context.newLog.provider}" oninput="handleLogFormChange('provider', this.value)" />
                                </div>
                            </div>
                            
                            <!-- Row 2 (Client Info) -->
                            <div class="flex flex-row gap-4 mt-4">
                                <div class="relative flex-[2] min-w-[150px]">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">대상자</label>
                                    <div class="relative flex items-center">
                                        <input type="text" class="input-field pr-10" value="${context.newLog.clientName}" 
                                            oninput="handleLogFormChange('clientName', this.value); handleDropdownToggle(true);" 
                                            placeholder="대상자 입력/선택" required />
                                        <button type="button" onclick="handleDropdownToggle(!state.logManagerContext.isClientDropdownOpen)" class="absolute right-2 p-1 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded">
                                            ${createIcon('ChevronDown', 20)}
                                        </button>
                                    </div>
                                    ${context.isClientDropdownOpen ? `
                                        <ul class="absolute z-10 w-full bg-white border border-slate-200 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto">
                                            ${context.sortedClients.length === 0 ? `
                                                <li class="p-3 text-slate-400 text-sm text-center">등록된 대상자가 없습니다.</li>
                                            ` : context.sortedClients.map((client) => `
                                                <li class="px-4 py-2 hover:bg-slate-50 cursor-pointer text-slate-700 border-b last:border-0 border-slate-50" 
                                                    onclick="handleLogFormChange('clientName', '${client.name}'); handleDropdownToggle(false);">
                                                    <span class="font-medium">${client.name}</span>
                                                    <span class="text-xs text-slate-400 ml-2">${calculateAge(client.birthDate)}세 | ${client.careLevel}</span>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    ` : ''}
                                </div>
                                <div class="flex-1 min-w-[100px]">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">생년월일</label>
                                    <input type="text" class="input-field bg-slate-50 text-slate-500" value="${matchedClient ? matchedClient.birthDate : ''}" readonly placeholder="자동표시" />
                                </div>
                                <div class="flex-1 min-w-[80px]">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">관리등급</label>
                                    <input type="text" class="input-field bg-slate-50 text-slate-500" value="${matchedClient ? matchedClient.careLevel : ''}" readonly placeholder="자동표시" />
                                </div>
                                <div class="flex-1 min-w-[80px]">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">행정동</label>
                                    <input type="text" class="input-field bg-slate-50 text-slate-500" value="${matchedClient ? matchedClient.region : ''}" readonly placeholder="자동표시" />
                                </div>
                            </div>
                            
                            <!-- Service Items -->
                            <div class="mt-4">
                                <div class="flex justify-between items-end mb-2">
                                    <label class="block text-sm font-medium text-slate-700">서비스 내용 (최대 6개)</label>
                                    ${context.newLog.serviceItems.length < 6 ? `<button type="button" onclick="addServiceItem()" class="text-xs flex items-center gap-1 text-emerald-600 hover:text-emerald-700">${createIcon('Plus', 14)} 서비스 추가</button>` : ''}
                                </div>
                                ${context.newLog.serviceItems.map((item, index) => `
                                    <div key="${item.id}" class="flex flex-row gap-2 mb-2 items-center">
                                        <div class="flex-1 min-w-[100px]">
                                            <select class="input-field py-2" value="${item.category}" 
                                                onchange="handleServiceItemChange(${item.id}, 'category', this.value)" required>
                                                <option value="">서비스 선택</option>
                                                ${context.allCategories.map(cat => `<option value="${cat}" ${item.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div class="flex-[1.5] min-w-[150px]">
                                            <select class="input-field py-2" value="${item.serviceId}" 
                                                onchange="handleServiceItemChange(${item.id}, 'serviceId', this.value)" required ${!item.category ? 'disabled' : ''}>
                                                <option value="">상세내용 선택</option>
                                                ${state.services.filter(s => s.category === item.category).map(s => `<option value="${s.id}" ${item.serviceId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div class="flex-1 min-w-[150px]">
                                            <input type="text" class="input-field py-2" placeholder="상세내용 직접입력" value="${item.detailNote || ''}" 
                                                oninput="handleServiceItemChange(${item.id}, 'detailNote', this.value)"/>
                                        </div>
                                        ${index > 0 ? `<button type="button" onclick="removeServiceItem(${item.id})" class="text-red-400 hover:text-red-600 p-1">${createIcon('Minus', 18)}</button>` : ''}
                                    </div>
                                `).join('')}
                            </div>

                            <!-- Content Area -->
                            <div class="mt-4">
                                <div class="flex justify-between items-end mb-1">
                                    <label class="block text-sm font-medium text-slate-700">진행 내용 및 특이사항</label>
                                    <button type="button" onclick="handleAiDraft()" ${context.isDrafting ? 'disabled' : ''} class="text-xs flex items-center gap-1 bg-purple-100 text-purple-700 px-2 py-1 rounded hover:bg-purple-200 transition-colors">
                                        ${context.isDrafting ? createIcon('Loader2', 12, 'animate-spin') : createIcon('Sparkles', 12)} 
                                        ${context.isDrafting ? 'AI 작성 중...' : 'AI로 다듬기'}
                                    </button>
                                </div>
                                <textarea class="input-field min-h-[150px]" placeholder="키워드 위주로 입력하고 'AI로 다듬기'를 눌러보세요." 
                                    oninput="handleLogFormChange('content', this.value)" required>${context.newLog.content}</textarea>
                                <p class="text-xs text-slate-400 mt-1 text-right">* AI가 작성한 내용은 반드시 검토 후 등록하세요.</p>
                            </div>
                            
                            <!-- Submit Buttons -->
                            <div class="flex justify-end gap-2 mt-4">
                                <button type="button" onclick="closeLogForm()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">취소</button>
                                <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">
                                    ${context.editingLogId ? '수정 완료' : '일지 등록'}
                                </button>
                            </div>
                        </form>
                    ` : ''}

                    <!-- Log List -->
                    <div class="space-y-4">
                        ${filteredLogs.length === 0 ? `
                            <div class="text-center py-12 bg-white rounded-xl border border-slate-100">
                                ${createIcon('Search', 32, 'mx-auto text-slate-300 mb-2')}
                                <p class="text-slate-500">검색 결과가 없거나 작성된 일지가 없습니다.</p>
                            </div>
                        ` : filteredLogs.map(log => {
                            const clientInfo = state.clients.find(c => c.id === log.clientId);
                            const clientDetailStr = clientInfo ? `${clientInfo.birthDate} (만 ${calculateAge(clientInfo.birthDate)}세) | ${clientInfo.careLevel}` : '정보 없음';
                            const serviceItems = log.serviceItems && log.serviceItems.length > 0 ? log.serviceItems : 
                                (log.serviceName ? log.serviceName.split(', ').map(svc => ({ serviceName: svc })) : []);
                            
                            return `
                                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col md:flex-row gap-4">
                                    <div class="md:w-48 flex-shrink-0 flex flex-col justify-center md:border-r md:border-slate-100 md:pr-4">
                                        <span class="text-sm text-slate-500">${log.date}</span>
                                        <div>
                                            <h4 class="font-bold text-lg text-slate-800 inline-block">${log.clientName}</h4>
                                            <p class="text-xs text-slate-500 mt-0.5">${clientDetailStr}</p>
                                        </div>
                                        <div class="mt-2 flex flex-wrap gap-1">
                                            ${serviceItems.map((item, idx) => `
                                                <span key="${idx}" class="inline-flex text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded">
                                                    ${item.serviceName} ${item.detailNote ? `- ${item.detailNote}` : ''}
                                                </span>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex justify-end items-center mb-2">
                                            <div class="flex items-center gap-1">
                                                <button onclick="duplicateLog('${log.id}')" class="p-1 text-slate-400 hover:text-emerald-500 hover:bg-emerald-50 rounded transition-colors" title="복사">${createIcon('Copy', 16)}</button>
                                                <button onclick="startEditLog('${log.id}')" class="p-1 text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded transition-colors" title="수정">${createIcon('Edit', 16)}</button>
                                                <button onclick="if(confirm('정말로 이 일지를 삭제하시겠습니까?')) { deleteLog('${log.id}'); }" class="p-1 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" title="삭제">${createIcon('Trash2', 16)}</button>
                                            </div>
                                        </div>
                                        <p class="text-slate-600 whitespace-pre-wrap">${log.content}</p>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            document.getElementById('content-container').innerHTML = content;
        };

        // 5. Statistics Manager
        const renderStatisticsManager = () => {
            const context = state.statsManagerContext;
            
            // --- Memoized Logic Translation ---
            
            // Grouped Services (for detailed view header)
            const groupedServices = (() => {
                const groups = {};
                const sortedServices = [...state.services].sort((a, b) => 
                    (a.majorCategory || '').localeCompare(b.majorCategory || '') || 
                    (a.category || '').localeCompare(b.category || '')
                );
                sortedServices.forEach(s => {
                    const cat = s.category || '기타'; 
                    if (!groups[cat]) groups[cat] = [];
                    if (!groups[cat].includes(s.name)) {
                        groups[cat].push(s.name);
                    }
                });
                const sortedCategories = Object.keys(groups).sort();
                return { groups, sortedCategories };
            })();

            // Flattened keys for columns
            const allServiceKeys = (() => {
                if (context.viewType === 'category') {
                    return [...new Set(state.services.map(s => s.category))].filter(Boolean).sort();
                }
                const keys = [];
                groupedServices.sortedCategories.forEach(cat => {
                    keys.push(...groupedServices.groups[cat]);
                });
                return keys;
            })();
            
            // Main Stats Data Calculation
            const statsData = (() => {
                const stats = {};
                const filteredClients = state.clients.filter(client => {
                    const matchName = context.filterName === '' || (client.name && client.name.includes(context.filterName));
                    const matchRegion = context.filterRegion === '' || (client.region === context.filterRegion);
                    return matchName && matchRegion;
                });

                filteredClients.forEach(client => {
                    stats[client.id] = { id: client.id, name: client.name, counts: {}, total: 0 };
                    allServiceKeys.forEach(key => { stats[client.id].counts[key] = 0; });
                });

                state.logs.forEach(log => {
                    if (log.date < context.startDate || log.date > context.endDate) return;
                    
                    let clientId = log.clientId;
                    if (!stats[clientId]) {
                        const found = filteredClients.find(c => c.name === log.clientName);
                        if (found) clientId = found.id;
                        else return; 
                    }

                    if (stats[clientId]) {
                        const items = log.serviceItems && log.serviceItems.length > 0 
                            ? log.serviceItems 
                            : [{ serviceName: log.serviceName, category: log.serviceCategory }]; 

                        items.forEach(item => {
                            let key = '';
                            if (context.viewType === 'category') {
                                key = item.category;
                                if (!key && item.serviceName) {
                                    const foundSvc = state.services.find(s => s.name === item.serviceName);
                                    if (foundSvc) key = foundSvc.category;
                                }
                            } else {
                                key = item.serviceName;
                            }

                            if (key && stats[clientId].counts[key] !== undefined) {
                                stats[clientId].counts[key]++;
                                stats[clientId].total++;
                            }
                        });
                    }
                });

                return Object.values(stats).sort((a, b) => String(a.name).localeCompare(String(b.name), 'ko'));
            })();

            // Column Totals
            const columnTotals = allServiceKeys.reduce((acc, key) => {
                acc[key] = statsData.reduce((sum, client) => sum + (client.counts[key] || 0), 0);
                return acc;
            }, {});

            // Grand Total
            const grandTotal = statsData.reduce((sum, client) => sum + client.total, 0);

            // --- Handler for Download ---
            window.handleDownloadStats = () => {
                if (typeof XLSX === 'undefined') { alert('엑셀 라이브러리가 로드되지 않았습니다.'); return; }

                let headerRow1 = ["대상자", "합계"];
                if (context.viewType === 'detail') {
                    allServiceKeys.forEach(key => {
                        let category = "기타";
                        for (const cat of groupedServices.sortedCategories) {
                            if (groupedServices.groups[cat].includes(key)) {
                                category = cat;
                                break;
                            }
                        }
                        headerRow1.push(`[${category}] ${key}`);
                    });
                } else {
                    headerRow1 = [...headerRow1, ...allServiceKeys];
                }

                const dataRows = statsData.map(client => {
                    const row = [client.name, client.total];
                    allServiceKeys.forEach(key => { row.push(client.counts[key] || 0); });
                    return row;
                });

                const totalRow = ["전체 합계", grandTotal];
                allServiceKeys.forEach(key => { totalRow.push(columnTotals[key]); });
                dataRows.push(totalRow);

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([headerRow1, ...dataRows]);
                const wscols = headerRow1.map(() => ({ wch: 15 }));
                ws['!cols'] = wscols;

                XLSX.utils.book_append_sheet(wb, ws, "서비스통계");
                XLSX.writeFile(wb, `서비스제공통계_${context.startDate}_${context.endDate}.xlsx`);
            };

            const content = `
                <div class="space-y-6">
                    <div class="flex flex-col gap-4">
                        <h2 class="text-2xl font-bold text-slate-800">서비스 제공 통계</h2>
                        
                        <div class="flex flex-wrap items-center gap-3">
                            <!-- View Type Toggle -->
                            <div class="flex bg-slate-100 p-1 rounded-lg">
                                <button 
                                    onclick="updateState({ statsManagerContext: { ...state.statsManagerContext, viewType: 'category' } })"
                                    class="flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${context.viewType === 'category' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}"
                                >
                                    ${createIcon('PieChart', 16)}
                                    분류별
                                </button>
                                <button 
                                    onclick="updateState({ statsManagerContext: { ...state.statsManagerContext, viewType: 'detail' } })"
                                    class="flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${context.viewType === 'detail' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}"
                                >
                                    ${createIcon('List', 16)}
                                    상세별
                                </button>
                            </div>

                            <!-- Filters -->
                            <div class="flex items-center gap-2">
                                <select 
                                    class="input-field text-sm py-1.5 w-24" 
                                    onchange="updateState({ statsManagerContext: { ...state.statsManagerContext, filterRegion: this.value } })"
                                >
                                    <option value="">전체 동</option>
                                    ${DONG_LIST.map(d => `<option value="${d}" ${context.filterRegion === d ? 'selected' : ''}>${d}</option>`).join('')}
                                </select>
                                <input 
                                    type="text" 
                                    placeholder="이름 검색" 
                                    class="input-field text-sm py-1.5 w-24"
                                    value="${context.filterName}" 
                                    oninput="updateState({ statsManagerContext: { ...state.statsManagerContext, filterName: this.value } })" 
                                />
                            </div>

                            <!-- Date Picker -->
                            <div class="flex items-center gap-2 bg-white p-1.5 rounded-lg border border-slate-200 shadow-sm">
                                ${createIcon('Calendar', 16, 'text-slate-400')}
                                <input type="date" value="${context.startDate}" onchange="updateState({ statsManagerContext: { ...state.statsManagerContext, startDate: this.value } })" class="text-xs outline-none text-slate-600"/>
                                <span class="text-slate-400 text-xs">~</span>
                                <input type="date" value="${context.endDate}" onchange="updateState({ statsManagerContext: { ...state.statsManagerContext, endDate: this.value } })" class="text-xs outline-none text-slate-600"/>
                            </div>

                            <!-- Excel Download Button -->
                            <button 
                                onclick="handleDownloadStats()"
                                class="flex items-center justify-center bg-emerald-600 text-white p-2 rounded-lg hover:bg-emerald-700 transition-colors shadow-sm"
                                title="엑셀 다운로드"
                            >
                                ${createIcon('Download', 16)}
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left border-collapse">
                                <thead class="bg-slate-50 text-slate-600 font-semibold">
                                    ${context.viewType === 'detail' ? `
                                        <tr>
                                            <th rowspan="2" class="p-3 sticky-left bg-slate-50 z-10 border-b border-r border-slate-200 min-w-[100px] align-middle text-center">대상자</th>
                                            <th rowspan="2" class="p-3 text-center bg-emerald-50 text-emerald-700 border-b border-r border-slate-200 min-w-[60px] align-middle">합계</th>
                                            ${groupedServices.sortedCategories.map(cat => `
                                                <th 
                                                    colspan="${groupedServices.groups[cat].length}" 
                                                    class="p-2 text-center border-b border-r border-slate-200 bg-slate-100 font-bold text-slate-700"
                                                >
                                                    ${cat}
                                                </th>
                                            `).join('')}
                                        </tr>
                                        <tr>
                                            ${groupedServices.sortedCategories.map(cat => 
                                                groupedServices.groups[cat].map(serviceName => `
                                                    <th class="p-2 text-center border-b border-r border-slate-100 min-w-[100px] whitespace-nowrap font-normal text-xs">
                                                        ${serviceName}
                                                    </th>
                                                `).join('')
                                            ).join('')}
                                        </tr>
                                    ` : `
                                        <tr>
                                            <th class="p-3 sticky-left bg-slate-50 z-10 border-b border-r border-slate-200 min-w-[100px]">대상자</th>
                                            <th class="p-3 text-center bg-emerald-50 text-emerald-700 border-b border-r border-slate-200 min-w-[60px]">합계</th>
                                            ${allServiceKeys.map(key => `
                                                <th class="p-3 text-center border-b border-r border-slate-100 min-w-[100px] whitespace-nowrap">${key}</th>
                                            `).join('')}
                                        </tr>
                                    `}
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    <tr class="bg-slate-50 font-bold text-slate-700">
                                        <td class="p-3 sticky-left bg-slate-50 border-r border-slate-200 text-center">전체 합계</td>
                                        <td class="p-3 text-center bg-emerald-50 text-emerald-700 border-r border-slate-200">${grandTotal}</td>
                                        ${allServiceKeys.map(key => `
                                            <td class="p-3 text-center border-r border-slate-200">${columnTotals[key]}</td>
                                        `).join('')}
                                    </tr>
                                    ${statsData.length === 0 ? `
                                        <tr><td colspan="${allServiceKeys.length + 2}" class="p-8 text-center text-slate-400">데이터가 없습니다.</td></tr>
                                    ` : statsData.map(client => `
                                        <tr class="hover:bg-slate-50 transition-colors">
                                            <td class="p-3 font-medium text-slate-700 sticky-left bg-white border-r border-slate-200 group-hover:bg-slate-50">${client.name}</td>
                                            <td class="p-3 text-center font-bold text-emerald-600 bg-emerald-50/30 border-r border-slate-200">${client.total}</td>
                                            ${allServiceKeys.map(key => `
                                                <td class="p-3 text-center border-r border-slate-100 ${client.counts[key] > 0 ? 'text-slate-800 font-medium bg-blue-50/50' : 'text-slate-300'}">
                                                    ${client.counts[key] > 0 ? client.counts[key] : '-'}
                                                </td>
                                            `).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('content-container').innerHTML = content;
        };

        // 6. Service Manager
        const renderServiceManager = () => {
            const context = state.serviceManagerContext || { newService: { name: '', category: '', majorCategory: '', example: '' } };
            
            window.handleServiceFormChange = (key, value) => {
                const newService = { ...context.newService, [key]: value };
                updateState({ serviceManagerContext: { ...context, newService } });
            };

            window.handleServiceSubmit = async (e) => {
                e.preventDefault();
                const service = context.newService;
                if(!service.name || !service.category) return; 

                await addService(service);

                updateState({ 
                    serviceManagerContext: { 
                        ...context, 
                        newService: { name: '', category: '', majorCategory: '', example: '' } 
                    } 
                });
            };

            const content = `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-slate-800">서비스 목록 설정</h2>
                        ${state.services.length === 0 ? `
                            <button onclick="loadSampleData()" class="text-sm flex items-center gap-1 text-emerald-600 bg-emerald-50 px-3 py-1 rounded hover:bg-emerald-100">
                                ${createIcon('RefreshCw', 14)} 기본 서비스 목록 불러오기
                            </button>
                        ` : ''}
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <form onsubmit="handleServiceSubmit(event)" class="flex flex-col lg:flex-row gap-4 items-end">
                            <div class="w-full lg:w-1/5 min-w-[120px]">
                                <label class="block text-sm font-medium text-slate-700 mb-1">서비스 대분류</label>
                                <input class="input-field" placeholder="예: 위기관리" value="${context.newService.majorCategory || ''}" 
                                    oninput="handleServiceFormChange('majorCategory', this.value)" />
                            </div>
                            <div class="w-full lg:w-1/5 min-w-[120px]">
                                <label class="block text-sm font-medium text-slate-700 mb-1">서비스</label>
                                <input class="input-field" placeholder="예: 사례관리" value="${context.newService.category || ''}" 
                                    oninput="handleServiceFormChange('category', this.value)" required />
                            </div>
                            <div class="w-full lg:w-1/4 min-w-[150px]">
                                <label class="block text-sm font-medium text-slate-700 mb-1">서비스 상세내용</label>
                                <input class="input-field" placeholder="예: 초기상담" value="${context.newService.name || ''}" 
                                    oninput="handleServiceFormChange('name', this.value)" required />
                            </div>
                            <div class="flex-1 w-full min-w-[150px]">
                                <label class="block text-sm font-medium text-slate-700 mb-1">서비스 예시</label>
                                <input class="input-field" placeholder="예: 가정방문" value="${context.newService.example || ''}" 
                                    oninput="handleServiceFormChange('example', this.value)" />
                            </div>
                            <button type="submit" class="bg-slate-800 text-white px-6 py-2 rounded-lg hover:bg-slate-700 h-[42px] whitespace-nowrap w-full lg:w-auto">추가</button>
                        </form>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden overflow-x-auto">
                        <table class="w-full text-left min-w-[800px]">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="p-4 font-semibold text-slate-600 whitespace-nowrap w-[20%]">대분류</th>
                                    <th class="p-4 font-semibold text-slate-600 whitespace-nowrap w-[15%]">서비스</th>
                                    <th class="p-4 font-semibold text-slate-600 whitespace-nowrap w-[25%]">서비스 상세내용</th>
                                    <th class="p-4 font-semibold text-slate-600 whitespace-nowrap w-[30%]">서비스 예시</th>
                                    <th class="p-4 font-semibold text-slate-600 text-right whitespace-nowrap w-[10%]">관리</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${state.services.length === 0 ? `
                                    <tr><td colspan="5" class="p-8 text-center text-slate-400">등록된 서비스가 없습니다.</td></tr>
                                ` : state.services.map(service => `
                                    <tr class="border-t border-slate-100 hover:bg-slate-50">
                                        <td class="p-4 text-slate-800">${service.majorCategory || '-'}</td>
                                        <td class="p-4 text-slate-500"><span class="bg-slate-100 px-2 py-1 rounded text-xs">${service.category}</span></td>
                                        <td class="p-4 text-slate-800 font-medium">${service.name}</td>
                                        <td class="p-4 text-slate-600 text-sm">${service.example || '-'}</td>
                                        <td class="p-4 text-right">
                                            <button onclick="if(confirm('정말로 이 서비스를 삭제하시겠습니까?')) { deleteService('${service.id}'); }" class="text-red-400 hover:text-red-600">
                                                ${createIcon('Trash2', 18)}
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            document.getElementById('content-container').innerHTML = content;
        };


        // --- Main Render & Init Logic ---

        const renderMainContent = () => {
            document.getElementById('modal-container').innerHTML = ''; // Clear modals
            
            switch (state.activeTab) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'clients':
                    renderClientManager();
                    break;
                case 'logs':
                    renderLogManager();
                    break;
                case 'statistics':
                    renderStatisticsManager();
                    break;
                case 'services':
                    renderServiceManager();
                    break;
                default:
                    renderDashboard();
            }
        };

        const renderApp = () => {
            renderSidebar();
            if (state.isLoading) return;
            renderMainContent();
        };
        
        const initFirebaseAndLoadData = async () => {
            // 1. Auth
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken).catch(err => console.error("Custom Token Sign-in Failed:", err));
            } else {
                await signInAnonymously(auth).catch(err => console.error("Anonymous Sign-in Failed:", err));
            }
            
            // 2. Data Sync
            const unsubscribeClients = onSnapshot(collection(db, ...basePath, 'clients'), 
                (snap) => {
                    const clients = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    updateState({ clients: clients });
                }
            );
            const unsubscribeServices = onSnapshot(collection(db, ...basePath, 'services'), 
                (snap) => {
                    const services = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    updateState({ services: services });
                }
            );
            const unsubscribeLogs = onSnapshot(collection(db, ...basePath, 'logs'), 
                (snap) => {
                    const logs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    logs.sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date));
                    updateState({ logs: logs, isLoading: false });
                }
            );
            
            // Cleanup on module unload (not strictly necessary in this context, but good practice)
            return () => {
                unsubscribeClients();
                unsubscribeServices();
                unsubscribeLogs();
            };
        };

        // Initialize on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            initFirebaseAndLoadData();

            // Setup mobile menu toggle
            const mobileMenuButton = document.querySelector('.md\\:hidden button');
            if(mobileMenuButton) {
                mobileMenuButton.onclick = () => updateState({ sidebarOpen: true });
            }
        });
        
    </script>
</body>
</html>
