<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>청전광장 - 실시간 공유형 사회복지 시스템</title>
    
    <link rel="icon" type="image/png" href="청전로고.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- SheetJS (Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; }
        .input-field {
            width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; outline: none;
            transition: border-color 0.2s, box-shadow 0.2s; background-color: white; font-size: 0.875rem;
        }
        .input-field:focus { border-color: #10b981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1); }
        .input-field:read-only { background-color: #f8fafc; color: #64748b; cursor: default; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        /* [수정] 애니메이션 변경: 슬라이드 효과(translateY) 제거하고 투명도만 조절 */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        
        /* Table Sticky Headers */
        .sticky-col { position: sticky; left: 0; background-color: white; z-index: 10; }
        .sticky-header { position: sticky; top: 0; z-index: 20; }

        /* [신규] 메인 모달 탭 스타일 */
        .modal-tab-btn {
            padding: 0.75rem 1.25rem;
            border-bottom: 2px solid transparent;
            color: #64748b;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s;
            cursor: pointer;
            flex: 1;
            text-align: center;
        }
        .modal-tab-btn:hover { color: #10b981; background-color: #f0fdf4; }
        .modal-tab-btn.active {
            border-bottom-color: #10b981;
            color: #059669;
            font-weight: 800;
            background-color: #fff;
        }
        .modal-tab-content { display: none; }
        .modal-tab-content.active { display: block; animation: fadeIn 0.2s ease-out; }

        /* [수정] 탭 컨텐츠 래퍼 스타일 (스크롤 방식 변경: 전체 스크롤 -> 내부 요소 스크롤) */
        .tab-content-wrapper {
            height: 100%;
            /* overflow-y: auto;  <-- 제거: 전체 스크롤 방지 */
            display: none;
            background-color: #f8fafc;
            position: relative;
            /* Flex 레이아웃 적용 */
            display: none; 
            flex-direction: column;
            overflow: hidden; 
        }
        .tab-content-wrapper.active {
            display: flex; /* block -> flex 변경 */
        }

        /* [신규] 윈도우 모드 스타일 (이동/크기조절 가능) */
        .window-pane {
            position: absolute;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #cbd5e1;
            display: flex;
            flex-direction: column;
            /* overflow: hidden; -> 핸들이 잘리지 않도록 제거하거나 내부 컨텐츠에서 처리 */
            min-width: 300px;
            min-height: 200px;
            will-change: left, top, width, height; 
        }
        
        .window-pane.active {
            z-index: 50 !important;
            border-color: #3b82f6;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05), 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        /* [최적화] 드래그 중인 윈도우 스타일 */
        .window-pane.dragging {
            cursor: grabbing;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }

        /* [핵심 최적화] 드래그 중 내부 컨텐츠 이벤트 차단 */
        .window-pane.dragging .window-content {
            pointer-events: none; 
        }

        .window-header {
            padding: 8px 12px;
            background-color: #f1f5f9;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: grab; /* 이동 커서 */
            user-select: none;
            flex-shrink: 0;
            border-radius: 8px 8px 0 0; /* 상단 라운드 처리 */
        }
        .window-header:active {
            cursor: grabbing;
            background-color: #e2e8f0;
        }

        .window-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #475569;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .window-controls {
            display: flex;
            gap: 6px;
        }
        
        .window-control-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .btn-minimize { background-color: #facc15; }
        .btn-maximize { background-color: #4ade80; }
        .btn-close { background-color: #f87171; }

        .window-content {
            flex: 1;
            /* overflow: auto; <-- 제거 */
            overflow: hidden; /* 스크롤은 내부 컨텐츠에 위임 */
            background-color: white;
            position: relative;
            border-radius: 0 0 8px 8px; /* 하단 라운드 처리 */
            display: flex; /* Flex 적용 */
            flex-direction: column;
        }

        /* [신규] 8방향 리사이즈 핸들 스타일 */
        .resizer {
            position: absolute;
            z-index: 100;
            /* 배경색은 디버깅용 아니면 투명 */
            /* background: rgba(255,0,0,0.1); */ 
        }
        /* 상하좌우 (두께 6px) */
        .resizer-n { top: -3px; left: 6px; right: 6px; height: 6px; cursor: n-resize; }
        .resizer-s { bottom: -3px; left: 6px; right: 6px; height: 6px; cursor: s-resize; }
        .resizer-e { top: 6px; right: -3px; bottom: 6px; width: 6px; cursor: e-resize; }
        .resizer-w { top: 6px; left: -3px; bottom: 6px; width: 6px; cursor: w-resize; }
        /* 모서리 (크기 12px) */
        .resizer-ne { top: -3px; right: -3px; width: 12px; height: 12px; cursor: ne-resize; z-index: 101; }
        .resizer-nw { top: -3px; left: -3px; width: 12px; height: 12px; cursor: nw-resize; z-index: 101; }
        .resizer-se { bottom: -3px; right: -3px; width: 12px; height: 12px; cursor: se-resize; z-index: 101; }
        .resizer-sw { bottom: -3px; left: -3px; width: 12px; height: 12px; cursor: sw-resize; z-index: 101; }

        /* [추가] 커스텀 스크롤바 스타일 (목록 내부 스크롤용) */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* [유지] 상단 탭 바 스타일 (초소형 레이아웃 적용) */
        .tab-bar-container {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            padding: 2px 8px 0; /* 패딩 최소화 */
            background-color: #f1f5f9;
            border-bottom: 1px solid #e2e8f0;
            overflow-x: auto;
            flex-shrink: 0;
            height: 28px; /* 높이 고정으로 컴팩트함 유지 */
        }
        .main-tab {
            display: flex;
            align-items: center;
            gap: 2px; /* 간격 최소화 */
            padding: 0 8px; /* 패딩 대폭 축소 */
            font-size: 0.75rem; /* 폰트 크기 축소 (12px) */
            font-weight: 500;
            color: #64748b;
            background-color: #e2e8f0;
            border-radius: 4px 4px 0 0; /* 라운드 축소 */
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            border-bottom: none;
            white-space: nowrap;
            height: 100%; /* 컨테이너 높이에 맞춤 */
        }
        .main-tab:hover {
            background-color: #e6eff5;
            color: #334155;
        }
        .main-tab.active {
            background-color: #ffffff;
            color: #059669; /* Emerald-600 */
            font-weight: 700;
            border-color: #e2e8f0;
            box-shadow: 0 -1px 2px rgba(0,0,0,0.02);
            position: relative;
            bottom: -1px; /* border-bottom 가리기 */
            z-index: 10;
        }
        .tab-close-btn {
            padding: 0;
            border-radius: 2px;
            opacity: 0.5;
            margin-left: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 12px; /* 버튼 크기 고정 */
            height: 12px;
        }
        .tab-close-btn:hover {
            background-color: #cbd5e1;
            color: #ef4444;
            opacity: 1;
        }
        
        /* Top Navigation Bar Styles */
        .nav-link {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 0.95rem;
            color: #cbd5e1;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }
        .nav-link:hover {
            color: #ffffff;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .nav-link.active {
            color: #ffffff;
            background-color: #059669;
            font-weight: 700;
        }
    </style>
</head>
<!-- [수정] body에서 h-screen, overflow-hidden 제거 -> 전체 스크롤 허용 -->
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- Top Navigation Bar (왼쪽 정렬 유지) -->
    <header class="bg-slate-800 text-white h-14 flex-shrink-0 flex items-center px-4 md:px-6 shadow-md z-50 sticky top-0">
        <!-- Logo -->
        <h1 class="font-bold flex items-center gap-2.5 text-lg cursor-pointer mr-8" onclick="app.setTab('dashboard')">
            <img src="청전로고.png" class="w-7 h-7 object-contain bg-white rounded-full p-0.5" alt="로고" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2903/2903558.png'">
            <span class="tracking-tight">청전광장</span>
        </h1>

        <!-- Desktop Navigation -->
        <nav class="hidden md:flex items-center gap-2">
            <button onclick="app.setTab('dashboard')" class="nav-link" data-tab="dashboard">홈</button>
            <button onclick="app.setTab('clients')" class="nav-link" data-tab="clients">대상자 관리</button>
            <button onclick="app.setTab('logs')" class="nav-link" data-tab="logs">서비스 일지</button>
            <button onclick="app.setTab('statistics')" class="nav-link" data-tab="statistics">통계</button>
            <button onclick="app.setTab('services')" class="nav-link" data-tab="services">서비스 설정</button>
        </nav>

        <!-- Right Side Utils -->
        <div class="flex items-center gap-3 ml-auto">
             <!-- 화면 분할 버튼 -->
            <button onclick="app.toggleSplitView()" id="btn-split-toggle" class="hidden md:flex items-center gap-1.5 px-3 py-1.5 rounded text-xs text-slate-300 hover:text-white border border-slate-600 hover:bg-slate-700 transition-colors" title="화면 분할">
                <span class="font-medium">분할 <span id="split-status-text">OFF</span></span>
            </button>

            <!-- Firebase Status -->
            <div class="hidden md:flex items-center gap-1.5 text-xs bg-slate-900/50 px-2 py-1 rounded text-emerald-400 border border-slate-700">
                연결됨
            </div>

            <!-- Mobile Menu Toggle -->
            <button class="md:hidden p-2 text-slate-300 hover:text-white" onclick="app.toggleMobileMenu()">
                <i data-lucide="menu" size="24"></i>
            </button>
        </div>
    </header>

    <!-- Mobile Navigation Menu (Overlay) -->
    <div id="mobile-menu" class="fixed top-14 left-0 right-0 bg-slate-800 z-40 transform -translate-y-[150%] transition-transform duration-300 ease-in-out shadow-xl md:hidden">
        <div class="p-4 space-y-2">
            <button onclick="app.setTab('dashboard')" class="nav-link w-full justify-start py-2.5" data-tab-mobile="dashboard">홈</button>
            <button onclick="app.setTab('clients')" class="nav-link w-full justify-start py-2.5" data-tab-mobile="clients">대상자 관리</button>
            <button onclick="app.setTab('logs')" class="nav-link w-full justify-start py-2.5" data-tab-mobile="logs">서비스 일지</button>
            <button onclick="app.setTab('statistics')" class="nav-link w-full justify-start py-2.5" data-tab-mobile="statistics">통계</button>
            <button onclick="app.setTab('services')" class="nav-link w-full justify-start py-2.5" data-tab-mobile="services">서비스 설정</button>
            
            <div class="border-t border-slate-700 my-2 pt-2">
                 <button onclick="app.toggleSplitView()" class="nav-link w-full justify-start text-slate-400 py-2.5">화면 분할 토글</button>
            </div>
            <div class="flex items-center gap-2 text-xs text-emerald-400 px-4 py-2">
                Firebase 연결됨
            </div>
        </div>
    </div>

    <!-- Main Content Container -->
    <!-- [수정] h-full, overflow-hidden 제거 -> 내용만큼 늘어나도록 변경 -->
    <main class="flex-1 flex flex-col relative bg-slate-50" id="main-content">
        
        <!-- 열린 탭 바 (Browser Tabs) -->
        <div id="top-tab-bar" class="tab-bar-container sticky top-14 z-40 bg-slate-50">
            <!-- 탭들이 여기에 동적으로 추가됨 -->
        </div>

        <!-- 스크롤 가능한 메인 영역 -->
        <!-- [수정] overflow-hidden 제거 -->
        <div class="flex-1 w-full relative" id="main-view-container">
            <!-- 각 탭의 컨텐츠(div)들이 이곳에 생성되고 유지됩니다 -->
            <div id="initial-loader" class="flex items-center justify-center h-64 text-slate-400">
                <div class="animate-spin mr-2"><i data-lucide="loader-2"></i></div>데이터 불러오는 중...
            </div>
        </div>
    </main>

    <div id="modal-container" class="fixed inset-0 z-[60] hidden flex items-center justify-center modal-overlay p-4 overflow-y-auto"></div>
    <div id="dialog-container" class="fixed inset-0 z-[70] hidden flex items-center justify-center bg-black/50 p-4"></div>

    <!-- Firebase SDK & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAx1EJ_7kawHTzsNS97ts5FjCaTJRqJTdM",
            authDomain: "cj-base.firebaseapp.com",
            projectId: "cj-base",
            storageBucket: "cj-base.firebasestorage.app",
            messagingSenderId: "518471894886",
            appId: "1:518471894886:web:9befd2e6d922b22edd6aa7"
        };

        let db, auth;
        try {
            const fbApp = initializeApp(firebaseConfig);
            db = getFirestore(fbApp);
            auth = getAuth(fbApp);
            signInAnonymously(auth).catch((error) => {
                console.error("익명 로그인 실패:", error);
                alert("로그인 실패: 인터넷 연결을 확인해주세요.");
            });
        } catch (e) {
            console.error("Firebase 초기화 실패:", e);
        }

        const CONSTANTS = {
            DONG_LIST: ['대연동', '감만동', '우암동', '문현동', '용호동', '용당동'],
            STATUS_LIST: ['이용', '장기부재', '종결'],
            CARE_LEVEL_LIST: ['일반', '중점'],
            ECONOMIC_LIST: ['일반(저소득)', '기초수급', '조건부 기초수급', '차상위'],
            HOUSEHOLD_LIST: ['독거세대', '부부세대', '동거', '자녀동거세대', '조손동거세대'],
            PROVIDE_METHOD_LIST: ['전화', '방문', '내방', '기타'],
            DUPLICATE_SERVICE_LIST: ['해당없음', '맞춤돌봄', '노노케어', '보훈재가', '장기요양', '기타'],
            ICT_STATUS_LIST: ['부', '여']
        };
        
        // 탭 이름 매핑
        const TAB_NAMES = {
            dashboard: '홈',
            clients: '대상자 관리',
            logs: '서비스 일지',
            statistics: '통계',
            services: '서비스 설정'
        };

        const getTodayStr = () => {
            const now = new Date();
            return new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        };

        const state = {
            activeTab: 'dashboard',
            // 열린 탭 관리 (브라우저 탭 스타일)
            openedTabs: ['dashboard'],
            // 화면 분할 관련 상태
            viewMode: 'single', // 'single' or 'split'
            focusedPane: 'left', // 'left' or 'right' (현재 활성화된 창)
            paneTabs: {
                left: 'dashboard',
                right: 'logs'
            },
            // [신규] 윈도우 상태 관리 (위치, 크기, z-index)
            windows: {
                left: { x: 20, y: 20, w: 600, h: 700, z: 1 },
                right: { x: 640, y: 20, w: 600, h: 700, z: 2 }
            },
            isMobileMenuOpen: false, // [신규] 모바일 메뉴 상태
            
            // [신규] 각 탭의 렌더링 여부 추적 (최적화용)
            renderedTabs: new Set(),
            
            clients: [],
            services: [],
            logs: [],
            editingServiceId: null,
            ui: {
                regionDropdownOpen: false,
                logRegionDropdownOpen: false,
                statsRegionDropdownOpen: false,
                selectedLogIds: new Set(),
                selectedClientIds: new Set(),
                clientModalTab: 'basic',
                caseSubTab: 'initial' 
            },
            pendingClientData: null,
            pendingLogData: null,
            pendingServiceData: null,
            filters: {
                client: { 
                    status: '이용', level: '', economicStatus: '', duplicateService: '', ictStatus: '', 
                    region: [], gender: '', search: '', searchPhone: '', targetYear: '', targetMonth: '' 
                },
                log: { start: '', end: '', search: '', provider: '', category: '', service: '', region: [] },
                stats: { 
                    start: (() => {
                        const d = new Date();
                        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-01`;
                    })(),
                    end: (() => {
                        const d = new Date();
                        const lastDay = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
                        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${lastDay}`;
                    })(),
                    type: 'detail', region: [], name: '' 
                }
            }
        };

        function calculateAge(birthDate) {
            if (!birthDate) return 0;
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
            return age;
        }

        function getFilteredLogs() {
            const { start, end, search, provider, category, service, region } = state.filters.log;
            return state.logs.filter(l => {
                const client = state.clients.find(c => c.id === l.clientId);
                const clientRegion = client ? client.region : '미지정';
                return (!start || l.date >= start) && 
                       (!end || l.date <= end) && 
                       (!search || l.clientName.includes(search)) && 
                       (!provider || (l.provider && l.provider.includes(provider))) && 
                       (!category || (l.serviceItems && l.serviceItems.some(i => i.category === category))) &&
                       (!service || (l.serviceItems && l.serviceItems.some(i => i.serviceName === service))) &&
                       (region.length === 0 || region.includes(clientRegion));
            });
        }

        function initDataSync() {
            if (!db) return;
            const handleErr = (e) => { if(e.code === 'permission-denied') console.warn("권한 부족: 규칙을 확인하세요."); };

            onSnapshot(query(collection(db, "clients"), orderBy("createdAt", "desc")), (snap) => {
                state.clients = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            }, handleErr);
            
            onSnapshot(collection(db, "services"), (snap) => {
                let loaded = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                const sortOrder = ['위기관리체계구축', '욕구기반 위기관리', '위기상황관리 및 긴급지원', '기타'];
                const caseManagementOrder = ['사례발굴', '초기상담', '사정 및 계획', '개입', '점검 및 모니터링', '종결 및 사후관리'];
                const counselingOrder = ['정서지원서비스(안전안부확인)', '노인일상생활관련 상담', '노인일상생활관련상담', '복지서비스 종합안내'];

                loaded.sort((a, b) => {
                    const catA = (a.majorCategory || '').replace(/\s+/g, '');
                    const catB = (b.majorCategory || '').replace(/\s+/g, '');
                    const indexA = sortOrder.findIndex(k => k.replace(/\s+/g, '') === catA);
                    const indexB = sortOrder.findIndex(k => k.replace(/\s+/g, '') === catB);
                    
                    if (indexA !== -1 && indexB === -1) return -1;
                    if (indexA === -1 && indexB !== -1) return 1;
                    if (indexA !== -1 && indexB !== -1) {
                        if (indexA !== indexB) return indexA - indexB;
                    } else {
                        const majorComp = (a.majorCategory || '').localeCompare(b.majorCategory || '');
                        if (majorComp !== 0) return majorComp;
                    }
                    const catComp = (a.category || '').localeCompare(b.category || '');
                    if (catComp !== 0) return catComp;
                    if (a.category === '사례관리' && b.category === '사례관리') {
                        const nameIndexA = caseManagementOrder.indexOf(a.name);
                        const nameIndexB = caseManagementOrder.indexOf(b.name);
                        if (nameIndexA !== -1 && nameIndexB !== -1) return nameIndexA - nameIndexB;
                    }
                    if (a.category === '노인상담 및 정보제공' && b.category === '노인상담 및 정보제공') {
                        const nameIndexA_C = counselingOrder.indexOf(a.name);
                        const nameIndexB_C = counselingOrder.indexOf(b.name);
                        if (nameIndexA_C !== -1 && nameIndexB_C !== -1) return nameIndexA_C - nameIndexB_C;
                        if (nameIndexA_C !== -1) return -1;
                        if (nameIndexB_C !== -1) return 1;
                    }
                    return (a.name || '').localeCompare(b.name || '');
                });
                state.services = loaded;
                render();
            }, handleErr);
            
            onSnapshot(query(collection(db, "logs"), orderBy("date", "desc")), (snap) => {
                state.logs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            }, handleErr);
        }

        function getTabHTML(tabName) {
            if (tabName === 'dashboard') return renderDashboard();
            if (tabName === 'clients') return renderClientManager();
            if (tabName === 'logs') return renderLogManager();
            if (tabName === 'statistics') return renderStatistics();
            if (tabName === 'services') return renderServiceManager();
            return '';
        }

        // [신규] 특정 탭의 컨텐츠를 DOM에 반영하는 함수 (부분 렌더링)
        function updateTabContent(tabName) {
            const containerId = `tab-view-${tabName}`;
            let container = document.getElementById(containerId);
            
            // 컨테이너가 없으면 생성 (Main Container 내부에)
            if (!container) {
                const mainContainer = document.getElementById('main-view-container');
                if (!mainContainer) return; // 로딩 전

                container = document.createElement('div');
                container.id = containerId;
                // [수정] 탭 컨텐츠 래퍼의 높이 제한 해제 (h-full 제거)
                container.className = 'tab-content-wrapper p-4 md:p-6'; 
                mainContainer.appendChild(container);
            }

            // HTML 컨텐츠 업데이트
            container.innerHTML = getTabHTML(tabName);
            state.renderedTabs.add(tabName);
            
            // 아이콘 리로드
            lucide.createIcons();
        }

        function renderDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const todayLogs = state.logs.filter(l => l.date === today).length;
            const activeClients = state.clients.filter(c => {
                const isTerminated = c.status === '종결' || (c.endDate && c.endDate < today);
                const isNotStarted = c.serviceStartDate && c.serviceStartDate > today;
                return (c.status === '이용' || c.status === '장기부재') && !isTerminated && !isNotStarted;
            });
            const totalActive = activeClients.length;
            const highFocus = activeClients.filter(c => c.careLevel === '중점').length;
            const general = activeClients.filter(c => c.careLevel === '일반').length;

            // [수정] 내부 스크롤 제거 (전체 스크롤 사용)
            return `
                <div class="space-y-6 animate-fade-in p-1">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl md:text-2xl font-bold text-slate-800">홈</h2>
                        <div class="text-xs md:text-sm text-emerald-600 flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>공유 중</div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 md:gap-6">
                        <div onclick="app.setTab('clients')" class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4 cursor-pointer hover:bg-slate-50 transition-colors">
                            <div class="p-3 bg-blue-100 text-blue-600 rounded-lg"><i data-lucide="users"></i></div>
                            <div>
                                <p class="text-sm text-slate-500">총 대상자 <span class="text-xs text-slate-400">(이용/장기부재)</span></p>
                                <p class="text-2xl font-bold text-slate-800">${totalActive}<span class="text-sm font-normal text-slate-500">명</span></p>
                                <p class="text-xs text-slate-400 mt-1">(중점: <span class="text-pink-600 font-bold">${highFocus}</span> / 일반: <span class="text-blue-600 font-bold">${general}</span>)</p>
                            </div>
                        </div>
                        <div onclick="app.setTab('logs')" class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4 cursor-pointer hover:bg-slate-50 transition-colors">
                            <div class="p-3 bg-emerald-100 text-emerald-600 rounded-lg"><i data-lucide="file-text"></i></div>
                            <div><p class="text-sm text-slate-500">오늘 일지</p><p class="text-2xl font-bold text-slate-800">${todayLogs}<span class="text-sm font-normal text-slate-500">건</span></p></div>
                        </div>
                        <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                            <div class="p-3 bg-purple-100 text-purple-600 rounded-lg"><i data-lucide="settings"></i></div>
                            <div><p class="text-sm text-slate-500">제공 서비스</p><p class="text-2xl font-bold text-slate-800">${state.services.length}<span class="text-sm font-normal text-slate-500">개</span></p></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 md:p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">최근 활동</h3>
                        <div class="space-y-3">
                        ${state.logs.length === 0 ? '<p class="text-center text-slate-400 py-4">데이터 없음</p>' : state.logs.slice(0,5).map(log => `
                            <div class="flex flex-col sm:flex-row sm:items-start gap-2 sm:gap-4 pb-3 border-b last:border-0 p-2 hover:bg-slate-50 rounded">
                                <div class="hidden sm:block mt-1 text-slate-500"><i data-lucide="check-circle" size="16"></i></div>
                                <div class="flex-1">
                                    <p class="font-medium text-slate-800 text-sm md:text-base">
                                        <span class="text-emerald-600 font-bold">${log.clientName}</span>님 
                                        <span class="text-xs text-slate-400 mx-1">|</span>
                                        ${log.serviceName}
                                    </p>
                                    <p class="text-xs md:text-sm text-slate-500 mt-1 line-clamp-2">${log.date} | ${log.content}</p>
                                </div>
                            </div>`).join('')}
                        </div>
                    </div>
                </div>`;
        }

        function renderClientManager() {
            const { search, searchPhone, status, level, economicStatus, duplicateService, ictStatus, region, gender, targetYear, targetMonth } = state.filters.client;
            let filterStart = '0000-01-01', filterEnd = '9999-12-31';
            if (targetYear) {
                if (targetMonth) {
                    const m = String(targetMonth).padStart(2, '0');
                    filterStart = `${targetYear}-${m}-01`;
                    const lastDay = new Date(targetYear, targetMonth, 0).getDate();
                    filterEnd = `${targetYear}-${m}-${lastDay}`;
                } else {
                    filterStart = `${targetYear}-01-01`;
                    filterEnd = `${targetYear}-12-31`;
                }
            }
            
            // ... (필터링 로직 동일) ...
            const filtered = state.clients.filter(c => {
                const matchEconomic = !economicStatus || (c.economicStatus && (
                    c.economicStatus === economicStatus || 
                    (economicStatus === '조건부 기초수급' && c.economicStatus === '조건부 수급자') ||
                    (economicStatus === '기초수급' && (c.economicStatus === '기초수급자' || c.economicStatus === '수급자'))
                ));

                const matchBasic = (!search || c.name.includes(search)) &&
                                   (!searchPhone || (c.phone && c.phone.includes(searchPhone))) && 
                                   (!status || c.status === status) &&
                                   (!level || c.careLevel === level) &&
                                   matchEconomic &&
                                   (!duplicateService || c.duplicateService === duplicateService) &&
                                   (!ictStatus || (c.ictStatus || '부') === ictStatus) &&
                                   (region.length === 0 || region.includes(c.region)) &&
                                   (!gender || c.gender === gender);
                if (!matchBasic) return false;
                const sDate = c.serviceStartDate || '0000-01-01'; 
                const eDate = c.endDate || '9999-12-31'; 
                if (sDate > filterEnd) return false;
                if (status && status !== '종결') { if (eDate < filterStart) return false; }
                return true;
            }).sort((a, b) => {
                if (targetYear) {
                    const eDateA = a.endDate || '9999-12-31';
                    const activeA = eDateA >= filterStart;
                    const eDateB = b.endDate || '9999-12-31';
                    const activeB = eDateB >= filterStart;
                    if (activeA && !activeB) return -1;
                    if (!activeA && activeB) return 1;
                }
                return (a.serviceStartDate || '').localeCompare(b.serviceStartDate || '');
            });

            const currentYearStr = String(new Date().getFullYear());
            let activeStats = { total: 0, using: 0, absent: 0, highFocus: 0, general: 0, male: 0, female: 0 };
            let yearStats = { new: 0, end: 0 };
            const today = new Date().toISOString().split('T')[0];

            state.clients.forEach(c => {
                const isTerminatedToday = c.status === '종결' || (c.endDate && c.endDate < today);
                const isNotStartedYet = c.serviceStartDate && c.serviceStartDate > today;
                if ((c.status === '이용' || c.status === '장기부재') && !isTerminatedToday && !isNotStartedYet) {
                    activeStats.total++;
                    if (c.status === '이용') activeStats.using++;
                    else if (c.status === '장기부재') activeStats.absent++;
                    if (c.careLevel === '중점') activeStats.highFocus++;
                    else if (c.careLevel === '일반') activeStats.general++;
                    if (c.gender === '남성') activeStats.male++;
                    else if (c.gender === '여성') activeStats.female++;
                }
                if (c.serviceStartDate && c.serviceStartDate.startsWith(currentYearStr)) yearStats.new++;
                if (c.endDate && c.endDate.startsWith(currentYearStr)) yearStats.end++;
            });

            const yearOptions = [`<option value="" ${!targetYear ? 'selected' : ''}>전체 기간</option>`];
            for (let y = 2010; y <= 2100; y++) yearOptions.push(`<option value="${y}" ${parseInt(targetYear) === y ? 'selected' : ''}>${y}년</option>`);
            const monthOptions = [`<option value="" ${!targetMonth ? 'selected' : ''}>전체 월</option>`];
            for (let m = 1; m <= 12; m++) monthOptions.push(`<option value="${m}" ${parseInt(targetMonth) === m ? 'selected' : ''}>${m}월</option>`);
            
            const filteredTotal = filtered.length;
            const filteredHighFocus = filtered.filter(c => c.careLevel === '중점').length;
            const filteredGeneral = filtered.filter(c => c.careLevel === '일반').length;
            const isFilterActive = search !== '' || searchPhone !== '' || status !== '이용' || level !== '' || economicStatus !== '' || duplicateService !== '' || ictStatus !== '' || region.length > 0 || gender !== '' || targetYear !== '' || targetMonth !== '';

            // [수정] 통계 메뉴처럼 목록 영역에 max-height와 overflow-auto 적용
            return `
                <div class="flex flex-col animate-fade-in">
                    <!-- [고정 영역] 제목, 통계, 필터 (Sticky 제거하고 일반 흐름으로 배치하되, 목록 영역에 스크롤 적용) -->
                    <div class="space-y-6 pb-2 pr-1 transition-all">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 pt-1">
                            <h2 class="text-xl md:text-2xl font-bold text-slate-800">대상자 관리</h2>
                            <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                                <div id="client-batch-actions" class="flex gap-2">
                                    ${state.ui.selectedClientIds.size > 0 ? `
                                        <button onclick="app.openBatchEditClientModal()" class="bg-blue-50 text-blue-600 px-3 py-2 rounded-lg text-xs md:text-sm flex items-center gap-1 flex-1 sm:flex-none justify-center animate-fade-in"><i data-lucide="edit-3" size="14"></i> 일괄수정(${state.ui.selectedClientIds.size})</button>
                                        <button onclick="app.deleteSelectedClients()" class="bg-red-50 text-red-600 px-3 py-2 rounded-lg text-xs md:text-sm flex items-center gap-1 flex-1 sm:flex-none justify-center animate-fade-in"><i data-lucide="trash-2" size="14"></i> 선택삭제(${state.ui.selectedClientIds.size})</button>
                                    ` : ''}
                                </div>
                                <button onclick="app.downloadClientListExcel()" class="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-xs md:text-sm flex items-center gap-1 flex-1 sm:flex-none justify-center"><i data-lucide="download" size="14"></i> 명부 저장</button>
                                <button onclick="app.downloadTemplate()" class="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-xs md:text-sm flex items-center gap-1 flex-1 sm:flex-none justify-center"><i data-lucide="file-text" size="14"></i> 양식</button>
                                <label class="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-xs md:text-sm flex items-center gap-1 cursor-pointer flex-1 sm:flex-none justify-center"><i data-lucide="upload" size="14"></i> 업로드<input type="file" class="hidden" onchange="app.uploadExcel(this)"></label>
                                <button onclick="app.openClientModal()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-xs md:text-sm flex items-center gap-1 flex-1 sm:flex-none justify-center"><i data-lucide="plus" size="16"></i> 등록</button>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-3 justify-start">
                           <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4 min-w-[240px]">
                              <div><p class="text-sm text-slate-500 font-medium leading-tight">이용 대상자</p><p class="text-2xl font-bold text-slate-800 mt-1">${activeStats.total}<span class="text-sm text-slate-400 font-normal ml-1">명 <span class="text-xs text-slate-500 font-normal tracking-tight ml-1">(이용중 : ${activeStats.using} / 장기부재 : ${activeStats.absent})</span></span></p></div>
                              <div class="p-3 bg-emerald-50 rounded-full text-emerald-500 ml-auto"><i data-lucide="user-check" size="24"></i></div>
                           </div>
                           <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-6">
                              <div class="flex flex-col justify-center"><span class="text-xs text-slate-500 font-bold mb-1">등급별</span><div class="text-sm font-bold flex gap-2"><span class="text-pink-600">중점 ${activeStats.highFocus}</span><span class="text-slate-300">|</span><span class="text-blue-600">일반 ${activeStats.general}</span></div></div>
                              <div class="w-px h-8 bg-slate-100"></div>
                              <div class="flex flex-col justify-center"><span class="text-xs text-slate-500 font-bold mb-1">성별</span><div class="text-sm font-bold flex gap-2"><span class="text-blue-500">남 ${activeStats.male}</span><span class="text-slate-300">|</span><span class="text-red-500">여 ${activeStats.female}</span></div></div>
                           </div>
                           <div onclick="app.showYearStatsModal()" class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-6 cursor-pointer hover:bg-slate-50 transition-colors group">
                              <div class="flex flex-col justify-center"><span class="text-xs text-slate-500 font-bold mb-1 group-hover:text-emerald-600 transition-colors">올해 현황 (${currentYearStr})</span><div class="text-sm font-bold flex gap-2"><span class="text-emerald-600">신규 ${yearStats.new}</span><span class="text-slate-300">|</span><span class="text-slate-500">종결 ${yearStats.end}</span></div></div>
                              <div class="p-3 bg-orange-50 rounded-full text-orange-500 ml-auto group-hover:bg-orange-100 transition-colors"><i data-lucide="activity" size="20"></i></div>
                           </div>
                            ${isFilterActive ? `
                           <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-6 animate-fade-in">
                              <div class="flex flex-col justify-center">
                                  <span class="text-xs text-slate-500 font-bold mb-1">조회된 대상자</span>
                                  <div class="text-sm font-bold flex items-baseline gap-1">
                                      <span class="text-xl text-slate-800">${filteredTotal}</span><span class="text-xs text-slate-500 font-normal">명</span>
                                      <span class="text-slate-300 mx-1">|</span>
                                      <span class="text-xs text-slate-500">(중점 <span class="text-pink-600">${filteredHighFocus}</span> / 일반 <span class="text-blue-600">${filteredGeneral}</span>)</span>
                                  </div>
                              </div>
                              <div class="p-3 bg-indigo-50 rounded-full text-indigo-500 ml-auto"><i data-lucide="search" size="20"></i></div>
                           </div>` : ''}
                        </div>
                        
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col gap-2">
                            <div class="flex flex-wrap items-center gap-3 w-full">
                                <div class="flex items-center gap-2 flex-1 min-w-[180px]"><span class="text-sm font-bold text-slate-600 whitespace-nowrap">대상자명</span><input id="client-search-name" class="input-field py-1.5 px-2 text-sm w-full" placeholder="이름 입력 (Enter)" value="${search}" onkeydown="if(event.key === 'Enter') app.setFilter('client','search',this.value)" oninput="if(this.value === '') app.setFilter('client','search','')"></div>
                                <div class="flex items-center gap-2 flex-1 min-w-[180px]"><span class="text-sm font-bold text-slate-600 whitespace-nowrap">연락처</span><input id="client-search-phone" class="input-field py-1.5 px-2 text-sm w-full" placeholder="번호 입력 (Enter)" value="${searchPhone}" onkeydown="if(event.key === 'Enter') app.setFilter('client','searchPhone',this.value)" oninput="if(this.value === '') app.setFilter('client','searchPhone','')"></div>
                                <button onclick="app.resetFilters('client')" class="bg-slate-100 text-slate-500 hover:text-slate-700 text-xs flex items-center gap-1 whitespace-nowrap px-3 py-2 rounded-lg font-medium transition-colors ml-auto sm:ml-0"><i data-lucide="refresh-cw" size="14"></i> 초기화</button>
                            </div>
                            <div class="flex flex-wrap items-center gap-1 sm:gap-2 text-sm pt-2 border-t border-slate-100">
                                <div class="flex items-center gap-1 text-slate-600 font-bold mr-1 flex-shrink-0"><i data-lucide="filter" size="14"></i></div>
                                <select class="input-field py-1.5 px-2 text-sm flex-1 min-w-[90px]" onchange="app.setFilter('client','targetYear',this.value)" title="연도">${yearOptions.join('')}</select>
                                <select class="input-field py-1.5 px-2 text-sm flex-1 min-w-[70px]" onchange="app.setFilter('client','targetMonth',this.value)" title="월">${monthOptions.join('')}</select>
                                <div class="h-4 w-px bg-slate-300 mx-1 hidden sm:block"></div>
                                <select class="input-field py-1.5 px-2 text-sm flex-1 min-w-[70px]" onchange="app.setFilter('client','status',this.value)"><option value="">전체</option>${CONSTANTS.STATUS_LIST.map(s=>`<option value="${s}" ${status===s?'selected':''}>${s}</option>`).join('')}</select>
                                <select class="input-field py-1.5 px-2 text-sm flex-1 min-w-[70px]" onchange="app.setFilter('client','level',this.value)"><option value="">등급</option>${CONSTANTS.CARE_LEVEL_LIST.map(c=>`<option value="${c}" ${level===c?'selected':''}>${c}</option>`).join('')}</select>
                                <div class="relative z-30">
                                    <button onclick="app.toggleRegionDropdown()" class="input-field py-1.5 px-2 text-sm flex items-center justify-between min-w-[100px] bg-white cursor-pointer text-left h-[34px]"><span class="truncate max-w-[90px] text-slate-700">${region.length > 0 ? (region.length === CONSTANTS.DONG_LIST.length ? '전체 동' : region.join(',')) : '전체 동'}</span><i data-lucide="chevron-down" size="14" class="text-slate-400"></i></button>
                                    ${state.ui.regionDropdownOpen ? `<div class="fixed inset-0 z-40" onclick="app.toggleRegionDropdown()"></div><div class="absolute top-full left-0 mt-1 w-48 bg-white border border-slate-200 rounded-lg shadow-xl z-50 p-2 max-h-60 overflow-y-auto animate-fade-in">${CONSTANTS.DONG_LIST.map(d => `<label class="flex items-center gap-2 text-sm p-2 hover:bg-slate-50 rounded cursor-pointer select-none"><input type="checkbox" class="rounded text-emerald-600 focus:ring-emerald-500 w-4 h-4 border-slate-300" ${region.includes(d) ? 'checked' : ''} onchange="app.toggleRegionFilter('${d}')"><span class="text-slate-700">${d}</span></label>`).join('')}</div>` : ''}
                                </div>
                                <select class="input-field py-1.5 px-2 text-sm w-[60px] flex-none" onchange="app.setFilter('client','gender',this.value)"><option value="">성별</option><option value="남성" ${gender==='남성'?'selected':''}>남</option><option value="여성" ${gender==='여성'?'selected':''}>여</option></select>
                                <select class="input-field py-1.5 px-2 text-sm flex-1 min-w-[90px]" onchange="app.setFilter('client','economicStatus',this.value)"><option value="">경제상황</option>${CONSTANTS.ECONOMIC_LIST.map(e=>`<option value="${e}" ${economicStatus===e?'selected':''}>${e}</option>`).join('')}</select>
                                <select class="input-field py-1.5 px-2 text-sm flex-1 min-w-[90px]" onchange="app.setFilter('client','duplicateService',this.value)"><option value="">중복서비스</option>${CONSTANTS.DUPLICATE_SERVICE_LIST.map(d=>`<option value="${d}" ${duplicateService===d?'selected':''}>${d}</option>`).join('')}</select>
                                <select class="input-field py-1.5 px-2 text-sm w-[70px] flex-none" onchange="app.setFilter('client','ictStatus',this.value)"><option value="">ICT</option>${CONSTANTS.ICT_STATUS_LIST.map(i=>`<option value="${i}" ${ictStatus===i?'selected':''}>${i}</option>`).join('')}</select>
                            </div>
                        </div>
                    </div>

                    <!-- [수정] 목록 영역: 고정 높이와 overflow-auto 적용하여 통계 메뉴처럼 내부 스크롤 생성 -->
                    <!-- max-h-[70vh]를 주어 화면이 작아도 스크롤됨. 전체 페이지 스크롤도 가능 -->
                    <div class="overflow-y-auto max-h-[70vh] custom-scrollbar space-y-2 pr-1 pb-4">
                        ${filtered.length === 0 ? `<div class="text-center py-12 bg-white rounded-xl border border-dashed border-slate-200 text-slate-400">검색 결과가 없습니다.</div>` :
                        filtered.map(c => {
                            const isLogicallyTerminated = c.status === '종결' || (c.endDate && c.endDate <= filterEnd);
                            const displayStatus = isLogicallyTerminated ? '종결' : c.status;
                            const statusColor = displayStatus === '종결' ? 'bg-slate-100 text-slate-500' : (displayStatus === '이용' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500');
                            const eDate = c.endDate || '9999-12-31';
                            const wasActiveInPeriod = eDate >= filterStart;
                            const getEconomicDisplay = (status) => {
                                if (status === '일반(저소득)') return '저소득';
                                if (status === '조건부 기초수급' || status === '조건부 수급자') return '조건부';
                                if (status === '기초수급') return '수급자';
                                return status || '-';
                            };
                            const birthShort = c.birthDate ? c.birthDate.substring(2).replace(/-/g, '.') : '-';
                            const genderShort = c.gender === '남성' ? '남' : (c.gender === '여성' ? '여' : c.gender);
                            const genderColorClass = c.gender === '남성' ? 'text-blue-600' : 'text-red-600';

                            return `
                            <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex flex-col md:grid md:grid-cols-[150px_160px_140px_1fr_70px] gap-1 md:items-center group hover:bg-slate-50 transition-colors">
                                <div class="flex items-center gap-2 w-full overflow-hidden">
                                    <input type="checkbox" class="w-4 h-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500 cursor-pointer flex-shrink-0" onchange="app.toggleClientSelection('${c.id}')" ${state.ui.selectedClientIds.has(c.id) ? 'checked' : ''}>
                                    <div class="flex items-center gap-1 overflow-hidden">
                                        <span class="font-bold text-xl text-slate-800 cursor-pointer hover:text-blue-600 truncate flex-shrink-0" onclick="app.openClientModal('${c.id}')" title="상세 정보 보기/수정">${c.name}</span>
                                        <span class="text-sm font-bold text-slate-600 whitespace-nowrap overflow-hidden text-ellipsis">
                                            (${birthShort}/<span class="${genderColorClass}">${genderShort}</span>)
                                        </span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-1 w-full flex-wrap content-start">
                                    <span class="text-xs px-1.5 py-0.5 rounded bg-slate-100 text-slate-600 font-medium whitespace-nowrap border border-slate-200">${c.region}</span>
                                    <span class="text-xs px-1.5 py-0.5 rounded bg-amber-50 text-amber-700 border border-amber-100 font-medium whitespace-nowrap">${getEconomicDisplay(c.economicStatus)}</span>
                                    <span class="text-xs px-1.5 py-0.5 rounded ${c.careLevel==='중점'?'bg-pink-50 text-pink-700 border border-pink-100':'bg-blue-50 text-blue-700 border border-blue-100'} font-medium whitespace-nowrap">${c.careLevel}</span>
                                    <span class="text-xs px-1.5 py-0.5 rounded ${statusColor} font-medium whitespace-nowrap border border-slate-200">${displayStatus}</span>
                                    ${targetYear && wasActiveInPeriod ? `<div class="w-2.5 h-2.5 rounded-full bg-emerald-500 ml-0.5 shadow-sm" title="해당 기간 이용 이력 있음"></div>` : ''}
                                </div>
                                <div class="flex items-center gap-2 w-full overflow-hidden" title="${c.phone||''}${c.phone2 ? ' / ' + c.phone2 : ''}"><span class="truncate text-lg text-slate-900">${c.phone||'-'}${c.phone2 ? ' / ' + c.phone2 : ''}</span></div>
                                <div class="flex items-center gap-2 w-full overflow-hidden" title="${c.address||''}"><span class="truncate text-lg text-slate-900">${c.address||'-'}</span></div>
                                <div class="flex items-center justify-end gap-1 w-full">
                                    <button onclick="app.openClientModal('${c.id}')" class="text-slate-400 hover:text-blue-500 p-1 rounded" title="수정"><i data-lucide="edit" size="12"></i></button>
                                    <button onclick="app.deleteData('clients','${c.id}')" class="text-slate-400 hover:text-red-500 p-1 rounded" title="삭제"><i data-lucide="trash-2" size="12"></i></button>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
        }

        function renderLogManager() {
            const filtered = getFilteredLogs(); 
            const categories = [...new Set(state.services.map(s => s.category))];
            const { category, service, start, end, search, provider, region } = state.filters.log; 
            const filteredServices = category ? state.services.filter(s => s.category === category) : state.services;
            const allSelected = filtered.length > 0 && filtered.every(l => state.ui.selectedLogIds.has(l.id));

            // [수정] 통계 메뉴처럼 목록 영역에 max-height와 overflow-auto 적용
            return `
                <div class="flex flex-col animate-fade-in">
                    <!-- [고정 영역] 제목, 버튼, 필터 -->
                    <div class="space-y-4 pb-2 pr-1 transition-all">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 pt-1">
                            <h2 class="text-xl md:text-2xl font-bold text-slate-800">서비스 일지</h2>
                            <div class="flex flex-wrap items-center gap-2 w-full sm:w-auto">
                                <button onclick="app.downloadLogTemplate()" class="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-1 hover:bg-slate-200 transition-colors"><i data-lucide="file-spreadsheet" size="16"></i> 양식</button>
                                <label class="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-1 cursor-pointer hover:bg-slate-200 transition-colors">
                                    <i data-lucide="upload" size="16"></i> 업로드
                                    <input type="file" class="hidden" onchange="app.uploadLogExcel(this)" accept=".xlsx, .xls">
                                </label>
                                <button onclick="app.printLogs()" class="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-1 hover:bg-slate-200 transition-colors"><i data-lucide="printer" size="16"></i> 인쇄</button>
                                <button onclick="app.downloadLogsExcel()" class="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-1 hover:bg-slate-200 transition-colors"><i data-lucide="download" size="16"></i> 엑셀 저장</button>
                                <button onclick="app.openLogModal()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium hover:bg-emerald-700 transition-colors"><i data-lucide="plus" size="16"></i> 작성</button>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-wrap items-center gap-2">
                            <div class="flex items-center gap-1 text-slate-600 font-bold text-sm mr-2 flex-shrink-0"><i data-lucide="filter" size="14"></i> 필터</div>
                            <div class="flex items-center gap-2 w-full sm:w-auto p-1 bg-slate-50 rounded-lg border border-slate-200">
                                <input type="date" class="bg-transparent border-0 text-sm focus:ring-0 px-1 py-1 w-[110px]" value="${start}" onchange="app.setFilter('log','start',this.value, false)" max="9999-12-31">
                                <span class="text-slate-400">~</span>
                                <input type="date" class="bg-transparent border-0 text-sm focus:ring-0 px-1 py-1 w-[110px]" value="${end}" onchange="app.setFilter('log','end',this.value, false)" max="9999-12-31">
                                <button onclick="app.render()" class="bg-slate-800 text-white px-3 py-1 rounded-md text-sm font-medium hover:bg-slate-700 transition-colors whitespace-nowrap ml-1">조회</button>
                            </div>
                            <input id="log-search-name" class="input-field py-1.5 w-full sm:w-32 text-sm" placeholder="이름 (Enter)" value="${search}" onkeydown="if(event.key === 'Enter') app.setFilter('log','search',this.value)" oninput="if(this.value === '') app.setFilter('log','search','')">
                            <input id="log-search-provider" class="input-field py-1.5 w-full sm:w-32 text-sm" placeholder="제공자 (Enter)" value="${provider || ''}" onkeydown="if(event.key === 'Enter') app.setFilter('log','provider',this.value)" oninput="if(this.value === '') app.setFilter('log','provider','')">
                            <div class="relative z-30 w-full sm:w-auto">
                                <button onclick="app.toggleLogRegionDropdown()" class="input-field py-1.5 px-2 text-sm flex items-center justify-between min-w-[100px] bg-white cursor-pointer text-left h-[34px] w-full sm:w-32"><span class="truncate max-w-[90px] text-slate-700">${region.length > 0 ? (region.length === CONSTANTS.DONG_LIST.length ? '전체 동' : region.join(',')) : '전체 동'}</span><i data-lucide="chevron-down" size="14" class="text-slate-400 ml-2"></i></button>
                                ${state.ui.logRegionDropdownOpen ? `<div class="fixed inset-0 z-40" onclick="app.toggleLogRegionDropdown()"></div><div class="absolute top-full left-0 mt-1 w-40 bg-white border border-slate-200 rounded-lg shadow-xl z-50 p-2 max-h-60 overflow-y-auto animate-fade-in">${CONSTANTS.DONG_LIST.map(d => `<label class="flex items-center gap-2 text-sm p-2 hover:bg-slate-50 rounded cursor-pointer select-none"><input type="checkbox" class="rounded text-emerald-600 focus:ring-emerald-500 w-4 h-4 border-slate-300" ${region.includes(d) ? 'checked' : ''} onchange="app.toggleLogRegionFilter('${d}')"><span class="text-slate-700">${d}</span></label>`).join('')}</div>` : ''}
                            </div>
                            <div class="flex flex-wrap gap-2 w-full sm:w-auto flex-1 min-w-[200px]">
                                <select class="input-field py-1.5 w-full sm:w-32 text-sm flex-1" onchange="app.setFilter('log','category',this.value); app.setFilter('log','service','');"><option value="">서비스(전체)</option>${categories.map(c=>`<option value="${c}" ${category===c?'selected':''}>${c}</option>`).join('')}</select>
                                <select class="input-field py-1.5 w-full sm:w-32 text-sm flex-1" onchange="app.setFilter('log','service',this.value)"><option value="">상세내용(전체)</option>${filteredServices.map(s=>`<option value="${s.name}" ${service===s.name?'selected':''}>${s.name}</option>`).join('')}</select>
                            </div>
                            <button onclick="app.resetFilters('log')" class="ml-auto text-slate-400 hover:text-slate-600 text-xs flex items-center gap-1 flex-shrink-0"><i data-lucide="refresh-cw" size="14"></i> 초기화</button>
                        </div>

                        <div class="flex items-center justify-between px-1 h-8">
                            <div class="flex items-center gap-3">
                                <div class="text-sm text-slate-500">총 <span class="font-bold text-slate-800">${filtered.length}</span>건</div>
                                <label class="flex items-center gap-2 cursor-pointer select-none hover:bg-slate-100 px-2 py-1 rounded transition-colors">
                                    <input type="checkbox" id="log-select-all" class="w-4 h-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500" onchange="app.toggleAllLogs(this.checked)" ${allSelected ? 'checked' : ''} ${filtered.length === 0 ? 'disabled' : ''}>
                                    <span class="text-sm font-medium text-slate-600">전체선택</span>
                                </label>
                            </div>
                            <div class="flex items-center gap-2" id="log-batch-actions">
                                ${state.ui.selectedLogIds.size > 0 ? `
                                    <button onclick="app.openBatchEditLogModal()" class="bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg text-xs font-medium flex items-center gap-1 hover:bg-blue-100 transition-colors animate-fade-in"><i data-lucide="edit-3" size="14"></i> 일괄수정(${state.ui.selectedLogIds.size})</button>
                                    <button onclick="app.deleteSelectedLogs()" class="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg text-xs font-medium flex items-center gap-1 hover:bg-red-100 transition-colors animate-fade-in"><i data-lucide="trash-2" size="14"></i> 선택삭제</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- [목록 영역] max-h 및 overflow-auto 적용 -->
                    <div class="overflow-y-auto max-h-[70vh] custom-scrollbar space-y-4 pr-1 pb-4">
                        ${filtered.length === 0 ? '<div class="text-center py-12 text-slate-400">검색 결과가 없습니다.</div>' : filtered.map(l => {
                            const c = state.clients.find(cl => cl.id === l.clientId);
                            return `
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 flex flex-col md:flex-row items-start gap-6 hover:shadow-md transition-shadow relative">
                                <div class="md:w-1/3 border-b md:border-b-0 md:border-r border-slate-100 pb-4 md:pb-0 md:pr-6 flex-shrink-0 w-full">
                                    <div class="mb-4">
                                        <div class="flex flex-wrap items-center gap-x-2 gap-y-1">
                                            <div class="flex items-center gap-2"><input type="checkbox" class="log-checkbox w-4 h-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500 cursor-pointer" data-id="${l.id}" onchange="app.toggleLogSelection('${l.id}')" ${state.ui.selectedLogIds.has(l.id) ? 'checked' : ''}><span class="text-sm text-slate-500 font-medium whitespace-nowrap">${l.date}</span></div>
                                            <span class="text-slate-300">|</span>
                                            <div class="flex items-baseline gap-1"><span class="font-bold text-slate-800 text-base hover:text-blue-600 cursor-pointer" onclick="app.openClientModal('${l.clientId}')">${l.clientName}</span>${c ? `<span class="text-xs text-slate-500">(${calculateAge(c.birthDate)}세/${c.gender})</span>` : ''}</div>
                                            ${c ? `<div class="flex items-center gap-1 text-xs text-slate-500"><span class="text-slate-300">|</span><span>${c.region}</span><span class="text-slate-300">·</span><span class="${c.careLevel==='중점'?'text-pink-600 font-bold':(c.careLevel==='일반'?'text-blue-600 font-bold':'')}">${c.careLevel}</span></div>` : ''}
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        ${l.serviceItems ? l.serviceItems.map(i => `
                                            <div class="bg-emerald-50/50 border border-emerald-100 rounded-lg px-2.5 py-2 flex flex-col items-start gap-1 text-xs">
                                                <div class="flex items-center gap-1.5 w-full"><div class="w-1.5 h-1.5 rounded-full bg-emerald-500 flex-shrink-0"></div><span class="font-bold text-emerald-800">${i.category}</span></div>
                                                <div class="pl-3 w-full leading-snug text-slate-700"><span class="font-bold">${i.serviceName}</span>${i.detailNote ? `<span class="text-slate-500 font-normal break-all"> - ${i.detailNote}</span>` : ''}</div>
                                            </div>
                                        `).join('') : ''}
                                    </div>
                                </div>
                                <div class="flex-1 relative min-w-0 flex flex-col justify-start h-full">
                                    <div class="flex justify-between items-center mb-2 pt-1">
                                        <div class="flex flex-wrap items-center gap-3">
                                            <div class="text-sm font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1"><i data-lucide="file-text" size="16"></i> 진행 내용</div>
                                            <div class="w-px h-3 bg-slate-300"></div>
                                            <div class="flex items-center gap-2"><span class="text-sm bg-slate-100 text-slate-900 px-2 py-0.5 rounded whitespace-nowrap border border-slate-200">${l.provideMethod || '방문'}</span><span class="text-sm text-slate-900 bg-slate-50 px-2 py-0.5 rounded border border-slate-200">${l.provider || '미지정'}</span></div>
                                        </div>
                                        <div class="flex gap-1 md:absolute md:top-0 md:right-0">
                                            <button onclick="app.duplicateLog('${l.id}')" class="p-1.5 text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 rounded transition-colors" title="복사"><i data-lucide="copy" size="14"></i></button>
                                            <button onclick="app.openLogModal('${l.id}')" class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors" title="수정"><i data-lucide="edit" size="14"></i></button>
                                            <button onclick="app.deleteData('logs','${l.id}')" class="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" title="삭제"><i data-lucide="trash-2" size="14"></i></button>
                                        </div>
                                    </div>
                                    <div class="flex-1 mt-1"><p class="text-slate-800 text-base leading-relaxed whitespace-pre-wrap cursor-pointer p-2 -ml-2 rounded hover:bg-slate-50 hover:text-blue-800 transition-colors mt-0" title="클릭하여 수정하기" onclick="app.openLogModal('${l.id}')">${l.content}</p></div>
                                </div>
                            </div>`
                        }).join('')}
                    </div>
                </div>`;
        }

        function renderStatistics() {
            const { start, end, type, region, name } = state.filters.stats;
            const sYear = start.split('-')[0];
            const eYear = end.split('-')[0];
            const fullYearStart = `${sYear}-01-01`;
            const fullYearEnd = `${eYear}-12-31`;
            const targetClients = state.clients.filter(c => {
                const matchBasic = (region.length === 0 || region.includes(c.region)) && (!name || c.name.includes(name));
                if (!matchBasic) return false;
                const cS = c.serviceStartDate || '0000-01-01';
                const cE = c.endDate || '9999-12-31';
                return cS <= fullYearEnd && cE >= fullYearStart;
            });
            let serviceHeaders = [];
            let headerGroups = {};
            let orderedCategories = [];
            if (type === 'category') {
                serviceHeaders = [...new Set(state.services.map(s => s.category))].filter(Boolean);
            } else {
                orderedCategories = [...new Set(state.services.map(s => s.category || '기타'))];
                state.services.forEach(s => {
                    const cat = s.category || '기타';
                    if (!headerGroups[cat]) headerGroups[cat] = [];
                    if (!headerGroups[cat].includes(s.name)) headerGroups[cat].push(s.name);
                });
                serviceHeaders = orderedCategories.flatMap(cat => headerGroups[cat]);
            }
            const dataMap = {}; 
            targetClients.forEach(c => {
                dataMap[c.id] = { name: c.name, birthDate: c.birthDate || '-', careLevel: c.careLevel || '-', region: (c.region || '-').replace(/동$/, ''), endDate: c.endDate || '9999-12-31', total: 0, emotionalCount: 0, counts: {} };
                serviceHeaders.forEach(k => dataMap[c.id].counts[k] = 0);
            });
            state.logs.forEach(l => {
                if (l.date < start || l.date > end) return;
                let cid = l.clientId;
                if (!dataMap[cid] && l.clientName) { const found = targetClients.find(c => c.name === l.clientName); if(found) cid = found.id; }
                if (dataMap[cid]) {
                    const items = l.serviceItems || [{ serviceName: l.serviceName, category: l.serviceCategory }];
                    items.forEach(item => {
                        let key = type === 'category' ? item.category : item.serviceName;
                        if (!key && item.serviceName && type === 'category') { const s = state.services.find(svc => svc.name === item.serviceName); if(s) key = s.category; }
                        if (item.serviceName && item.serviceName.includes('정서지원')) dataMap[cid].emotionalCount++;
                        if (key && dataMap[cid].counts[key] !== undefined) { dataMap[cid].counts[key]++; dataMap[cid].total++; }
                    });
                }
            });
            const rows = Object.values(dataMap).filter(r => r.total >= 0).sort((a, b) => {
                const levelPriority = { '중점': 1, '일반': 2 };
                const pA = levelPriority[a.careLevel] || 3;
                const pB = levelPriority[b.careLevel] || 3;
                if (pA !== pB) return pA - pB;
                return a.name.localeCompare(b.name);
            });
            const colTotals = {};
            serviceHeaders.forEach(k => colTotals[k] = rows.reduce((sum, r) => sum + (r.counts[k]||0), 0));
            const grandTotal = rows.reduce((sum, r) => sum + r.total, 0);
            const W_No = 30, W_Name = 60, W_Birth = 75, W_Level = 35, W_Region = 35, W_Total = 40;
            const L_No = 0, L1 = W_No, L2 = L1 + W_Name, L3 = L2 + W_Birth, L4 = L3 + W_Level, L5 = L4 + W_Region;
            const stickColStyle = (left, z) => `position: sticky; left: ${left}px; z-index: ${z};`;
            let theadHTML = '';
            const totalRowHTML = `<tr class="bg-slate-100 font-bold shadow-sm border-b border-slate-200"><td class="py-2 px-1 border-r bg-slate-100" style="${stickColStyle(L_No, 50)}"></td><td class="py-2 px-1 border-r text-center text-slate-700 bg-slate-100" style="${stickColStyle(L1, 50)}">총계</td><td class="py-2 px-1 border-r bg-slate-100" style="${stickColStyle(L2, 50)}"></td><td class="py-2 px-1 border-r bg-slate-100" style="${stickColStyle(L3, 50)}"></td><td class="py-2 px-1 border-r bg-slate-100" style="${stickColStyle(L4, 50)}"></td><td class="py-2 px-1 text-center border-r bg-emerald-100 text-emerald-700" style="${stickColStyle(L5, 50)}">${grandTotal}</td>${serviceHeaders.map(k => `<td class="py-2 px-2 text-center border-r text-slate-700">${colTotals[k]}</td>`).join('')}</tr>`;
            if (type === 'category') {
                theadHTML = `<tr><th class="py-2 px-1 border-b border-r min-w-[${W_No}px] bg-slate-50 text-xs text-center font-bold text-slate-500" style="${stickColStyle(L_No, 50)}">No</th><th class="py-2 px-1 border-b border-r min-w-[${W_Name}px] bg-slate-50 text-xs text-center font-bold text-slate-700" style="${stickColStyle(L1, 50)}">대상자</th><th class="py-2 px-1 border-b border-r min-w-[${W_Birth}px] bg-slate-50 text-xs text-center font-bold text-slate-600" style="${stickColStyle(L2, 50)}">생년월일</th><th class="py-2 px-1 border-b border-r min-w-[${W_Level}px] bg-slate-50 text-xs text-center font-bold text-slate-600" style="${stickColStyle(L3, 50)}">등급</th><th class="py-2 px-1 border-b border-r min-w-[${W_Region}px] bg-slate-50 text-xs text-center font-bold text-slate-600" style="${stickColStyle(L4, 50)}">행정동</th><th class="py-2 px-1 bg-emerald-50 text-emerald-700 border-b border-r min-w-[${W_Total}px] text-xs text-center font-bold" style="${stickColStyle(L5, 50)}">합계</th>${serviceHeaders.map(k => `<th class="py-2 px-2 border-b border-r text-xs text-center text-slate-600 bg-slate-50 whitespace-nowrap">${k}</th>`).join('')}</tr>${totalRowHTML}`;
            } else {
                theadHTML = `<tr><th rowspan="2" class="py-2 px-1 border-b border-r min-w-[${W_No}px] bg-slate-50 z-30 text-xs text-center font-bold text-slate-500" style="${stickColStyle(L_No, 50)}">No</th><th rowspan="2" class="py-2 px-1 border-b border-r min-w-[${W_Name}px] bg-slate-50 z-30 text-xs text-center font-bold text-slate-700" style="${stickColStyle(L1, 50)}">대상자</th><th rowspan="2" class="py-2 px-1 border-b border-r min-w-[${W_Birth}px] bg-slate-50 z-30 text-xs text-center font-bold text-slate-600" style="${stickColStyle(L2, 50)}">생년월일</th><th rowspan="2" class="py-2 px-1 border-b border-r min-w-[${W_Level}px] bg-slate-50 z-30 text-xs text-center font-bold text-slate-600" style="${stickColStyle(L3, 50)}">등급</th><th rowspan="2" class="py-2 px-1 border-b border-r min-w-[${W_Region}px] bg-slate-50 z-30 text-xs text-center font-bold text-slate-600" style="${stickColStyle(L4, 50)}">행정동</th><th rowspan="2" class="py-2 px-1 bg-emerald-50 text-emerald-700 border-b border-r min-w-[${W_Total}px] z-30 text-xs text-center font-bold" style="${stickColStyle(L5, 50)}">합계</th>${orderedCategories.map(cat => `<th colspan="${headerGroups[cat].length}" class="py-1 border-b border-r bg-slate-100 text-center text-xs text-center font-semibold text-slate-600 whitespace-nowrap">${cat}</th>`).join('')}</tr><tr>${orderedCategories.map(cat => headerGroups[cat].map(svc => `<th class="py-1.5 px-2 border-b border-r font-normal text-xs text-center text-slate-500 bg-slate-50 whitespace-nowrap">${svc === '정서지원서비스(안전안부확인)' ? '안전안부확인' : svc}</th>`).join('')).join('')}</tr>${totalRowHTML}`;
            }

            // [수정] 전체 스크롤 + Sticky Header 구조로 변경
            return `
                <div class="space-y-6 animate-fade-in p-1">
                    <h2 class="text-2xl font-bold text-slate-800">서비스 제공 통계</h2>
                    <div class="sticky top-0 z-50 bg-slate-50 pt-2 pb-2 shadow-sm -mx-1 px-1">
                        <div class="flex flex-col sm:flex-row flex-wrap gap-2 items-center bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                            <div class="flex bg-slate-100 p-1 rounded w-full sm:w-auto justify-center">
                                <button onclick="app.setFilter('stats','type','category')" class="px-3 py-1 rounded text-sm flex-1 sm:flex-none ${type==='category'?'bg-white shadow':''}">분류별</button>
                                <button onclick="app.setFilter('stats','type','detail')" class="px-3 py-1 rounded text-sm flex-1 sm:flex-none ${type==='detail'?'bg-white shadow':''}">상세별</button>
                            </div>
                            <div class="flex w-full sm:w-auto gap-2">
                                <input id="stats-start" type="date" class="input-field w-full sm:w-32 py-1 text-sm" value="${start}" onchange="app.setStatsStart(this.value)" max="9999-12-31">
                                <input id="stats-end" type="date" class="input-field w-full sm:w-32 py-1 text-sm" value="${end}" onchange="app.setFilter('stats','end',this.value)" max="9999-12-31">
                            </div>
                            <div class="flex w-full sm:w-auto gap-2 flex-1">
                                <input id="stats-search-name" class="input-field w-full sm:w-24 py-1 text-sm" placeholder="이름 (Enter)" value="${name}" onkeydown="if(event.key === 'Enter') app.setFilter('stats','name',this.value)" oninput="if(this.value === '') app.setFilter('stats','name','')">
                                <div class="relative z-30 w-full sm:w-auto">
                                    <button onclick="app.toggleStatsRegionDropdown()" class="input-field py-1.5 px-2 text-sm flex items-center justify-between min-w-[100px] bg-white cursor-pointer text-left h-[30px] w-full sm:w-24"><span class="truncate max-w-[80px] text-slate-700">${region.length > 0 ? (region.length === CONSTANTS.DONG_LIST.length ? '전체 동' : region.join(',')) : '전체 동'}</span><i data-lucide="chevron-down" size="14" class="text-slate-400 ml-2"></i></button>
                                    ${state.ui.statsRegionDropdownOpen ? `<div class="fixed inset-0 z-40" onclick="app.toggleStatsRegionDropdown()"></div><div class="absolute top-full left-0 mt-1 w-40 bg-white border border-slate-200 rounded-lg shadow-xl z-50 p-2 max-h-60 overflow-y-auto animate-fade-in">${CONSTANTS.DONG_LIST.map(d => `<label class="flex items-center gap-2 text-sm p-2 hover:bg-slate-50 rounded cursor-pointer select-none"><input type="checkbox" class="rounded text-emerald-600 focus:ring-emerald-500 w-4 h-4 border-slate-300" ${region.includes(d) ? 'checked' : ''} onchange="app.toggleStatsRegionFilter('${d}')"><span class="text-slate-700">${d}</span></label>`).join('')}</div>` : ''}
                                </div>
                            </div>
                            <button onclick="app.resetFilters('stats')" class="w-full sm:w-auto text-slate-400 hover:text-slate-600 p-2 rounded hover:bg-slate-100 transition-colors flex justify-center items-center flex-shrink-0" title="필터 초기화"><i data-lucide="refresh-cw" size="20"></i></button>
                            <button onclick="app.downloadStatsExcel()" class="w-full sm:w-auto bg-emerald-600 text-white p-2 rounded flex justify-center items-center flex-shrink-0"><i data-lucide="download" size="20"></i></button>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-auto max-h-[600px]">
                        <table class="w-auto text-sm text-left border-collapse whitespace-nowrap">
                            <thead class="sticky-header bg-slate-50 text-slate-600 font-semibold z-20 shadow-sm" style="position: sticky; top: 0; z-index: 40;">${theadHTML}</thead>
                            <tbody class="divide-y divide-slate-100">
                                ${rows.map((r, index) => {
                                    const careLevelClass = r.careLevel === '중점' ? 'text-pink-600 font-bold' : (r.careLevel === '일반' ? 'text-blue-600 font-bold' : 'text-slate-500');
                                    const isTerminatedInPeriod = r.endDate <= fullYearEnd; 
                                    let isDeficient = false;
                                    if (!isTerminatedInPeriod) {
                                        if (r.careLevel === '중점' && r.emotionalCount < 4) isDeficient = true;
                                        else if (r.careLevel === '일반' && r.emotionalCount < 1) isDeficient = true;
                                    }
                                    return `
                                    <tr class="hover:bg-slate-50 group">
                                        <td class="py-1.5 px-1 border-r text-center text-slate-400 text-xs bg-white" style="${stickColStyle(L_No, 30)}">${index + 1}</td>
                                        <td class="py-1.5 px-1 border-r group-hover:bg-slate-50 text-center font-medium text-slate-800 bg-white" style="${stickColStyle(L1, 30)}">${r.name}</td>
                                        <td class="py-1.5 px-1 text-center border-r text-slate-500 text-xs bg-white" style="${stickColStyle(L2, 30)}">${r.birthDate}</td>
                                        <td class="py-1.5 px-1 text-center border-r text-xs bg-white ${careLevelClass}" style="${stickColStyle(L3, 30)}">${r.careLevel}</td>
                                        <td class="py-1.5 px-1 text-center border-r text-slate-500 text-xs bg-white" style="${stickColStyle(L4, 30)}">${r.region}</td>
                                        <td class="p-1.5 text-center font-bold border-r text-emerald-600 bg-emerald-50" style="${stickColStyle(L5, 30)}">${r.total}</td>
                                        ${serviceHeaders.map(k => {
                                            const isTargetCell = isDeficient && k.includes('정서지원');
                                            let cellClass = "p-1.5 px-2 text-center border-r";
                                            if (isTargetCell) { cellClass += " text-red-600 font-bold bg-red-50"; } else { if (r.counts[k] > 0) { cellClass += " bg-blue-50 font-medium text-blue-600"; } else { cellClass += " text-slate-300"; } }
                                            return `<td class="${cellClass}">${r.counts[k]||'-'}</td>`;
                                        }).join('')}
                                    </tr>
                                `;}).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderServiceManager() {
            const isEditing = !!state.editingServiceId;
            const editData = isEditing ? state.services.find(s => s.id === state.editingServiceId) : {};
            
            // [수정] 내부 스크롤 제거 (전체 스크롤 사용)
            return `
                <div class="space-y-6 animate-fade-in p-1">
                    <h2 class="text-2xl font-bold text-slate-800">서비스 목록 설정</h2>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <form onsubmit="app.addService(event)" class="flex flex-col sm:flex-row flex-wrap gap-4 items-end">
                            <div class="w-full sm:flex-1 min-w-[140px]"><label class="block text-sm font-medium text-slate-700 mb-1">서비스 대분류</label><input name="majorCategory" class="input-field" placeholder="예: 위기관리" value="${editData.majorCategory || ''}" list="list-major" autocomplete="off"><datalist id="list-major">${[...new Set(state.services.map(s=>s.majorCategory).filter(Boolean))].sort().map(v=>`<option value="${v}">`).join('')}</datalist></div>
                            <div class="w-full sm:flex-1 min-w-[140px]"><label class="block text-sm font-medium text-slate-700 mb-1">서비스</label><input name="category" class="input-field" placeholder="예: 사례관리" required value="${editData.category || ''}" list="list-cat" autocomplete="off"><datalist id="list-cat">${[...new Set(state.services.map(s=>s.category).filter(Boolean))].sort().map(v=>`<option value="${v}">`).join('')}</datalist></div>
                            <div class="w-full sm:flex-1 min-w-[140px]"><label class="block text-sm font-medium text-slate-700 mb-1">서비스 상세내용</label><input name="name" class="input-field" placeholder="예: 초기상담" required value="${editData.name || ''}" list="list-name" autocomplete="off"><datalist id="list-name">${[...new Set(state.services.map(s=>s.name).filter(Boolean))].sort().map(v=>`<option value="${v}">`).join('')}</datalist></div>
                            <div class="w-full sm:flex-1 min-w-[140px]"><label class="block text-sm font-medium text-slate-700 mb-1">예시</label><input name="example" class="input-field" placeholder="예: 가정방문" value="${editData.example || ''}"></div>
                            <div class="w-full sm:w-auto flex gap-2">
                                ${isEditing ? `<button type="button" onclick="app.cancelEditService()" class="flex-1 sm:flex-none bg-slate-200 text-slate-600 px-4 py-2 rounded-lg hover:bg-slate-300 h-[42px] whitespace-nowrap">취소</button>` : ''}
                                <button type="submit" class="flex-1 sm:flex-none bg-slate-800 text-white px-6 py-2 rounded-lg hover:bg-slate-700 h-[42px] whitespace-nowrap">${isEditing ? '수정' : '추가'}</button>
                            </div>
                        </form>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden overflow-x-auto">
                        <table class="w-full text-left min-w-[800px]">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="p-4 font-semibold text-slate-600 whitespace-nowrap w-[20%]">서비스 대분류</th>
                                    <th class="p-4 font-semibold text-slate-600 whitespace-nowrap w-[20%]">서비스</th>
                                    <th class="p-4 font-semibold text-slate-600 whitespace-nowrap w-[25%]">서비스 상세내용</th>
                                    <th class="p-4 font-semibold text-slate-600 whitespace-nowrap w-[25%]">예시</th>
                                    <th class="p-4 font-semibold text-slate-600 text-right whitespace-nowrap w-[10%]">관리</th>
                                </tr>
                            </thead>
                            <tbody>${state.services.map(s => `
                                <tr class="border-t border-slate-100 hover:bg-slate-50 ${state.editingServiceId === s.id ? 'bg-slate-100' : ''}">
                                    <td class="p-4 text-slate-800">${s.majorCategory || '-'}</td>
                                    <td class="p-4 text-slate-500"><span class="bg-slate-100 px-2 py-1 rounded text-xs">${s.category}</span></td>
                                    <td class="p-4 text-slate-800 font-medium">${s.name}</td>
                                    <td class="p-4 text-slate-600 text-sm">${s.example || '-'}</td>
                                    <td class="p-4 text-right flex justify-end gap-1">
                                        <button onclick="app.editService('${s.id}')" class="text-slate-400 hover:text-blue-500 p-1"><i data-lucide="edit" size="18"></i></button>
                                        <button onclick="app.deleteData('services','${s.id}')" class="text-slate-400 hover:text-red-600 p-1"><i data-lucide="trash-2" size="18"></i></button>
                                    </td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        window.app = {
            setTab: (t) => { 
                // 탭 열기 로직
                if (!state.openedTabs.includes(t)) {
                    state.openedTabs.push(t);
                }

                if (state.viewMode === 'single') {
                    state.activeTab = t; 
                } else {
                    state.paneTabs[state.focusedPane] = t;
                }
                
                // 모바일 메뉴 닫기
                state.isMobileMenuOpen = false;

                // [최적화] 전체 render() 대신 UI 상태만 변경하여 즉시 반응
                app.updateTabVisibility(); 
            },
            
            // [신규] 탭 가시성 및 상단 탭바만 빠르게 업데이트
            updateTabVisibility: () => {
                const currentTab = state.viewMode === 'single' ? state.activeTab : state.paneTabs[state.focusedPane];

                // 1. 상단 탭바 업데이트 (렌더링 비용 낮음)
                app.renderTabBar(currentTab);
                
                // 2. 상단 네비게이션 버튼 스타일 업데이트
                document.querySelectorAll('.nav-link').forEach(b => { 
                    const tabKey = b.dataset.tab || b.dataset.tabMobile;
                    if(tabKey === currentTab) b.classList.add('active'); 
                    else b.classList.remove('active'); 
                });

                // 3. 메인 컨텐츠 영역 Show/Hide (DOM 교체 없이 display 속성만 변경)
                if (state.viewMode === 'single') {
                    // 싱글 뷰 모드
                    const mainContainer = document.getElementById('main-view-container');
                    if(mainContainer) {
                        mainContainer.className = "flex-1 w-full relative overflow-hidden flex flex-col"; // 레이아웃 초기화
                        mainContainer.style.backgroundColor = ""; // 배경 초기화
                        mainContainer.innerHTML = ""; // 윈도우 모드 잔재 제거

                        // 기존 싱글 뷰 로직 복구: tab-content-wrapper 사용
                        // (하지만 innerHTML=""로 인해 래퍼가 사라졌을 수 있으므로 다시 생성 로직 필요)
                        // updateTabContent가 래퍼 없으면 생성하므로 호출하면 됨
                        
                        updateTabContent(state.activeTab);
                        const activeView = document.getElementById(`tab-view-${state.activeTab}`);
                        if (activeView) activeView.classList.add('active');
                        
                        // 다른 탭 숨김 (DOM이 살아있다면)
                        state.openedTabs.forEach(t => {
                            if (t !== state.activeTab) {
                                const v = document.getElementById(`tab-view-${t}`);
                                if (v) v.classList.remove('active');
                            }
                        });
                    }
                } else {
                    // 분할(윈도우) 뷰 모드
                    render(); // 윈도우 모드는 구조가 완전히 다르므로 전체 렌더링
                }
            },

            // [신규] 상단 탭바만 별도 렌더링
            renderTabBar: (currentTab) => {
                const tabBar = document.getElementById('top-tab-bar');
                if (tabBar) {
                    tabBar.innerHTML = state.openedTabs.map(t => {
                        const isActive = t === currentTab;
                        return `
                        <div class="main-tab ${isActive ? 'active' : ''}" onclick="app.setTab('${t}')">
                            <span>${TAB_NAMES[t] || t}</span>
                            <button onclick="app.closeTab('${t}', event)" class="tab-close-btn" title="탭 닫기">
                                <i data-lucide="x" size="8"></i>
                            </button>
                        </div>`;
                    }).join('');
                    lucide.createIcons();
                }
            },

            closeTab: (t, e) => {
                if (e) e.stopPropagation();
                // 탭 제거
                state.openedTabs = state.openedTabs.filter(tab => tab !== t);
                
                // DOM 요소도 제거 (메모리 관리)
                const view = document.getElementById(`tab-view-${t}`);
                if (view) view.remove();
                state.renderedTabs.delete(t);

                // 만약 모든 탭을 닫았다면 기본값 추가
                if (state.openedTabs.length === 0) {
                    state.openedTabs.push('dashboard');
                }

                // 현재 보고 있던 탭을 닫았을 경우 처리
                const fallbackTab = state.openedTabs[state.openedTabs.length - 1]; 
                
                if (state.viewMode === 'single') {
                    if (state.activeTab === t) {
                        state.activeTab = fallbackTab;
                        app.updateTabVisibility(); // 최적화된 전환
                    } else {
                        app.renderTabBar(state.activeTab); // 탭바만 갱신
                    }
                } else {
                    if (state.paneTabs.left === t) state.paneTabs.left = fallbackTab;
                    if (state.paneTabs.right === t) state.paneTabs.right = fallbackTab;
                    render();
                }
            },
            toggleSplitView: () => {
                state.isMobileMenuOpen = false; // 메뉴 닫기
                if (state.viewMode === 'single') {
                    state.viewMode = 'split';
                    state.paneTabs.left = state.activeTab;
                    state.paneTabs.right = (state.activeTab === 'logs' ? 'clients' : 'logs');
                    if (!state.openedTabs.includes(state.paneTabs.right)) state.openedTabs.push(state.paneTabs.right);
                    state.focusedPane = 'left';
                    document.getElementById('split-status-text').textContent = 'ON';
                    document.getElementById('btn-split-toggle').classList.add('bg-slate-700', 'text-emerald-400', 'border-emerald-500');
                    
                    // [수정] 윈도우 모드 진입 시 전체 스크롤 방지 및 배경 고정 (App-like feel)
                    document.body.style.overflow = 'hidden';
                    document.body.style.height = '100vh';

                    // 윈도우 초기 위치 설정 (화면 크기에 맞춰 중앙 정렬)
                    const container = document.getElementById('main-content');
                    const w = container ? container.clientWidth : window.innerWidth;
                    const h = container ? container.clientHeight : window.innerHeight;
                    const winW = Math.min(600, w / 2 - 20);
                    const winH = h - 100;
                    
                    state.windows.left = { x: 20, y: 20, w: winW, h: winH, z: 10 };
                    state.windows.right = { x: winW + 40, y: 20, w: winW, h: winH, z: 9 };

                    // 분할 모드 진입 시에는 DOM 구조가 바뀌므로 전체 렌더링
                    render();
                } else {
                    state.viewMode = 'single';
                    state.activeTab = state.paneTabs.left;
                    document.getElementById('split-status-text').textContent = 'OFF';
                    document.getElementById('btn-split-toggle').classList.remove('bg-slate-700', 'text-emerald-400', 'border-emerald-500');
                    
                    // [수정] 싱글 모드 복귀 시 전체 스크롤 허용 (Web-like feel)
                    document.body.style.overflow = '';
                    document.body.style.height = '';

                    // 싱글 모드 복귀 시 DOM 재구성 (기존 탭 뷰들 복원)
                    const mainContainer = document.getElementById('main-view-container');
                    if(mainContainer) {
                        mainContainer.innerHTML = ''; // 분할 뷰 초기화
                        state.renderedTabs.clear(); // 렌더링 상태 초기화 (다시 그림)
                    }
                    app.updateTabVisibility();
                }
            },
            
            // [유지] 윈도우 드래그 시작 (직접 이동 + 성능 최적화)
            startDrag: (e, paneId) => {
                e.preventDefault();
                app.setFocusedPane(paneId);
                
                const winState = state.windows[paneId];
                const el = document.getElementById(`window-${paneId}`);
                if (!el) return;

                const startX = e.clientX;
                const startY = e.clientY;
                const initialLeft = winState.x;
                const initialTop = winState.y;

                el.classList.add('dragging');
                document.body.style.userSelect = 'none';
                document.body.style.cursor = 'grabbing';

                let currentX = startX;
                let currentY = startY;
                let rafId = null;

                const updatePosition = () => {
                    const dx = currentX - startX;
                    const dy = currentY - startY;
                    
                    winState.x = initialLeft + dx;
                    winState.y = initialTop + dy;
                    
                    el.style.left = `${winState.x}px`;
                    el.style.top = `${winState.y}px`;
                    
                    rafId = null;
                };

                const onMove = (moveEvent) => {
                    currentX = moveEvent.clientX;
                    currentY = moveEvent.clientY;
                    if (!rafId) rafId = requestAnimationFrame(updatePosition);
                };

                const onUp = () => {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                    if (rafId) cancelAnimationFrame(rafId);
                    
                    el.classList.remove('dragging');
                    document.body.style.userSelect = '';
                    document.body.style.cursor = '';
                };

                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            },

            // [대폭 수정] 윈도우 크기 조절 시작 (8방향 지원)
            startResize: (e, paneId, direction) => {
                e.preventDefault();
                e.stopPropagation();
                app.setFocusedPane(paneId);
                
                const winState = state.windows[paneId];
                const el = document.getElementById(`window-${paneId}`);
                if (!el) return;

                const startX = e.clientX;
                const startY = e.clientY;
                
                // 초기 상태 저장
                const initialX = winState.x;
                const initialY = winState.y;
                const initialW = winState.w;
                const initialH = winState.h;

                el.classList.add('dragging'); // 컨텐츠 이벤트 차단
                document.body.style.userSelect = 'none';
                
                // 방향에 따른 커서 설정
                const cursorMap = {
                    'n': 'n-resize', 's': 's-resize', 'e': 'e-resize', 'w': 'w-resize',
                    'ne': 'ne-resize', 'nw': 'nw-resize', 'se': 'se-resize', 'sw': 'sw-resize'
                };
                document.body.style.cursor = cursorMap[direction];

                let currentX = startX;
                let currentY = startY;
                let rafId = null;

                const updateSize = () => {
                    const dx = currentX - startX;
                    const dy = currentY - startY;
                    
                    let newW = initialW;
                    let newH = initialH;
                    let newX = initialX;
                    let newY = initialY;

                    // 동(East) - 너비만 증가
                    if (direction.includes('e')) {
                        newW = Math.max(300, initialW + dx);
                    }
                    // 서(West) - 너비 증가 및 X좌표 이동
                    if (direction.includes('w')) {
                        const proposedW = initialW - dx;
                        newW = Math.max(300, proposedW);
                        // 너비가 최소값(300)에 걸리면 위치도 멈춰야 함 (드래그한 만큼만 이동)
                        newX = initialX + (initialW - newW); 
                    }
                    // 남(South) - 높이만 증가
                    if (direction.includes('s')) {
                        newH = Math.max(200, initialH + dy);
                    }
                    // 북(North) - 높이 증가 및 Y좌표 이동
                    if (direction.includes('n')) {
                        const proposedH = initialH - dy;
                        newH = Math.max(200, proposedH);
                        newY = initialY + (initialH - newH);
                    }

                    // 상태 업데이트
                    winState.x = newX;
                    winState.y = newY;
                    winState.w = newW;
                    winState.h = newH;
                    
                    // 스타일 적용
                    el.style.width = `${newW}px`;
                    el.style.height = `${newH}px`;
                    el.style.left = `${newX}px`;
                    el.style.top = `${newY}px`;
                    
                    rafId = null;
                };

                const onMove = (moveEvent) => {
                    currentX = moveEvent.clientX;
                    currentY = moveEvent.clientY;
                    if (!rafId) rafId = requestAnimationFrame(updateSize);
                };

                const onUp = () => {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                    if (rafId) cancelAnimationFrame(rafId);
                    
                    el.classList.remove('dragging');
                    document.body.style.userSelect = '';
                    document.body.style.cursor = '';
                };

                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            },

            // [신규] 모바일 메뉴 토글
            toggleMobileMenu: () => {
                state.isMobileMenuOpen = !state.isMobileMenuOpen;
                const menu = document.getElementById('mobile-menu');
                if (state.isMobileMenuOpen) {
                    menu.classList.remove('-translate-y-[150%]');
                } else {
                    menu.classList.add('-translate-y-[150%]');
                }
            },

            setFocusedPane: (pane) => {
                state.focusedPane = pane;
                // Z-Index 업데이트
                state.windows.left.z = pane === 'left' ? 10 : 1;
                state.windows.right.z = pane === 'right' ? 10 : 1;
                
                const leftEl = document.getElementById('window-left');
                const rightEl = document.getElementById('window-right');
                
                if (leftEl) {
                    leftEl.style.zIndex = state.windows.left.z;
                    if (pane === 'left') leftEl.classList.add('active'); else leftEl.classList.remove('active');
                }
                if (rightEl) {
                    rightEl.style.zIndex = state.windows.right.z;
                    if (pane === 'right') rightEl.classList.add('active'); else rightEl.classList.remove('active');
                }
                
                app.renderTabBar(state.paneTabs[pane]);
            },
            setFilter: (s, k, v, doRender = true) => { 
                state.filters[s][k] = v; 
                if(doRender) {
                    // 전체 렌더링 대신 현재 탭 컨텐츠만 업데이트 (깜빡임 방지)
                    if (state.viewMode === 'single') {
                        updateTabContent(state.activeTab);
                    } else {
                        render();
                    }
                }
            },
            render: () => render(), // 외부 호출용 (데이터 변경 시 등)
            toggleRegionDropdown: () => { 
                state.ui.regionDropdownOpen = !state.ui.regionDropdownOpen; 
                if(state.viewMode==='single') updateTabContent('clients'); else render(); 
            },
            toggleRegionFilter: (val) => { 
                const r = state.filters.client.region; const idx = r.indexOf(val); if (idx > -1) r.splice(idx, 1); else r.push(val); 
                if(state.viewMode==='single') updateTabContent('clients'); else render(); 
            },
            toggleLogRegionDropdown: () => { 
                state.ui.logRegionDropdownOpen = !state.ui.logRegionDropdownOpen; 
                if(state.viewMode==='single') updateTabContent('logs'); else render(); 
            },
            toggleLogRegionFilter: (val) => { 
                const r = state.filters.log.region; const idx = r.indexOf(val); if (idx > -1) r.splice(idx, 1); else r.push(val); 
                if(state.viewMode==='single') updateTabContent('logs'); else render(); 
            },
            toggleStatsRegionDropdown: () => { 
                state.ui.statsRegionDropdownOpen = !state.ui.statsRegionDropdownOpen; 
                if(state.viewMode==='single') updateTabContent('statistics'); else render(); 
            },
            toggleStatsRegionFilter: (val) => { 
                const r = state.filters.stats.region; const idx = r.indexOf(val); if (idx > -1) r.splice(idx, 1); else r.push(val); 
                if(state.viewMode==='single') updateTabContent('statistics'); else render(); 
            },
            resetFilters: (section) => {
                if (section === 'client') {
                    state.filters.client = { 
                        status: '이용', level: '', economicStatus: '', duplicateService: '', ictStatus: '', 
                        region: [], gender: '', search: '', searchPhone: '', targetYear: '', targetMonth: '' 
                    };
                    state.ui.regionDropdownOpen = false;
                    if(state.viewMode==='single') updateTabContent('clients');
                } else if (section === 'log') {
                    state.filters.log = { start: '', end: '', search: '', provider: '', category: '', service: '', region: [] };
                    state.ui.logRegionDropdownOpen = false;
                    if(state.viewMode==='single') updateTabContent('logs');
                } else if (section === 'stats') {
                    const d = new Date();
                    const s = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-01`;
                    const l = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
                    const e = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${l}`;
                    state.filters.stats = { start: s, end: e, type: 'detail', region: [], name: '' };
                    state.ui.statsRegionDropdownOpen = false;
                    if(state.viewMode==='single') updateTabContent('statistics');
                }
                if (state.viewMode !== 'single') render();
            },

            toggleLogSelection: (id) => { 
                if (state.ui.selectedLogIds.has(id)) state.ui.selectedLogIds.delete(id); 
                else state.ui.selectedLogIds.add(id); 
                app.updateLogBatchActionsUI(); 
            },
            updateLogBatchActionsUI: () => {
                const container = document.getElementById('log-batch-actions');
                const selectAllCheckbox = document.getElementById('log-select-all');
                if (!container) return; 
                const count = state.ui.selectedLogIds.size;
                if (count > 0) {
                    container.innerHTML = `<button onclick="app.openBatchEditLogModal()" class="bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg text-xs font-medium flex items-center gap-1 hover:bg-blue-100 transition-colors animate-fade-in"><i data-lucide="edit-3" size="14"></i> 일괄수정(${count})</button><button onclick="app.deleteSelectedLogs()" class="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg text-xs font-medium flex items-center gap-1 hover:bg-red-100 transition-colors animate-fade-in"><i data-lucide="trash-2" size="14"></i> 선택삭제</button>`;
                    lucide.createIcons();
                } else {
                    container.innerHTML = '';
                }
                if (selectAllCheckbox) {
                    const filtered = getFilteredLogs();
                    const allSelected = filtered.length > 0 && filtered.every(l => state.ui.selectedLogIds.has(l.id));
                    selectAllCheckbox.checked = allSelected;
                }
            },
            toggleAllLogs: (checked) => {
                const filtered = getFilteredLogs();
                if (checked) { filtered.forEach(l => state.ui.selectedLogIds.add(l.id)); }
                else { filtered.forEach(l => state.ui.selectedLogIds.delete(l.id)); }
                const checkboxes = document.querySelectorAll('.log-checkbox');
                checkboxes.forEach(cb => { cb.checked = checked; });
                app.updateLogBatchActionsUI();
            },
            deleteSelectedLogs: () => {
                const count = state.ui.selectedLogIds.size;
                if (count === 0) return;
                showDialog(`<div class="bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl transform transition-all scale-100"><div class="text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4"><i data-lucide="alert-triangle" class="text-red-600" size="24"></i></div><h3 class="text-lg font-bold text-slate-900 mb-2">일괄 삭제 확인</h3><p class="text-sm text-slate-500 mb-6">선택한 <span class="font-bold text-red-600">${count}개</span>의 일지를 삭제하시겠습니까?<br>이 작업은 되돌릴 수 없습니다.</p><div class="flex gap-3 justify-center"><button onclick="app.executeDeleteSelectedLogs()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium shadow-sm transition-colors">예, 삭제</button><button onclick="app.closeDialog()" class="flex-1 px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 font-medium transition-colors">아니오</button></div></div></div>`);
                lucide.createIcons();
            },
            openBatchEditClientModal: () => {
                const count = state.ui.selectedClientIds.size;
                if (count === 0) return;
                const html = `<div class="bg-white w-full max-w-md p-6 rounded-xl shadow-xl mx-4"><div class="flex items-center gap-2 mb-4"><div class="p-2 bg-blue-100 text-blue-600 rounded-full"><i data-lucide="edit-3" size="20"></i></div><h3 class="font-bold text-lg text-slate-900">대상자 일괄 수정 (${count}명)</h3></div><p class="text-sm text-slate-500 mb-6 bg-slate-50 p-3 rounded">체크박스를 선택한 항목만 일괄 변경됩니다.<br>선택하지 않은 항목은 기존 값이 유지됩니다.</p><form onsubmit="app.executeBatchEditClients(event)"><div class="space-y-4"><div class="flex items-center gap-3"><input type="checkbox" id="chk-region" class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer" onchange="document.getElementById('val-region').disabled = !this.checked"><label for="chk-region" class="w-24 text-sm font-bold text-slate-700 cursor-pointer">행정동</label><select id="val-region" class="input-field flex-1 py-1.5 text-sm disabled:bg-slate-100 disabled:text-slate-400" disabled>${CONSTANTS.DONG_LIST.map(d => `<option value="${d}">${d}</option>`).join('')}</select></div><div class="flex items-center gap-3"><input type="checkbox" id="chk-careLevel" class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer" onchange="document.getElementById('val-careLevel').disabled = !this.checked"><label for="chk-careLevel" class="w-24 text-sm font-bold text-slate-700 cursor-pointer">등급</label><select id="val-careLevel" class="input-field flex-1 py-1.5 text-sm disabled:bg-slate-100 disabled:text-slate-400" disabled>${CONSTANTS.CARE_LEVEL_LIST.map(v => `<option value="${v}">${v}</option>`).join('')}</select></div><div class="flex items-center gap-3"><input type="checkbox" id="chk-economicStatus" class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer" onchange="document.getElementById('val-economicStatus').disabled = !this.checked"><label for="chk-economicStatus" class="w-24 text-sm font-bold text-slate-700 cursor-pointer">경제상황</label><select id="val-economicStatus" class="input-field flex-1 py-1.5 text-sm disabled:bg-slate-100 disabled:text-slate-400" disabled>${CONSTANTS.ECONOMIC_LIST.map(v => `<option value="${v}">${v}</option>`).join('')}</select></div><div class="flex items-center gap-3"><input type="checkbox" id="chk-householdType" class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer" onchange="document.getElementById('val-householdType').disabled = !this.checked"><label for="chk-householdType" class="w-24 text-sm font-bold text-slate-700 cursor-pointer">세대유형</label><select id="val-householdType" class="input-field flex-1 py-1.5 text-sm disabled:bg-slate-100 disabled:text-slate-400" disabled>${CONSTANTS.HOUSEHOLD_LIST.map(v => `<option value="${v}">${v}</option>`).join('')}</select></div><div class="flex items-center gap-3"><input type="checkbox" id="chk-duplicateService" class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer" onchange="document.getElementById('val-duplicateService').disabled = !this.checked"><label for="chk-duplicateService" class="w-24 text-sm font-bold text-slate-700 cursor-pointer">중복서비스</label><select id="val-duplicateService" class="input-field flex-1 py-1.5 text-sm disabled:bg-slate-100 disabled:text-slate-400" disabled>${CONSTANTS.DUPLICATE_SERVICE_LIST.map(v => `<option value="${v}">${v}</option>`).join('')}</select></div><div class="flex items-center gap-3"><input type="checkbox" id="chk-ictStatus" class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer" onchange="document.getElementById('val-ictStatus').disabled = !this.checked"><label for="chk-ictStatus" class="w-24 text-sm font-bold text-slate-700 cursor-pointer">ICT현황</label><select id="val-ictStatus" class="input-field flex-1 py-1.5 text-sm disabled:bg-slate-100 disabled:text-slate-400" disabled>${CONSTANTS.ICT_STATUS_LIST.map(v => `<option value="${v}">${v}</option>`).join('')}</select></div></div><div class="flex justify-end gap-2 mt-8 pt-4 border-t border-slate-100"><button type="button" onclick="app.closeModal()" class="px-4 py-2 text-slate-600 border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors">취소</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-medium shadow-sm transition-colors">수정 완료</button></div></form></div>`;
                showModal(html);
                lucide.createIcons();
            },
            executeBatchEditClients: async (e) => {
                e.preventDefault();
                const updateData = {};
                if (document.getElementById('chk-region').checked) updateData.region = document.getElementById('val-region').value;
                if (document.getElementById('chk-careLevel').checked) updateData.careLevel = document.getElementById('val-careLevel').value;
                if (document.getElementById('chk-economicStatus').checked) updateData.economicStatus = document.getElementById('val-economicStatus').value;
                if (document.getElementById('chk-householdType').checked) updateData.householdType = document.getElementById('val-householdType').value;
                if (document.getElementById('chk-duplicateService').checked) updateData.duplicateService = document.getElementById('val-duplicateService').value;
                if (document.getElementById('chk-ictStatus').checked) updateData.ictStatus = document.getElementById('val-ictStatus').value;
                if (Object.keys(updateData).length === 0) { alert("변경할 항목을 하나 이상 선택해주세요."); return; }
                try {
                    const promises = Array.from(state.ui.selectedClientIds).map(id => updateDoc(doc(db, "clients", id), updateData));
                    await Promise.all(promises);
                    alert(`${state.ui.selectedClientIds.size}명의 대상자 정보가 수정되었습니다.`);
                    state.ui.selectedClientIds.clear();
                    closeModal();
                    render(); 
                } catch (err) { alert("수정 중 오류가 발생했습니다: " + err.message); }
            },
            openBatchEditLogModal: () => {
                const count = state.ui.selectedLogIds.size;
                if (count === 0) return;
                const html = `<div class="bg-white w-full max-w-2xl p-6 rounded-xl shadow-xl mx-4 max-h-[90vh] overflow-y-auto"><div class="flex items-center gap-2 mb-4"><div class="p-2 bg-blue-100 text-blue-600 rounded-full"><i data-lucide="edit-3" size="20"></i></div><h3 class="font-bold text-lg text-slate-900">일괄 수정 (${count}건)</h3></div><p class="text-sm text-slate-500 mb-6 bg-slate-50 p-3 rounded">체크박스를 선택한 항목만 일괄 변경됩니다.<br>선택하지 않은 항목은 기존 값이 유지됩니다.</p><form onsubmit="app.executeBatchEditLogs(event)"><div class="space-y-4"><div class="flex items-center gap-3"><input type="checkbox" id="chk-date" class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer" onchange="document.getElementById('val-date').disabled = !this.checked"><label for="chk-date" class="w-20 text-sm font-bold text-slate-700 cursor-pointer">날짜</label><input type="date" id="val-date" class="input-field flex-1 py-1.5 text-sm disabled:bg-slate-100 disabled:text-slate-400" max="9999-12-31" disabled></div><div class="flex items-center gap-3"><input type="checkbox" id="chk-method" class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer" onchange="document.getElementById('val-method').disabled = !this.checked"><label for="chk-method" class="w-20 text-sm font-bold text-slate-700 cursor-pointer">제공방법</label><select id="val-method" class="input-field flex-1 py-1.5 text-sm disabled:bg-slate-100 disabled:text-slate-400" disabled>${CONSTANTS.PROVIDE_METHOD_LIST.map(m => `<option value="${m}">${m}</option>`).join('')}</select></div><div class="flex items-center gap-3"><input type="checkbox" id="chk-provider" class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer" onchange="document.getElementById('val-provider').disabled = !this.checked"><label for="chk-provider" class="w-20 text-sm font-bold text-slate-700 cursor-pointer">제공자</label><input type="text" id="val-provider" class="input-field flex-1 py-1.5 text-sm disabled:bg-slate-100 disabled:text-slate-400" placeholder="변경할 이름" disabled></div><div class="flex items-start gap-3 pt-2 border-t border-dashed border-slate-200"><input type="checkbox" id="chk-service" class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 mt-1 cursor-pointer" onchange="app.toggleBatchService(this.checked)"><label for="chk-service" class="w-20 text-sm font-bold text-slate-700 mt-1 cursor-pointer">서비스</label><div class="flex-1"><div class="flex justify-between items-center mb-2"><span class="text-xs text-slate-500">체크 시 아래 목록으로 덮어씌워집니다 (최대 6개)</span><button type="button" id="btn-add-batch-svc" onclick="app.addBatchSvcRow()" class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded disabled:opacity-50 disabled:cursor-not-allowed" disabled>추가</button></div><div id="batch-svc-container" class="space-y-2 p-2 bg-slate-50 rounded border border-slate-200 min-h-[50px]"><div class="text-center text-xs text-slate-400 py-2">변경하려면 체크박스를 선택하세요</div></div></div></div><div class="flex items-start gap-3 pt-2 border-t border-dashed border-slate-200"><input type="checkbox" id="chk-content" class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 mt-1 cursor-pointer" onchange="document.getElementById('val-content').disabled = !this.checked"><label for="chk-content" class="w-20 text-sm font-bold text-slate-700 mt-1 cursor-pointer">진행내용</label><textarea id="val-content" class="input-field flex-1 py-1.5 text-sm h-24 disabled:bg-slate-100 disabled:text-slate-400" placeholder="변경할 내용" disabled></textarea></div></div><div class="flex justify-end gap-2 mt-8 pt-4 border-t border-slate-100"><button type="button" onclick="app.closeModal()" class="px-4 py-2 text-slate-600 border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors">취소</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-medium shadow-sm transition-colors">수정 완료</button></div></form></div>`;
                showModal(html);
                lucide.createIcons();
            },
            toggleBatchService: (checked) => {
                const btn = document.getElementById('btn-add-batch-svc');
                const container = document.getElementById('batch-svc-container');
                if (btn) btn.disabled = !checked;
                if (checked) { container.innerHTML = ''; app.addBatchSvcRow({ category: '노인상담 및 정보제공', serviceName: '정서지원서비스(안전안부확인)', detailNote: '' }); app.addBatchSvcRow(); } else { container.innerHTML = '<div class="text-center text-xs text-slate-400 py-2">변경하려면 체크박스를 선택하세요</div>'; }
            },
            addBatchSvcRow: (item = null) => {
                const container = document.getElementById('batch-svc-container');
                if (container.querySelectorAll('.batch-svc-row').length >= 6) { alert('최대 6개까지입니다.'); return; }
                const cats = [...new Set(state.services.map(s => s.category))];
                const id = Date.now() + Math.random().toString(36).substr(2, 9);
                const div = document.createElement('div');
                div.className = "batch-svc-row flex flex-col sm:flex-row gap-2 mb-2 p-2 border rounded bg-white";
                div.id = `batch-row-${id}`;
                const defCat = item ? item.category : '';
                const defSvc = item ? item.serviceName : '';
                const defNote = item ? item.detailNote : '';
                div.innerHTML = `<select class="batch-cat-sel input-field w-full sm:w-1/4 text-xs" onchange="app.updateOpts(this)"><option value="">분류</option>${cats.map(c => `<option value="${c}" ${c === defCat ? 'selected' : ''}>${c}</option>`).join('')}</select><select class="batch-svc-sel input-field w-full sm:w-1/3 text-xs"><option value="${defSvc}">${defSvc || '서비스 선택'}</option></select><div class="flex w-full sm:flex-1 gap-2"><input class="batch-det-inp input-field flex-1 text-xs" placeholder="메모" value="${defNote}"><button type="button" onclick="app.removeBatchSvcRow('${id}')" class="text-red-400 p-1 hover:text-red-600"><i data-lucide="minus-circle" size="16"></i></button></div>`;
                container.appendChild(div);
                if (defCat) { const sel = div.querySelector('.batch-svc-sel'); const svcs = state.services.filter(s => s.category === defCat); sel.innerHTML = svcs.map(s => `<option value="${s.name}" ${s.name === defSvc ? 'selected' : ''}>${s.name}</option>`).join(''); }
                lucide.createIcons();
            },
            removeBatchSvcRow: (id) => { const el = document.getElementById(`batch-row-${id}`); if (el) el.remove(); },
            executeBatchEditLogs: async (e) => {
                e.preventDefault();
                const updateData = {};
                if (document.getElementById('chk-date').checked) updateData.date = document.getElementById('val-date').value;
                if (document.getElementById('chk-method').checked) updateData.provideMethod = document.getElementById('val-method').value;
                if (document.getElementById('chk-provider').checked) updateData.provider = document.getElementById('val-provider').value;
                if (document.getElementById('chk-content').checked) updateData.content = document.getElementById('val-content').value;
                if (document.getElementById('chk-service').checked) {
                    const rows = document.querySelectorAll('.batch-svc-row');
                    const newItems = [];
                    rows.forEach(row => { const cat = row.querySelector('.batch-cat-sel').value; const svc = row.querySelector('.batch-svc-sel').value; const note = row.querySelector('.batch-det-inp').value; if (svc) { newItems.push({ id: Date.now() + Math.random(), category: cat, serviceName: svc, detailNote: note }); } });
                    if (newItems.length === 0) { alert("서비스 변경을 선택하셨다면, 최소 1개의 서비스를 입력해주세요."); return; }
                    updateData.serviceItems = newItems;
                    updateData.serviceName = newItems.map(i => i.serviceName).join(', ');
                }
                if (Object.keys(updateData).length === 0) { alert("변경할 항목을 하나 이상 선택해주세요."); return; }
                if (document.getElementById('chk-date').checked && updateData.date === "") { alert("날짜를 선택해주세요."); return; }
                try {
                    const promises = Array.from(state.ui.selectedLogIds).map(id => updateDoc(doc(db, "logs", id), updateData));
                    await Promise.all(promises);
                    alert(`${state.ui.selectedLogIds.size}건의 일지가 수정되었습니다.`);
                    state.ui.selectedLogIds.clear();
                    closeModal();
                    render(); 
                } catch (err) { alert("수정 중 오류가 발생했습니다: " + err.message); }
            },
            executeDeleteSelectedLogs: async () => { try { const promises = Array.from(state.ui.selectedLogIds).map(id => deleteDoc(doc(db, "logs", id))); await Promise.all(promises); state.ui.selectedLogIds.clear(); closeDialog(); } catch (err) { alert("삭제 중 오류가 발생했습니다: " + err.message); } },
            
            // [수정] 대상자 선택 시 전체 화면 새로고침(render) 방지 및 부분 UI 업데이트
            toggleClientSelection: (id) => { 
                if (state.ui.selectedClientIds.has(id)) {
                    state.ui.selectedClientIds.delete(id); 
                } else {
                    state.ui.selectedClientIds.add(id); 
                }
                // render() 제거 -> 전체 화면 깜빡임 방지
                app.updateClientBatchActionsUI(); 
            },

            // [신규] 대상자 일괄 작업 버튼 영역만 부분 업데이트하는 함수
            updateClientBatchActionsUI: () => {
                const container = document.getElementById('client-batch-actions');
                if (!container) return;
                
                const count = state.ui.selectedClientIds.size;
                if (count > 0) {
                    container.innerHTML = `
                        <button onclick="app.openBatchEditClientModal()" class="bg-blue-50 text-blue-600 px-3 py-2 rounded-lg text-xs md:text-sm flex items-center gap-1 flex-1 sm:flex-none justify-center animate-fade-in"><i data-lucide="edit-3" size="14"></i> 일괄수정(${count})</button>
                        <button onclick="app.deleteSelectedClients()" class="bg-red-50 text-red-600 px-3 py-2 rounded-lg text-xs md:text-sm flex items-center gap-1 flex-1 sm:flex-none justify-center animate-fade-in"><i data-lucide="trash-2" size="14"></i> 선택삭제(${count})</button>
                    `;
                    lucide.createIcons();
                } else {
                    container.innerHTML = '';
                }
            },

            deleteSelectedClients: () => {
                const count = state.ui.selectedClientIds.size;
                if (count === 0) return;
                showDialog(`<div class="bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl transform transition-all scale-100"><div class="text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4"><i data-lucide="alert-triangle" class="text-red-600" size="24"></i></div><h3 class="text-lg font-bold text-slate-900 mb-2">대상자 일괄 삭제</h3><p class="text-sm text-slate-500 mb-6">선택한 <span class="font-bold text-red-600">${count}명</span>의 대상자를 삭제하시겠습니까?<br>삭제 시 해당 대상자의 정보가 영구적으로 사라집니다.</p><div class="flex gap-3 justify-center"><button onclick="app.executeDeleteSelectedClients()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium shadow-sm transition-colors">예, 삭제</button><button onclick="app.closeDialog()" class="flex-1 px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 font-medium transition-colors">아니오</button></div></div></div>`);
                lucide.createIcons();
            },
            executeDeleteSelectedClients: async () => { try { const promises = Array.from(state.ui.selectedClientIds).map(id => deleteDoc(doc(db, "clients", id))); await Promise.all(promises); state.ui.selectedClientIds.clear(); closeDialog(); } catch (err) { alert("삭제 중 오류가 발생했습니다: " + err.message); } },

            // 올해 현황 모달 기능
            showYearStatsModal: () => {
                const currentYear = String(new Date().getFullYear());
                const newClients = state.clients.filter(c => c.serviceStartDate && c.serviceStartDate.startsWith(currentYear)).sort((a,b) => b.serviceStartDate.localeCompare(a.serviceStartDate));
                const endClients = state.clients.filter(c => c.endDate && c.endDate.startsWith(currentYear)).sort((a,b) => b.endDate.localeCompare(a.endDate));

                const html = `
                    <div class="bg-white w-full max-w-4xl p-6 rounded-xl shadow-xl mx-4 max-h-[90vh] overflow-hidden flex flex-col">
                        <div class="flex justify-between items-center mb-6 flex-shrink-0">
                            <h3 class="font-bold text-xl text-slate-800 flex items-center gap-2">
                                <i data-lucide="calendar" class="text-slate-500"></i> ${currentYear}년 대상자 현황
                            </h3>
                            <button onclick="app.closeModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" size="24"></i></button>
                        </div>
                        
                        <div class="flex flex-col md:flex-row gap-6 overflow-hidden min-h-0 flex-1">
                            <!-- 신규 대상자 목록 -->
                            <div class="flex-1 flex flex-col min-h-0 bg-emerald-50/50 rounded-xl border border-emerald-100 overflow-hidden">
                                <div class="p-4 bg-emerald-100/50 border-b border-emerald-200 flex justify-between items-center flex-shrink-0">
                                    <h4 class="font-bold text-emerald-800 flex items-center gap-2"><i data-lucide="user-plus" size="18"></i> 신규 등록 (${newClients.length}명)</h4>
                                </div>
                                <div class="overflow-y-auto p-2 flex-1">
                                    <table class="w-full text-sm text-left border-separate border-spacing-y-1">
                                        <thead class="text-xs text-emerald-700 font-bold sticky top-0 bg-emerald-50 z-10">
                                            <tr>
                                                <th class="px-3 py-2">이름</th>
                                                <th class="px-3 py-2">시작일</th>
                                                <th class="px-3 py-2">등급/동</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${newClients.length ? newClients.map(c => `
                                                <tr class="hover:bg-white hover:shadow-sm transition-all cursor-pointer rounded-lg" onclick="app.openClientModal('${c.id}')" title="클릭하여 상세정보 보기">
                                                    <td class="px-3 py-2 font-bold text-slate-700 bg-transparent rounded-l-lg">${c.name}</td>
                                                    <td class="px-3 py-2 text-slate-600 bg-transparent">${c.serviceStartDate}</td>
                                                    <td class="px-3 py-2 text-slate-500 text-xs bg-transparent rounded-r-lg">${c.careLevel} · ${c.region}</td>
                                                </tr>
                                            `).join('') : '<tr><td colspan="3" class="text-center py-8 text-slate-400">데이터가 없습니다.</td></tr>'}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- 종결 대상자 목록 -->
                            <div class="flex-1 flex flex-col min-h-0 bg-slate-50 rounded-xl border border-slate-200 overflow-hidden">
                                <div class="p-4 bg-slate-100 border-b border-slate-200 flex justify-between items-center flex-shrink-0">
                                    <h4 class="font-bold text-slate-700 flex items-center gap-2"><i data-lucide="user-minus" size="18"></i> 종결 (${endClients.length}명)</h4>
                                </div>
                                <div class="overflow-y-auto p-2 flex-1">
                                    <table class="w-full text-sm text-left border-separate border-spacing-y-1">
                                        <thead class="text-xs text-slate-600 font-bold sticky top-0 bg-slate-100 z-10">
                                            <tr>
                                                <th class="px-3 py-2">이름</th>
                                                <th class="px-3 py-2">종결일</th>
                                                <th class="px-3 py-2">사유/상태</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${endClients.length ? endClients.map(c => `
                                                <tr class="hover:bg-white hover:shadow-sm transition-all cursor-pointer rounded-lg" onclick="app.openClientModal('${c.id}')" title="클릭하여 상세정보 보기">
                                                    <td class="px-3 py-2 font-bold text-slate-700 bg-transparent rounded-l-lg">${c.name}</td>
                                                    <td class="px-3 py-2 text-slate-600 bg-transparent">${c.endDate}</td>
                                                    <td class="px-3 py-2 text-slate-500 text-xs bg-transparent rounded-r-lg">${c.status}</td>
                                                </tr>
                                            `).join('') : '<tr><td colspan="3" class="text-center py-8 text-slate-400">데이터가 없습니다.</td></tr>'}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 text-right flex-shrink-0 pt-2 border-t border-slate-100">
                            <button onclick="app.closeModal()" class="px-5 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 text-sm font-medium transition-colors shadow-sm">닫기</button>
                        </div>
                    </div>
                `;
                showModal(html);
                lucide.createIcons();
            },

            // 대상자 모달 탭 및 하위 탭 기능
            setClientModalTab: (tabName) => {
                state.ui.clientModalTab = tabName;
                document.querySelectorAll('.modal-tab-btn').forEach(btn => {
                    if (btn.dataset.tab === tabName) btn.classList.add('active');
                    else btn.classList.remove('active');
                });
                document.querySelectorAll('.modal-tab-content').forEach(content => {
                    if (content.id === `tab-${tabName}`) content.classList.add('active');
                    else content.classList.remove('active');
                });
            },
            setCaseSubTab: (tabName) => {
                state.ui.caseSubTab = tabName;
                document.querySelectorAll('.sub-tab-btn').forEach(btn => {
                    if (btn.dataset.subtab === tabName) btn.classList.add('active');
                    else btn.classList.remove('active');
                });
                document.querySelectorAll('.sub-tab-content').forEach(content => {
                    if (content.id === `sub-tab-${tabName}`) content.classList.add('active');
                    else content.classList.remove('active');
                });
            },
            openClientModal: (id) => {
                const c = id ? state.clients.find(x => x.id === id) : {};
                let absStart = '', absEnd = '';
                if (c.absencePeriod && c.absencePeriod.includes('~')) { const parts = c.absencePeriod.split('~'); if(parts.length === 2) { absStart = parts[0].trim(); absEnd = parts[1].trim(); } }
                const initialAge = c.birthDate ? `만 ${calculateAge(c.birthDate)}세` : '';
                const cm = c.caseManagement || {};
                const getVal = (obj, path) => path.split('.').reduce((o, i) => o ? o[i] : '', obj);

                // 상태 초기화
                state.ui.clientModalTab = 'basic';
                state.ui.caseSubTab = 'initial';

                const html = `
                <div class="bg-white w-full max-w-4xl p-0 rounded-xl shadow-xl max-h-[90vh] overflow-hidden flex flex-col mx-2">
                    <div class="p-4 sm:p-6 border-b border-slate-100 flex justify-between items-center bg-white z-10">
                        <h3 class="font-bold text-lg">${c.id ? '수정' : '등록'}</h3>
                        <button onclick="app.closeModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" size="24"></i></button>
                    </div>
                    <!-- 메인 탭 (기본정보 / 사례관리) -->
                    <div class="flex border-b border-slate-100 bg-slate-50 sticky top-0 z-10">
                        <button type="button" class="modal-tab-btn active" data-tab="basic" onclick="app.setClientModalTab('basic')">기본 정보</button>
                        <button type="button" class="modal-tab-btn" data-tab="case" onclick="app.setClientModalTab('case')">사례관리</button>
                    </div>
                    <div class="p-4 sm:p-6 overflow-y-auto flex-1 bg-white">
                        <form onsubmit="app.saveClient(event, '${c.id || ''}')" id="client-form" class="space-y-4">
                            <!-- 1. 기본 정보 탭 -->
                            <div id="tab-basic" class="modal-tab-content active space-y-4">
                                <div class="grid grid-cols-1 sm:grid-cols-12 gap-3">
                                    <div class="sm:col-span-6 md:col-span-3"><label class="text-sm block mb-1">이름</label><input name="name" class="input-field" value="${c.name||''}" required></div>
                                    <div class="sm:col-span-6 md:col-span-2"><label class="text-sm block mb-1">성별</label><select name="gender" class="input-field" id="gender-select"><option value="남성">남성</option><option value="여성" ${c.gender==='여성'?'selected':''}>여성</option></select></div>
                                    <div class="sm:col-span-6 md:col-span-3"><label class="text-sm block mb-1">주민등록번호</label><input name="residentNum" class="input-field" placeholder="YYMMDD-1..." value="${c.residentNum||''}" maxlength="14" oninput="app.calcBirthFromRR(this)"></div>
                                    <div class="sm:col-span-6 md:col-span-4"><label class="text-sm block mb-1">생년월일</label><div class="flex items-center gap-2"><input type="date" name="birthDate" id="birth-date-input" class="input-field flex-1" value="${c.birthDate||''}" max="9999-12-31" oninput="app.updateAgeDisplay(this)"><input id="age-display" class="input-field !w-[25%] min-w-[60px] text-center bg-slate-100 text-slate-600 focus:outline-none cursor-default font-bold" readonly value="${initialAge}" placeholder="나이" tabindex="-1"></div></div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div><label class="text-sm block mb-1">연락처 1</label><input name="phone" class="input-field" placeholder="본인 연락처" value="${c.phone||''}"></div>
                                    <div><label class="text-sm block mb-1">연락처 2</label><input name="phone2" class="input-field" placeholder="비상/추가 연락처" value="${c.phone2||''}"></div>
                                    <div><label class="text-sm block mb-1">보호자 연락처</label><div class="flex gap-2"><input name="guardianRelation" class="input-field w-20" placeholder="관계" value="${c.guardianRelation||''}"><input name="guardianPhone" class="input-field flex-1" placeholder="번호" value="${c.guardianPhone||''}"></div></div>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
                                    <div class="sm:col-span-1"><label class="text-sm block mb-1">행정동</label><select name="region" class="input-field">${CONSTANTS.DONG_LIST.map(d=>`<option value="${d}" ${c.region===d?'selected':''}>${d}</option>`).join('')}</select></div>
                                    <div class="sm:col-span-3"><label class="text-sm block mb-1">주소</label><input name="address" class="input-field" value="${c.address||''}" placeholder="상세 주소 입력"></div>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-3 md:grid-cols-5 gap-3">
                                    <div><label class="text-sm block mb-1">등급</label><select name="careLevel" class="input-field">${CONSTANTS.CARE_LEVEL_LIST.map(v=>`<option value="${v}" ${c.careLevel===v?'selected':''}>${v}</option>`).join('')}</select></div>
                                    <div><label class="text-sm block mb-1">경제상황</label><select name="economicStatus" class="input-field">${CONSTANTS.ECONOMIC_LIST.map(v=>`<option value="${v}" ${c.economicStatus===v?'selected':''}>${v}</option>`).join('')}</select></div>
                                    <div><label class="text-sm block mb-1">세대유형</label><select name="householdType" class="input-field">${CONSTANTS.HOUSEHOLD_LIST.map(v=>`<option value="${v}" ${c.householdType===v?'selected':''}>${v}</option>`).join('')}</select></div>
                                    <div><label class="text-sm block mb-1">중복서비스</label><select name="duplicateService" class="input-field">${CONSTANTS.DUPLICATE_SERVICE_LIST.map(v=>`<option value="${v}" ${c.duplicateService===v?'selected':''}>${v}</option>`).join('')}</select></div>
                                    <div><label class="text-sm block mb-1">ICT 현황</label><select name="ictStatus" class="input-field">${CONSTANTS.ICT_STATUS_LIST.map(v=>`<option value="${v}" ${c.ictStatus===v?'selected':''}>${v}</option>`).join('')}</select></div>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-12 gap-3">
                                    <div class="sm:col-span-2"><label class="text-sm block mb-1">상태</label><select name="status" class="input-field">${CONSTANTS.STATUS_LIST.map(s=>`<option value="${s}" ${c.status===s?'selected':''}>${s}</option>`).join('')}</select></div>
                                    <div class="sm:col-span-3"><label class="text-sm block mb-1">시작일</label><input type="date" name="serviceStartDate" class="input-field" value="${c.serviceStartDate||''}" max="9999-12-31"></div>
                                    <div class="sm:col-span-4"><label class="text-sm block mb-1">장기부재기간</label><div class="flex items-center gap-1"><input type="date" name="absStart" class="input-field px-1 text-sm text-center" value="${absStart}" max="9999-12-31" style="font-size: 0.8rem;"><span class="text-slate-400">~</span><input type="date" name="absEnd" class="input-field px-1 text-sm text-center" value="${absEnd}" max="9999-12-31" style="font-size: 0.8rem;"></div></div>
                                    <div class="sm:col-span-3"><label class="text-sm block mb-1">종결일</label><input type="date" name="endDate" class="input-field" value="${c.endDate||''}" max="9999-12-31"></div>
                                </div>
                                <div><label class="text-sm block mb-1">비고</label><textarea name="note" class="input-field" rows="2">${c.note||''}</textarea></div>
                            </div>
                            
                            <!-- 2. 사례관리 탭 (하위 탭 포함) -->
                            <div id="tab-case" class="modal-tab-content space-y-4">
                                <div class="flex gap-2 overflow-x-auto pb-2 border-b border-slate-100 mb-4 sticky top-0 bg-white z-0">
                                    <button type="button" class="sub-tab-btn active" data-subtab="initial" onclick="app.setCaseSubTab('initial')">초기면접지</button>
                                    <button type="button" class="sub-tab-btn" data-subtab="assessment" onclick="app.setCaseSubTab('assessment')">사정기록지</button>
                                    <button type="button" class="sub-tab-btn" data-subtab="reassess" onclick="app.setCaseSubTab('reassess')">재사정</button>
                                    <button type="button" class="sub-tab-btn" data-subtab="satisfaction" onclick="app.setCaseSubTab('satisfaction')">만족도조사</button>
                                </div>

                                <div id="sub-tab-initial" class="sub-tab-content active space-y-4">
                                    <div class="bg-blue-50 p-3 rounded text-sm text-blue-700 mb-2 flex items-start gap-2"><i data-lucide="info" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>대상자의 초기 상태와 욕구를 파악하기 위한 면접 기록입니다.</div>
                                    <div class="grid grid-cols-2 gap-3"><div><label class="text-sm block mb-1 font-bold">면접일자</label><input type="date" id="cm-initial-date" class="input-field" value="${getVal(cm, 'initial.date')}"></div><div><label class="text-sm block mb-1 font-bold">면접자</label><input type="text" id="cm-initial-interviewer" class="input-field" value="${getVal(cm, 'initial.interviewer')}"></div></div>
                                    <div><label class="text-sm block mb-1 font-bold">호소 문제 및 욕구</label><textarea id="cm-initial-problem" class="input-field h-20" placeholder="대상자가 주로 호소하는 문제와 요구사항">${getVal(cm, 'initial.problem')}</textarea></div>
                                    <div><label class="text-sm block mb-1 font-bold">가족 및 사회적 관계</label><textarea id="cm-initial-family" class="input-field h-20" placeholder="가족 관계 및 지지체계">${getVal(cm, 'initial.family')}</textarea></div>
                                    <div><label class="text-sm block mb-1 font-bold">주거 및 경제 상황</label><textarea id="cm-initial-economic" class="input-field h-20" placeholder="주거 환경 및 경제적 어려움">${getVal(cm, 'initial.economic')}</textarea></div>
                                    <div><label class="text-sm block mb-1 font-bold">신체 및 정신 건강</label><textarea id="cm-initial-health" class="input-field h-20" placeholder="질병 유무 및 정신 건강 상태">${getVal(cm, 'initial.health')}</textarea></div>
                                    <div><label class="text-sm block mb-1 font-bold">종합 소견</label><textarea id="cm-initial-conclusion" class="input-field h-24" placeholder="면접자 종합 의견">${getVal(cm, 'initial.conclusion')}</textarea></div>
                                </div>

                                <div id="sub-tab-assessment" class="sub-tab-content space-y-4">
                                    <div class="bg-purple-50 p-3 rounded text-sm text-purple-700 mb-2 flex items-start gap-2"><i data-lucide="info" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>위기도 및 생활 실태를 점수화하여 기록합니다. (1점: 매우 나쁨 ~ 5점: 매우 좋음/안정)</div>
                                    <div class="grid grid-cols-2 gap-3"><div><label class="text-sm block mb-1 font-bold">사정일자</label><input type="date" id="cm-assess-date" class="input-field" value="${getVal(cm, 'assessment.date')}"></div><div><label class="text-sm block mb-1 font-bold">작성자</label><input type="text" id="cm-assess-writer" class="input-field" value="${getVal(cm, 'assessment.writer')}"></div></div>
                                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 bg-slate-50 p-3 rounded border border-slate-200">
                                        <div><label class="text-xs block mb-1 text-slate-500">신체건강 (1-5)</label><input type="number" id="cm-assess-score-health" class="input-field text-center" min="1" max="5" value="${getVal(cm, 'assessment.scoreHealth')}"></div>
                                        <div><label class="text-xs block mb-1 text-slate-500">정신건강 (1-5)</label><input type="number" id="cm-assess-score-mental" class="input-field text-center" min="1" max="5" value="${getVal(cm, 'assessment.scoreMental')}"></div>
                                        <div><label class="text-xs block mb-1 text-slate-500">경제상태 (1-5)</label><input type="number" id="cm-assess-score-eco" class="input-field text-center" min="1" max="5" value="${getVal(cm, 'assessment.scoreEco')}"></div>
                                        <div><label class="text-xs block mb-1 text-slate-500">사회지지 (1-5)</label><input type="number" id="cm-assess-score-social" class="input-field text-center" min="1" max="5" value="${getVal(cm, 'assessment.scoreSocial')}"></div>
                                    </div>
                                    <div><label class="text-sm block mb-1 font-bold">위기 사정 내용</label><textarea id="cm-assess-content" class="input-field h-24" placeholder="위기 상황 및 사정 상세 내용">${getVal(cm, 'assessment.content')}</textarea></div>
                                    <div><label class="text-sm block mb-1 font-bold">개입 계획</label><textarea id="cm-assess-plan" class="input-field h-24" placeholder="서비스 제공 계획 및 목표">${getVal(cm, 'assessment.plan')}</textarea></div>
                                </div>

                                <div id="sub-tab-reassess" class="sub-tab-content space-y-4">
                                    <div class="bg-orange-50 p-3 rounded text-sm text-orange-700 mb-2 flex items-start gap-2"><i data-lucide="info" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>서비스 제공 후 변화 확인 및 계획 재수립을 위한 기록입니다.</div>
                                    <div class="grid grid-cols-2 gap-3"><div><label class="text-sm block mb-1 font-bold">재사정일자</label><input type="date" id="cm-re-date" class="input-field" value="${getVal(cm, 'reAssessment.date')}"></div><div><label class="text-sm block mb-1 font-bold">진행기간</label><input type="text" id="cm-re-period" class="input-field" placeholder="예: 6개월" value="${getVal(cm, 'reAssessment.period')}"></div></div>
                                    <div><label class="text-sm block mb-1 font-bold">목표 달성 정도</label><textarea id="cm-re-goal" class="input-field h-20" placeholder="기존 목표 달성 여부 및 변화">${getVal(cm, 'reAssessment.goal')}</textarea></div>
                                    <div><label class="text-sm block mb-1 font-bold">주요 변화 사항</label><textarea id="cm-re-change" class="input-field h-20" placeholder="대상자의 신체, 정서, 환경적 변화">${getVal(cm, 'reAssessment.change')}</textarea></div>
                                    <div><label class="text-sm block mb-1 font-bold">향후 계획 (유지/종결/변경)</label><select id="cm-re-plan-type" class="input-field mb-2"><option value="유지" ${getVal(cm, 'reAssessment.planType')==='유지'?'selected':''}>현 서비스 유지</option><option value="변경" ${getVal(cm, 'reAssessment.planType')==='변경'?'selected':''}>서비스 변경/추가</option><option value="종결" ${getVal(cm, 'reAssessment.planType')==='종결'?'selected':''}>서비스 종결</option></select><textarea id="cm-re-plan-detail" class="input-field h-16" placeholder="향후 계획 상세">${getVal(cm, 'reAssessment.planDetail')}</textarea></div>
                                </div>

                                <div id="sub-tab-satisfaction" class="sub-tab-content space-y-4">
                                    <div class="bg-green-50 p-3 rounded text-sm text-green-700 mb-2 flex items-start gap-2"><i data-lucide="info" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>서비스 이용에 대한 만족도 평가 기록입니다.</div>
                                    <div><label class="text-sm block mb-1 font-bold">조사일자</label><input type="date" id="cm-sat-date" class="input-field w-1/2" value="${getVal(cm, 'satisfaction.date')}"></div>
                                    <div class="p-4 border border-slate-200 rounded-lg">
                                        <div class="mb-3 flex items-center justify-between"><label class="font-bold">전반적 만족도</label><select id="cm-sat-score" class="input-field w-32 font-bold text-emerald-600"><option value="5" ${getVal(cm, 'satisfaction.score')==='5'?'selected':''}>★★★★★ (매우만족)</option><option value="4" ${getVal(cm, 'satisfaction.score')==='4'?'selected':''}>★★★★ (만족)</option><option value="3" ${getVal(cm, 'satisfaction.score')==='3'?'selected':''}>★★★ (보통)</option><option value="2" ${getVal(cm, 'satisfaction.score')==='2'?'selected':''}>★★ (불만족)</option><option value="1" ${getVal(cm, 'satisfaction.score')==='1'?'selected':''}>★ (매우불만족)</option></select></div>
                                        <div class="space-y-2 text-sm text-slate-600">
                                            <div class="flex items-center gap-2"><input type="checkbox" id="cm-sat-kind" class="w-4 h-4 text-emerald-600 rounded" ${getVal(cm, 'satisfaction.kind')?'checked':''}> 담당자가 친절했습니까?</div>
                                            <div class="flex items-center gap-2"><input type="checkbox" id="cm-sat-help" class="w-4 h-4 text-emerald-600 rounded" ${getVal(cm, 'satisfaction.help')?'checked':''}> 서비스가 도움이 되었습니까?</div>
                                            <div class="flex items-center gap-2"><input type="checkbox" id="cm-sat-time" class="w-4 h-4 text-emerald-600 rounded" ${getVal(cm, 'satisfaction.time')?'checked':''}> 약속 시간을 잘 지켰습니까?</div>
                                        </div>
                                    </div>
                                    <div><label class="text-sm block mb-1 font-bold">건의사항 및 기타의견</label><textarea id="cm-sat-comment" class="input-field h-24" placeholder="대상자의 의견">${getVal(cm, 'satisfaction.comment')}</textarea></div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="p-4 border-t border-slate-100 bg-white flex justify-end gap-2 z-10">
                        <button type="button" onclick="app.closeModal()" class="px-5 py-2.5 text-slate-600 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors font-medium">취소</button>
                        <button type="button" onclick="document.getElementById('client-form').dispatchEvent(new Event('submit', {cancelable: true, bubbles: true}))" class="bg-emerald-600 text-white px-6 py-2.5 rounded-lg hover:bg-emerald-700 font-bold shadow-md transition-colors transform hover:scale-[1.02]">저장</button>
                    </div>
                </div>`;
                showModal(html);
                lucide.createIcons();
            },
            saveClient: async (e, id) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);
                const start = data.absStart; const end = data.absEnd;
                if (start || end) { data.absencePeriod = `${start || ''} ~ ${end || ''}`; } else { data.absencePeriod = ''; }
                delete data.absStart; delete data.absEnd;
                if (!id) data.createdAt = new Date().toISOString();
                
                // 사례관리 데이터 수집
                const cmData = {
                    initial: {
                        date: document.getElementById('cm-initial-date').value,
                        interviewer: document.getElementById('cm-initial-interviewer').value,
                        problem: document.getElementById('cm-initial-problem').value,
                        family: document.getElementById('cm-initial-family').value,
                        economic: document.getElementById('cm-initial-economic').value,
                        health: document.getElementById('cm-initial-health').value,
                        conclusion: document.getElementById('cm-initial-conclusion').value
                    },
                    assessment: {
                        date: document.getElementById('cm-assess-date').value,
                        writer: document.getElementById('cm-assess-writer').value,
                        scoreHealth: document.getElementById('cm-assess-score-health').value,
                        scoreMental: document.getElementById('cm-assess-score-mental').value,
                        scoreEco: document.getElementById('cm-assess-score-eco').value,
                        scoreSocial: document.getElementById('cm-assess-score-social').value,
                        content: document.getElementById('cm-assess-content').value,
                        plan: document.getElementById('cm-assess-plan').value
                    },
                    reAssessment: {
                        date: document.getElementById('cm-re-date').value,
                        period: document.getElementById('cm-re-period').value,
                        goal: document.getElementById('cm-re-goal').value,
                        change: document.getElementById('cm-re-change').value,
                        planType: document.getElementById('cm-re-plan-type').value,
                        planDetail: document.getElementById('cm-re-plan-detail').value
                    },
                    satisfaction: {
                        date: document.getElementById('cm-sat-date').value,
                        score: document.getElementById('cm-sat-score').value,
                        kind: document.getElementById('cm-sat-kind').checked,
                        help: document.getElementById('cm-sat-help').checked,
                        time: document.getElementById('cm-sat-time').checked,
                        comment: document.getElementById('cm-sat-comment').value
                    }
                };
                data.caseManagement = cmData;

                if (!id) {
                    const duplicate = state.clients.find(c => c.name === data.name && c.birthDate === data.birthDate);
                    if (duplicate) {
                        state.pendingClientData = data;
                        showDialog(`<div class="bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl transform transition-all scale-100"><div class="text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-orange-100 mb-4"><i data-lucide="alert-circle" class="text-orange-600" size="24"></i></div><h3 class="text-lg font-bold text-slate-900 mb-2">중복 대상자 확인</h3><p class="text-sm text-slate-500 mb-4">이름: <span class="font-bold text-slate-800">${data.name}</span><br>생년월일: <span class="font-bold text-slate-800">${data.birthDate}</span></p><p class="text-sm text-slate-600 mb-6">이미 등록된 대상자와 정보가 일치합니다.<br>그래도 등록하시겠습니까?</p><div class="flex gap-3 justify-center"><button onclick="app.confirmSaveClient()" class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium shadow-sm">예, 등록</button><button onclick="app.closeDialog()" class="flex-1 px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 font-medium">아니오</button></div></div></div>`);
                        lucide.createIcons();
                        return;
                    }
                }
                await app.processSaveClient(data, id);
            },
            calcBirthFromRR: (input) => {
                let val = input.value.replace(/[^0-9]/g, '');
                if (val.length > 6) { val = val.slice(0, 6) + '-' + val.slice(6); input.value = val; }
                const cleanVal = val.replace(/-/g, '');
                if (cleanVal.length >= 7) {
                    const yy = cleanVal.substr(0, 2), mm = cleanVal.substr(2, 2), dd = cleanVal.substr(4, 2), g = cleanVal.substr(6, 1);
                    let yearPrefix = '';
                    if (['1', '2', '5', '6'].includes(g)) yearPrefix = '19'; else if (['3', '4', '7', '8'].includes(g)) yearPrefix = '20';
                    if (yearPrefix) {
                        const fullDate = `${yearPrefix}${yy}-${mm}-${dd}`;
                        const birthInput = document.getElementById('birth-date-input'); 
                        if (birthInput) { 
                            birthInput.value = fullDate;
                            app.updateAgeDisplay(birthInput);
                        }
                        const genderSelect = document.getElementById('gender-select');
                        if (genderSelect) { if (['1', '3', '5', '7'].includes(g)) genderSelect.value = '남성'; else if (['2', '4', '6', '8'].includes(g)) genderSelect.value = '여성'; }
                    }
                }
            },
            updateAgeDisplay: (input) => {
                const ageInput = document.getElementById('age-display');
                if (input.value && ageInput) {
                    ageInput.value = `만 ${calculateAge(input.value)}세`;
                } else if (ageInput) {
                    ageInput.value = '';
                }
            },
            confirmSaveClient: async () => { if (state.pendingClientData) { await app.processSaveClient(state.pendingClientData, null); state.pendingClientData = null; closeDialog(); } },
            processSaveClient: async (data, id) => { try { if (id) await updateDoc(doc(db, "clients", id), data); else await addDoc(collection(db, "clients"), data); closeModal(); } catch(err) { alert("저장 실패: " + err.message); } },
            closeDialog: () => { state.pendingClientData = null; state.pendingLogData = null; state.pendingServiceData = null; closeDialog(); },
            openLogModal: (id, prefillData = null) => {
                let l;
                if (id) { l = state.logs.find(x => x.id === id); } else if (prefillData) { l = prefillData; } else { l = { date: new Date().toISOString().split('T')[0], provideMethod: '방문', provider: '', serviceItems: [{id: Date.now(), category: '노인상담 및 정보제공', serviceName: '정서지원서비스(안전안부확인)', detailNote: ''}, {id: Date.now() + 1, category: '', serviceName: '', detailNote: ''}] }; }
                if (!l) l = { date: new Date().toISOString().split('T')[0], provideMethod: '방문', provider: '', serviceItems: [{id: Date.now(), category:'', serviceName:'', detailNote:''}] };
                const c = l.clientName ? (state.clients.find(x => x.name === l.clientName) || {}) : {};
                if (id || prefillData) { window.tempSelectedClients = l.clientName ? [l.clientName] : []; window.tempServiceItems = l.serviceItems ? l.serviceItems.map(i => ({...i, id: Date.now() + Math.random()})) : [{id: Date.now(), category:'', serviceName:'', detailNote:''}]; } else { window.tempSelectedClients = []; window.tempServiceItems = [{id: Date.now(), category: '노인상담 및 정보제공', serviceName: '정서지원서비스(안전안부확인)', detailNote: ''}, {id: Date.now() + 1, category: '', serviceName: '', detailNote: ''}]; }
                const html = `
                <div class="bg-white w-full max-w-4xl p-4 sm:p-6 rounded-xl shadow-xl max-h-[90vh] overflow-y-auto mx-2">
                    <h3 class="font-bold text-lg mb-4">${id ? '수정' : (prefillData ? '일지 복사 등록' : '작성')}</h3>
                    <form onsubmit="app.saveLog(event, '${id || ''}')" class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 bg-slate-50 p-4 rounded">
                            <div><label class="block text-sm font-medium mb-1">날짜</label><input type="date" name="date" class="input-field" value="${l.date}" required max="9999-12-31"></div>
                            <div><label class="block text-sm font-medium mb-1">제공방법</label><select name="provideMethod" class="input-field">${CONSTANTS.PROVIDE_METHOD_LIST.map(m => `<option value="${m}" ${l.provideMethod===m?'selected':''}>${m}</option>`).join('')}</select></div>
                            <div><label class="block text-sm font-medium mb-1">제공자</label><input name="provider" class="input-field" value="${l.provider || ''}" placeholder="담당자"></div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded mt-2">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                <div class="md:col-span-1">
                                    <label class="block text-sm font-medium mb-1">대상자 검색</label>
                                    <div class="flex gap-2">
                                        <input list="cl-list" id="client-input" class="input-field" placeholder="이름 검색" onchange="app.fillClientInfo(this)" onkeydown="if(event.key === 'Enter') { event.preventDefault(); app.addClientToSelection(); }" autocomplete="off" ${id ? 'disabled title="수정 시 대상자 변경 불가"' : ''}>
                                        <datalist id="cl-list">${state.clients.map(c=>`<option value="${c.name}">`).join('')}</datalist>
                                        ${!id ? `<button type="button" onclick="app.addClientToSelection()" class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded text-sm font-medium whitespace-nowrap hover:bg-emerald-200">+추가</button>` : ''}
                                    </div>
                                </div>
                                <div class="md:col-span-3 flex flex-col sm:flex-row gap-2">
                                    <div class="flex-1"><label class="block text-sm font-medium mb-1 text-slate-500">생년월일</label><input id="d-birth" class="input-field bg-slate-100" readonly value="${c.birthDate||''}"></div>
                                    <div class="flex-1"><label class="block text-sm font-medium mb-1 text-slate-500">행정동</label><input id="d-region" class="input-field bg-slate-100" readonly value="${c.region||''}"></div>
                                    <div class="flex-1"><label class="block text-sm font-medium mb-1 text-slate-500">관리등급</label><input id="d-level" class="input-field bg-slate-100" readonly value="${c.careLevel||''}"></div>
                                </div>
                            </div>
                            <div id="selected-clients-area" class="flex flex-wrap gap-2 mt-3 pt-2 border-t border-slate-200"></div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-2"><label class="font-bold text-sm">서비스 (최대 6개)</label><button type="button" onclick="app.addSvcRow()" class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded">추가</button></div>
                            <div id="svc-container" class="space-y-2"></div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1"><label class="text-sm">내용</label><button type="button" onclick="app.aiDraft()" class="text-xs bg-purple-100 text-purple-700 px-2 rounded">AI 다듬기</button></div>
                            <textarea id="log-content" name="content" class="input-field h-32" required>${l.content||''}</textarea>
                        </div>
                        <div class="flex justify-end gap-2"><button type="button" onclick="app.closeModal()" class="px-4 py-2 text-slate-600 border border-slate-200 rounded-lg">취소</button><button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded-lg">${id ? '수정 저장' : '등록'}</button></div>
                    </form>
                </div>`;
                showModal(html);
                window.tempServiceItems.forEach(item => renderSvcRow(item));
                app.renderSelectedClients(!!id); 
            },
            fillClientInfo: (input) => {
                const c = state.clients.find(x => x.name === input.value);
                if(c) {
                    document.getElementById('d-birth').value = c.birthDate || '';
                    document.getElementById('d-region').value = c.region || '';
                    document.getElementById('d-level').value = c.careLevel || '';
                } else {
                    document.getElementById('d-birth').value = '';
                    document.getElementById('d-region').value = '';
                    document.getElementById('d-level').value = '';
                }
            },
            addClientToSelection: () => {
                const input = document.getElementById('client-input');
                const name = input.value.trim();
                if(!name) return;
                const isValid = state.clients.some(c => c.name === name);
                if(!isValid) { alert("등록된 대상자가 아닙니다."); return; }
                if(!window.tempSelectedClients.includes(name)) { window.tempSelectedClients.push(name); app.renderSelectedClients(); }
                input.value = ''; 
                document.getElementById('d-birth').value = ''; document.getElementById('d-region').value = ''; document.getElementById('d-level').value = '';
            },
            removeClientFromSelection: (index) => { window.tempSelectedClients.splice(index, 1); app.renderSelectedClients(); },
            renderSelectedClients: (isEditMode = false) => {
                const container = document.getElementById('selected-clients-area');
                if(!container) return;
                container.innerHTML = window.tempSelectedClients.map((name, idx) => `<span class="bg-emerald-50 text-emerald-700 px-2 py-1 rounded text-sm flex items-center gap-1 border border-emerald-200">${name}${!isEditMode ? `<button type="button" onclick="app.removeClientFromSelection(${idx})" class="text-emerald-400 hover:text-red-500"><i data-lucide="x" size="14"></i></button>` : ''}</span>`).join('');
                lucide.createIcons();
            },
            addSvcRow: () => { if(document.querySelectorAll('.svc-row').length >= 6) return alert('최대 6개까지입니다.'); renderSvcRow({id: Date.now(), category:'', serviceName:'', detailNote:''}); },
            removeSvcRow: (id) => document.getElementById(`row-${id}`).remove(),
            saveLog: async (e, id) => {
                e.preventDefault();
                if(window.tempSelectedClients.length === 0) return alert("대상자를 1명 이상 추가해주세요.");
                const fd = new FormData(e.target);
                const items = Array.from(document.querySelectorAll('.svc-row')).map(row => ({ category: row.querySelector('.cat-sel').value, serviceName: row.querySelector('.svc-sel').value, detailNote: row.querySelector('.det-inp').value })).filter(i => i.serviceName);
                if(items.length === 0) return alert('서비스를 하나 이상 선택하세요.');
                const baseData = { date: fd.get('date'), provideMethod: fd.get('provideMethod'), provider: fd.get('provider'), content: fd.get('content'), serviceItems: items, serviceName: items.map(i=>i.serviceName).join(', ') };
                if (!id) {
                    let duplicateFound = false;
                    let duplicateInfo = "";
                    for (const cName of window.tempSelectedClients) {
                        const existingLogs = state.logs.filter(l => l.date === baseData.date && l.clientName === cName);
                        for (const log of existingLogs) {
                            const hasOverlap = items.some(newItem => log.serviceItems && log.serviceItems.some(oldItem => oldItem.serviceName === newItem.serviceName));
                            if (hasOverlap) { duplicateFound = true; duplicateInfo = `${cName}님 (${baseData.date})`; break; }
                        }
                        if (duplicateFound) break;
                    }
                    if (duplicateFound) {
                        state.pendingLogData = { baseData, items, clients: [...window.tempSelectedClients] };
                        showDialog(`<div class="bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl transform transition-all scale-100"><div class="text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-orange-100 mb-4"><i data-lucide="alert-circle" class="text-orange-600" size="24"></i></div><h3 class="text-lg font-bold text-slate-900 mb-2">중복 일지 확인</h3><p class="text-sm text-slate-500 mb-4"><span class="font-bold text-slate-800">${duplicateInfo}</span>의<br>동일한 서비스 일지가 이미 존재합니다.</p><p class="text-sm text-slate-600 mb-6">그래도 등록하시겠습니까?</p><div class="flex gap-3 justify-center"><button onclick="app.confirmSaveLog()" class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium shadow-sm">예, 등록</button><button onclick="app.closeDialog()" class="flex-1 px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 font-medium">아니오</button></div></div></div>`);
                        lucide.createIcons();
                        return;
                    }
                }
                await app.processSaveLog(baseData, items, window.tempSelectedClients, id);
            },
            confirmSaveLog: async () => { if (state.pendingLogData) { const { baseData, items, clients } = state.pendingLogData; await app.processSaveLog(baseData, items, clients, null); state.pendingLogData = null; closeDialog(); } },
            processSaveLog: async (baseData, items, clients, id) => { try { const promises = clients.map(async (cName, idx) => { const client = state.clients.find(x => x.name === cName); const logData = { ...baseData, clientName: cName, clientId: client ? client.id : 'unknown' }; if (id && idx === 0) { return updateDoc(doc(db, "logs", id), logData); } else { return addDoc(collection(db, "logs"), logData); } }); await Promise.all(promises); closeModal(); } catch(err) { alert("저장 실패: " + err.message); } },
            duplicateLog: (id) => { const l = state.logs.find(x => x.id === id); if(l) { const { id: originId, ...data } = l; data.date = new Date().toISOString().split('T')[0]; app.openLogModal(null, data); } },
            aiDraft: () => { const t = document.getElementById('log-content'); if(!t.value) return alert('내용을 입력하세요'); t.value = "AI 분석 중..."; setTimeout(() => { t.value = "[AI] 대상자 안부 확인 및 물품 전달 완료. 건강 상태 양호함."; }, 1000); },
            deleteData: (col, id) => { showDialog(`<div class="bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl transform transition-all scale-100"><div class="text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4"><i data-lucide="alert-triangle" class="text-red-600" size="24"></i></div><h3 class="text-lg font-bold text-slate-900 mb-2">삭제 확인</h3><p class="text-sm text-slate-500 mb-6">정말로 삭제하시겠습니까?<br>이 작업은 되돌릴 수 없습니다.</p><div class="flex gap-3 justify-center"><button onclick="app.executeDelete('${col}', '${id}')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium shadow-sm">예, 삭제</button><button onclick="app.closeDialog()" class="flex-1 px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 font-medium">아니오</button></div></div></div>`); lucide.createIcons(); },
            executeDelete: async (col, id) => { try { await deleteDoc(doc(db, col, id)); closeDialog(); } catch (err) { alert("삭제 실패: " + err.message); } },
            closeModal: () => closeModal(),
            editService: (id) => { state.editingServiceId = id; if(state.viewMode==='single') updateTabContent('services'); else render(); },
            cancelEditService: () => { state.editingServiceId = null; if(state.viewMode==='single') updateTabContent('services'); else render(); },
            addService: async (e) => {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(e.target));
                if (!state.editingServiceId) {
                    const duplicate = state.services.find(s => (s.majorCategory || '').trim() === (data.majorCategory || '').trim() && (s.category || '').trim() === (data.category || '').trim() && (s.name || '').trim() === (data.name || '').trim());
                    if (duplicate) {
                        state.pendingServiceData = data;
                        showDialog(`<div class="bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl transform transition-all scale-100"><div class="text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-orange-100 mb-4"><i data-lucide="alert-circle" class="text-orange-600" size="24"></i></div><h3 class="text-lg font-bold text-slate-900 mb-2">중복 서비스 확인</h3><p class="text-sm text-slate-500 mb-4">대분류: ${data.majorCategory || '-'}<br>서비스: ${data.category || '-'}<br>상세내용: <span class="font-bold text-slate-800">${data.name}</span></p><p class="text-sm text-slate-600 mb-6">이미 등록된 서비스입니다.<br>(예시 내용이 달라도 위 항목이 같으면 중복입니다)<br>그래도 추가하시겠습니까?</p><div class="flex gap-3 justify-center"><button onclick="app.confirmAddService()" class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium shadow-sm">예, 추가</button><button onclick="app.closeDialog()" class="flex-1 px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 font-medium">아니오</button></div></div></div>`);
                        lucide.createIcons();
                        return;
                    }
                }
                await app.processAddService(data);
            },
            confirmAddService: async () => { if (state.pendingServiceData) { await app.processAddService(state.pendingServiceData); state.pendingServiceData = null; closeDialog(); } },
            processAddService: async (data) => { try { if (state.editingServiceId) { await updateDoc(doc(db, "services", state.editingServiceId), data); state.editingServiceId = null; } else { await addDoc(collection(db, "services"), data); } document.querySelector('form[onsubmit="app.addService(event)"]').reset(); /* render 호출 제거 (자동갱신됨) */ } catch (err) { alert("오류 발생: " + err.message); } },
            downloadTemplate: () => { const headers = ['이름', '성별', '생년월일', '행정동', '주소', '연락처1', '연락처2', '보호자관계', '보호자연락처', '등급', '경제상황', '세대유형', '상태', '서비스시작일', '비고']; const ws = XLSX.utils.aoa_to_sheet([headers]); ws['!cols'] = [{ wch: 10 }, { wch: 6 }, { wch: 12 }, { wch: 10 }, { wch: 30 }, { wch: 13 }, { wch: 13 }, { wch: 10 }, { wch: 13 }, { wch: 8 }, { wch: 12 }, { wch: 12 }, { wch: 8 }, { wch: 12 }, { wch: 30 }]; const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "양식"); XLSX.writeFile(wb, "대상자등록양식_전체.xlsx"); },
            uploadExcel: (input) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const wb = XLSX.read(e.target.result, {type:'binary'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1}).slice(1);
                    const fmtDate = (v) => { if(!v) return ''; const s = String(v).trim().replace(/[^0-9]/g, ''); if(s.length === 8) { return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`; } return String(v); };
                    let count = 0;
                    json.forEach(async row => {
                        if(row[0]) {
                            await addDoc(collection(db,"clients"), {
                                name: String(row[0]), gender: String(row[1] || '남성'), birthDate: fmtDate(row[2]), region: String(row[3] || '대연동'), address: String(row[4] || ''), phone: String(row[5] || ''), phone2: String(row[6] || ''), guardianRelation: String(row[7] || ''), guardianPhone: String(row[8] || ''), careLevel: String(row[9] || '일반'), economicStatus: String(row[10] || '일반(저소득)'), householdType: String(row[11] || '독거세대'), status: String(row[12] || '이용'), serviceStartDate: fmtDate(row[13]) || new Date().toISOString().split('T')[0], note: String(row[14] || ''), createdAt: new Date().toISOString()
                            });
                            count++;
                        }
                    });
                    alert(`${count}명 등록이 시작되었습니다. 잠시 후 새로고침 됩니다.`); input.value = '';
                };
                reader.readAsBinaryString(input.files[0]);
            },
            downloadStatsExcel: () => {
                const { start, end, type, region, name } = state.filters.stats;
                const targetClients = state.clients.filter(c => { const matchBasic = (region.length === 0 || region.includes(c.region)) && (!name || c.name.includes(name)); if (!matchBasic) return false; const cS = c.serviceStartDate || '0000-01-01'; const cE = c.endDate || '9999-12-31'; return cS <= end && cE >= start; });
                let serviceHeaders = [];
                if (type === 'category') { serviceHeaders = [...new Set(state.services.map(s => s.category))].filter(Boolean); } else { const headerGroups = {}; const orderedCategories = [...new Set(state.services.map(s => s.category || '기타'))]; state.services.forEach(s => { const cat = s.category || '기타'; if (!headerGroups[cat]) headerGroups[cat] = []; if (!headerGroups[cat].includes(s.name)) headerGroups[cat].push(s.name); }); serviceHeaders = orderedCategories.flatMap(cat => headerGroups[cat]); }
                const dataMap = {}; 
                targetClients.forEach(c => { dataMap[c.id] = { name: c.name, birthDate: c.birthDate || '-', region: (c.region || '-').replace(/동$/, ''), total: 0, counts: {} }; serviceHeaders.forEach(k => dataMap[c.id].counts[k] = 0); });
                state.logs.forEach(l => {
                    if (l.date < start || l.date > end) return;
                    let cid = l.clientId;
                    if (!dataMap[cid] && l.clientName) { const found = targetClients.find(c => c.name === l.clientName); if(found) cid = found.id; }
                    if (dataMap[cid]) {
                        const items = l.serviceItems || [{ serviceName: l.serviceName, category: l.serviceCategory }];
                        items.forEach(item => {
                            let key = type === 'category' ? item.category : item.serviceName;
                            if (!key && item.serviceName && type === 'category') { const s = state.services.find(svc => svc.name === item.serviceName); if(s) key = s.category; }
                            if (key && dataMap[cid].counts[key] !== undefined) { dataMap[cid].counts[key]++; dataMap[cid].total++; }
                        });
                    }
                });
                const excelData = Object.values(dataMap).sort((a,b) => b.total - a.total).map(r => { const row = { '대상자': r.name, '생년월일': r.birthDate, '행정동': r.region, '합계': r.total }; serviceHeaders.forEach(h => { row[h] = r.counts[h]; }); return row; });
                if (excelData.length === 0) { alert("다운로드할 데이터가 없습니다."); return; }
                const ws = XLSX.utils.json_to_sheet(excelData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "서비스제공통계"); XLSX.writeFile(wb, `서비스제공통계_${new Date().toISOString().slice(0,10)}.xlsx`);
            },
            downloadLogsExcel: () => {
                const { start, end, search, category, service } = state.filters.log;
                const filtered = state.logs.filter(l => (!start || l.date >= start) && (!end || l.date <= end) && (!search || l.clientName.includes(search)) && (!category || (l.serviceItems && l.serviceItems.some(i => i.category === category))) && (!service || (l.serviceItems && l.serviceItems.some(i => i.serviceName === service)))).sort((a, b) => new Date(a.date) - new Date(b.date));
                if (filtered.length === 0) { alert("다운로드할 데이터가 없습니다."); return; }
                const excelData = [];
                filtered.forEach(l => {
                    const client = state.clients.find(c => c.id === l.clientId);
                    const baseData = { 
                        '날짜': l.date, 
                        '이름': l.clientName, 
                        '제공방법': l.provideMethod || '방문', 
                        '제공자': l.provider || '', 
                        '진행내용': l.content 
                    };
                    if (l.serviceItems && l.serviceItems.length > 0) { 
                        l.serviceItems.forEach(item => { 
                            excelData.push({ 
                                ...baseData, 
                                '서비스': item.category, 
                                '서비스 상세내용': item.serviceName, 
                                '서비스 메모': item.detailNote || '' 
                            }); 
                        }); 
                    } else { 
                        excelData.push({ 
                            ...baseData, 
                            '서비스': '', 
                            '서비스 상세내용': '',
                            '서비스 메모': ''
                        }); 
                    }
                }); 
                const ws = XLSX.utils.json_to_sheet(excelData);
                ws['!cols'] = [{ wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 30 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 20 }];
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "서비스일지"); XLSX.writeFile(wb, `서비스일지_${new Date().toISOString().slice(0,10)}.xlsx`);
            },
            
            // 일지 업로드 양식 다운로드
            downloadLogTemplate: () => {
                const headers = ['날짜', '이름', '제공방법', '서비스', '서비스 상세내용', '서비스 메모', '진행내용', '제공자'];
                const example = ['2024-01-01', '홍길동', '방문', '위기관리체계구축', '초기상담', '특이사항 없음', '대상자 가정 방문하여 상담 진행함.', '김사회'];
                const ws = XLSX.utils.aoa_to_sheet([headers, example]);
                ws['!cols'] = [{ wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 40 }, { wch: 10 }];
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "일지등록양식");
                XLSX.writeFile(wb, "일지등록양식.xlsx");
            },

            // 일지 엑셀 업로드 로직 (날짜+이름 기준 병합)
            uploadLogExcel: (input) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const wb = XLSX.read(e.target.result, {type:'binary'});
                        const sheet = wb.Sheets[wb.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(sheet, {header:1});
                        
                        const rows = json.slice(1);
                        if (rows.length === 0) { alert("데이터가 없습니다."); return; }

                        const logGroups = {}; 

                        rows.forEach(row => {
                            // 필수 값 확인 (날짜, 이름)
                            if (!row[0] || !row[1]) return;

                            // 날짜 포맷팅 (YYYY-MM-DD)
                            let dateStr = String(row[0]).trim();
                            if (!isNaN(dateStr) && dateStr.length < 8) {
                                const dateObj = new Date((dateStr - (25567 + 2)) * 86400 * 1000); 
                                dateStr = dateObj.toISOString().split('T')[0];
                            } else {
                                const nums = dateStr.replace(/[^0-9]/g, '');
                                if(nums.length === 8) dateStr = `${nums.slice(0,4)}-${nums.slice(4,6)}-${nums.slice(6,8)}`;
                            }

                            const clientName = String(row[1]).trim();
                            const groupKey = `${dateStr}_${clientName}`; 

                            if (!logGroups[groupKey]) {
                                const client = state.clients.find(c => c.name === clientName);
                                const clientId = client ? client.id : 'unknown';

                                logGroups[groupKey] = {
                                    date: dateStr,
                                    clientName: clientName,
                                    clientId: clientId,
                                    provideMethod: row[2] ? String(row[2]).trim() : '방문',
                                    content: row[6] ? String(row[6]).trim() : '', 
                                    provider: row[7] ? String(row[7]).trim() : '',
                                    serviceItems: []
                                };
                            }

                            const category = row[3] ? String(row[3]).trim() : '';
                            const serviceName = row[4] ? String(row[4]).trim() : '';
                            const serviceNote = row[5] ? String(row[5]).trim() : ''; 

                            if (category || serviceName) {
                                logGroups[groupKey].serviceItems.push({
                                    id: Date.now() + Math.random(),
                                    category: category,
                                    serviceName: serviceName,
                                    detailNote: serviceNote
                                });
                            }
                        });

                        let successCount = 0;
                        const promises = Object.values(logGroups).map(async (logData) => {
                            const mandatoryService = '정서지원서비스(안전안부확인)';
                            const hasMandatory = logData.serviceItems.some(item => item.serviceName === mandatoryService);
                            
                            if (!hasMandatory) {
                                logData.serviceItems.unshift({
                                    id: Date.now() + Math.random(),
                                    category: '노인상담 및 정보제공',
                                    serviceName: mandatoryService,
                                    detailNote: ''
                                });
                            }

                            const serviceNameSummary = logData.serviceItems.map(i => i.serviceName).filter(Boolean).join(', ');
                            
                            await addDoc(collection(db, "logs"), {
                                ...logData,
                                serviceName: serviceNameSummary
                            });
                            successCount++;
                        });

                        Promise.all(promises).then(() => {
                            alert(`${successCount}건의 일지가 등록되었습니다.\n(날짜와 이름이 같은 항목은 하나로 합쳐졌으며,\n필수 서비스[안전안부확인]가 자동 추가되었습니다)`);
                            input.value = ''; 
                        });

                    } catch (err) {
                        console.error(err);
                        alert("파일 읽기 실패: 양식을 확인해주세요.");
                        input.value = '';
                    }
                };
                reader.readAsBinaryString(input.files[0]);
            },
            printLogs: () => {
                const { start, end, search, category, service } = state.filters.log;
                const filtered = state.logs.filter(l => (!start || l.date >= start) && (!end || l.date <= end) && (!search || l.clientName.includes(search)) && (!category || (l.serviceItems && l.serviceItems.some(i => i.category === category))) && (!service || (l.serviceItems && l.serviceItems.some(i => i.serviceName === service)))).sort((a, b) => new Date(a.date) - new Date(b.date));
                if (filtered.length === 0) { alert("인쇄할 일지가 없습니다."); return; }
                const printWindow = window.open('', '', 'width=1100,height=800');
                const minDate = filtered[0].date;
                const maxDate = filtered[filtered.length - 1].date;
                const dateRangeText = `기간 : ${minDate} ~ ${maxDate}`;
                let rowsHTML = '';
                filtered.forEach(l => {
                    const client = state.clients.find(c => c.id === l.clientId);
                    let clientInfo = '';
                    if (client) {
                        let birthShort = '-';
                        if (client.birthDate && client.birthDate.length >= 4) {
                            birthShort = client.birthDate.substring(2).replace(/-/g, '.');
                        }
                        const level = client.careLevel || '-';
                        clientInfo = `(${birthShort} / ${level})`;
                    }
                    const servicesHTML = l.serviceItems && l.serviceItems.length > 0 ? l.serviceItems.map((i, idx, arr) => {
                        const style = idx < arr.length - 1 ? 'border-bottom: 1px solid #ddd; padding-bottom: 4px; margin-bottom: 4px;' : '';
                        return `<div style="${style} text-align: left; font-size: 11px;">
                            <div style="font-weight:bold; margin-bottom: 2px;">[${i.category}]</div>
                            <div style="padding-left: 2px;">${i.serviceName}${i.detailNote ? ` - <span style="color:#555;">${i.detailNote}</span>` : ''}</div>
                        </div>`;
                    }).join('') : '-';
                    rowsHTML += `<tr><td style="text-align:center;">${l.date}</td><td style="text-align:center;"><b>${l.clientName}</b><br><span style="font-size:0.8em; color:#666; letter-spacing: -1px; white-space: nowrap;">${clientInfo}</span></td><td style="text-align:center;">${l.provideMethod || '방문'}</td><td style="padding:5px; vertical-align: top;">${servicesHTML}</td><td style="white-space:pre-wrap; padding:5px;">${l.content}</td><td style="text-align:center; vertical-align: middle;">${l.provider || ''}</td></tr>`;
                });
                
                const printDocument = `<html><head><title>서비스제공 · 과정상담기록지</title><style>@media print { @page { margin-left: 1.5cm; margin-right: 0.5cm; margin-top: 1cm; margin-bottom: 1cm; } body { margin: 0; padding: 0; -webkit-print-color-adjust: exact; font-size: 12px; } table { page-break-inside: auto; } tr { page-break-inside: avoid; page-break-after: auto; } .header-container { display: block !important; } } body { font-family: "Malgun Gothic", sans-serif; padding: 20px; } .header-container { position: relative; width: 100%; height: 80px; border-bottom: 2px solid #333; margin-bottom: 10px; } .header-title { margin: 0; padding: 0; line-height: 80px; text-align: center; font-size: 22px; font-weight: bold; } .approval-box { position: absolute; right: 0; bottom: 5px; border-collapse: collapse; text-align: center; font-size: 11px; background: white; } .approval-box td { border: 1px solid #333; padding: 0; } .approval-header { background: #f0f0f0; height: 20px; width: 60px; font-weight: bold; } .approval-sign { height: 50px; } .date-range { text-align: left; font-size: 12px; margin-bottom: 10px; font-weight: bold; color: #555; } table.main-table { width: 100%; border-collapse: collapse; font-size: 12px; } table.main-table th, table.main-table td { border: 1px solid #999; padding: 6px; vertical-align: top; } table.main-table th { background-color: #f0f0f0; text-align: center; font-weight: bold; height: 30px; } </style></head><body><div class="header-container"><h1 class="header-title">서비스제공 · 과정상담기록지</h1><table class="approval-box"><tr><td rowspan="2" style="width: 20px; background: #f0f0f0; font-weight: bold; vertical-align: middle;">결<br>재</td><td class="approval-header">담당자</td><td class="approval-header">센터장</td></tr><tr><td class="approval-sign"></td><td class="approval-sign"></td></tr></table></div><div class="date-range">${dateRangeText}</div><table class="main-table"><thead><tr><th width="75">일자</th><th width="55">대상자</th><th width="40">방법</th><th width="180">서비스 내용</th><th>진행 내용</th><th width="45">제공자</th></tr></thead><tbody>${rowsHTML}</tbody></table><script>window.onload = function() { setTimeout(function() { window.print(); window.close(); }, 500); }<\/script></body></html>`;
                printWindow.document.write(printDocument); printWindow.document.close();
            },
            setStatsStart: (val) => {
                state.filters.stats.start = val;
                // [최적화] 전체 렌더링 대신 해당 탭만 업데이트
                if (state.viewMode === 'single') updateTabContent('statistics'); else render();
                setTimeout(() => {
                    const endInput = document.getElementById('stats-end');
                    if (endInput) {
                        endInput.focus();
                        if (typeof endInput.showPicker === 'function') {
                            try { endInput.showPicker(); } catch (e) { console.log('showPicker not supported:', e); }
                        }
                    }
                }, 50);
            },
            closeDialog: () => closeDialog(),
            updateOpts: (el) => { const svcs = state.services.filter(s => s.category === el.value); el.nextElementSibling.innerHTML = svcs.map(s => `<option value="${s.name}">${s.name}</option>`).join(''); }
        };

        function showModal(html) { const m = document.getElementById('modal-container'); m.innerHTML = html; m.classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal-container').classList.add('hidden'); }
        function showDialog(html) { const d = document.getElementById('dialog-container'); d.innerHTML = html; d.classList.remove('hidden'); }
        function closeDialog() { document.getElementById('dialog-container').classList.add('hidden'); }
        
        function renderSvcRow(item) {
            const cats = [...new Set(state.services.map(s => s.category))];
            const div = document.createElement('div');
            div.className = "svc-row flex flex-col sm:flex-row gap-2 mb-2 p-2 border rounded bg-white sm:bg-transparent sm:border-0";
            div.id = `row-${item.id || Date.now()}`;
            div.innerHTML = `
                <select class="cat-sel input-field w-full sm:w-1/4" onchange="app.updateOpts(this)"><option value="">분류</option>${cats.map(c=>`<option value="${c}" ${item.category===c?'selected':''}>${c}</option>`).join('')}</select>
                <select class="svc-sel input-field w-full sm:w-1/3"><option value="${item.serviceName}">${item.serviceName||'선택'}</option></select>
                <div class="flex w-full sm:flex-1 gap-2"><input class="det-inp input-field flex-1" placeholder="메모" value="${item.detailNote||''}"><button type="button" onclick="app.removeSvcRow('${div.id.split('-')[1]}')" class="text-red-400 p-1"><i data-lucide="minus-circle"></i></button></div>
            `;
            document.getElementById('svc-container').appendChild(div);
            if(item.category) { const sel = div.querySelector('.svc-sel'); const svcs = state.services.filter(s => s.category === item.category); sel.innerHTML = svcs.map(s => `<option value="${s.name}" ${s.name===item.serviceName?'selected':''}>${s.name}</option>`).join(''); }
            lucide.createIcons();
        }

        function render() {
            // [최적화] Single 모드일 때는 render()가 데이터 갱신 역할만 수행
            if (state.viewMode === 'single') {
                // 현재 보고 있는 탭의 내용만 업데이트 (데이터가 변경되었을 때 호출됨)
                // 로딩 화면 제거
                const loader = document.getElementById('initial-loader');
                if (loader) loader.remove();
                
                updateTabContent(state.activeTab);
                app.updateTabVisibility(); // 탭바 상태 동기화
                return;
            }

            // [윈도우 모드 렌더링]
            let main = document.getElementById('main-view-container'); // ID 변경됨
            if (!main) return;
            
            // 상단 탭 렌더링
            app.renderTabBar(state.activeTab);

            // 분할 뷰 모드 설정
            // [수정] 윈도우 모드는 화면 전체를 덮는 고정 컨테이너여야 함
            main.className = "fixed inset-0 top-14 bg-slate-100 z-0 overflow-hidden"; // fixed로 변경하여 전체 덮기
            main.innerHTML = ""; // 기존 컨텐츠 초기화 (윈도우 모드는 래퍼 방식 아님)

            // 윈도우 생성 헬퍼 함수
            const createWindow = (paneId) => {
                const winState = state.windows[paneId];
                const tabKey = state.paneTabs[paneId];
                const isActive = state.focusedPane === paneId;
                
                const winDiv = document.createElement('div');
                winDiv.id = `window-${paneId}`;
                // [수정] 윈도우 모드 내부에서는 flex 및 overflow-hidden 필요 (창 내부 스크롤)
                winDiv.className = `window-pane ${isActive ? 'active' : ''}`;
                winDiv.style.left = `${winState.x}px`;
                winDiv.style.top = `${winState.y}px`;
                winDiv.style.width = `${winState.w}px`;
                winDiv.style.height = `${winState.h}px`;
                winDiv.style.zIndex = winState.z;
                
                // 마우스 다운 시 활성화 (Z-Index 처리)
                winDiv.onmousedown = () => app.setFocusedPane(paneId);

                // 8방향 리사이즈 핸들 HTML 생성
                const handles = ['n', 's', 'e', 'w', 'ne', 'nw', 'se', 'sw'].map(dir => 
                    `<div class="resizer resizer-${dir}" onmousedown="app.startResize(event, '${paneId}', '${dir}')"></div>`
                ).join('');

                winDiv.innerHTML = `
                    <div class="window-header" onmousedown="app.startDrag(event, '${paneId}')">
                        <div class="window-title">
                            <i data-lucide="${isActive ? 'app-window' : 'minus-square'}" size="16"></i>
                            <span>${TAB_NAMES[tabKey] || tabKey}</span>
                        </div>
                        <div class="window-controls">
                            <!-- 최소화/최대화 버튼 제거 -->
                            <div class="window-control-btn btn-close" onclick="app.toggleSplitView()" title="창 닫기 (분할 모드 종료)"></div>
                        </div>
                    </div>
                    <!-- [수정] 윈도우 내부 컨텐츠: overflow-auto 적용 -->
                    <div class="window-content p-4 overflow-y-auto h-full flex-1">
                        ${getTabHTML(tabKey)}
                    </div>
                    ${handles}
                `;
                return winDiv;
            };

            main.appendChild(createWindow('left'));
            main.appendChild(createWindow('right'));

            lucide.createIcons();
        }

        initDataSync();
    </script>
</body>
</html>
