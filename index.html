<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>청전광장 - 사회복지 통합관리 시스템</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- XLSX Library (Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        .input-field {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            outline: none;
            transition: border-color 0.2s;
            background-color: white;
        }

        .input-field:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hidden {
            display: none !important;
        }

        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-slate-50 z-[100] flex flex-col items-center justify-center text-slate-400">
        <i data-lucide="loader-2" class="w-10 h-10 animate-spin text-emerald-600 mb-4"></i>
        <p>데이터를 불러오는 중입니다...</p>
    </div>

    <!-- Mobile Header -->
    <div class="md:hidden fixed top-0 left-0 right-0 bg-slate-800 text-white p-4 flex justify-between items-center z-40 h-16">
        <h1 class="font-bold flex items-center gap-2">
            <i data-lucide="book-open" class="text-emerald-400"></i>
            청전광장
        </h1>
        <button onclick="toggleSidebar()">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
    </div>

    <!-- Sidebar -->
    <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-slate-800 text-white transform -translate-x-full md:relative md:translate-x-0 sidebar-transition flex flex-col flex-shrink-0 pt-16 md:pt-0">
        <div class="p-6 flex items-center justify-between hidden md:flex">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i data-lucide="book-open" class="text-emerald-400"></i>
                청전광장
            </h1>
        </div>
        
        <nav class="flex-1 px-4 space-y-2 mt-4 md:mt-0">
            <button onclick="switchTab('dashboard')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-slate-300 hover:bg-slate-700" data-tab="dashboard">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i> 홈
            </button>
            <button onclick="switchTab('clients')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-slate-300 hover:bg-slate-700" data-tab="clients">
                <i data-lucide="users" class="w-5 h-5"></i> 대상자 관리
            </button>
            <button onclick="switchTab('logs')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-slate-300 hover:bg-slate-700" data-tab="logs">
                <i data-lucide="file-text" class="w-5 h-5"></i> 서비스 일지
            </button>
            <button onclick="switchTab('statistics')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-slate-300 hover:bg-slate-700" data-tab="statistics">
                <i data-lucide="bar-chart-2" class="w-5 h-5"></i> 통계
            </button>
            <button onclick="switchTab('services')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-slate-300 hover:bg-slate-700" data-tab="services">
                <i data-lucide="settings" class="w-5 h-5"></i> 서비스 목록 설정
            </button>
        </nav>
        
        <div class="p-4 bg-slate-900 text-xs text-slate-400">
            <div class="flex items-center gap-2 mb-1 text-emerald-400">
                <i data-lucide="cloud" class="w-3 h-3"></i>
                <span>실시간 데이터 동기화 중</span>
            </div>
            <p>사회복지 통합관리 시스템 v2.1</p>
        </div>

        <!-- Mobile Close Button -->
        <button onclick="toggleSidebar()" class="absolute top-4 right-4 md:hidden text-slate-400 hover:text-white">
            <i data-lucide="x" class="w-6 h-6"></i>
        </button>
    </div>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-8 overflow-y-auto mt-16 md:mt-0 bg-slate-50">
        <div class="max-w-5xl mx-auto">
            
            <!-- Dashboard View -->
            <div id="view-dashboard" class="space-y-6 fade-in">
                <!-- Content will be injected by JS -->
            </div>

            <!-- Clients View -->
            <div id="view-clients" class="space-y-6 hidden fade-in">
                <!-- Content will be injected by JS -->
            </div>

            <!-- Logs View -->
            <div id="view-logs" class="space-y-6 hidden fade-in">
                <!-- Content will be injected by JS -->
            </div>

            <!-- Statistics View -->
            <div id="view-statistics" class="space-y-6 hidden fade-in">
                <!-- Content will be injected by JS -->
            </div>

            <!-- Services View -->
            <div id="view-services" class="space-y-6 hidden fade-in">
                <!-- Content will be injected by JS -->
            </div>

        </div>
    </main>

    <!-- Modals -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div id="modal-content" class="bg-white rounded-xl max-w-4xl w-full p-6 shadow-xl relative max-h-[90vh] overflow-y-auto">
            <!-- Dynamic Modal Content -->
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- Configuration & Constants ---
        const DONG_LIST = ['대연동', '감만동', '우암동', '문현동', '용호동', '용당동'];
        const GENDER_LIST = ['남성', '여성'];
        const STATUS_LIST = ['이용', '장기부재', '종결'];
        const CARE_LEVEL_LIST = ['일반', '중점'];
        const ECONOMIC_LIST = ['일반(저소득)', '기초수급', '조건부 기초수급', '차상위'];
        const HOUSEHOLD_LIST = ['독거세대', '부부세대', '동거', '자녀동거세대', '조손동거세대'];
        const PROVIDE_METHOD_LIST = ['전화', '방문', '내방'];
        
        const apiKey = ""; // Runtime provided

        // --- Firebase Init ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Global State ---
        const state = {
            user: null,
            clients: [],
            services: [],
            logs: [],
            activeTab: 'dashboard',
            filters: {
                clients: { status: '', careLevel: '', region: '', gender: '', search: '' },
                logs: { startDate: '', endDate: '', category: '', service: '', search: '' },
                stats: { startDate: '', endDate: '', viewType: 'detail', name: '', region: '' }
            },
            editingId: null, // For client or log edits
            tempLogItems: [] // For adding multiple services in log form
        };

        // --- Initialization ---
        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        }

        initAuth();

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if (user) {
                setupRealtimeListeners();
            } else {
                document.getElementById('loading-screen').classList.add('hidden');
            }
        });

        function setupRealtimeListeners() {
            const basePath = ['artifacts', appId, 'public', 'data'];
            
            // Clients
            onSnapshot(collection(db, ...basePath, 'clients'), (snap) => {
                state.clients = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                refreshUI();
            });

            // Services
            onSnapshot(collection(db, ...basePath, 'services'), (snap) => {
                state.services = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                refreshUI();
            });

            // Logs
            onSnapshot(collection(db, ...basePath, 'logs'), (snap) => {
                const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                data.sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date));
                state.logs = data;
                document.getElementById('loading-screen').classList.add('hidden');
                refreshUI();
            });
        }

        // --- Helper Functions ---
        window.calculateAge = (birthDate) => {
            if (!birthDate) return 0;
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
            return age;
        };

        async function callGemini(prompt) {
            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                    }
                );
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "응답 없음";
            } catch (error) {
                console.error(error);
                return "AI 서비스 연결 오류. 잠시 후 다시 시도하세요.";
            }
        }

        // --- UI Logic: Navigation ---
        window.switchTab = (tabId) => {
            state.activeTab = tabId;
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            
            // Sidebar Active State
            document.querySelectorAll('.nav-item').forEach(el => {
                if(el.dataset.tab === tabId) {
                    el.classList.add('bg-emerald-600', 'text-white');
                    el.classList.remove('text-slate-300', 'hover:bg-slate-700');
                } else {
                    el.classList.remove('bg-emerald-600', 'text-white');
                    el.classList.add('text-slate-300', 'hover:bg-slate-700');
                }
            });

            // Mobile sidebar close
            document.getElementById('sidebar').classList.add('-translate-x-full');

            refreshUI();
        };

        window.toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
            } else {
                sidebar.classList.add('-translate-x-full');
            }
        };

        function refreshUI() {
            lucide.createIcons();
            if (state.activeTab === 'dashboard') renderDashboard();
            if (state.activeTab === 'clients') renderClients();
            if (state.activeTab === 'logs') renderLogs();
            if (state.activeTab === 'statistics') renderStatistics();
            if (state.activeTab === 'services') renderServices();
        }

        // --- Render: Dashboard ---
        function renderDashboard() {
            const todayLogs = state.logs.filter(l => l.date === new Date().toISOString().split('T')[0]).length;
            const highFocusCount = state.clients.filter(c => c.careLevel === '중점').length;
            const generalCount = state.clients.filter(c => c.careLevel === '일반').length;

            const recentLogs = state.logs.slice(0, 5).map(log => `
                <div onclick="openLogDetail('${log.id}')" class="flex items-start gap-4 pb-4 border-b last:border-0 last:pb-0 border-slate-100 cursor-pointer hover:bg-slate-50 rounded p-2 transition-colors">
                    <div class="mt-1 p-2 bg-slate-100 rounded-full text-slate-500"><i data-lucide="check-circle" class="w-4 h-4"></i></div>
                    <div>
                        <p class="font-medium text-slate-800">
                            <span class="text-emerald-600 font-bold">${log.clientName || ''}</span>님에게 
                            <span class="bg-slate-100 px-2 py-0.5 rounded mx-2 text-sm">${log.serviceName || '서비스'}</span>
                            제공
                        </p>
                        <p class="text-sm text-slate-500 mt-1">${log.date} | ${(log.content || '').substring(0, 50)}...</p>
                    </div>
                </div>
            `).join('');

            const html = `
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-slate-800">홈</h2>
                    <div class="text-sm text-slate-500 flex items-center gap-1">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        실시간 연결됨
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                        <div class="p-3 bg-blue-100 text-blue-600 rounded-lg"><i data-lucide="users"></i></div>
                        <div>
                            <p class="text-sm text-slate-500">총 대상자</p>
                            <div class="flex items-baseline gap-2">
                                <p class="text-2xl font-bold text-slate-800">${state.clients.length}명</p>
                            </div>
                            <p class="text-xs text-slate-400 mt-1">(중점: <span class="text-pink-600">${highFocusCount}</span> / 일반: <span class="text-blue-600">${generalCount}</span>)</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                        <div class="p-3 bg-emerald-100 text-emerald-600 rounded-lg"><i data-lucide="file-text"></i></div>
                        <div>
                            <p class="text-sm text-slate-500">오늘 작성된 일지</p>
                            <p class="text-2xl font-bold text-slate-800">${todayLogs}건</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                        <div class="p-3 bg-purple-100 text-purple-600 rounded-lg"><i data-lucide="settings"></i></div>
                        <div>
                            <p class="text-sm text-slate-500">제공 가능 서비스</p>
                            <p class="text-2xl font-bold text-slate-800">${state.services.length}개</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">최근 활동 기록</h3>
                    <div class="space-y-4">${recentLogs || '<p class="text-slate-400 text-center py-4">기록이 없습니다.</p>'}</div>
                </div>
            `;
            document.getElementById('view-dashboard').innerHTML = html;
            lucide.createIcons();
        }

        window.openLogDetail = (logId) => {
            state.activeTab = 'logs';
            switchTab('logs');
            // Slight delay to ensure render
            setTimeout(() => {
                const log = state.logs.find(l => l.id === logId);
                if(log) openLogModal(log);
            }, 100);
        }

        // --- Render: Clients ---
        function renderClients() {
            const f = state.filters.clients;
            const filtered = state.clients.filter(c => {
                return (f.status === '' || c.status === f.status) &&
                       (f.careLevel === '' || c.careLevel === f.careLevel) &&
                       (f.region === '' || c.region === f.region) &&
                       (f.gender === '' || c.gender === f.gender) &&
                       (f.search === '' || (c.name && c.name.includes(f.search)));
            }).sort((a,b) => (b.serviceStartDate || '').localeCompare(a.serviceStartDate || ''));

            const clientCards = filtered.map(c => {
                const age = calculateAge(c.birthDate);
                let statusClass = c.status === '이용' ? 'bg-green-100 text-green-700' : c.status === '장기부재' ? 'bg-orange-100 text-orange-700' : 'bg-slate-100 text-slate-500';
                
                return `
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow relative group ${c.status === '종결' ? 'opacity-75' : ''}">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <h3 class="font-bold text-lg text-slate-800">${c.name}</h3>
                            <span class="text-sm font-bold ${c.gender === '남성' ? 'text-blue-500' : 'text-red-500'}">(${age}세/${c.gender})</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs px-2 py-1 rounded font-medium ${statusClass}">${c.status}</span>
                            <button onclick="openClientModal('${c.id}')" class="text-slate-300 hover:text-blue-500"><i data-lucide="edit" class="w-4 h-4"></i></button>
                            <button onclick="deleteClient('${c.id}')" class="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-1 mb-3">
                        <span class="bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded">${c.region || '-'}</span>
                        <span class="text-xs px-2 py-1 rounded ${c.careLevel === '중점' ? 'bg-pink-100 text-pink-700' : 'bg-blue-100 text-blue-700'}">${c.careLevel}</span>
                        <span class="bg-amber-50 text-amber-700 text-xs px-2 py-1 rounded">${c.economicStatus || '-'}</span>
                    </div>
                    <div class="space-y-1 text-sm text-slate-600 mb-4">
                        <p class="flex items-center gap-2"><i data-lucide="phone" class="w-3 h-3"></i> ${c.phone || '-'}</p>
                        <p class="flex items-center gap-2"><i data-lucide="home" class="w-3 h-3"></i> ${c.address || '-'}</p>
                    </div>
                    ${c.status !== '종결' ? `<button onclick="getAiRecommendation('${c.id}')" class="w-full flex items-center justify-center gap-2 py-2 bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100 transition-colors text-sm font-medium"><i data-lucide="sparkles" class="w-4 h-4"></i> AI 케어 제안</button>` : ''}
                </div>`;
            }).join('');

            const html = `
                <div class="flex flex-col md:flex-row justify-between items-center gap-2">
                    <h2 class="text-2xl font-bold text-slate-800">대상자 관리</h2>
                    <div class="flex gap-2">
                        <button onclick="downloadClientTemplate()" class="flex items-center gap-1 bg-slate-100 text-slate-600 px-3 py-2 rounded-lg hover:bg-slate-200 text-sm"><i data-lucide="download" class="w-4 h-4"></i> 양식</button>
                        <label class="flex items-center gap-1 bg-slate-100 text-slate-600 px-3 py-2 rounded-lg hover:bg-slate-200 text-sm cursor-pointer">
                            <i data-lucide="upload" class="w-4 h-4"></i> 엑셀 등록
                            <input type="file" onchange="uploadClientExcel(this)" accept=".xlsx" class="hidden">
                        </label>
                        <button onclick="openClientModal()" class="flex items-center gap-2 bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-colors">
                            <i data-lucide="plus" class="w-4 h-4"></i> 대상자 등록
                        </button>
                    </div>
                </div>

                <!-- Stats Summary -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                     <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center">
                        <div><p class="text-sm text-slate-500">총 대상자</p><p class="text-2xl font-bold text-slate-800">${state.clients.length}명</p></div>
                        <i data-lucide="users" class="text-slate-300"></i>
                     </div>
                     <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                         <p class="text-sm text-slate-500">관리 등급</p>
                         <div class="flex gap-3 mt-2">
                             <span class="text-sm font-bold text-pink-600">중점 ${state.clients.filter(c=>c.careLevel==='중점').length}</span>
                             <span class="text-sm font-bold text-blue-600">일반 ${state.clients.filter(c=>c.careLevel==='일반').length}</span>
                         </div>
                     </div>
                     <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                         <p class="text-sm text-slate-500">성별</p>
                         <div class="flex gap-3 mt-2">
                             <span class="text-sm font-bold text-blue-500">남 ${state.clients.filter(c=>c.gender==='남성').length}</span>
                             <span class="text-sm font-bold text-red-500">여 ${state.clients.filter(c=>c.gender==='여성').length}</span>
                         </div>
                     </div>
                </div>

                <!-- Filters -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-wrap items-center gap-2">
                    <div class="flex items-center gap-1 text-slate-600 mr-2"><i data-lucide="filter" class="w-4 h-4"></i><span class="font-bold text-sm">필터</span></div>
                    <input type="text" placeholder="이름 검색" class="input-field py-2 w-32 md:w-48 text-sm" value="${f.search}" oninput="updateClientFilter('search', this.value)">
                    <select class="input-field py-2 w-24 md:w-32 text-sm" onchange="updateClientFilter('status', this.value)">
                        <option value="">상태 (전체)</option>${STATUS_LIST.map(s=>`<option value="${s}" ${f.status===s?'selected':''}>${s}</option>`).join('')}
                    </select>
                    <select class="input-field py-2 w-24 md:w-32 text-sm" onchange="updateClientFilter('careLevel', this.value)">
                        <option value="">등급 (전체)</option>${CARE_LEVEL_LIST.map(s=>`<option value="${s}" ${f.careLevel===s?'selected':''}>${s}</option>`).join('')}
                    </select>
                    <select class="input-field py-2 w-24 md:w-32 text-sm" onchange="updateClientFilter('region', this.value)">
                        <option value="">행정동 (전체)</option>${DONG_LIST.map(s=>`<option value="${s}" ${f.region===s?'selected':''}>${s}</option>`).join('')}
                    </select>
                    <button onclick="resetClientFilters()" class="text-xs text-slate-400 hover:text-slate-600 flex items-center gap-1 ml-auto"><i data-lucide="refresh-cw" class="w-3 h-3"></i> 초기화</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${filtered.length ? clientCards : '<div class="col-span-full py-12 text-center text-slate-400 border-2 border-dashed border-slate-200 rounded-xl">데이터가 없습니다.</div>'}
                </div>
            `;
            document.getElementById('view-clients').innerHTML = html;
            lucide.createIcons();
        }

        window.updateClientFilter = (key, val) => {
            state.filters.clients[key] = val;
            renderClients();
        };
        window.resetClientFilters = () => {
            state.filters.clients = { status: '', careLevel: '', region: '', gender: '', search: '' };
            renderClients();
        };

        // --- Render: Logs ---
        function renderLogs() {
            const f = state.filters.logs;
            // Get unique categories for filter
            const categories = [...new Set(state.services.map(s => s.category))];
            
            const filtered = state.logs.filter(log => {
                let match = true;
                if (f.search && !log.clientName.includes(f.search)) match = false;
                if (f.startDate && log.date < f.startDate) match = false;
                if (f.endDate && log.date > f.endDate) match = false;
                if (f.category) {
                    if (log.serviceItems) match = log.serviceItems.some(i => i.category === f.category);
                    else match = log.serviceCategory === f.category;
                }
                return match;
            });

            const logItems = filtered.map(log => {
                const client = state.clients.find(c => c.id === log.clientId);
                const clientDetails = client ? `${client.birthDate} (${calculateAge(client.birthDate)}세) | ${client.careLevel}` : '정보 없음';
                
                const servicesBadge = log.serviceItems && log.serviceItems.length 
                    ? log.serviceItems.map(i => `<span class="inline-flex text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded mr-1 mb-1">${i.serviceName} ${i.detailNote ? '- '+i.detailNote : ''}</span>`).join('')
                    : `<span class="inline-flex text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded">${log.serviceName}</span>`;

                return `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col md:flex-row gap-4">
                    <div class="md:w-48 flex-shrink-0 flex flex-col justify-center md:border-r md:border-slate-100 md:pr-4">
                        <span class="text-sm text-slate-500">${log.date}</span>
                        <div>
                            <h4 class="font-bold text-lg text-slate-800 inline-block">${log.clientName}</h4>
                            <p class="text-xs text-slate-500 mt-0.5">${clientDetails}</p>
                        </div>
                        <div class="mt-2 flex flex-wrap">${servicesBadge}</div>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-end items-center gap-1 mb-2">
                             <button onclick="copyLog('${log.id}')" class="p-1 text-slate-400 hover:text-emerald-500" title="복사"><i data-lucide="copy" class="w-4 h-4"></i></button>
                             <button onclick="openLogModal(null, '${log.id}')" class="p-1 text-slate-400 hover:text-blue-500" title="수정"><i data-lucide="edit" class="w-4 h-4"></i></button>
                             <button onclick="deleteLog('${log.id}')" class="p-1 text-slate-400 hover:text-red-500" title="삭제"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                        <p class="text-slate-600 whitespace-pre-wrap text-sm">${log.content}</p>
                    </div>
                </div>`;
            }).join('');

            const html = `
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl font-bold text-slate-800">서비스 일지</h2>
                    <button onclick="openLogModal()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 flex items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i> 일지 작성
                    </button>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-wrap items-center gap-2">
                    <div class="flex items-center gap-1 text-slate-600 mr-2"><i data-lucide="filter" class="w-4 h-4"></i><span class="font-bold text-sm">필터</span></div>
                    <div class="flex items-center gap-2 bg-slate-50 rounded p-1 border border-slate-200">
                        <input type="date" class="bg-transparent text-sm outline-none" value="${f.startDate}" onchange="updateLogFilter('startDate', this.value)">
                        <span>~</span>
                        <input type="date" class="bg-transparent text-sm outline-none" value="${f.endDate}" onchange="updateLogFilter('endDate', this.value)">
                    </div>
                    <input type="text" placeholder="이름 검색" class="input-field py-2 w-32 text-sm" value="${f.search}" oninput="updateLogFilter('search', this.value)">
                    <select class="input-field py-2 w-32 text-sm" onchange="updateLogFilter('category', this.value)">
                        <option value="">서비스 (전체)</option>${categories.map(c=>`<option value="${c}" ${f.category===c?'selected':''}>${c}</option>`).join('')}
                    </select>
                    <button onclick="resetLogFilters()" class="ml-auto text-xs text-slate-400 hover:text-slate-600 flex items-center gap-1"><i data-lucide="refresh-cw" class="w-3 h-3"></i> 초기화</button>
                </div>

                <div class="space-y-4">
                    ${filtered.length ? logItems : '<div class="py-12 text-center text-slate-400 bg-white rounded-xl">일지가 없습니다.</div>'}
                </div>
            `;
            document.getElementById('view-logs').innerHTML = html;
            lucide.createIcons();
        }

        window.updateLogFilter = (key, val) => { state.filters.logs[key] = val; renderLogs(); };
        window.resetLogFilters = () => { state.filters.logs = { startDate: '', endDate: '', category: '', service: '', search: '' }; renderLogs(); };

        // --- Render: Statistics ---
        function renderStatistics() {
            const f = state.filters.stats;
            // Default dates
            if(!f.startDate) {
                const d = new Date(); d.setDate(1); 
                f.startDate = d.toISOString().split('T')[0];
                f.endDate = new Date().toISOString().split('T')[0];
            }

            const { startDate, endDate, viewType, name, region } = f;

            // Logic matching React code
            const filteredClients = state.clients.filter(c => 
                (name === '' || c.name.includes(name)) && 
                (region === '' || c.region === region)
            );

            // Group services
            const groups = {};
            const sortedServices = [...state.services].sort((a,b) => (a.majorCategory||'').localeCompare(b.majorCategory||'') || (a.category||'').localeCompare(b.category||''));
            sortedServices.forEach(s => {
                const cat = s.category || '기타';
                if(!groups[cat]) groups[cat] = [];
                if(!groups[cat].includes(s.name)) groups[cat].push(s.name);
            });
            const sortedCategories = Object.keys(groups).sort();

            let allKeys = [];
            if(viewType === 'category') {
                allKeys = [...new Set(state.services.map(s => s.category))].filter(Boolean).sort();
            } else {
                sortedCategories.forEach(cat => allKeys.push(...groups[cat]));
            }

            // Calc stats
            const stats = {};
            filteredClients.forEach(c => {
                stats[c.id] = { id: c.id, name: c.name, counts: {}, total: 0 };
                allKeys.forEach(k => stats[c.id].counts[k] = 0);
            });

            state.logs.forEach(log => {
                if(log.date < startDate || log.date > endDate) return;
                let cId = log.clientId;
                if(!stats[cId]) {
                    const found = filteredClients.find(c => c.name === log.clientName);
                    if(found) cId = found.id;
                    else return;
                }

                if(stats[cId]) {
                    const items = log.serviceItems && log.serviceItems.length ? log.serviceItems : [{serviceName: log.serviceName, category: log.serviceCategory}];
                    items.forEach(item => {
                        let key = '';
                        if(viewType === 'category') {
                            key = item.category;
                            if(!key && item.serviceName) {
                                const fs = state.services.find(s=>s.name===item.serviceName);
                                if(fs) key = fs.category;
                            }
                        } else {
                            key = item.serviceName;
                        }
                        if(key && stats[cId].counts[key] !== undefined) {
                            stats[cId].counts[key]++;
                            stats[cId].total++;
                        }
                    });
                }
            });

            const data = Object.values(stats).sort((a,b) => a.name.localeCompare(b.name));
            const colTotals = {};
            allKeys.forEach(k => colTotals[k] = data.reduce((sum, c) => sum + (c.counts[k]||0), 0));
            const grandTotal = data.reduce((sum, c) => sum + c.total, 0);

            // Build Table HTML
            let theadHtml = '';
            if(viewType === 'detail') {
                theadHtml = `
                    <tr>
                        <th rowspan="2" class="p-3 sticky left-0 bg-slate-50 z-10 border border-slate-200 min-w-[100px]">대상자</th>
                        <th rowspan="2" class="p-3 text-center bg-emerald-50 text-emerald-700 border border-slate-200 min-w-[60px]">합계</th>
                        ${sortedCategories.map(cat => `<th colspan="${groups[cat].length}" class="p-2 text-center border border-slate-200 bg-slate-100">${cat}</th>`).join('')}
                    </tr>
                    <tr>
                        ${sortedCategories.map(cat => groups[cat].map(sn => `<th class="p-2 text-center border border-slate-100 min-w-[80px] text-xs font-normal">${sn}</th>`).join('')).join('')}
                    </tr>
                `;
            } else {
                theadHtml = `
                    <tr>
                        <th class="p-3 sticky left-0 bg-slate-50 z-10 border border-slate-200 min-w-[100px]">대상자</th>
                        <th class="p-3 text-center bg-emerald-50 text-emerald-700 border border-slate-200 min-w-[60px]">합계</th>
                        ${allKeys.map(k => `<th class="p-3 text-center border border-slate-200 min-w-[100px]">${k}</th>`).join('')}
                    </tr>
                `;
            }

            const tbodyHtml = `
                <tr class="bg-slate-50 font-bold text-slate-700">
                    <td class="p-3 sticky left-0 bg-slate-50 border border-slate-200 text-center">전체 합계</td>
                    <td class="p-3 text-center bg-emerald-50 text-emerald-700 border border-slate-200">${grandTotal}</td>
                    ${allKeys.map(k => `<td class="p-3 text-center border border-slate-200">${colTotals[k]}</td>`).join('')}
                </tr>
                ${data.map(d => `
                    <tr class="hover:bg-slate-50">
                        <td class="p-3 font-medium sticky left-0 bg-white border border-slate-200 group-hover:bg-slate-50">${d.name}</td>
                        <td class="p-3 text-center font-bold text-emerald-600 bg-emerald-50/30 border border-slate-200">${d.total}</td>
                        ${allKeys.map(k => `<td class="p-3 text-center border border-slate-100 ${d.counts[k]>0?'bg-blue-50/50 font-medium text-slate-800':'text-slate-300'}">${d.counts[k]||'-'}</td>`).join('')}
                    </tr>
                `).join('')}
            `;

            const html = `
                <h2 class="text-2xl font-bold text-slate-800 mb-4">서비스 제공 통계</h2>
                <div class="flex flex-wrap items-center gap-3 mb-4">
                     <div class="flex bg-slate-100 p-1 rounded-lg">
                        <button onclick="updateStatsFilter('viewType', 'category')" class="px-3 py-1.5 rounded-md text-sm font-medium ${viewType==='category'?'bg-white text-emerald-600 shadow-sm':'text-slate-500'}">분류별</button>
                        <button onclick="updateStatsFilter('viewType', 'detail')" class="px-3 py-1.5 rounded-md text-sm font-medium ${viewType==='detail'?'bg-white text-emerald-600 shadow-sm':'text-slate-500'}">상세별</button>
                     </div>
                     <select class="input-field py-1.5 w-24 text-sm" onchange="updateStatsFilter('region', this.value)">
                        <option value="">전체 동</option>${DONG_LIST.map(d=>`<option value="${d}" ${region===d?'selected':''}>${d}</option>`).join('')}
                     </select>
                     <input type="text" placeholder="이름" class="input-field py-1.5 w-24 text-sm" value="${name}" oninput="updateStatsFilter('name', this.value)">
                     <div class="flex items-center gap-2 bg-white p-1.5 rounded-lg border border-slate-200">
                        <input type="date" value="${startDate}" onchange="updateStatsFilter('startDate', this.value)" class="text-xs outline-none">
                        <span>~</span>
                        <input type="date" value="${endDate}" onchange="updateStatsFilter('endDate', this.value)" class="text-xs outline-none">
                     </div>
                     <button onclick="downloadStatsExcel()" class="bg-emerald-600 text-white p-2 rounded-lg hover:bg-emerald-700"><i data-lucide="download" class="w-4 h-4"></i></button>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-x-auto">
                    <table class="w-full text-sm text-left border-collapse min-w-[800px]">
                        <thead class="bg-slate-50 text-slate-600 font-semibold">${theadHtml}</thead>
                        <tbody>${tbodyHtml}</tbody>
                    </table>
                </div>
            `;
            document.getElementById('view-statistics').innerHTML = html;
            lucide.createIcons();
            
            // Store data for excel export
            state.currentStatsData = { data, allKeys, grandTotal, colTotals, groups, sortedCategories, viewType };
        }

        window.updateStatsFilter = (k, v) => { state.filters.stats[k] = v; renderStatistics(); };

        // --- Render: Services ---
        function renderServices() {
            const html = `
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-slate-800">서비스 목록 설정</h2>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <form onsubmit="addService(event)" class="flex flex-col lg:flex-row gap-4 items-end">
                        <div class="w-full lg:w-1/5"><label class="block text-sm font-medium mb-1">대분류</label><input name="major" class="input-field" placeholder="위기관리"></div>
                        <div class="w-full lg:w-1/5"><label class="block text-sm font-medium mb-1">서비스(중분류)</label><input name="category" class="input-field" placeholder="사례관리" required></div>
                        <div class="w-full lg:w-1/4"><label class="block text-sm font-medium mb-1">상세내용</label><input name="name" class="input-field" placeholder="초기상담" required></div>
                        <div class="flex-1 w-full"><label class="block text-sm font-medium mb-1">예시</label><input name="example" class="input-field" placeholder="가정방문"></div>
                        <button type="submit" class="bg-slate-800 text-white px-6 py-2 rounded-lg h-[42px] whitespace-nowrap">추가</button>
                    </form>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-x-auto">
                    <table class="w-full text-left min-w-[800px]">
                        <thead class="bg-slate-50"><tr><th class="p-4">대분류</th><th class="p-4">서비스</th><th class="p-4">상세내용</th><th class="p-4">예시</th><th class="p-4 text-right">관리</th></tr></thead>
                        <tbody>
                            ${state.services.map(s => `
                                <tr class="border-t border-slate-100 hover:bg-slate-50">
                                    <td class="p-4">${s.majorCategory || '-'}</td>
                                    <td class="p-4"><span class="bg-slate-100 px-2 py-1 rounded text-xs">${s.category}</span></td>
                                    <td class="p-4 font-medium">${s.name}</td>
                                    <td class="p-4 text-sm text-slate-500">${s.example || '-'}</td>
                                    <td class="p-4 text-right"><button onclick="deleteService('${s.id}')" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('view-services').innerHTML = html;
            lucide.createIcons();
        }

        // --- Modals & Forms ---
        function openModal(contentHtml) {
            const m = document.getElementById('modal-overlay');
            const c = document.getElementById('modal-content');
            c.innerHTML = `
                <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
                ${contentHtml}
            `;
            m.classList.remove('hidden');
            lucide.createIcons();
        }

        window.closeModal = () => {
            document.getElementById('modal-overlay').classList.add('hidden');
            state.editingId = null;
            state.tempLogItems = [];
        };

        // Client Modal
        window.openClientModal = (id = null) => {
            state.editingId = id;
            const c = id ? state.clients.find(x => x.id === id) : {};
            const html = `
                <h3 class="font-bold text-lg mb-4">${id ? '대상자 수정' : '대상자 등록'}</h3>
                <form onsubmit="handleClientSubmit(event)" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm mb-1">이름</label><input name="name" class="input-field" value="${c.name||''}" required></div>
                        <div><label class="block text-sm mb-1">성별</label><select name="gender" class="input-field">${GENDER_LIST.map(g=>`<option ${c.gender===g?'selected':''}>${g}</option>`).join('')}</select></div>
                        <div><label class="block text-sm mb-1">생년월일</label><input type="date" name="birthDate" class="input-field" value="${c.birthDate||''}" required></div>
                        <div><label class="block text-sm mb-1">상태</label><select name="status" class="input-field">${STATUS_LIST.map(s=>`<option ${c.status===s?'selected':''}>${s}</option>`).join('')}</select></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm mb-1">연락처</label><input name="phone" class="input-field" value="${c.phone||''}"></div>
                        <div><label class="block text-sm mb-1">행정동</label><select name="region" class="input-field">${DONG_LIST.map(d=>`<option ${c.region===d?'selected':''}>${d}</option>`).join('')}</select></div>
                    </div>
                    <div><label class="block text-sm mb-1">주소</label><input name="address" class="input-field" value="${c.address||''}"></div>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-sm mb-1">등급</label><select name="careLevel" class="input-field">${CARE_LEVEL_LIST.map(x=>`<option ${c.careLevel===x?'selected':''}>${x}</option>`).join('')}</select></div>
                        <div><label class="block text-sm mb-1">경제상황</label><select name="economicStatus" class="input-field">${ECONOMIC_LIST.map(x=>`<option ${c.economicStatus===x?'selected':''}>${x}</option>`).join('')}</select></div>
                        <div><label class="block text-sm mb-1">세대유형</label><select name="householdType" class="input-field">${HOUSEHOLD_LIST.map(x=>`<option ${c.householdType===x?'selected':''}>${x}</option>`).join('')}</select></div>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-sm mb-1">시작일</label><input type="date" name="serviceStartDate" class="input-field" value="${c.serviceStartDate||''}"></div>
                        <div><label class="block text-sm mb-1">종결일</label><input type="date" name="endDate" class="input-field" value="${c.endDate||''}"></div>
                        <div><label class="block text-sm mb-1">부재기간</label><input name="absencePeriod" class="input-field" value="${c.absencePeriod||''}"></div>
                    </div>
                    <div><label class="block text-sm mb-1">비고</label><textarea name="note" class="input-field" rows="3">${c.note||''}</textarea></div>
                    <div class="flex justify-end gap-2 pt-2">
                        <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-100 rounded text-slate-600">취소</button>
                        <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">저장</button>
                    </div>
                </form>
            `;
            openModal(html);
        };

        // Log Modal
        window.openLogModal = (prefillData = null, editId = null) => {
            state.editingId = editId;
            const log = editId ? state.logs.find(l => l.id === editId) : (prefillData || {});
            
            // Init temp items
            state.tempLogItems = log.serviceItems ? [...log.serviceItems] : [{id: Date.now(), category: '', serviceId: '', serviceName: '', detailNote: ''}];

            const renderItems = () => {
                return state.tempLogItems.map((item, idx) => `
                    <div class="flex gap-2 items-center mb-2 service-row" data-id="${item.id}">
                        <select class="input-field flex-1" onchange="updateTempItem(${item.id}, 'category', this.value)">
                            <option value="">서비스 선택</option>
                            ${[...new Set(state.services.map(s=>s.category))].map(c=>`<option value="${c}" ${item.category===c?'selected':''}>${c}</option>`).join('')}
                        </select>
                        <select class="input-field flex-1" onchange="updateTempItem(${item.id}, 'serviceId', this.value)">
                            <option value="">상세 선택</option>
                            ${state.services.filter(s=>s.category===item.category).map(s=>`<option value="${s.id}" ${item.serviceId===s.id?'selected':''}>${s.name}</option>`).join('')}
                        </select>
                        <input class="input-field flex-1" placeholder="상세메모" value="${item.detailNote||''}" oninput="updateTempItem(${item.id}, 'detailNote', this.value)">
                        ${idx > 0 ? `<button type="button" onclick="removeTempItem(${item.id})" class="text-red-400"><i data-lucide="minus-circle"></i></button>` : ''}
                    </div>
                `).join('');
            };

            const html = `
                <h3 class="font-bold text-lg mb-4">${editId ? '일지 수정' : '일지 작성'}</h3>
                <form onsubmit="handleLogSubmit(event)" class="space-y-4">
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label class="block text-sm mb-1">날짜</label>
                            <input type="date" name="date" class="input-field" value="${log.date || new Date().toISOString().split('T')[0]}" required>
                        </div>
                        <div class="flex-1">
                             <label class="block text-sm mb-1">대상자</label>
                             <input list="client-list" name="clientName" class="input-field" value="${log.clientName||''}" placeholder="이름 검색" required>
                             <datalist id="client-list">${state.clients.map(c=>`<option value="${c.name}" data-id="${c.id}">`).join('')}</datalist>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex-1"><label class="block text-sm mb-1">제공방법</label><select name="provideMethod" class="input-field">${PROVIDE_METHOD_LIST.map(m=>`<option ${log.provideMethod===m?'selected':''}>${m}</option>`).join('')}</select></div>
                        <div class="flex-1"><label class="block text-sm mb-1">제공자</label><input name="provider" class="input-field" value="${log.provider||''}"></div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="block text-sm">서비스 내역</label>
                            <button type="button" onclick="addTempItem()" class="text-xs text-emerald-600 flex items-center gap-1"><i data-lucide="plus"></i>추가</button>
                        </div>
                        <div id="service-items-container">${renderItems()}</div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="block text-sm">내용</label>
                            <button type="button" onclick="aiDraftLog()" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded"><i data-lucide="sparkles" class="w-3 h-3 inline"></i> AI 다듬기</button>
                        </div>
                        <textarea id="log-content" name="content" class="input-field h-32" required>${log.content||''}</textarea>
                    </div>
                    <div class="flex justify-end gap-2 pt-2">
                        <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-100 rounded text-slate-600">취소</button>
                        <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">저장</button>
                    </div>
                </form>
            `;
            openModal(html);
        };

        // --- Log Form Dynamic Logic ---
        window.updateTempItem = (id, field, val) => {
            const idx = state.tempLogItems.findIndex(i => i.id === id);
            if(idx === -1) return;
            state.tempLogItems[idx][field] = val;
            if(field === 'category') {
                state.tempLogItems[idx].serviceId = '';
                state.tempLogItems[idx].serviceName = '';
                // Re-render to update dependent dropdown
                const container = document.getElementById('service-items-container');
                if(container) {
                    // Update only this row to avoid losing focus if possible, 
                    // but simple re-render is safer for vanilla js state sync
                    // We will just re-render the whole list for simplicity in this file
                    const selectService = document.querySelector(`.service-row[data-id="${id}"] select:nth-child(2)`);
                    const services = state.services.filter(s=>s.category===val);
                    selectService.innerHTML = '<option value="">상세 선택</option>' + services.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
                }
            } else if (field === 'serviceId') {
                const svc = state.services.find(s => s.id === val);
                state.tempLogItems[idx].serviceName = svc ? svc.name : '';
            }
        };

        window.addTempItem = () => {
            if(state.tempLogItems.length >= 6) return;
            state.tempLogItems.push({id: Date.now(), category: '', serviceId: '', serviceName: '', detailNote: ''});
            rerenderLogItems();
        };

        window.removeTempItem = (id) => {
            state.tempLogItems = state.tempLogItems.filter(i => i.id !== id);
            rerenderLogItems();
        };

        function rerenderLogItems() {
            const container = document.getElementById('service-items-container');
            if(!container) return;
            container.innerHTML = state.tempLogItems.map((item, idx) => `
                <div class="flex gap-2 items-center mb-2 service-row" data-id="${item.id}">
                    <select class="input-field flex-1" onchange="updateTempItem(${item.id}, 'category', this.value)">
                        <option value="">서비스 선택</option>
                        ${[...new Set(state.services.map(s=>s.category))].map(c=>`<option value="${c}" ${item.category===c?'selected':''}>${c}</option>`).join('')}
                    </select>
                    <select class="input-field flex-1" onchange="updateTempItem(${item.id}, 'serviceId', this.value)">
                        <option value="">상세 선택</option>
                        ${state.services.filter(s=>s.category===item.category).map(s=>`<option value="${s.id}" ${item.serviceId===s.id?'selected':''}>${s.name}</option>`).join('')}
                    </select>
                    <input class="input-field flex-1" placeholder="상세메모" value="${item.detailNote||''}" oninput="updateTempItem(${item.id}, 'detailNote', this.value)">
                    ${idx > 0 ? `<button type="button" onclick="removeTempItem(${item.id})" class="text-red-400"><i data-lucide="minus-circle"></i></button>` : ''}
                </div>
            `).join('');
            lucide.createIcons();
        }

        // --- Data Actions ---

        // Clients
        window.handleClientSubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.createdAt = new Date().toISOString();
            
            try {
                if(state.editingId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'clients', state.editingId), data);
                else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'clients'), data);
                closeModal();
                alert('저장되었습니다.');
            } catch(err) { console.error(err); alert('오류 발생'); }
        };

        window.deleteClient = async (id) => {
            if(!confirm('정말 삭제하시겠습니까?')) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'clients', id));
        };

        // Services
        window.addService = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'services'), data);
            e.target.reset();
        };

        window.deleteService = async (id) => {
            if(!confirm('삭제하시겠습니까?')) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'services', id));
        };

        // Logs
        window.handleLogSubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const basicData = Object.fromEntries(formData.entries());
            
            // Validate Client
            const client = state.clients.find(c => c.name === basicData.clientName);
            if(!client) { alert('존재하지 않는 대상자입니다.'); return; }
            
            // Validate Services
            const validItems = state.tempLogItems.filter(i => i.serviceName);
            if(validItems.length === 0) { alert('서비스를 하나 이상 선택해주세요.'); return; }

            const logData = {
                ...basicData,
                clientId: client.id,
                serviceItems: validItems,
                serviceName: validItems.map(i=>i.serviceName).join(', '),
                serviceCategory: validItems[0].category,
                timestamp: new Date().toISOString()
            };

            try {
                if(state.editingId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'logs', state.editingId), logData);
                else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), logData);
                closeModal();
            } catch(err) { console.error(err); alert('저장 실패'); }
        };

        window.copyLog = (id) => {
            const log = state.logs.find(l => l.id === id);
            if(!log) return;
            // Create a copy without ID and set date to today
            const copy = { ...log, date: new Date().toISOString().split('T')[0] };
            openLogModal(copy);
        };

        window.deleteLog = async (id) => {
            if(!confirm('삭제하시겠습니까?')) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'logs', id));
        };

        // --- AI Features ---
        window.getAiRecommendation = async (clientId) => {
            const client = state.clients.find(c => c.id === clientId);
            if(!client) return;
            
            const prompt = `
                당신은 전문 사회복지사입니다. 다음 대상자 정보를 바탕으로 필요한 복지 서비스나 주의해야 할 케어 포인트를 3가지 추천해주세요.
                대상자: ${client.name} (${client.gender}, ${calculateAge(client.birthDate)}세)
                등급: ${client.careLevel}, ${client.economicStatus}
                거주: ${client.region}
                상태: ${client.status}
            `;
            
            openModal(`<div class="text-center p-8"><i data-lucide="loader-2" class="animate-spin inline mr-2"></i> AI 분석 중...</div>`);
            const result = await callGemini(prompt);
            openModal(`
                <h3 class="font-bold text-lg mb-2 text-purple-700 flex items-center gap-2"><i data-lucide="sparkles"></i> AI 맞춤 제안</h3>
                <div class="prose prose-sm max-w-none whitespace-pre-wrap">${result}</div>
            `);
        };

        window.aiDraftLog = async () => {
            const content = document.getElementById('log-content').value;
            if(!content) { alert('내용을 입력해주세요.'); return; }
            
            const btn = document.querySelector('button[onclick="aiDraftLog()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '작성 중...';
            btn.disabled = true;

            const prompt = `다음 사회복지 일지 내용을 전문가스러운 문체로 다듬어주세요: "${content}"`;
            const result = await callGemini(prompt);
            
            document.getElementById('log-content').value = result;
            btn.innerHTML = originalText;
            btn.disabled = false;
        };

        // --- Excel Features ---
        window.downloadClientTemplate = () => {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([['이름','성별','생년월일','행정동','연락처','상태','주소','등급','경제상황','세대유형']]);
            XLSX.utils.book_append_sheet(wb, ws, "양식");
            XLSX.writeFile(wb, "대상자등록양식.xlsx");
        };

        window.uploadClientExcel = (input) => {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                let count = 0;
                json.forEach(row => {
                    if(row['이름']) {
                        addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'clients'), {
                            name: row['이름'],
                            gender: row['성별'] || '남성',
                            birthDate: row['생년월일'] || '',
                            region: row['행정동'] || '대연동',
                            phone: row['연락처'] || '',
                            status: row['상태'] || '이용',
                            address: row['주소'] || '',
                            careLevel: row['등급'] || '일반',
                            economicStatus: row['경제상황'] || '일반',
                            householdType: row['세대유형'] || '독거',
                            createdAt: new Date().toISOString()
                        });
                        count++;
                    }
                });
                alert(`${count}명 등록 완료`);
                input.value = '';
            };
            reader.readAsArrayBuffer(file);
        };

        window.downloadStatsExcel = () => {
            if(!state.currentStatsData) return;
            const { data, allKeys, grandTotal, colTotals, groups, sortedCategories, viewType } = state.currentStatsData;
            
            let headers = ['대상자', '합계', ...allKeys];
            let rows = data.map(d => [d.name, d.total, ...allKeys.map(k => d.counts[k]||0)]);
            rows.push(['전체합계', grandTotal, ...allKeys.map(k => colTotals[k])]);
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
            XLSX.utils.book_append_sheet(wb, ws, "통계");
            XLSX.writeFile(wb, "서비스제공통계.xlsx");
        };

        // --- Initial Render ---
        lucide.createIcons();

    </script>
</body>
</html>
