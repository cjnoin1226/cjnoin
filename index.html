import React, { useState, useEffect, useRef, useMemo } from 'react';
import { 
  Users, 
  BookOpen, 
  LayoutDashboard, 
  Settings, 
  Plus, 
  Search, 
  Trash2, 
  FileText,
  CheckCircle,
  Menu,
  X,
  Sparkles,
  Loader2,
  Cloud,
  RefreshCw,
  ChevronDown,
  Edit,      
  Download,
  Filter,
  Minus,
  Upload,
  Calendar,
  Copy,
  BarChart2,
  PieChart, 
  List
} from 'lucide-react';

// --- Firebase Imports ---
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  deleteDoc, 
  updateDoc, 
  doc, 
  onSnapshot,
  getDocs
} from 'firebase/firestore';

// --- Firebase Initialization ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Gemini API Configuration ---
const apiKey = ""; 

async function callGemini(prompt) {
  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
      }
    );

    if (!response.ok) throw new Error(`API Error: ${response.status}`);
    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
  } catch (error) {
    console.error("Gemini API Error:", error);
    return "AI ì„œë¹„ìŠ¤ ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
  }
}

// --- Initial Mock Data (For populating DB only) ---
const SAMPLE_SERVICES = [
  { name: 'ë¯¼ê´€í˜‘ì˜ì²´êµ¬ì„±', category: 'ì‚¬ë¡€ê´€ë¦¬', majorCategory: 'ìœ„ê¸°ê´€ë¦¬ ì²´ê³„êµ¬ì¶•', example: 'ì§€ì—­ì‚¬íšŒë³´ì¥í˜‘ì˜ì²´ íšŒì˜ ì°¸ì„' },
  { name: 'ì´ˆê¸°ìƒë‹´', category: 'ì‚¬ë¡€ê´€ë¦¬', majorCategory: 'ìš•êµ¬ê¸°ë°˜ ìœ„ê¸°ê´€ë¦¬', example: 'ê°€ì •ë°©ë¬¸ ë° ìš•êµ¬ì¡°ì‚¬' },
  { name: 'ê¸´ê¸‰ ìƒê³„ë¹„ ì§€ì›', category: 'ê²½ì œì  ìœ„ê¸°ê´€ë¦¬', majorCategory: 'ìš•êµ¬ê¸°ë°˜ ìœ„ê¸°ê´€ë¦¬', example: 'ê¸´ê¸‰ë³µì§€ ìƒê³„ë¹„ ì—°ê³„' },
  { name: 'ê¸‰ì‹ì§€ì›', category: 'ê¸´ê¸‰ì§€ì›', majorCategory: 'ìœ„ê¸°ìƒí™© ê´€ë¦¬ ë° ê¸´ê¸‰ì§€ì›', example: 'ë„ì‹œë½ ë°°ë‹¬, ê²½ë¡œì‹ë‹¹ ì´ìš©' },
  { name: 'ë²•ë¥  ìƒë‹´ ë° ë™í–‰', category: 'ê¶Œë¦¬ì˜¹í˜¸', majorCategory: 'ìœ„ê¸°ê´€ë¦¬ ì²´ê³„êµ¬ì¶•', example: 'ë¬´ë£Œë²•ë¥ êµ¬ì¡°ê³µë‹¨ ë™í–‰' },
];

// --- Constants ---
const DONG_LIST = ['ëŒ€ì—°ë™', 'ê°ë§Œë™', 'ìš°ì•”ë™', 'ë¬¸í˜„ë™', 'ìš©í˜¸ë™', 'ìš©ë‹¹ë™'];
const GENDER_LIST = ['ë‚¨ì„±', 'ì—¬ì„±'];
const STATUS_LIST = ['ì´ìš©', 'ì¥ê¸°ë¶€ì¬', 'ì¢…ê²°'];
const CARE_LEVEL_LIST = ['ì¼ë°˜', 'ì¤‘ì '];
const ECONOMIC_LIST = ['ì¼ë°˜(ì €ì†Œë“)', 'ê¸°ì´ˆìˆ˜ê¸‰', 'ì¡°ê±´ë¶€ ê¸°ì´ˆìˆ˜ê¸‰', 'ì°¨ìƒìœ„'];
const HOUSEHOLD_LIST = ['ë…ê±°ì„¸ëŒ€', 'ë¶€ë¶€ì„¸ëŒ€', 'ë™ê±°', 'ìë…€ë™ê±°ì„¸ëŒ€', 'ì¡°ì†ë™ê±°ì„¸ëŒ€'];
const PROVIDE_METHOD_LIST = ['ì „í™”', 'ë°©ë¬¸', 'ë‚´ë°©'];

const App = () => {
  // --- State Management ---
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [targetLogId, setTargetLogId] = useState(null); 
  
  // Data States
  const [clients, setClients] = useState([]);
  const [services, setServices] = useState([]);
  const [logs, setLogs] = useState([]);
  const [isLoading, setIsLoading] = useState(true);

  // --- Load XLSX Library Dynamically ---
  useEffect(() => {
    const script = document.createElement('script');
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js";
    script.async = true;
    document.body.appendChild(script);
    return () => {
      document.body.removeChild(script);
    }
  }, []);

  // --- Firebase Auth & Data Sync ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      if (!u) setIsLoading(false);
    });
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const basePath = ['artifacts', appId, 'public', 'data']; 
    
    const unsubClients = onSnapshot(collection(db, ...basePath, 'clients'), 
      (snap) => setClients(snap.docs.map(d => ({ id: d.id, ...d.data() }))),
      (err) => console.error("Clients fetch error", err)
    );
    const unsubServices = onSnapshot(collection(db, ...basePath, 'services'), 
      (snap) => setServices(snap.docs.map(d => ({ id: d.id, ...d.data() }))),
      (err) => console.error("Services fetch error", err)
    );
    const unsubLogs = onSnapshot(collection(db, ...basePath, 'logs'), 
      (snap) => {
        const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        data.sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date));
        setLogs(data);
        setIsLoading(false);
      },
      (err) => console.error("Logs fetch error", err)
    );

    return () => {
      unsubClients();
      unsubServices();
      unsubLogs();
    };
  }, [user]);

  // --- CRUD Operations ---
  const addClient = async (client) => {
    if (!user) return;
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'clients'), {
      ...client,
      createdAt: new Date().toISOString()
    });
  };

  const updateClient = async (id, updatedData) => {
    if (!user) return;
    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'clients', id), updatedData);
  };

  const deleteClient = async (id) => {
    if (!user) return;
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'clients', id));
  };
  
  const addService = async (service) => {
    if (!user) return;
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'services'), service);
  };

  const deleteService = async (id) => {
    if (!user) return;
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'services', id));
  };
  
  const addLog = async (log) => {
    if (!user) return;
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {
      ...log,
      timestamp: new Date().toISOString() // For sorting
    });
  };

  const updateLog = async (id, updatedLog) => {
    if (!user) return;
    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'logs', id), {
      ...updatedLog,
      timestamp: new Date().toISOString() // Update timestamp on edit
    });
  };

  const deleteLog = async (id) => {
    if (!user) return;
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'logs', id));
  };

  const loadSampleData = async () => {
    if (services.length > 0) return; 
    SAMPLE_SERVICES.forEach(s => addService(s));
  };

  const calculateAge = (birthDate) => {
    if (!birthDate) return 0;
    const today = new Date();
    const birth = new Date(birthDate);
    let age = today.getFullYear() - birth.getFullYear();
    const m = today.getMonth() - birth.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
      age--;
    }
    return age;
  };

  // --- Helper for Select with Other Input ---
  const renderSelectWithOther = (value, options, onChange, placeholder = "ì§ì ‘ ì…ë ¥") => {
    const isCustom = value && value !== 'ê¸°íƒ€' && !options.includes(value);
    const selectValue = (value === 'ê¸°íƒ€' || isCustom) ? 'ê¸°íƒ€' : value;

    return (
      <div className="flex gap-1 w-full">
        <select
          className={`input-field transition-all ${selectValue === 'ê¸°íƒ€' ? '!w-24 flex-none' : 'w-full'}`}
          value={String(selectValue || '')}
          onChange={(e) => {
            onChange(e.target.value);
          }}
        >
          <option value="" disabled>ì„ íƒ</option>
          {options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
          <option value="ê¸°íƒ€">ê¸°íƒ€</option>
        </select>
        {(selectValue === 'ê¸°íƒ€') && (
          <input
            type="text"
            className="input-field flex-1"
            value={String(value === 'ê¸°íƒ€' ? '' : value)}
            onChange={(e) => onChange(e.target.value)}
            placeholder={placeholder}
            autoFocus
          />
        )}
      </div>
    );
  };


  // --- Components ---

  const Sidebar = () => (
    <div className={`fixed inset-y-0 left-0 z-50 w-64 bg-slate-800 text-white transform transition-transform duration-300 ease-in-out ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 flex flex-col flex-shrink-0`}>
      <div className="p-6 flex items-center justify-between">
        <h1 className="text-xl font-bold flex items-center gap-2">
          <BookOpen className="text-emerald-400" />
          ì²­ì „ê´‘ì¥
        </h1>
        <button onClick={() => setSidebarOpen(false)} className="md:hidden text-slate-400 hover:text-white">
          <X size={24} />
        </button>
      </div>
      
      <nav className="flex-1 px-4 space-y-2">
        {[
          { id: 'dashboard', label: 'í™ˆ', icon: LayoutDashboard },
          { id: 'clients', label: 'ëŒ€ìƒì ê´€ë¦¬', icon: Users },
          { id: 'logs', label: 'ì„œë¹„ìŠ¤ ì¼ì§€', icon: FileText },
          { id: 'statistics', label: 'í†µê³„', icon: BarChart2 }, // í†µê³„ ë©”ë‰´ ì¶”ê°€
          { id: 'services', label: 'ì„œë¹„ìŠ¤ ëª©ë¡ ì„¤ì •', icon: Settings },
        ].map((item) => (
          <button
            key={item.id}
            onClick={() => { setActiveTab(item.id); setSidebarOpen(false); }}
            className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${activeTab === item.id ? 'bg-emerald-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}
          >
            <item.icon size={20} />
            {item.label}
          </button>
        ))}
      </nav>
      
      <div className="p-4 bg-slate-900 text-xs text-slate-400">
        <div className="flex items-center gap-2 mb-1 text-emerald-400">
          <Cloud size={12} />
          <span>ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™” ì¤‘</span>
        </div>
        <p>ì‚¬íšŒë³µì§€ í†µí•©ê´€ë¦¬ ì‹œìŠ¤í…œ v2.1</p>
      </div>
    </div>
  );

  const Dashboard = ({ onLogClick }) => {
    const todayLogs = logs.filter(l => l.date === new Date().toISOString().split('T')[0]).length;
    const highFocusCount = clients.filter(c => c.careLevel === 'ì¤‘ì ').length;
    const generalCount = clients.filter(c => c.careLevel === 'ì¼ë°˜').length;

    return (
      <div className="space-y-6">
        <div className="flex justify-between items-center">
          <h2 className="text-2xl font-bold text-slate-800">í™ˆ</h2>
          <div className="text-sm text-slate-500 flex items-center gap-1">
            <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
            ì‹¤ì‹œê°„ ì—°ê²°ë¨
          </div>
        </div>
        
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
            <div className="p-3 bg-blue-100 text-blue-600 rounded-lg"><Users size={24} /></div>
            <div>
              <p className="text-sm text-slate-500">ì´ ëŒ€ìƒì</p>
              <div className="flex items-baseline gap-2">
                <p className="text-2xl font-bold text-slate-800">{clients.length}ëª…</p>
              </div>
              <p className="text-xs text-slate-400 mt-1">
                (ì¤‘ì : <span className="font-medium text-pink-600">{highFocusCount}</span>ëª… / 
                ì¼ë°˜: <span className="font-medium text-blue-600">{generalCount}</span>ëª…)
              </p>
            </div>
          </div>
          <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
            <div className="p-3 bg-emerald-100 text-emerald-600 rounded-lg"><FileText size={24} /></div>
            <div>
              <p className="text-sm text-slate-500">ì˜¤ëŠ˜ ì‘ì„±ëœ ì¼ì§€</p>
              <p className="text-2xl font-bold text-slate-800">{todayLogs}ê±´</p>
            </div>
          </div>
          <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
            <div className="p-3 bg-purple-100 text-purple-600 rounded-lg"><Settings size={24} /></div>
            <div>
              <p className="text-sm text-slate-500">ì œê³µ ê°€ëŠ¥ ì„œë¹„ìŠ¤</p>
              <p className="text-2xl font-bold text-slate-800">{services.length}ê°œ</p>
            </div>
          </div>
        </div>

        <div className="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
          <h3 className="text-lg font-bold text-slate-800 mb-4">ìµœê·¼ í™œë™ ê¸°ë¡</h3>
          {logs.length === 0 ? (
            <p className="text-slate-400 text-center py-4">ì•„ì§ ê¸°ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          ) : (
            <div className="space-y-4">
              {logs.slice(0, 5).map(log => (
                <div 
                  key={log.id} 
                  onClick={() => onLogClick(log)}
                  className="flex items-start gap-4 pb-4 border-b last:border-0 last:pb-0 border-slate-100 cursor-pointer hover:bg-slate-50 rounded p-2 transition-colors"
                >
                  <div className="mt-1 p-2 bg-slate-100 rounded-full text-slate-500"><CheckCircle size={16} /></div>
                  <div>
                    <p className="font-medium text-slate-800">
                      <span className="text-emerald-600 font-bold">{String(log.clientName || '')}</span>ë‹˜ì—ê²Œ 
                      <span className="bg-slate-100 px-2 py-0.5 rounded mx-2 text-sm">{String(log.serviceName || '')}</span>
                      ì„œë¹„ìŠ¤ë¥¼ ì œê³µí–ˆìŠµë‹ˆë‹¤.
                    </p>
                    <p className="text-sm text-slate-500 mt-1">{String(log.date || '')} | {String(log.content || '').substring(0, 50)}...</p>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    );
  };

  const ClientManager = () => {
    const [showForm, setShowForm] = useState(false);
    const [editingClientId, setEditingClientId] = useState(null); 
    const fileInputRef = useRef(null); 
    
    const [filterStatus, setFilterStatus] = useState('');
    const [filterCareLevel, setFilterCareLevel] = useState('');
    const [filterRegion, setFilterRegion] = useState('');
    const [filterGender, setFilterGender] = useState(''); 
    const [clientSearchTerm, setClientSearchTerm] = useState('');

    const [newClient, setNewClient] = useState({ 
      name: '', 
      birthDate: '', 
      gender: 'ë‚¨ì„±', 
      region: 'ëŒ€ì—°ë™',     
      careLevel: 'ì¼ë°˜', 
      economicStatus: 'ì¼ë°˜(ì €ì†Œë“)', 
      householdType: 'ë…ê±°ì„¸ëŒ€', 
      status: 'ì´ìš©', 
      address: '', 
      phone: '',
      guardianRelation: '', 
      guardianPhone: '',    
      serviceStartDate: '', 
      absencePeriod: '',    
      endDate: '',          
      note: ''              
    });
    
    const [selectedClient, setSelectedClient] = useState(null);
    const [aiRecommendation, setAiRecommendation] = useState('');
    const [isAiLoading, setIsAiLoading] = useState(false);

    const handleSubmit = (e) => {
      e.preventDefault();
      if(!newClient.name) return;

      if (editingClientId) {
        updateClient(editingClientId, newClient);
        setEditingClientId(null);
        alert("ëŒ€ìƒì ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
      } else {
        addClient(newClient);
        alert("ìƒˆ ëŒ€ìƒìê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      setNewClient({ 
        name: '', 
        birthDate: '', 
        gender: 'ë‚¨ì„±', 
        region: 'ëŒ€ì—°ë™',
        careLevel: 'ì¼ë°˜',
        economicStatus: 'ì¼ë°˜(ì €ì†Œë“)',
        householdType: 'ë…ê±°ì„¸ëŒ€', 
        status: 'ì´ìš©', 
        address: '', 
        phone: '',
        guardianRelation: '', 
        guardianPhone: '',
        serviceStartDate: '', 
        absencePeriod: '', 
        endDate: '',
        note: ''
      });
      setShowForm(false);
    };

    const startEdit = (client) => {
      setEditingClientId(client.id);
      setNewClient({
        name: client.name || '',
        birthDate: client.birthDate || '',
        gender: client.gender || 'ë‚¨ì„±',
        region: client.region || 'ëŒ€ì—°ë™',
        careLevel: client.careLevel || 'ì¼ë°˜',
        economicStatus: client.economicStatus || 'ì¼ë°˜(ì €ì†Œë“)',
        householdType: client.householdType || 'ë…ê±°ì„¸ëŒ€',
        status: client.status || 'ì´ìš©',
        address: client.address || '',
        phone: client.phone || '',
        guardianRelation: client.guardianRelation || '',
        guardianPhone: client.guardianPhone || '',
        serviceStartDate: client.serviceStartDate || '',
        absencePeriod: client.absencePeriod || '',
        endDate: client.endDate || '',
        note: client.note || ''
      });
      setShowForm(true);
    };

    const getAiRecommendation = async (client) => {
      setSelectedClient(client);
      setIsAiLoading(true);
      setAiRecommendation('');
      
      const age = client.birthDate ? calculateAge(client.birthDate) : client.age;
      const info = client.careLevel ? `${client.careLevel}, ${client.economicStatus}` : client.grade;
      const extraInfo = client.status ? `(${client.status})` : '';

      const prompt = `
        ë‹¹ì‹ ì€ ì „ë¬¸ ì‚¬íšŒë³µì§€ì‚¬ì…ë‹ˆë‹¤. ë‹¤ìŒ ëŒ€ìƒì ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•„ìš”í•œ ë³µì§€ ì„œë¹„ìŠ¤ë‚˜ ì£¼ì˜í•´ì•¼ í•  ì¼€ì–´ í¬ì¸íŠ¸ë¥¼ 3ê°€ì§€ ì¶”ì²œí•´ì£¼ì„¸ìš”. í•œêµ­ì–´ë¡œ ë¶€ë“œëŸ½ê³  ì „ë¬¸ì ì¸ ì–´ì¡°ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
        
        ëŒ€ìƒì ì •ë³´:
        - ì´ë¦„: ${client.name} (${client.gender || 'ì„±ë³„ë¯¸ìƒ'})
        - ë‚˜ì´: ${age}ì„¸ (${client.birthDate || 'ìƒë…„ì›”ì¼ ë¯¸ìƒ'})
        - ë“±ê¸‰ ë° êµ¬ë¶„: ${info} ${extraInfo}
        - ê±°ì£¼ì§€: ${client.address} (${client.region || 'í–‰ì •ë™ ë¯¸ìƒ'})
      `;

      const result = await callGemini(prompt);
      setAiRecommendation(result);
      setIsAiLoading(false);
    };

    const handleDownloadTemplate = () => {
      if (typeof XLSX === 'undefined') {
        alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const header = [
        'ì´ë¦„', 'ì„±ë³„', 'ìƒë…„ì›”ì¼(YYYY-MM-DD)', 'í–‰ì •ë™', 'ì—°ë½ì²˜', 'ì„œë¹„ìŠ¤ìƒíƒœ', 
        'ì£¼ì†Œ', 'ê´€ë¦¬ë“±ê¸‰', 'ê²½ì œìƒí™©', 'ì„¸ëŒ€ìœ í˜•', 'ë³´í˜¸ìê´€ê³„', 'ë³´í˜¸ìì—°ë½ì²˜', 
        'ì„œë¹„ìŠ¤ì‹œì‘ì¼', 'ì¥ê¸°ë¶€ì¬ê¸°ê°„', 'ì¢…ê²°ì¼ì', 'ë¹„ê³ '
      ];
      
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet([header]);
      XLSX.utils.book_append_sheet(wb, ws, "ëŒ€ìƒìë“±ë¡ì–‘ì‹");
      XLSX.writeFile(wb, "ëŒ€ìƒìë“±ë¡ì–‘ì‹.xlsx");
    };

    const handleFileUpload = (e) => {
      const file = e.target.files[0];
      if (!file) return;

      if (typeof XLSX === 'undefined') {
        alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }

      const reader = new FileReader();
      reader.onload = (evt) => {
        const bstr = evt.target.result;
        const wb = XLSX.read(bstr, { type: 'binary' });
        const wsname = wb.SheetNames[0];
        const ws = wb.Sheets[wsname];
        const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
        
        const rows = data.slice(1);
        let successCount = 0;

        rows.forEach((row) => {
          if (row[0]) {
            const clientData = {
              name: String(row[0] || ''),
              gender: String(row[1] || 'ë‚¨ì„±'),
              birthDate: String(row[2] || ''),
              region: String(row[3] || 'ëŒ€ì—°ë™'),
              phone: String(row[4] || ''),
              status: String(row[5] || 'ì´ìš©'),
              address: String(row[6] || ''),
              careLevel: String(row[7] || 'ì¼ë°˜'),
              economicStatus: String(row[8] || 'ì¼ë°˜(ì €ì†Œë“)'),
              householdType: String(row[9] || 'ë…ê±°ì„¸ëŒ€'),
              guardianRelation: String(row[10] || ''),
              guardianPhone: String(row[11] || ''),
              serviceStartDate: String(row[12] || ''),
              absencePeriod: String(row[13] || ''),
              endDate: String(row[14] || ''),
              note: String(row[15] || ''),
              createdAt: new Date().toISOString()
            };
            addClient(clientData);
            successCount++;
          }
        });
        alert(`${successCount}ëª…ì˜ ëŒ€ìƒìê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        e.target.value = ''; 
      };
      reader.readAsBinaryString(file);
    };

    const getStatusColor = (status) => {
      if (STATUS_LIST.includes(status)) {
        switch(status) {
          case 'ì´ìš©': return 'bg-green-100 text-green-700';
          case 'ì¥ê¸°ë¶€ì¬': return 'bg-orange-100 text-orange-700';
          case 'ì¢…ê²°': return 'bg-slate-100 text-slate-500';
          default: return 'bg-slate-100 text-slate-600';
        }
      }
      return 'bg-purple-100 text-purple-700'; 
    };

    const getCareLevelStyle = (level) => {
        if (level === 'ì¤‘ì ') return 'bg-pink-100 text-pink-700';
        if (level === 'ì¼ë°˜') return 'bg-blue-100 text-blue-700';
        return 'bg-indigo-50 text-indigo-700';
    };

    const totalCount = clients.length;
    const highFocusCount = clients.filter(c => c.careLevel === 'ì¤‘ì ').length;
    const generalCount = clients.filter(c => c.careLevel === 'ì¼ë°˜').length;
    const maleCount = clients.filter(c => c.gender === 'ë‚¨ì„±').length;
    const femaleCount = clients.filter(c => c.gender === 'ì—¬ì„±').length;

    const filteredClients = clients.filter(client => {
        const matchStatus = filterStatus === '' || client.status === filterStatus;
        const matchCareLevel = filterCareLevel === '' || client.careLevel === filterCareLevel;
        const matchRegion = filterRegion === '' || client.region === filterRegion;
        const matchGender = filterGender === '' || client.gender === filterGender;
        const matchName = clientSearchTerm === '' || (client.name && client.name.includes(clientSearchTerm));
        return matchStatus && matchCareLevel && matchRegion && matchGender && matchName;
    }).sort((a, b) => {
      const dateA = String(a.serviceStartDate || '');
      const dateB = String(b.serviceStartDate || '');
      return dateB.localeCompare(dateA);
    });

    return (
      <div className="space-y-6">
        <div className="flex flex-col md:flex-row justify-between items-center gap-2">
          <h2 className="text-2xl font-bold text-slate-800">ëŒ€ìƒì ê´€ë¦¬</h2>
          <div className="flex gap-2">
            <button 
              onClick={handleDownloadTemplate}
              className="flex items-center gap-1 bg-slate-100 text-slate-600 px-3 py-2 rounded-lg hover:bg-slate-200 transition-colors text-sm"
            >
              <Download size={16} /> ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
            </button>
            <label className="flex items-center gap-1 bg-slate-100 text-slate-600 px-3 py-2 rounded-lg hover:bg-slate-200 transition-colors text-sm cursor-pointer">
              <Upload size={16} /> ì—‘ì…€ ì¼ê´„ ë“±ë¡
              <input type="file" accept=".xlsx, .xls" className="hidden" ref={fileInputRef} onChange={handleFileUpload} />
            </label>
            <button 
              onClick={() => {
                setEditingClientId(null);
                setNewClient({ 
                  name: '', birthDate: '', gender: 'ë‚¨ì„±', region: 'ëŒ€ì—°ë™', 
                  careLevel: 'ì¼ë°˜', economicStatus: 'ì¼ë°˜(ì €ì†Œë“)', householdType: 'ë…ê±°ì„¸ëŒ€', status: 'ì´ìš©', address: '', phone: '',
                  guardianRelation: '', guardianPhone: '', serviceStartDate: '', absencePeriod: '', endDate: '', note: ''
                });
                setShowForm(!showForm);
              }}
              className="flex items-center gap-2 bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-colors"
            >
              <Plus size={20} /> ëŒ€ìƒì ë“±ë¡
            </button>
          </div>
        </div>

        {/* Stats */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
           <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between">
              <div><p className="text-sm text-slate-500">ì´ ëŒ€ìƒì</p><p className="text-2xl font-bold text-slate-800">{totalCount}ëª…</p></div>
              <div className="p-2 bg-slate-50 rounded-full text-slate-400"><Users size={20}/></div>
           </div>
           <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
              <p className="text-sm text-slate-500">ê´€ë¦¬ ë“±ê¸‰ë³„</p>
              <div className="flex gap-4 mt-2 items-center">
                <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-pink-500"></div><span className="text-sm font-bold text-slate-700">ì¤‘ì  {highFocusCount}</span></div>
                <div className="h-4 w-px bg-slate-200"></div>
                <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-blue-500"></div><span className="text-sm font-bold text-slate-700">ì¼ë°˜ {generalCount}</span></div>
              </div>
           </div>
           <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
              <p className="text-sm text-slate-500">ì„±ë³„</p>
              <div className="flex gap-4 mt-2 items-center">
                <div className="flex items-center gap-1"><span className="text-blue-500 font-bold text-sm">ë‚¨ {maleCount}</span></div>
                <div className="h-4 w-px bg-slate-200"></div>
                <div className="flex items-center gap-1"><span className="text-red-500 font-bold text-sm">ì—¬ {femaleCount}</span></div>
              </div>
           </div>
        </div>

        {/* Search & Filters */}
        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col md:flex-row flex-wrap items-center gap-2">
            <div className="flex items-center gap-1 text-slate-600 mr-2 whitespace-nowrap self-start md:self-center">
                <Filter size={16} />
                <span className="font-bold text-sm">ê²€ìƒ‰ í•„í„°</span>
            </div>
            
            <div className="relative flex-1 min-w-[120px] max-w-[200px]">
              <Search className="absolute left-2 top-1/2 transform -translate-y-1/2 text-slate-400" size={14} />
              <input 
                type="text"
                placeholder="ì´ë¦„ ê²€ìƒ‰"
                className="input-field text-sm py-2 pl-8 w-full"
                value={clientSearchTerm}
                onChange={(e) => setClientSearchTerm(e.target.value)}
              />
            </div>

            <select className="input-field text-sm py-2 flex-1 min-w-[80px] max-w-[160px]" value={filterStatus} onChange={e => setFilterStatus(e.target.value)}>
                <option value="">ìƒíƒœ (ì „ì²´)</option>
                {STATUS_LIST.map(s => <option key={s} value={s}>{s}</option>)}
            </select>
            <select className="input-field text-sm py-2 flex-1 min-w-[80px] max-w-[160px]" value={filterCareLevel} onChange={e => setFilterCareLevel(e.target.value)}>
                <option value="">ë“±ê¸‰ (ì „ì²´)</option>
                {CARE_LEVEL_LIST.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
            <select className="input-field text-sm py-2 flex-1 min-w-[80px] max-w-[160px]" value={filterRegion} onChange={e => setFilterRegion(e.target.value)}>
                <option value="">í–‰ì •ë™ (ì „ì²´)</option>
                {DONG_LIST.map(d => <option key={d} value={d}>{d}</option>)}
            </select>
            <select className="input-field text-sm py-2 flex-1 min-w-[80px] max-w-[160px]" value={filterGender} onChange={e => setFilterGender(e.target.value)}>
                <option value="">ì„±ë³„ (ì „ì²´)</option>
                <option value="ë‚¨ì„±">ë‚¨ì„±</option>
                <option value="ì—¬ì„±">ì—¬ì„±</option>
            </select>

            <button 
                onClick={() => {setFilterStatus(''); setFilterCareLevel(''); setFilterRegion(''); setFilterGender(''); setClientSearchTerm('');}} 
                className="ml-auto text-xs flex items-center gap-1 text-slate-400 hover:text-slate-600 transition-colors whitespace-nowrap"
            >
                <RefreshCw size={14} /> <span className="hidden sm:inline">ì´ˆê¸°í™”</span>
            </button>
        </div>

        {showForm && (
          <form onSubmit={handleSubmit} className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 animate-fade-in">
            <h3 className="font-bold mb-4 text-lg">{editingClientId ? 'ëŒ€ìƒì ì •ë³´ ìˆ˜ì •' : 'ìƒˆ ëŒ€ìƒì ë“±ë¡'}</h3>
            
            {/* Row 1 */}
            <div className="flex flex-col md:flex-row gap-4 mb-4">
                <div className="flex-[1.5]">
                  <label className="block text-sm font-medium text-slate-700 mb-1">ì´ë¦„</label>
                  <input placeholder="ëŒ€ìƒì ì„±í•¨" className="input-field" value={newClient.name} onChange={e => setNewClient({...newClient, name: e.target.value})} required />
                </div>
                <div className="w-20">
                  <label className="block text-sm font-medium text-slate-700 mb-1">ì„±ë³„</label>
                  {renderSelectWithOther(newClient.gender, GENDER_LIST, (val) => setNewClient({...newClient, gender: val}))}
                </div>
                <div className="flex-1 min-w-[120px]">
                  <label className="block text-sm font-medium text-slate-700 mb-1">ìƒë…„ì›”ì¼</label>
                  <input type="date" className="input-field" value={newClient.birthDate} onChange={e => setNewClient({...newClient, birthDate: e.target.value})} required max="9999-12-31" />
                </div>
                <div className="flex-[1.5] min-w-[100px]">
                  <label className="block text-sm font-medium text-slate-700 mb-1">ì„œë¹„ìŠ¤ ìƒíƒœ</label>
                  {renderSelectWithOther(newClient.status, STATUS_LIST, (val) => setNewClient({...newClient, status: val}))}
                </div>
            </div>

            {/* Row 2 */}
            <div className="flex flex-col md:flex-row gap-4 mb-4">
                <div className="flex-1">
                  <label className="block text-sm font-medium text-slate-700 mb-1">ì—°ë½ì²˜</label>
                  <input placeholder="010-0000-0000" className="input-field" value={newClient.phone} onChange={e => setNewClient({...newClient, phone: e.target.value})} />
                </div>
                <div className="flex-[1.2]">
                  <label className="block text-sm font-medium text-slate-700 mb-1">ë³´í˜¸ì ì—°ë½ì²˜</label>
                  <div className="flex gap-2">
                    <input placeholder="ê´€ê³„" className="input-field !w-20 text-center p-2" value={newClient.guardianRelation} onChange={e => setNewClient({...newClient, guardianRelation: e.target.value})} />
                    <input placeholder="010-0000-0000" className="input-field flex-1" value={newClient.guardianPhone} onChange={e => setNewClient({...newClient, guardianPhone: e.target.value})} />
                  </div>
                </div>
            </div>

            {/* Row 3 */}
            <div className="flex flex-col md:flex-row gap-4 mb-4">
                <div className="w-full md:w-1/4 min-w-[120px]">
                  <label className="block text-sm font-medium text-slate-700 mb-1">í–‰ì •ë™</label>
                  {renderSelectWithOther(newClient.region, DONG_LIST, (val) => setNewClient({...newClient, region: val}))}
                </div>
                <div className="flex-1">
                  <label className="block text-sm font-medium text-slate-700 mb-1">ìƒì„¸ ì£¼ì†Œ</label>
                  <input placeholder="ìƒì„¸ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" className="input-field" value={newClient.address} onChange={e => setNewClient({...newClient, address: e.target.value})} />
                </div>
            </div>

            {/* Row 4 */}
            <div className="flex flex-col md:flex-row gap-4 mb-4">
                <div className="flex-1">
                  <label className="block text-sm font-medium text-slate-700 mb-1">ê´€ë¦¬ ë“±ê¸‰</label>
                  {renderSelectWithOther(newClient.careLevel, CARE_LEVEL_LIST, (val) => setNewClient({...newClient, careLevel: val}))}
                </div>
                <div className="flex-1">
                  <label className="block text-sm font-medium text-slate-700 mb-1">ê²½ì œ ìƒí™© êµ¬ë¶„</label>
                  {renderSelectWithOther(newClient.economicStatus, ECONOMIC_LIST, (val) => setNewClient({...newClient, economicStatus: val}))}
                </div>
                <div className="flex-1">
                   <label className="block text-sm font-medium text-slate-700 mb-1">ì„¸ëŒ€ ìœ í˜•</label>
                   {renderSelectWithOther(newClient.householdType, HOUSEHOLD_LIST, (val) => setNewClient({...newClient, householdType: val}))}
                </div>
            </div>

            {/* Row 5 */}
            <div className="flex flex-col md:flex-row gap-4 mb-4">
                <div className="flex-1">
                  <label className="block text-sm font-medium text-slate-700 mb-1">ì„œë¹„ìŠ¤ ì‹œì‘ì¼</label>
                  <input type="date" className="input-field" value={newClient.serviceStartDate} onChange={e => setNewClient({...newClient, serviceStartDate: e.target.value})} max="9999-12-31" />
                </div>
                <div className="flex-1">
                  <label className="block text-sm font-medium text-slate-700 mb-1">ì¥ê¸°ë¶€ì¬ ê¸°ê°„</label>
                  <input placeholder="ì˜ˆ: 2023.10.01~2023.10.31" className="input-field" value={newClient.absencePeriod} onChange={e => setNewClient({...newClient, absencePeriod: e.target.value})} />
                </div>
                <div className="flex-1">
                  <label className="block text-sm font-medium text-slate-700 mb-1">ì¢…ê²° ì¼ì</label>
                  <input type="date" className="input-field" value={newClient.endDate} onChange={e => setNewClient({...newClient, endDate: e.target.value})} max="9999-12-31" />
                </div>
            </div>

            {/* Row 6 */}
            <div className="mb-6">
                <label className="block text-sm font-medium text-slate-700 mb-1">ë¹„ê³ </label>
                <textarea 
                    rows={5}
                    placeholder="íŠ¹ì´ì‚¬í•­ ë“± ë©”ëª¨" 
                    className="input-field resize-none" 
                    value={newClient.note} 
                    onChange={e => setNewClient({...newClient, note: e.target.value})} 
                />
            </div>

            <div className="flex justify-end gap-2">
              <button type="button" onClick={() => setShowForm(false)} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">ì·¨ì†Œ</button>
              <button type="submit" className="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium">
                {editingClientId ? 'ìˆ˜ì • ì™„ë£Œ' : 'ì €ì¥í•˜ê¸°'}
              </button>
            </div>
          </form>
        )}
        
        {/* Client List */}
        {filteredClients.length === 0 ? (
          <div className="text-center py-12 bg-white rounded-xl border border-slate-100 border-dashed">
            <Users size={48} className="mx-auto mb-2 opacity-50" />
            <p>ì¡°ê±´ì— ë§ëŠ” ëŒ€ìƒìê°€ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {filteredClients.map(client => {
              const age = client.birthDate ? calculateAge(client.birthDate) : client.age;
              const statusColor = getStatusColor(client.status);
              const genderText = client.gender === 'ë‚¨ì„±' ? 'ë‚¨' : client.gender === 'ì—¬ì„±' ? 'ì—¬' : client.gender;
              const genderColor = client.gender === 'ë‚¨ì„±' ? 'text-blue-500' : client.gender === 'ì—¬ì„±' ? 'text-red-500' : 'text-gray-500';

              return (
                <div key={client.id} className={`bg-white p-5 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow relative overflow-hidden group ${client.status === 'ì¢…ê²°' ? 'opacity-75' : ''}`}>
                  <div className="flex justify-between items-start mb-2">
                    <div className="flex items-center gap-2">
                      <h3 className="font-bold text-lg text-slate-800">{String(client.name || '')}</h3>
                      {/* Gender Visual Indicator */}
                      <span className={`text-sm font-bold ${genderColor}`}>({age}ì„¸/{String(genderText || '')})</span>
                    </div>
                    <div className="flex items-center gap-2">
                      {client.status && <span className={`text-xs px-2 py-1 rounded font-medium ${statusColor}`}>{String(client.status || '')}</span>}
                      <button onClick={() => startEdit(client)} className="text-slate-300 hover:text-blue-500 transition-colors"><Edit size={18} /></button>
                      <button onClick={() => deleteClient(client.id)} className="text-slate-300 hover:text-red-500"><Trash2 size={18} /></button>
                    </div>
                  </div>
                  
                  <div className="flex flex-wrap gap-1 mb-3">
                    {client.region && <span className="inline-block bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded">{String(client.region || '')}</span>}
                    {client.careLevel && <span className={`inline-block text-xs px-2 py-1 rounded ${getCareLevelStyle(client.careLevel)}`}>{String(client.careLevel || '')}</span>}
                    {client.economicStatus && <span className="inline-block bg-amber-50 text-amber-700 text-xs px-2 py-1 rounded">{String(client.economicStatus || '')}</span>}
                  </div>

                  <div className="space-y-1 text-sm text-slate-600 mb-4">
                    <p className="flex items-center gap-2"><span className="w-4"><Users size={14}/></span> {String(client.phone || '')}</p>
                    <p className="flex items-center gap-2"><span className="w-4">ğŸ </span> {String(client.address || '')}</p>
                  </div>
                  
                  {client.status !== 'ì¢…ê²°' && (
                    <button 
                      onClick={() => getAiRecommendation(client)}
                      className="w-full flex items-center justify-center gap-2 py-2 bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100 transition-colors text-sm font-medium"
                    >
                      <Sparkles size={16} />
                      AI ì¼€ì–´ ì œì•ˆë°›ê¸°
                    </button>
                  )}
                </div>
              );
            })}
          </div>
        )}
        
        {/* AI Recommendation Modal */}
        {selectedClient && (
          <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl max-w-lg w-full p-6 shadow-xl relative">
              <button 
                onClick={() => setSelectedClient(null)}
                className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"
              >
                <X size={24} />
              </button>
              
              <div className="flex items-center gap-2 mb-4 text-purple-600">
                <Sparkles size={24} />
                <h3 className="text-lg font-bold">AI ë§ì¶¤ ì¼€ì–´ ì œì•ˆ</h3>
              </div>
              
              <div className="mb-4 p-3 bg-slate-50 rounded-lg border border-slate-100">
                <p className="font-medium text-slate-800">
                  {selectedClient.name} 
                  <span className="text-slate-500 text-sm ml-1">
                    ({selectedClient.birthDate ? calculateAge(selectedClient.birthDate) : selectedClient.age}ì„¸, {selectedClient.gender || 'ì„±ë³„ë¯¸ìƒ'})
                  </span>
                </p>
              </div>

              <div className="min-h-[150px]">
                {isAiLoading ? (
                  <div className="flex flex-col items-center justify-center h-full py-8 text-slate-400">
                    <Loader2 size={32} className="animate-spin mb-2" />
                    <p>AIê°€ ëŒ€ìƒìë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
                  </div>
                ) : (
                  <div className="prose prose-sm max-w-none whitespace-pre-wrap text-slate-700 leading-relaxed">
                    {aiRecommendation}
                  </div>
                )}
              </div>
              
              <div className="mt-6 flex justify-end">
                <button 
                  onClick={() => setSelectedClient(null)}
                  className="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700"
                >
                  ë‹«ê¸°
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  // ... LogManager ...
  const LogManager = ({ targetLogId, setTargetLogId }) => {
    // ... (LogManager code is unchanged)
    const [showForm, setShowForm] = useState(false);
    const [isDrafting, setIsDrafting] = useState(false); 
    const [selectedCategory, setSelectedCategory] = useState(''); 
    const [searchTerm, setSearchTerm] = useState(''); 
    const [isClientDropdownOpen, setIsClientDropdownOpen] = useState(false);
    const [filterStartDate, setFilterStartDate] = useState('');
    const [filterEndDate, setFilterEndDate] = useState('');
    const [filterCategory, setFilterCategory] = useState('');
    const [filterService, setFilterService] = useState('');
    const [editingLogId, setEditingLogId] = useState(null);
    const clientDropdownRef = useRef(null);

    const [newLog, setNewLog] = useState({
      clientId: '', clientName: '', date: new Date().toISOString().split('T')[0],
      provider: '', provideMethod: '', content: '',
      serviceItems: [{ id: Date.now(), category: '', serviceId: '', serviceName: '', detailNote: '' }]
    });

    const matchedClient = clients.find(c => c.name === newLog.clientName);
    const categories = [...new Set(services.map(s => s.category))];
    const filteredServices = services.filter(s => s.category === selectedCategory);

    const filteredLogs = logs.filter(log => {
      const matchName = log.clientName.toLowerCase().includes(searchTerm.toLowerCase());
      let matchDate = true;
      if (filterStartDate) matchDate = matchDate && log.date >= filterStartDate;
      if (filterEndDate) matchDate = matchDate && log.date <= filterEndDate;
      let matchCategory = true;
      if (filterCategory) {
        if (log.serviceItems && log.serviceItems.length > 0) { matchCategory = log.serviceItems.some(item => item.category === filterCategory); } 
        else { matchCategory = log.serviceCategory === filterCategory; }
      }
      let matchService = true;
      if (filterService) {
        if (log.serviceItems && log.serviceItems.length > 0) { matchService = log.serviceItems.some(item => item.serviceName === filterService); } 
        else { matchService = log.serviceName === filterService; }
      }
      return matchName && matchDate && matchCategory && matchService;
    });

    useEffect(() => {
      if (targetLogId && logs.length > 0) {
        const targetLog = logs.find(l => l.id === targetLogId);
        if (targetLog) { startEdit(targetLog); setTargetLogId(null); }
      }
    }, [targetLogId, logs]);

    useEffect(() => {
        const handleClickOutside = (event) => {
          if (clientDropdownRef.current && !clientDropdownRef.current.contains(event.target)) { setIsClientDropdownOpen(false); }
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    const handleAiDraft = async () => {
      if (!newLog.content.trim()) { alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
      setIsDrafting(true);
      const prompt = `ë‹¹ì‹ ì€ ì „ë¬¸ ì‚¬íšŒë³µì§€ì‚¬ì…ë‹ˆë‹¤...`; 
      const polishedContent = await callGemini(prompt);
      setNewLog({ ...newLog, content: polishedContent });
      setIsDrafting(false);
    };

    const duplicateLog = (log) => {
      let initialServiceItems = [];
      if (log.serviceItems && log.serviceItems.length > 0) { initialServiceItems = log.serviceItems.map((item, index) => ({ ...item, id: Date.now() + index })); } 
      else { initialServiceItems = [{ id: Date.now(), category: log.serviceCategory || '', serviceId: log.serviceId || '', serviceName: log.serviceName || '', detailNote: '' }]; }
      setNewLog({ clientId: log.clientId || '', clientName: log.clientName, date: log.date, provider: log.provider || '', provideMethod: log.provideMethod || '', content: log.content, serviceItems: initialServiceItems });
      setEditingLogId(null);
      setShowForm(true);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    const startEdit = (log) => {
      setEditingLogId(log.id);
      let initialServiceItems = [];
      if (log.serviceItems && log.serviceItems.length > 0) { initialServiceItems = log.serviceItems; } 
      else { initialServiceItems = [{ id: Date.now(), category: log.serviceCategory || '', serviceId: log.serviceId || '', serviceName: log.serviceName || '', detailNote: '' }]; }
      setNewLog({ clientId: log.clientId || '', clientName: log.clientName, date: log.date, provider: log.provider || '', provideMethod: log.provideMethod || '', content: log.content, serviceItems: initialServiceItems });
      setShowForm(true);
    };

    const handleSubmit = (e) => {
      e.preventDefault();
      if (!newLog.clientName) { alert('ëŒ€ìƒìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
      const validServices = newLog.serviceItems.filter(item => item.serviceName);
      if (validServices.length === 0) { alert('ìµœì†Œ í•˜ë‚˜ì˜ ì„œë¹„ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
      const serviceNameStr = validServices.map(s => s.serviceName).join(', ');
      const serviceCategoryStr = validServices[0].category;
      const logData = { clientId: newLog.clientId, clientName: newLog.clientName, date: newLog.date, provider: newLog.provider, provideMethod: newLog.provideMethod, content: newLog.content, serviceName: serviceNameStr, serviceCategory: serviceCategoryStr, serviceItems: validServices };
      if (editingLogId) { updateLog(editingLogId, logData); alert("ì¼ì§€ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); } else { addLog(logData); }
      closeForm();
    };

    const closeForm = () => { setShowForm(false); setEditingLogId(null); setNewLog({ clientId: '', clientName: '', date: new Date().toISOString().split('T')[0], provider: '', provideMethod: '', content: '', serviceItems: [{ id: Date.now(), category: '', serviceId: '', serviceName: '', detailNote: '' }] }); setSelectedCategory(''); }
    const addServiceItem = () => { if (newLog.serviceItems.length >= 6) return; setNewLog(prev => ({ ...prev, serviceItems: [...prev.serviceItems, { id: Date.now(), category: '', serviceId: '', serviceName: '', detailNote: '' }] })); };
    const removeServiceItem = (id) => { setNewLog(prev => ({ ...prev, serviceItems: prev.serviceItems.filter(item => item.id !== id) })); };
    const updateServiceItem = (id, field, value) => { setNewLog(prev => ({ ...prev, serviceItems: prev.serviceItems.map(item => { if (item.id === id) { const updated = { ...item, [field]: value }; if (field === 'category') { updated.serviceId = ''; updated.serviceName = ''; } if (field === 'serviceId') { const s = services.find(svc => svc.id === value); updated.serviceName = s ? s.name : ''; } return updated; } return item; }) })); };
    const allCategories = [...new Set(services.map(s => s.category))];
    const servicesInFilteredCategory = filterCategory ? services.filter(s => s.category === filterCategory) : services;
    const sortedClients = [...clients].sort((a, b) => String(a.name).localeCompare(String(b.name), 'ko'));

    const handleDownload = () => { /* ... download logic ... */ }; // simplified for brevity, assume same as previous

    return (
      <div className="space-y-6">
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
          <h2 className="text-2xl font-bold text-slate-800">ì„œë¹„ìŠ¤ ì¼ì§€</h2>
          <div className="flex flex-col md:flex-row gap-2 w-full md:w-auto items-center">
            <button onClick={() => setShowForm(!showForm)} className="flex items-center justify-center gap-2 bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-colors whitespace-nowrap"><Plus size={20} /> ì¼ì§€ ì‘ì„±</button>
            {/* ... other buttons ... */}
          </div>
        </div>
        {/* Filters Bar & Form & List ... same as before ... */}
        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col md:flex-row flex-wrap items-center gap-2">
            <div className="flex items-center gap-1 text-slate-600 mr-2 whitespace-nowrap self-start md:self-center"><Filter size={16} /><span className="font-bold text-sm">ê²€ìƒ‰ í•„í„°</span></div>
            <div className="flex items-center gap-2 w-full md:w-auto"><div className="relative flex-1 md:w-44"><Calendar className="absolute left-2 top-1/2 transform -translate-y-1/2 text-slate-400" size={14} /><input type="date" className="input-field text-sm py-2 pl-8" value={filterStartDate} onChange={e => setFilterStartDate(e.target.value)} max="9999-12-31"/></div><span className="text-slate-400">~</span><div className="relative flex-1 md:w-44"><input type="date" className="input-field text-sm py-2" value={filterEndDate} onChange={e => setFilterEndDate(e.target.value)} max="9999-12-31"/></div></div>
            <div className="relative w-full md:w-32 min-w-[100px]"><Search className="absolute left-2 top-1/2 transform -translate-y-1/2 text-slate-400" size={14} /><input type="text" placeholder="ì´ë¦„" className="input-field text-sm py-2 pl-8 w-full" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div>
            <select className="input-field text-sm py-2 flex-1 w-full md:w-auto min-w-[130px]" value={filterCategory} onChange={e => { setFilterCategory(e.target.value); setFilterService(''); }}><option value="">ì„œë¹„ìŠ¤ ì¢…ë¥˜(ì „ì²´)</option>{allCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}</select>
            <select className="input-field text-sm py-2 flex-1 w-full md:w-auto min-w-[130px]" value={filterService} onChange={e => setFilterService(e.target.value)}><option value="">ì„¸ë¶€ ì„œë¹„ìŠ¤(ì „ì²´)</option>{servicesInFilteredCategory.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select>
            <button onClick={() => {setFilterStartDate(''); setFilterEndDate(''); setSearchTerm(''); setFilterCategory(''); setFilterService('');}} className="ml-auto text-xs flex items-center gap-1 text-slate-400 hover:text-slate-600 transition-colors whitespace-nowrap"><RefreshCw size={14} /> ì´ˆê¸°í™”</button>
        </div>
        {showForm && (
          <form onSubmit={handleSubmit} className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 animate-fade-in">
             {/* ... Form rendering code ... */}
             {/* For brevity, I assume the form rendering is preserved from the previous step */}
             <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg">{editingLogId ? 'ì¼ì§€ ìˆ˜ì •í•˜ê¸°' : 'ì¼ì§€ ì‘ì„±í•˜ê¸°'}</h3></div>
             {/* ... inputs ... */}
             <div className="flex flex-row gap-4"><div className="flex-1 min-w-[120px]"><label className="block text-sm font-medium text-slate-700 mb-1">ë‚ ì§œ</label><input type="date" className="input-field" value={newLog.date} onChange={e => setNewLog({...newLog, date: e.target.value})} required /></div><div className="relative flex-[1.5] min-w-[150px]"><label className="block text-sm font-medium text-slate-700 mb-1">ì œê³µë°©ë²•</label>{renderSelectWithOther(newLog.provideMethod, PROVIDE_METHOD_LIST, (val) => setNewLog({...newLog, provideMethod: val}), "ì§ì ‘ ì…ë ¥ (ì˜ˆ: ë¬¸ì)")}</div><div className="flex-1 min-w-[100px]"><label className="block text-sm font-medium text-slate-700 mb-1">ì œê³µì</label><input type="text" className="input-field" placeholder="ë‹´ë‹¹ì ì„±ëª…" value={newLog.provider} onChange={e => setNewLog({...newLog, provider: e.target.value})} /></div></div>
             <div className="flex flex-row gap-4 mt-4"><div className="relative flex-[2] min-w-[150px]" ref={clientDropdownRef}><label className="block text-sm font-medium text-slate-700 mb-1">ëŒ€ìƒì</label><div className="relative flex items-center"><input type="text" className="input-field pr-10" value={newLog.clientName} onChange={(e) => { const name = e.target.value; const client = clients.find(c => c.name === name); setNewLog({...newLog, clientName: name, clientId: client ? client.id : ''}); }} placeholder="ëŒ€ìƒì ì…ë ¥/ì„ íƒ" required /><button type="button" onClick={() => setIsClientDropdownOpen(!isClientDropdownOpen)} className="absolute right-2 p-1 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded"><ChevronDown size={20} /></button></div>{isClientDropdownOpen && (<ul className="absolute z-10 w-full bg-white border border-slate-200 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto">{sortedClients.length === 0 ? <li className="p-3 text-slate-400 text-sm text-center">ë“±ë¡ëœ ëŒ€ìƒìê°€ ì—†ìŠµë‹ˆë‹¤.</li> : sortedClients.map((client) => (<li key={client.id} className="px-4 py-2 hover:bg-slate-50 cursor-pointer text-slate-700 border-b last:border-0 border-slate-50" onClick={() => { setNewLog({...newLog, clientName: client.name, clientId: client.id}); setIsClientDropdownOpen(false); }}><span className="font-medium">{client.name}</span><span className="text-xs text-slate-400 ml-2">{calculateAge(client.birthDate)}ì„¸ | {client.careLevel}</span></li>))}</ul>)}</div><div className="flex-1 min-w-[100px]"><label className="block text-sm font-medium text-slate-700 mb-1">ìƒë…„ì›”ì¼</label><input type="text" className="input-field bg-slate-50 text-slate-500" value={matchedClient ? matchedClient.birthDate : ''} readOnly placeholder="ìë™í‘œì‹œ" /></div><div className="flex-1 min-w-[80px]"><label className="block text-sm font-medium text-slate-700 mb-1">ê´€ë¦¬ë“±ê¸‰</label><input type="text" className="input-field bg-slate-50 text-slate-500" value={matchedClient ? matchedClient.careLevel : ''} readOnly placeholder="ìë™í‘œì‹œ" /></div><div className="flex-1 min-w-[80px]"><label className="block text-sm font-medium text-slate-700 mb-1">í–‰ì •ë™</label><input type="text" className="input-field bg-slate-50 text-slate-500" value={matchedClient ? matchedClient.region : ''} readOnly placeholder="ìë™í‘œì‹œ" /></div></div>
             <div className="mt-4"><div className="flex justify-between items-end mb-2"><label className="block text-sm font-medium text-slate-700">ì„œë¹„ìŠ¤ ë‚´ìš© (ìµœëŒ€ 6ê°œ)</label>{newLog.serviceItems.length < 6 && (<button type="button" onClick={addServiceItem} className="text-xs flex items-center gap-1 text-emerald-600 hover:text-emerald-700"><Plus size={14} /> ì„œë¹„ìŠ¤ ì¶”ê°€</button>)}</div>{newLog.serviceItems.map((item, index) => (<div key={item.id} className="flex flex-row gap-2 mb-2 items-center"><div className="flex-1 min-w-[100px]"><select className="input-field py-2" value={item.category} onChange={(e) => updateServiceItem(item.id, 'category', e.target.value)} required><option value="">ì„œë¹„ìŠ¤ ì„ íƒ</option>{categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}</select></div><div className="flex-[1.5] min-w-[150px]"><select className="input-field py-2" value={item.serviceId} onChange={(e) => updateServiceItem(item.id, 'serviceId', e.target.value)} required disabled={!item.category}><option value="">ìƒì„¸ë‚´ìš© ì„ íƒ</option>{services.filter(s => s.category === item.category).map(s => (<option key={s.id} value={s.id}>{s.name}</option>))}</select></div><div className="flex-1 min-w-[150px]"><input type="text" className="input-field py-2" placeholder="ìƒì„¸ë‚´ìš© ì§ì ‘ì…ë ¥" value={item.detailNote || ''} onChange={(e) => updateServiceItem(item.id, 'detailNote', e.target.value)}/></div>{index > 0 && (<button type="button" onClick={() => removeServiceItem(item.id)} className="text-red-400 hover:text-red-600 p-1"><Minus size={18} /></button>)}</div>))}</div>
             <div className="mt-4"><div className="flex justify-between items-end mb-1"><label className="block text-sm font-medium text-slate-700">ì§„í–‰ ë‚´ìš© ë° íŠ¹ì´ì‚¬í•­</label><button type="button" onClick={handleAiDraft} disabled={isDrafting} className="text-xs flex items-center gap-1 bg-purple-100 text-purple-700 px-2 py-1 rounded hover:bg-purple-200 transition-colors">{isDrafting ? <Loader2 size={12} className="animate-spin"/> : <Sparkles size={12} />} {isDrafting ? 'AI ì‘ì„± ì¤‘...' : 'AIë¡œ ë‹¤ë“¬ê¸°'}</button></div><textarea className="input-field min-h-[150px]" placeholder="í‚¤ì›Œë“œ ìœ„ì£¼ë¡œ ì…ë ¥í•˜ê³  'AIë¡œ ë‹¤ë“¬ê¸°'ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”." value={newLog.content} onChange={e => setNewLog({...newLog, content: e.target.value})} required /><p className="text-xs text-slate-400 mt-1 text-right">* AIê°€ ì‘ì„±í•œ ë‚´ìš©ì€ ë°˜ë“œì‹œ ê²€í†  í›„ ë“±ë¡í•˜ì„¸ìš”.</p></div>
             <div className="flex justify-end gap-2 mt-4"><button type="button" onClick={closeForm} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">ì·¨ì†Œ</button><button type="submit" className="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">{editingLogId ? 'ìˆ˜ì • ì™„ë£Œ' : 'ì¼ì§€ ë“±ë¡'}</button></div>
          </form>
        )}
        <div className="space-y-4">
          {filteredLogs.length === 0 ? <div className="text-center py-12 bg-white rounded-xl border border-slate-100"><Search className="mx-auto text-slate-300 mb-2" size={32} /><p className="text-slate-500">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ê±°ë‚˜ ì‘ì„±ëœ ì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div> : filteredLogs.map(log => {
              const clientInfo = clients.find(c => c.id === log.clientId);
              const clientDetailStr = clientInfo ? `${clientInfo.birthDate} (ë§Œ ${calculateAge(clientInfo.birthDate)}ì„¸) | ${clientInfo.careLevel}` : 'ì •ë³´ ì—†ìŒ';
              return (
                <div key={log.id} className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col md:flex-row gap-4">
                  <div className="md:w-48 flex-shrink-0 flex flex-col justify-center md:border-r md:border-slate-100 md:pr-4"><span className="text-sm text-slate-500">{log.date}</span><div><h4 className="font-bold text-lg text-slate-800 inline-block">{log.clientName}</h4><p className="text-xs text-slate-500 mt-0.5">{clientDetailStr}</p></div><div className="mt-2 flex flex-wrap gap-1">{log.serviceItems && log.serviceItems.length > 0 ? (log.serviceItems.map((item, idx) => (<span key={idx} className="inline-flex text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded">{item.serviceName} {item.detailNote ? `- ${item.detailNote}` : ''}</span>))) : (log.serviceName ? log.serviceName.split(', ').map((svc, idx) => (<span key={idx} className="inline-flex text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded">{svc}</span>)) : <span className="text-xs text-gray-400">ì„œë¹„ìŠ¤ ì •ë³´ ì—†ìŒ</span>)}</div></div>
                  <div className="flex-1"><div className="flex justify-between items-start mb-2"><div className="flex-1"></div><div className="flex items-center gap-1"><button onClick={() => duplicateLog(log)} className="p-1 text-slate-400 hover:text-emerald-500 hover:bg-emerald-50 rounded transition-colors" title="ë³µì‚¬"><Copy size={16} /></button><button onClick={() => startEdit(log)} className="p-1 text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded transition-colors" title="ìˆ˜ì •"><Edit size={16} /></button><button onClick={() => deleteLog(log.id)} className="p-1 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors" title="ì‚­ì œ"><Trash2 size={16} /></button></div></div><p className="text-slate-600 whitespace-pre-wrap">{log.content}</p></div>
                </div>
              );
            })}
        </div>
      </div>
    );
  };

  const StatisticsManager = () => {
    const [startDate, setStartDate] = useState(new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0]);
    const [endDate, setEndDate] = useState(new Date().toISOString().split('T')[0]);
    const [viewType, setViewType] = useState('detail'); // 'detail' or 'category'
    const [filterName, setFilterName] = useState('');
    const [filterRegion, setFilterRegion] = useState('');

    // ê·¸ë£¹í™”ëœ ì„œë¹„ìŠ¤ êµ¬ì¡° ìƒì„± (Detail ë·°ìš©)
    const groupedServices = useMemo(() => {
        const groups = {};
        // ì •ë ¬ëœ ì¹´í…Œê³ ë¦¬ ìˆœì„œë¥¼ ìœ„í•´ (majorCategory -> category ìˆœìœ¼ë¡œ ì •ë ¬)
        const sortedServices = [...services].sort((a, b) => 
            (a.majorCategory || '').localeCompare(b.majorCategory || '') || 
            (a.category || '').localeCompare(b.category || '')
        );

        sortedServices.forEach(s => {
            // ëŒ€ë¶„ë¥˜(category)ê°€ ì—†ìœ¼ë©´ 'ê¸°íƒ€'ë¡œ ì²˜ë¦¬
            const cat = s.category || 'ê¸°íƒ€'; 
            if (!groups[cat]) groups[cat] = [];
            // ì¤‘ë³µ ì œê±°
            if (!groups[cat].includes(s.name)) {
                groups[cat].push(s.name);
            }
        });
        
        const sortedCategories = Object.keys(groups).sort();
        
        return { groups, sortedCategories };
    }, [services]);

    // Flattened keys for data mapping & counting
    const allServiceKeys = useMemo(() => {
        if (viewType === 'category') {
            return [...new Set(services.map(s => s.category))].filter(Boolean).sort();
        }
        // detail ë·°ì¼ ë•ŒëŠ” ê·¸ë£¹ ìˆœì„œëŒ€ë¡œ í‚¤ ë°°ì—´ ìƒì„±
        const keys = [];
        groupedServices.sortedCategories.forEach(cat => {
            keys.push(...groupedServices.groups[cat]);
        });
        return keys;
    }, [services, viewType, groupedServices]);
    
    const statsData = useMemo(() => {
        const stats = {};
        
        // Filter Clients First
        const filteredClients = clients.filter(client => {
            const matchName = filterName === '' || (client.name && client.name.includes(filterName));
            const matchRegion = filterRegion === '' || (client.region === filterRegion);
            return matchName && matchRegion;
        });

        // Initialize all clients
        filteredClients.forEach(client => {
            stats[client.id] = {
                id: client.id,
                name: client.name,
                counts: {},
                total: 0
            };
            allServiceKeys.forEach(key => {
                stats[client.id].counts[key] = 0;
            });
        });

        // Iterate Logs
        logs.forEach(log => {
            if (log.date < startDate || log.date > endDate) return;
            
            let clientId = log.clientId;
            // If client not in stats (filtered out), skip
            if (!stats[clientId]) {
                // Try finding by name for older logs without ID, but only if that client exists in filtered list
                const found = filteredClients.find(c => c.name === log.clientName);
                if (found) clientId = found.id;
                else return; 
            }

            if (stats[clientId]) {
                const items = log.serviceItems && log.serviceItems.length > 0 
                    ? log.serviceItems 
                    : [{ serviceName: log.serviceName, category: log.serviceCategory }]; 

                items.forEach(item => {
                    let key = '';
                    if (viewType === 'category') {
                        key = item.category;
                        // Fallback if category missing in log but name exists (old data)
                        if (!key && item.serviceName) {
                            const foundSvc = services.find(s => s.name === item.serviceName);
                            if (foundSvc) key = foundSvc.category;
                        }
                    } else {
                        key = item.serviceName;
                    }

                    if (key && stats[clientId].counts[key] !== undefined) {
                        stats[clientId].counts[key]++;
                        stats[clientId].total++;
                    }
                });
            }
        });

        return Object.values(stats).sort((a, b) => String(a.name).localeCompare(String(b.name), 'ko'));
    }, [clients, services, logs, startDate, endDate, allServiceKeys, viewType, filterName, filterRegion]);

    const columnTotals = useMemo(() => {
        return allServiceKeys.reduce((acc, key) => {
            acc[key] = statsData.reduce((sum, client) => sum + (client.counts[key] || 0), 0);
            return acc;
        }, {});
    }, [allServiceKeys, statsData]);

    const grandTotal = useMemo(() => statsData.reduce((sum, client) => sum + client.total, 0), [statsData]);

    const handleDownloadStats = () => {
        if (typeof XLSX === 'undefined') {
            alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            return;
        }

        let headerRow1 = ["ëŒ€ìƒì", "í•©ê³„"];
        
        // ì—‘ì…€ í—¤ë” êµ¬ì„±
        if (viewType === 'detail') {
            // ìƒì„¸ ë·°: [ëŒ€ë¶„ë¥˜] ìƒì„¸ë‚´ìš© í˜•ì‹ìœ¼ë¡œ í—¤ë” ìƒì„±
            allServiceKeys.forEach(key => {
                // Find category for this service name
                let category = "ê¸°íƒ€";
                for (const cat of groupedServices.sortedCategories) {
                    if (groupedServices.groups[cat].includes(key)) {
                        category = cat;
                        break;
                    }
                }
                headerRow1.push(`[${category}] ${key}`);
            });
        } else {
            // ì¹´í…Œê³ ë¦¬ ë·°: ì¹´í…Œê³ ë¦¬ëª… ê·¸ëŒ€ë¡œ
            headerRow1 = [...headerRow1, ...allServiceKeys];
        }

        // ë°ì´í„° í–‰ êµ¬ì„±
        const dataRows = statsData.map(client => {
            const row = [client.name, client.total];
            allServiceKeys.forEach(key => {
                row.push(client.counts[key] || 0);
            });
            return row;
        });

        // í•©ê³„ í–‰ êµ¬ì„±
        const totalRow = ["ì „ì²´ í•©ê³„", grandTotal];
        allServiceKeys.forEach(key => {
            totalRow.push(columnTotals[key]);
        });
        dataRows.push(totalRow);

        // ì›Œí¬ë¶ ìƒì„±
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet([headerRow1, ...dataRows]);
        
        // ì»¬ëŸ¼ ë„ˆë¹„ ìë™ ì¡°ì • (ë‹¨ìˆœí™”)
        const wscols = headerRow1.map(() => ({ wch: 15 }));
        ws['!cols'] = wscols;

        XLSX.utils.book_append_sheet(wb, ws, "ì„œë¹„ìŠ¤í†µê³„");
        XLSX.writeFile(wb, `ì„œë¹„ìŠ¤ì œê³µí†µê³„_${startDate}_${endDate}.xlsx`);
    };

    return (
        <div className="space-y-6">
            <div className="flex flex-col gap-4">
                <h2 className="text-2xl font-bold text-slate-800">ì„œë¹„ìŠ¤ ì œê³µ í†µê³„</h2>
                
                <div className="flex flex-wrap items-center gap-3">
                    {/* View Type Toggle */}
                    <div className="flex bg-slate-100 p-1 rounded-lg">
                        <button 
                            onClick={() => setViewType('category')}
                            className={`flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${viewType === 'category' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                        >
                            <PieChart size={16} />
                            ë¶„ë¥˜ë³„
                        </button>
                        <button 
                            onClick={() => setViewType('detail')}
                            className={`flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${viewType === 'detail' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                        >
                            <List size={16} />
                            ìƒì„¸ë³„
                        </button>
                    </div>

                    {/* Filters */}
                    <div className="flex items-center gap-2">
                        <select 
                            className="input-field text-sm py-1.5 w-24" 
                            value={filterRegion} 
                            onChange={e => setFilterRegion(e.target.value)}
                        >
                            <option value="">ì „ì²´ ë™</option>
                            {DONG_LIST.map(d => <option key={d} value={d}>{d}</option>)}
                        </select>
                        <input 
                            type="text" 
                            placeholder="ì´ë¦„ ê²€ìƒ‰" 
                            className="input-field text-sm py-1.5 w-24"
                            value={filterName} 
                            onChange={e => setFilterName(e.target.value)} 
                        />
                    </div>

                    {/* Date Picker */}
                    <div className="flex items-center gap-2 bg-white p-1.5 rounded-lg border border-slate-200 shadow-sm">
                        <Calendar size={16} className="text-slate-400"/>
                        <input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="text-xs outline-none text-slate-600"/>
                        <span className="text-slate-400 text-xs">~</span>
                        <input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} className="text-xs outline-none text-slate-600"/>
                    </div>

                    {/* Excel Download Button (Icon Only) */}
                    <button 
                        onClick={handleDownloadStats}
                        className="flex items-center justify-center bg-emerald-600 text-white p-2 rounded-lg hover:bg-emerald-700 transition-colors shadow-sm"
                        title="ì—‘ì…€ ë‹¤ìš´ë¡œë“œ"
                    >
                        <Download size={16} />
                    </button>
                </div>
            </div>

            <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left border-collapse">
                        <thead className="bg-slate-50 text-slate-600 font-semibold">
                            {viewType === 'detail' ? (
                                // 2-Row Header for Detailed View
                                <>
                                    <tr>
                                        <th rowSpan="2" className="p-3 sticky left-0 bg-slate-50 z-10 border-b border-r border-slate-200 min-w-[100px] align-middle text-center">ëŒ€ìƒì</th>
                                        <th rowSpan="2" className="p-3 text-center bg-emerald-50 text-emerald-700 border-b border-r border-slate-200 min-w-[60px] align-middle">í•©ê³„</th>
                                        {groupedServices.sortedCategories.map(cat => (
                                            <th 
                                                key={cat} 
                                                colSpan={groupedServices.groups[cat].length} 
                                                className="p-2 text-center border-b border-r border-slate-200 bg-slate-100 font-bold text-slate-700"
                                            >
                                                {cat}
                                            </th>
                                        ))}
                                    </tr>
                                    <tr>
                                        {groupedServices.sortedCategories.map(cat => (
                                            groupedServices.groups[cat].map(serviceName => (
                                                <th key={serviceName} className="p-2 text-center border-b border-r border-slate-100 min-w-[100px] whitespace-nowrap font-normal text-xs">
                                                    {serviceName}
                                                </th>
                                            ))
                                        ))}
                                    </tr>
                                </>
                            ) : (
                                // Single Row Header for Category View
                                <tr>
                                    <th className="p-3 sticky left-0 bg-slate-50 z-10 border-b border-r border-slate-200 min-w-[100px]">ëŒ€ìƒì</th>
                                    <th className="p-3 text-center bg-emerald-50 text-emerald-700 border-b border-r border-slate-200 min-w-[60px]">í•©ê³„</th>
                                    {allServiceKeys.map(key => (
                                        <th key={key} className="p-3 text-center border-b border-r border-slate-100 min-w-[100px] whitespace-nowrap">{key}</th>
                                    ))}
                                </tr>
                            )}
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                            <tr className="bg-slate-50 font-bold text-slate-700">
                                <td className="p-3 sticky left-0 bg-slate-50 border-r border-slate-200 text-center">ì „ì²´ í•©ê³„</td>
                                <td className="p-3 text-center bg-emerald-50 text-emerald-700 border-r border-slate-200">{grandTotal}</td>
                                {allServiceKeys.map(key => (
                                    <td key={key} className="p-3 text-center border-r border-slate-200">{columnTotals[key]}</td>
                                ))}
                            </tr>
                            {statsData.length === 0 ? (
                                <tr><td colSpan={allServiceKeys.length + 2} className="p-8 text-center text-slate-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            ) : statsData.map(client => (
                                <tr key={client.id} className="hover:bg-slate-50 transition-colors">
                                    <td className="p-3 font-medium text-slate-700 sticky left-0 bg-white border-r border-slate-200 group-hover:bg-slate-50">{client.name}</td>
                                    <td className="p-3 text-center font-bold text-emerald-600 bg-emerald-50/30 border-r border-slate-200">{client.total}</td>
                                    {allServiceKeys.map(key => (
                                        <td key={key} className={`p-3 text-center border-r border-slate-100 ${client.counts[key] > 0 ? 'text-slate-800 font-medium bg-blue-50/50' : 'text-slate-300'}`}>
                                            {client.counts[key] > 0 ? client.counts[key] : '-'}
                                        </td>
                                    ))}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
  };

  // ... ServiceManager (updated) ...
  const ServiceManager = () => {
    // Added example field to state
    const [newService, setNewService] = useState({ name: '', category: '', majorCategory: '', example: '' });
    const handleAdd = (e) => { e.preventDefault(); if(!newService.name) return; addService(newService); setNewService({ name: '', category: '', majorCategory: '', example: '' }); };

    return (
      <div className="space-y-6">
        <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-slate-800">ì„œë¹„ìŠ¤ ëª©ë¡ ì„¤ì •</h2>{services.length === 0 && <button onClick={loadSampleData} className="text-sm flex items-center gap-1 text-emerald-600 bg-emerald-50 px-3 py-1 rounded hover:bg-emerald-100"><RefreshCw size={14} /> ê¸°ë³¸ ì„œë¹„ìŠ¤ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>}</div>
        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
          <form onSubmit={handleAdd} className="flex flex-col lg:flex-row gap-4 items-end">
            <div className="w-full lg:w-1/5 min-w-[120px]"><label className="block text-sm font-medium text-slate-700 mb-1">ì„œë¹„ìŠ¤ ëŒ€ë¶„ë¥˜</label><input className="input-field" placeholder="ì˜ˆ: ìœ„ê¸°ê´€ë¦¬" value={newService.majorCategory} onChange={e => setNewService({...newService, majorCategory: e.target.value})} /></div>
            <div className="w-full lg:w-1/5 min-w-[120px]"><label className="block text-sm font-medium text-slate-700 mb-1">ì„œë¹„ìŠ¤</label><input className="input-field" placeholder="ì˜ˆ: ì‚¬ë¡€ê´€ë¦¬" value={newService.category} onChange={e => setNewService({...newService, category: e.target.value})} required /></div>
            <div className="w-full lg:w-1/4 min-w-[150px]"><label className="block text-sm font-medium text-slate-700 mb-1">ì„œë¹„ìŠ¤ ìƒì„¸ë‚´ìš©</label><input className="input-field" placeholder="ì˜ˆ: ì´ˆê¸°ìƒë‹´" value={newService.name} onChange={e => setNewService({...newService, name: e.target.value})} required /></div>
            <div className="flex-1 w-full min-w-[150px]"><label className="block text-sm font-medium text-slate-700 mb-1">ì„œë¹„ìŠ¤ ì˜ˆì‹œ</label><input className="input-field" placeholder="ì˜ˆ: ê°€ì •ë°©ë¬¸" value={newService.example} onChange={e => setNewService({...newService, example: e.target.value})} /></div>
            <button type="submit" className="bg-slate-800 text-white px-6 py-2 rounded-lg hover:bg-slate-700 h-[42px] whitespace-nowrap w-full lg:w-auto">ì¶”ê°€</button>
          </form>
        </div>
        <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden overflow-x-auto">
          <table className="w-full text-left min-w-[800px]">
            <thead className="bg-slate-50"><tr><th className="p-4 font-semibold text-slate-600 whitespace-nowrap w-[20%]">ëŒ€ë¶„ë¥˜</th><th className="p-4 font-semibold text-slate-600 whitespace-nowrap w-[15%]">ì„œë¹„ìŠ¤</th><th className="p-4 font-semibold text-slate-600 whitespace-nowrap w-[25%]">ì„œë¹„ìŠ¤ ìƒì„¸ë‚´ìš©</th><th className="p-4 font-semibold text-slate-600 whitespace-nowrap w-[30%]">ì„œë¹„ìŠ¤ ì˜ˆì‹œ</th><th className="p-4 font-semibold text-slate-600 text-right whitespace-nowrap w-[10%]">ê´€ë¦¬</th></tr></thead>
            <tbody>{services.length === 0 ? <tr><td colSpan="5" className="p-8 text-center text-slate-400">ë“±ë¡ëœ ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr> : services.map(service => (<tr key={service.id} className="border-t border-slate-100 hover:bg-slate-50"><td className="p-4 text-slate-800">{service.majorCategory || '-'}</td><td className="p-4 text-slate-500"><span className="bg-slate-100 px-2 py-1 rounded text-xs">{service.category}</span></td><td className="p-4 text-slate-800 font-medium">{service.name}</td><td className="p-4 text-slate-600 text-sm">{service.example || '-'}</td><td className="p-4 text-right"><button onClick={() => deleteService(service.id)} className="text-red-400 hover:text-red-600"><Trash2 size={18} /></button></td></tr>))}</tbody>
          </table>
        </div>
      </div>
    );
  };

  if (isLoading) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 text-slate-400">
        <Loader2 size={40} className="animate-spin mb-4 text-emerald-600" />
        <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col md:flex-row font-sans overflow-hidden">
      <style>{`
        .input-field {
          width: 100%;
          padding: 0.5rem 0.75rem;
          border: 1px solid #e2e8f0;
          border-radius: 0.5rem;
          outline: none;
          transition: border-color 0.2s;
        }
        .input-field:focus {
          border-color: #10b981;
          box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1);
        }
        @keyframes fade-in {
          from { opacity: 0; transform: translateY(-10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
          animation: fade-in 0.3s ease-out forwards;
        }
      `}</style>
      
      <div className="md:hidden bg-slate-800 text-white p-4 flex justify-between items-center flex-shrink-0">
        <h1 className="font-bold flex items-center gap-2">
          <BookOpen className="text-emerald-400" />
          ì²­ì „ê´‘ì¥
        </h1>
        <button onClick={() => setSidebarOpen(true)}><Menu size={24} /></button>
      </div>

      <Sidebar />
      
      {/* Main Content - Removed min-w-[1000px] to allow responsive scaling */}
      <main className="flex-1 p-4 md:p-8 overflow-y-auto overflow-x-auto">
        <div className="max-w-5xl mx-auto"> 
          {activeTab === 'dashboard' && <Dashboard onLogClick={(log) => { setTargetLogId(log.id); setActiveTab('logs'); }} />}
          {activeTab === 'clients' && <ClientManager />}
          {activeTab === 'logs' && <LogManager targetLogId={targetLogId} setTargetLogId={setTargetLogId} />}
          {activeTab === 'statistics' && <StatisticsManager />}
          {activeTab === 'services' && <ServiceManager />}
        </div>
      </main>
    </div>
  );
};

export default App;